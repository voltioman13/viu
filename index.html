<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIU estudio examenes</title>
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #1e293b;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --info: #3b82f6;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #0f172a;
            --accent: #fbbf24;
            --success: #34d399;
            --error: #f87171;
            --bg: #0f172a;
            --card: #1e293b;
            --info: #60a5fa;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --input-bg: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        /* --- NAVEGACI√ìN --- */
        nav {
            background-color: var(--secondary);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .nav-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .logo { font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px;}
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap;}
        .menu-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .menu-btn:hover, .menu-btn.active {
            background-color: var(--primary);
            transform: translateY(-1px);
        }
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        /* --- MEN√ö DESPLEGABLE --- */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown > .menu-btn {
            cursor: pointer;
            user-select: none;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--card);
            min-width: 200px;
            box-shadow: 0 8px 16px var(--shadow);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
        }
        .dropdown.active .dropdown-content {
            display: block;
        }
        .dropdown-content button {
            background: none;
            border: none;
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .dropdown-content button:hover {
            background-color: var(--primary);
            color: white;
        }
        
        /* --- CONTENEDOR CENTRAL --- */
        main {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 2rem auto;
            padding: 0 1rem;
            box-sizing: border-box;
        } 
        /* --- TARJETAS --- */
        .card {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px var(--shadow);
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-out;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2, h3 { margin-top: 0; color: var(--text-primary); }
        /* --- FORMULARIOS --- */
        .form-group { margin-bottom: 1.2rem; text-align: left;}
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;}
        .form-input, .form-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
            transition: border-color 0.2s;
            box-sizing: border-box;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .form-select option {
            background: var(--card);
            color: var(--text-primary);
        }
        textarea.form-input { min-height: 100px; resize: vertical; }
        
        /* --- BOT√ìN DE TEMA --- */
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        /* --- BOTONES --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: #64748b; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #059669; }
        .btn-warning { background-color: var(--accent); color: #fff; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-outline { background: transparent; border: 2px solid #cbd5e1; color: #64748b; }
        .btn-outline:hover { border-color: var(--secondary); color: var(--secondary); background: transparent; }
        .btn-info { background-color: var(--info); }
        .btn-info:hover { background-color: #2563eb; }
        /* --- ESTILOS DEL TEST --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: #64748b; font-size: 0.9rem; }
        
        .quiz-progress {
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
        .question-text { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; line-height: 1.5; color: var(--text-primary); }
        .option-btn {
            width: 100%; text-align: left; padding: 1.2rem; margin-bottom: 0.8rem;
            background: var(--card); border: 2px solid var(--border); border-radius: 10px;
            cursor: pointer; transition: all 0.2s; font-size: 1rem; color: var(--text-primary);
            position: relative;
        }
        .option-btn:hover { border-color: var(--primary); background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .option-btn.correct { background: #dcfce7; border-color: var(--success); color: #065f46; font-weight: 600; }
        [data-theme="dark"] .option-btn.correct { background: #064e3b; color: #6ee7b7; }
        .option-btn.incorrect { background: #fee2e2; border-color: var(--error); color: #991b1b; }
        [data-theme="dark"] .option-btn.incorrect { background: #7f1d1d; color: #fca5a5; }
        .option-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
        [data-theme="dark"] .option-btn.selected { background: var(--primary); color: white; }
        
        /* --- ESTILOS DE LA B√öSQUEDA (ACTUALIZADO) --- */
        .result-item { 
            padding: 1rem; 
            border-bottom: 1px solid var(--border); 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .result-item:hover { background: var(--input-bg); }
        .tag { 
            font-size: 0.75rem; 
            background: var(--border); 
            padding: 4px 8px; 
            border-radius: 6px; 
            color: var(--text-secondary); 
            margin-right: 8px; 
            font-weight: 600; 
            display: inline-block;
            margin-bottom: 4px;
        }
        .tag-subject { background: #e0e7ff; color: #4338ca; }
        [data-theme="dark"] .tag-subject { background: #312e81; color: #a5b4fc; }
        .tag-obligatoria { background: #fef3c7; color: #92400e; }
        [data-theme="dark"] .tag-obligatoria { background: #78350f; color: #fde68a; }
        .tag-optativa { background: #dbeafe; color: #1e40af; }
        [data-theme="dark"] .tag-optativa { background: #1e3a8a; color: #93c5fd; }
        .tag-especialidad { background: #fce7f3; color: #9f1239; }
        [data-theme="dark"] .tag-especialidad { background: #831843; color: #fbcfe8; }
        .detail-option {
            padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg);
        }
        .detail-correct {
            background-color: #dcfce7; border-color: var(--success); color: #065f46; font-weight: bold;
        }
        [data-theme="dark"] .detail-correct {
            background-color: #064e3b; border-color: var(--success); color: #6ee7b7;
        }

        /* ESTILO PARA RESALTAR TEXTO DE B√öSQUEDA */
        .highlight {
            background-color: var(--accent);
            color: var(--secondary);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        /* Clases para modo oscuro en elementos din√°micos */
        .bg-light-box {
            background: #f8fafc;
        }
        [data-theme="dark"] .bg-light-box {
            background: #1e293b;
        }
        
        .bg-white-box {
            background: white;
        }
        [data-theme="dark"] .bg-white-box {
            background: #334155;
        }
        
        .bg-blue-light {
            background: #eff6ff;
        }
        [data-theme="dark"] .bg-blue-light {
            background: #1e293b;
        }
        
        .text-muted {
            color: #64748b;
        }
        [data-theme="dark"] .text-muted {
            color: #94a3b8;
        }
        
        .text-dark {
            color: #334155;
        }
        [data-theme="dark"] .text-dark {
            color: #e2e8f0;
        }
        
        .border-light {
            border-color: #e2e8f0;
        }
        [data-theme="dark"] .border-light {
            border-color: #334155;
        }
        
        /* SNIPPET STYLES - NUEVOS ESTILOS PARA LA L√çNEA DE COLOR */
        .snippet-container { margin-top: 10px; }
        .search-snippet {
            margin-top: 5px; 
            font-size: 0.9rem; 
            padding: 8px 10px; 
            border-radius: 4px;
            line-height: 1.4;
            margin-bottom: 8px; 
            font-weight: 500;
        }
        .snippet-correct {
            border-left: 3px solid var(--success); /* L√≠nea verde */
            background: #dcfce7; /* Fondo verde claro */
            color: #065f46;
        }
        .snippet-incorrect {
            border-left: 3px solid var(--error); /* L√≠nea roja */
            background: #fee2e2; /* Fondo rojo claro */
            color: #991b1b;
        }

        /* --- UTILIDADES --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .loading-box { text-align: center; padding: 3rem; color: #94a3b8; }
        
        /* Modal de selecci√≥n de especialidad */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .especialidad-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin: 1.5rem 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .especialidad-option {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 500;
            background: var(--input-bg);
        }
        .especialidad-option:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }
        .especialidad-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        .config-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .config-btn:hover {
            background: var(--border);
            transform: rotate(45deg);
        }
        .especialidad-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.15) 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-weight: 500;
        }
        [data-theme="dark"] .especialidad-display {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(129, 140, 248, 0.15) 100%);
        }
        .especialidad-display .badge {
            background: linear-gradient(135deg, var(--primary) 0%, #818cf8 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 1rem;
            flex: 1;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        @media (max-width: 600px) {
            .nav-content { justify-content: center; }
            .card { padding: 1.5rem; }
            .btn { padding: 0.8rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <!-- T√≠tulo de navegaci√≥n actualizado - Click secreto para admin -->
            <div class="logo" onclick="app.secretAdminClick()" style="cursor: default;">VIU - Master Profesor</div>
            <div class="nav-buttons">
                <button class="menu-btn active" onclick="app.navigate('home')">Inicio</button>
                <button class="menu-btn" onclick="app.navigate('stats')">üìä</button>
                <button class="menu-btn" onclick="app.navigate('search')">üîç</button>
                <button class="menu-btn" onclick="app.navigate('contribute')" title="Contribuir con preguntas">‚ûï
                <button class="theme-toggle" onclick="app.showHelp()" title="Ayuda y atajos">
                    ‚ÑπÔ∏è
                </button>
                <button class="theme-toggle" onclick="app.toggleTheme()" id="theme-toggle" title="Cambiar tema">
                    üåô
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Modal de Login Admin -->
    <div id="admin-login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 350px; margin: 20px; text-align: center;">
            <h3 style="margin-bottom: 1rem;">üîê Acceso Administrador</h3>
            <input type="password" id="admin-password" class="form-input" placeholder="Contrase√±a" style="margin-bottom: 1rem;" onkeypress="if(event.key==='Enter') app.verifyAdminPassword()">
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="app.verifyAdminPassword()" style="flex: 1;">Entrar</button>
                <button class="btn btn-outline" onclick="app.hideAdminLogin()" style="flex: 1;">Cancelar</button>
            </div>
            <p id="admin-login-error" style="color: var(--error); font-size: 0.85rem; margin-top: 0.5rem; display: none;">Contrase√±a incorrecta</p>
        </div>
    </div>
    
    <!-- Modal de Ayuda -->
    <div id="help-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card bg-white-box" style="max-width: 600px; max-height: 80vh; margin: 20px; position: relative; display: flex; flex-direction: column;">
            <button onclick="app.hideHelp()" style="position: absolute; top: 10px; right: 12px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary); z-index: 10;">&times;</button>
            
            <h2 style="margin-bottom: 0.75rem; padding-right: 30px; font-size: 1.3rem;">üìö Gu√≠a R√°pida</h2>
            
            <!-- Pesta√±as -->
            <div style="display: flex; gap: 0.25rem; border-bottom: 2px solid var(--border); margin-bottom: 1rem; flex-wrap: wrap;">
                <button onclick="app.showHelpTab('inicio')" id="help-tab-inicio" class="help-tab active" style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.85rem;">
                    üöÄ Inicio
                </button>
                <button onclick="app.showHelpTab('tests')" id="help-tab-tests" class="help-tab" style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.85rem;">
                    üìù Tests
                </button>
                <button onclick="app.showHelpTab('votos')" id="help-tab-votos" class="help-tab" style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.85rem;">
                    üëç Votos
                </button>
                <button onclick="app.showHelpTab('contribuir')" id="help-tab-contribuir" class="help-tab" style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.85rem;">
                    ‚ûï Contribuir
                </button>
                <button onclick="app.showHelpTab('atajos')" id="help-tab-atajos" class="help-tab" style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.85rem;">
                    ‚å®Ô∏è Atajos
                </button>
            </div>
            
            <!-- Contenido de las pesta√±as -->
            <div style="overflow-y: auto; flex: 1; padding-right: 8px; font-size: 0.9rem; color: var(--text-primary);">
                <!-- Pesta√±a: Inicio R√°pido -->
                <div id="help-content-inicio" class="help-content">
                    <div style="background: var(--primary); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; color: white;">
                        <p style="margin: 0; font-weight: 600;">1Ô∏è‚É£ Elige especialidad ‚Üí 2Ô∏è‚É£ Elige asignatura ‚Üí 3Ô∏è‚É£ ¬°Comienza el test!</p>
                    </div>
                    
                    <p style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-secondary);">Funciones principales:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div style="padding: 0.5rem; background: var(--card); border-radius: 6px; border-left: 3px solid #10b981;">
                            <strong style="font-size: 0.8rem; color: var(--text-primary);">üîÑ Modo Repaso</strong><br>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Solo preguntas falladas</span>
                        </div>
                        <div style="padding: 0.5rem; background: var(--card); border-radius: 6px; border-left: 3px solid #ef4444;">
                            <strong style="font-size: 0.8rem; color: var(--text-primary);">‚è±Ô∏è Modo Examen</strong><br>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Con tiempo l√≠mite</span>
                        </div>
                        <div style="padding: 0.5rem; background: var(--card); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                            <strong style="font-size: 0.8rem; color: var(--text-primary);">üìä Estad√≠sticas</strong><br>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Tu progreso y predicciones</span>
                        </div>
                        <div style="padding: 0.5rem; background: var(--card); border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <strong style="font-size: 0.8rem; color: var(--text-primary);">üëçüëé Votaci√≥n</strong><br>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Valida las preguntas</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--card); border: 1px solid var(--border); padding: 0.6rem; border-radius: 6px; margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-primary);">
                        <strong>üí° Tip:</strong> Vota üëç/üëé en cada pregunta para ayudar a verificar si est√°n correctas.
                    </div>
                </div>
                
                <!-- Pesta√±a: Tests -->
                <div id="help-content-tests" class="help-content" style="display: none;">
                    <div style="display: grid; gap: 0.5rem;">
                        <div style="padding: 0.6rem; background: var(--card); border-radius: 6px; border-left: 3px solid #10b981; color: var(--text-primary);">
                            <strong style="color: #10b981;">‚úÖ Test Normal</strong> ‚Äî Feedback inmediato al responder. Ideal para <em>aprender</em>.
                        </div>
                        <div style="padding: 0.6rem; background: var(--card); border-radius: 6px; border-left: 3px solid #ef4444; color: var(--text-primary);">
                            <strong style="color: #ef4444;">‚è±Ô∏è Modo Examen</strong> ‚Äî Con temporizador, sin feedback hasta el final. Para <em>simulacros</em>.
                        </div>
                        <div style="padding: 0.6rem; background: var(--card); border-radius: 6px; border-left: 3px solid #3b82f6; color: var(--text-primary);">
                            <strong style="color: #3b82f6;">üîÑ Modo Repaso</strong> ‚Äî Solo tus preguntas falladas. Para <em>mejorar</em>.
                        </div>
                        <div style="padding: 0.6rem; background: var(--card); border-radius: 6px; border-left: 3px solid #a855f7; color: var(--text-primary);">
                            <strong style="color: #a855f7;">üìñ Ver Resumen</strong> ‚Äî Todas las preguntas con respuestas. Para <em>estudiar</em>.
                        </div>
                    </div>
                    
                    <p style="margin: 0.75rem 0 0.4rem 0; font-weight: 600; font-size: 0.85rem;">‚≠ê Extras:</p>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; line-height: 1.6;">
                        <li><strong>üîñ Marcar</strong> ‚Äî Guarda preguntas dif√≠ciles para repasarlas</li>
                        <li><strong>üìù Notas</strong> ‚Äî Escribe apuntes en cada pregunta</li>
                        <li><strong>üé≤ Orden aleatorio</strong> ‚Äî Mezcla las preguntas cada vez</li>
                    </ul>
                </div>
                
                <!-- Pesta√±a: Votos -->
                <div id="help-content-votos" class="help-content" style="display: none;">
                    <div style="background: var(--card); border: 1px solid var(--border); padding: 0.6rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.85rem; color: var(--text-primary);">
                        <strong>¬øPara qu√© sirve?</strong> Las preguntas las a√±ade cualquiera, as√≠ que votamos entre todos para verificar si est√°n bien.
                    </div>
                    
                    <p style="margin: 0 0 0.4rem 0; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">üè∑Ô∏è Niveles de verificaci√≥n:</p>
                    <div style="display: grid; gap: 0.35rem; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-left: 3px solid #10b981; border-radius: 4px; color: var(--text-primary);">
                            <span style="background: #10b981; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">‚úÖ Verificada</span>
                            <span>80%+ votos positivos ‚Üí <strong>Fiable</strong></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-left: 3px solid #3b82f6; border-radius: 4px; color: var(--text-primary);">
                            <span style="background: #3b82f6; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">üü¢ Prob. correcta</span>
                            <span>60%+ positivos ‚Üí <strong>Bastante fiable</strong></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-left: 3px solid #f59e0b; border-radius: 4px; color: var(--text-primary);">
                            <span style="background: #f59e0b; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">üü° Dudosa</span>
                            <span>Votos divididos ‚Üí <strong>Verifica t√∫</strong></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-left: 3px solid #ef4444; border-radius: 4px; color: var(--text-primary);">
                            <span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">üî¥ Posible error</span>
                            <span>Mayor√≠a negativos ‚Üí <strong>¬°Cuidado!</strong></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-left: 3px solid var(--text-secondary); border-radius: 4px; color: var(--text-primary);">
                            <span style="background: var(--text-secondary); color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">‚ö™ Sin verificar</span>
                            <span>Pocos votos ‚Üí <strong>¬°Vota t√∫!</strong></span>
                        </div>
                    </div>
                    
                    <div style="background: var(--card); border: 1px solid var(--border); padding: 0.5rem; border-radius: 6px; margin-top: 0.6rem; font-size: 0.8rem; color: var(--text-primary);">
                        <strong>üí° Tip:</strong> Vota despu√©s de ver la respuesta. Si coincide con el temario ‚Üí üëç. Si no est√°s seguro ‚Üí no votes.
                    </div>
                </div>
                
                <!-- Pesta√±a: Contribuir -->
                <div id="help-content-contribuir" class="help-content" style="display: none;">
                    <div style="background: var(--card); border: 1px solid #f59e0b; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.6rem; font-size: 0.85rem; color: var(--text-primary);">
                        <strong>‚ö†Ô∏è Solo env√≠a preguntas de las que est√©s 100% seguro de la respuesta correcta.</strong>
                    </div>
                    
                    <p style="margin: 0 0 0.4rem 0; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">üìã Pasos:</p>
                    <ol style="margin: 0; padding-left: 1.3rem; font-size: 0.85rem; line-height: 1.5; color: var(--text-primary);">
                        <li>Pulsa <strong>"+"</strong> en el men√∫</li>
                        <li>Selecciona especialidad y asignatura</li>
                        <li>Escribe n¬∫ de tema, pregunta y 4 opciones</li>
                        <li>Marca la respuesta correcta</li>
                        <li>¬°Enviar!</li>
                    </ol>
                    
                    <p style="margin: 0.6rem 0 0.4rem 0; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">üìù Tipos de pregunta:</p>
                    <div style="display: grid; gap: 0.35rem; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-radius: 4px; color: var(--text-primary);">
                            <span>üìù</span><strong>Test</strong> ‚Äî Pregunta normal tipo test
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-radius: 4px; color: var(--text-primary);">
                            <span>ü§ñ</span><strong>Test IA</strong> ‚Äî Generada con ChatGPT/IA
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--card); border-radius: 4px; color: var(--text-primary);">
                            <span>üìÑ</span><strong>Desarrollo</strong> ‚Äî Pregunta abierta con respuesta modelo
                        </div>
                    </div>
                    
                    <div style="background: var(--card); border: 1px solid var(--border); padding: 0.5rem; border-radius: 6px; margin-top: 0.6rem; font-size: 0.8rem; color: var(--text-primary);">
                        <strong>üõ†Ô∏è Editar/Eliminar:</strong> Ve a <strong>"+" ‚Üí Mis Contribuciones</strong>
                    </div>
                </div>
                
                <!-- Pesta√±a: Atajos -->
                <div id="help-content-atajos" class="help-content" style="display: none;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">‚å®Ô∏è Durante el test:</p>
                    <div style="display: grid; gap: 0.4rem; font-size: 0.85rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.4rem; background: var(--card); border-radius: 4px; color: var(--text-primary);">
                            <div style="display: flex; gap: 0.25rem;">
                                <kbd style="background: var(--border); padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">1</kbd>
                                <kbd style="background: var(--border); padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">2</kbd>
                                <kbd style="background: var(--border); padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">3</kbd>
                                <kbd style="background: var(--border); padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">4</kbd>
                            </div>
                            <span>‚Üí Respuesta A, B, C, D</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.4rem; background: var(--card); border-radius: 4px; color: var(--text-primary);">
                            <kbd style="background: var(--border); padding: 0.2rem 0.6rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">Enter</kbd>
                            <span>‚Üí Siguiente pregunta</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.4rem; background: var(--card); border-radius: 4px; color: var(--text-primary);">
                            <div style="display: flex; gap: 0.25rem;">
                                <kbd style="background: var(--border); padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">‚Üê</kbd>
                                <kbd style="background: var(--border); padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid var(--text-secondary); font-size: 0.75rem; color: var(--text-primary);">‚Üí</kbd>
                            </div>
                            <span>‚Üí Navegar preguntas</span>
                        </div>
                    </div>
                    
                    <p style="margin: 0.75rem 0 0.4rem 0; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">üé® Personalizaci√≥n:</p>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; line-height: 1.5; color: var(--text-primary);">
                        <li><strong>üåô Tema oscuro:</strong> Bot√≥n en barra superior</li>
                        <li><strong>üî§ Tama√±o letra:</strong> Slider en pantalla inicio</li>
                    </ul>
                    
                    <p style="margin: 0.75rem 0 0.4rem 0; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">üíæ Se guarda autom√°ticamente:</p>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; line-height: 1.5; color: var(--text-primary);">
                        <li>Notas personales y preguntas marcadas</li>
                        <li>Historial y estad√≠sticas</li>
                        <li>Preguntas falladas (para repaso)</li>
                        <li>Tema, tama√±o letra, preferencias</li>
                    </ul>
                    
                    <div style="background: var(--card); border: 1px solid #ef4444; padding: 0.5rem; border-radius: 6px; margin-top: 0.6rem; font-size: 0.8rem; color: var(--text-primary);">
                        <strong>‚ö†Ô∏è Ojo:</strong> Los datos est√°n en tu navegador. Si limpias cach√©, los pierdes.
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; padding: 1rem 0 0 0; border-top: 1px solid var(--border); margin-top: 0.75rem;">
                <button class="btn" onclick="app.hideHelp()" style="min-width: 120px; padding: 0.5rem 1rem;">¬°Entendido!</button>
            </div>
        </div>
    </div>
    
    <main id="app-container">
        <div class="loading-box">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Cargando sistema...</p>
        </div>
    </main>
    <!-- Notificaci√≥n Flotante -->
    <div id="toast">Mensaje</div>
    <script>
        // --- CONFIGURACI√ìN SUPABASE ---
        const SUPABASE_CONFIG = {
            url: 'https://uhvmvnaxzvytgcmzkyoe.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVodm12bmF4enZ5dGdjbXpreW9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODQwNzcsImV4cCI6MjA4MTI2MDA3N30.D-ZcfCIMLSO_K2mJJhVITh7pMxetmGds_rWZ22HTbv4',
            table: 'preguntas'
        };
        
        // --- CONFIGURACI√ìN Y ESTRUCTURA ---
        const CONFIG = {
            especialidades: {
                'tecnologias-informatica': 'Tecnolog√≠as e Inform√°tica',
                'orientacion-educativa': 'Orientaci√≥n Educativa',
                'musica': 'M√∫sica',
                'lengua-literatura': 'Lengua y Literatura',
                'ingles': 'Ingl√©s',
                'geografia-historia': 'Geograf√≠a e Historia',
                'fol': 'FOL',
                'fisica-quimica': 'F√≠sica y Qu√≠mica',
                'educacion-fisica': 'Educaci√≥n F√≠sica',
                'economia-administracion': 'Econom√≠a y Administraci√≥n',
                'dibujo': 'Dibujo',
                'biologia-geologia': 'Biolog√≠a y Geolog√≠a',
                'matematicas': 'Matem√°ticas'
            },
            asignaturas: {
                obligatorias: [
                    { id: 'sociedad-familia-educacion', nombre: 'Sociedad, familia y educaci√≥n', archivo: 'obligatorias/sociedad-familia-educacion.json' },
                    { id: 'procesos-contextos-educativos', nombre: 'Procesos y contextos educativos', archivo: 'obligatorias/procesos-contextos-educativos.json' },
                    { id: 'aprendizaje-desarrollo-personalidad', nombre: 'Aprendizaje y desarrollo de la personalidad', archivo: 'obligatorias/aprendizaje-desarrollo-personalidad.json' }
                ],
                optativas: [
                    { id: 'mediacion', nombre: 'Mediaci√≥n', archivo: 'optativas-comunes/mediacion.json' },
                    { id: 'materiales-estrategias-didacticas', nombre: 'Materiales y estrategias did√°cticas', archivo: 'optativas-comunes/materiales-estrategias-didacticas.json' },
                    { id: 'educacion-emocional-habilidades-sociales', nombre: 'Educaci√≥n emocional y habilidades sociales', archivo: 'optativas-comunes/educacion-emocional-habilidades-sociales.json' }
                ],
                especialidad: [
                    { id: 'innovacion-docente-investigacion', nombre: 'Innovaci√≥n docente e iniciaci√≥n a la investigaci√≥n', archivo: 'innovacion-docente-investigacion.json' },
                    { id: 'complementos-formacion-disciplinar', nombre: 'Complementos para la formaci√≥n disciplinar', archivo: 'complementos-formacion-disciplinar.json' },
                    { id: 'aprendizaje-ensenanza', nombre: 'Aprendizaje y ense√±anza', archivo: 'aprendizaje-ensenanza.json' }
                ],
                especialidadOrientacion: [
                    { id: 'procesos-orientacion-educativa', nombre: 'Procesos de orientaci√≥n educativa', archivo: 'procesos-orientacion-educativa.json' },
                    { id: 'investigacion-innovacion-gestion-cambio', nombre: 'Investigaci√≥n e innovaci√≥n educativa', archivo: 'investigacion-innovacion-gestion-cambio.json' },
                    { id: 'educacion-inclusiva-atencion-diversidad', nombre: 'Educaci√≥n inclusiva', archivo: 'educacion-inclusiva-atencion-diversidad.json' }
                ]
            }
        };

        const app = {
            filteredQuestions: [],
            activeQuizQuestions: [],
            currentEspecialidad: '',
            userEspecialidad: null, // Especialidad fija del usuario (guardada permanentemente)
            currentAsignatura: null,
            currentTema: 'all', // Tema seleccionado ('all' o n√∫mero de tema)
            asignaturasDisponibles: [],
            loadedData: {},
            
            // Preguntas de la base de datos
            dbQuestions: [],
            dbQuestionsLoaded: false,
            
            // ID √∫nico del usuario (para controlar sus propias preguntas)
            userId: null,
            
            // Estado del Quiz
            quiz: { 
                index: 0, 
                score: 0, 
                answered: false, 
                failedQuestions: [],
                answers: [] // Guarda {questionIndex, selectedOption, isCorrect}
            },
            
            // Configuraci√≥n de quiz
            quizSettings: {
                randomOrder: false, // false = orden original, true = orden aleatorio
                onlyMarked: false,  // mostrar solo preguntas marcadas
                includeTest: true,  // incluir preguntas de test normal
                includeAI: true,    // incluir preguntas generadas con IA
                includeDesarrollo: true // incluir preguntas de desarrollo
            },
            
            // Preguntas marcadas como dif√≠ciles (guardadas en localStorage)
            markedQuestions: new Set(),
            
            // Votos del usuario en preguntas (guardados en localStorage)
            // Formato: { questionId: 'up' | 'down' }
            userVotes: {},
            
            // Historial de tests completados
            testHistory: [],
            
            // Estad√≠sticas por asignatura
            stats: {},
            
            // Preferencias guardadas
            savedPreferences: null,
            
            // Tema actual (light o dark)
            currentTheme: 'light',
            
            // Notas personales por pregunta
            questionNotes: {},
            
            // Tama√±o de fuente (porcentaje)
            fontSize: 100,
            
            // Contribuciones del usuario
            userContributions: [],
            
            // Estado de contribuci√≥n (para mantener especialidad, asignatura, tema)
            contribState: { especialidad: '', asignatura: '', tema: '' },
            
            // ID de contribuci√≥n siendo editada (null si es nueva)
            editingContribId: null,
            
            // ID de pregunta de BD siendo editada (null si es nueva)
            editingDbQuestionId: null,
            
            // Constantes de cache
            CACHE_DURATION: 24 * 60 * 60 * 1000, // 24 horas en ms
            REFRESH_COOLDOWN: 60 * 1000, // 1 minuto en ms
            CACHE_KEYS: {
                questions: 'viu_db_questions_cache',
                cacheTime: 'viu_db_questions_cache_time',
                lastRefresh: 'viu_db_last_manual_refresh'
            },
            
            // Verificar si el cooldown del bot√≥n est√° activo
            isRefreshOnCooldown: () => {
                const lastRefresh = localStorage.getItem(app.CACHE_KEYS.lastRefresh);
                if (!lastRefresh) return false;
                const elapsed = Date.now() - parseInt(lastRefresh);
                return elapsed < app.REFRESH_COOLDOWN;
            },
            
            // Obtener tiempo restante del cooldown en segundos
            getCooldownRemaining: () => {
                const lastRefresh = localStorage.getItem(app.CACHE_KEYS.lastRefresh);
                if (!lastRefresh) return 0;
                const elapsed = Date.now() - parseInt(lastRefresh);
                const remaining = app.REFRESH_COOLDOWN - elapsed;
                return remaining > 0 ? Math.ceil(remaining / 1000) : 0;
            },
            
            // Obtener info del estado del cache
            getCacheInfo: () => {
                const cacheTime = localStorage.getItem(app.CACHE_KEYS.cacheTime);
                if (!cacheTime) {
                    return { hasCache: false, age: 0, ageText: 'Sin datos', isExpired: true };
                }
                
                const age = Date.now() - parseInt(cacheTime);
                const isExpired = age >= app.CACHE_DURATION;
                
                // Formatear tiempo transcurrido
                const minutes = Math.floor(age / 60000);
                const hours = Math.floor(minutes / 60);
                
                let ageText;
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    ageText = `hace ${days} d√≠a${days > 1 ? 's' : ''}`;
                } else if (hours > 0) {
                    ageText = `hace ${hours}h ${minutes % 60}m`;
                } else if (minutes > 0) {
                    ageText = `hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                } else {
                    ageText = 'hace menos de 1 minuto';
                }
                
                return { hasCache: true, age, ageText, isExpired };
            },
            
            // Funci√≥n para refrescar cache y recargar p√°gina (con cooldown)
            refreshAndReload: async () => {
                const btn = event.target;
                
                // Verificar cooldown
                if (app.isRefreshOnCooldown()) {
                    const remaining = app.getCooldownRemaining();
                    app.showToast(`‚è≥ Espera ${remaining} segundos antes de actualizar de nuevo`);
                    return;
                }
                
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Actualizando...';
                
                const success = await app.refreshDbCache();
                if (success) {
                    // Guardar timestamp del refresh manual
                    localStorage.setItem(app.CACHE_KEYS.lastRefresh, Date.now().toString());
                    app.showToast('‚úÖ Preguntas actualizadas correctamente');
                    // Recargar la vista actual
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Actualizar Preguntas de la BD';
                    app.showToast('‚ùå Error al actualizar. Int√©ntalo de nuevo.');
                }
            },
            
            // Estado para persistir la b√∫squeda
            searchState: { term: '', resultsHTML: '' },
            
            // Modo examen
            // Modo examen
            examMode: {
                active: false,
                timeLimit: 30, // minutos
                questionCount: 30,
                startTime: null,
                endTime: null,
                timer: null
            },
            
            // Historial de respuestas incorrectas (para modo repaso)
            failedQuestionsHistory: [],
            
            // Controlar dropdown con clic
            toggleDropdown: (event) => {
                event.stopPropagation();
                const dropdown = document.getElementById('test-dropdown');
                dropdown.classList.toggle('active');
            },
            
            closeDropdown: () => {
                const dropdown = document.getElementById('test-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
            },
            
            init: async () => {
                app.showLoading('Cargando datos...');
                app.getUserId(); // Inicializar ID del usuario
                app.loadMarkedQuestions();
                app.loadUserVotes(); // Cargar votos del usuario
                app.loadTestHistory();
                app.loadStats();
                app.loadPreferences();
                app.loadQuestionNotes();
                app.loadContributions();
                app.loadContribState();
                app.loadFailedHistory();
                app.loadUserEspecialidad(); // Cargar especialidad fija del usuario
                await app.loadInitialData();
                
                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('test-dropdown');
                    if (dropdown && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
                
                // Si el usuario tiene especialidad guardada, cargarla
                if (app.userEspecialidad) {
                    app.currentEspecialidad = app.userEspecialidad;
                    await app.loadEspecialidadData(app.userEspecialidad);
                }
                
                // Aplicar preferencias guardadas (excepto especialidad que ya est√° fija)
                if (app.savedPreferences) {
                    if (app.savedPreferences.lastAsignatura) {
                        await app.selectAsignatura(app.savedPreferences.lastAsignatura);
                        // Aplicar filtro de tema si hay uno guardado
                        if (app.savedPreferences.lastTema) {
                            app.currentTema = app.savedPreferences.lastTema;
                            if (app.savedPreferences.lastTema !== 'all') {
                                await app.applyTemaFilter(app.savedPreferences.lastTema);
                            }
                        }
                    }
                    if (app.savedPreferences.randomOrder !== undefined) {
                        app.quizSettings.randomOrder = app.savedPreferences.randomOrder;
                    }
                    if (app.savedPreferences.onlyMarked !== undefined) {
                        app.quizSettings.onlyMarked = app.savedPreferences.onlyMarked;
                    }
                    // Cargar filtros de tipo de pregunta
                    if (app.savedPreferences.includeTest !== undefined) {
                        app.quizSettings.includeTest = app.savedPreferences.includeTest;
                    }
                    if (app.savedPreferences.includeAI !== undefined) {
                        app.quizSettings.includeAI = app.savedPreferences.includeAI;
                    }
                    if (app.savedPreferences.includeDesarrollo !== undefined) {
                        app.quizSettings.includeDesarrollo = app.savedPreferences.includeDesarrollo;
                    }
                }
                
                // Cargar y aplicar tema
                app.loadTheme();
                
                // Cargar y aplicar tama√±o de fuente
                app.loadFontSize();
                
                // Configurar atajos de teclado
                app.setupKeyboardShortcuts();
                
                // Inicializar modal de ayuda
                app.initHelpModal();
                
                // Si no tiene especialidad, mostrar modal obligatorio
                if (!app.userEspecialidad) {
                    app.showEspecialidadModal();
                } else {
                    // Restaurar vista anterior o ir a home
                    const savedView = localStorage.getItem('viu_current_view') || 'home';
                    app.navigate(savedView);
                }
            },
            
            // Gesti√≥n de tema oscuro/claro
            loadTheme: () => {
                const savedTheme = localStorage.getItem('viu_theme') || 'light';
                app.currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);
                app.updateThemeIcon();
            },
            
            toggleTheme: () => {
                const newTheme = app.currentTheme === 'light' ? 'dark' : 'light';
                app.currentTheme = newTheme;
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('viu_theme', newTheme);
                app.updateThemeIcon();
                app.showToast(newTheme === 'dark' ? 'üåô Modo oscuro activado' : '‚òÄÔ∏è Modo claro activado');
            },
            
            updateThemeIcon: () => {
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = app.currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                }
            },
            
            // --- GESTI√ìN DE ESPECIALIDAD DEL USUARIO ---
            loadUserEspecialidad: () => {
                try {
                    const saved = localStorage.getItem('viu_user_especialidad');
                    if (saved) {
                        app.userEspecialidad = saved;
                        app.currentEspecialidad = saved; // Tambi√©n actualizar currentEspecialidad
                    }
                } catch (e) {
                    console.error('Error cargando especialidad del usuario:', e);
                }
            },
            
            saveUserEspecialidad: async (especialidadId) => {
                try {
                    app.userEspecialidad = especialidadId;
                    app.currentEspecialidad = especialidadId;
                    localStorage.setItem('viu_user_especialidad', especialidadId);
                    // Cargar datos de especialidad para que aparezcan las asignaturas
                    await app.loadEspecialidadData(especialidadId);
                } catch (e) {
                    console.error('Error guardando especialidad del usuario:', e);
                }
            },
            
            showEspecialidadModal: (isChange = false) => {
                const especialidadOptions = Object.entries(CONFIG.especialidades).map(([id, nombre]) => 
                    `<div class="especialidad-option" data-id="${id}" onclick="app.selectEspecialidadOption('${id}')">${nombre}</div>`
                ).join('');
                
                const modalHtml = `
                    <div id="especialidad-modal" class="modal-overlay">
                        <div class="modal-content">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéì</div>
                                <h2 style="margin: 0;">${isChange ? 'Cambiar Especialidad' : '¬°Bienvenido/a!'}</h2>
                                <p class="text-muted" style="margin-top: 0.5rem;">
                                    ${isChange ? 'Selecciona tu nueva especialidad' : 'Para comenzar, selecciona tu especialidad del M√°ster'}
                                </p>
                            </div>
                            
                            <div class="especialidad-grid">
                                ${especialidadOptions}
                            </div>
                            
                            <div id="especialidad-confirm-area" style="display: none; margin-top: 1.5rem;">
                                <p style="text-align: center; font-weight: 600; margin-bottom: 1rem;">
                                    Has seleccionado: <span id="selected-esp-name" style="color: var(--primary);"></span>
                                </p>
                                <button class="btn" onclick="app.confirmEspecialidad()" style="width: 100%;">
                                    ‚úÖ Confirmar Especialidad
                                </button>
                                ${isChange ? `
                                <button class="btn btn-outline" onclick="app.closeEspecialidadModal()" style="width: 100%; margin-top: 0.5rem;">
                                    ‚ùå Cancelar
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Insertar modal en el body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },
            
            selectEspecialidadOption: (especialidadId) => {
                // Quitar selecci√≥n anterior
                document.querySelectorAll('.especialidad-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Seleccionar la nueva
                const selected = document.querySelector(`.especialidad-option[data-id="${especialidadId}"]`);
                if (selected) {
                    selected.classList.add('selected');
                }
                
                // Guardar temporalmente y mostrar confirmaci√≥n
                app._tempSelectedEspecialidad = especialidadId;
                const confirmArea = document.getElementById('especialidad-confirm-area');
                const espName = document.getElementById('selected-esp-name');
                if (confirmArea && espName) {
                    espName.textContent = CONFIG.especialidades[especialidadId];
                    confirmArea.style.display = 'block';
                }
            },
            
            confirmEspecialidad: async () => {
                if (!app._tempSelectedEspecialidad) return;
                
                // Guardar el valor antes de cerrar el modal (que lo resetea)
                const selectedEspecialidad = app._tempSelectedEspecialidad;
                
                app.closeEspecialidadModal();
                app.showLoading('Cargando asignaturas de especialidad...');
                
                await app.saveUserEspecialidad(selectedEspecialidad);
                app.currentTema = 'all';
                app.savePreferences();
                
                app.showToast(`‚úÖ Especialidad configurada: ${CONFIG.especialidades[selectedEspecialidad]}`);
                app.navigate('home');
            },
            
            closeEspecialidadModal: () => {
                const modal = document.getElementById('especialidad-modal');
                if (modal) {
                    modal.remove();
                }
                app._tempSelectedEspecialidad = null;
            },
            
            promptChangeEspecialidad: () => {
                const currentName = CONFIG.especialidades[app.userEspecialidad] || 'No configurada';
                
                const confirmHtml = `
                    <div id="change-esp-confirm" class="modal-overlay">
                        <div class="modal-content" style="max-width: 400px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                                <h3 style="margin: 0 0 1rem 0;">¬øCambiar especialidad?</h3>
                                <p class="text-muted">
                                    Tu especialidad actual es:<br>
                                    <strong style="color: var(--primary);">${currentName}</strong>
                                </p>
                                <p style="font-size: 0.9rem; color: var(--error); margin-top: 1rem;">
                                    ‚ö†Ô∏è Si cambias de especialidad, aseg√∫rate de que las preguntas que contribuyas correspondan a la nueva especialidad.
                                </p>
                                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                                    <button class="btn btn-outline" onclick="document.getElementById('change-esp-confirm').remove()" style="flex: 1;">
                                        Cancelar
                                    </button>
                                    <button class="btn" onclick="document.getElementById('change-esp-confirm').remove(); app.showEspecialidadModal(true);" style="flex: 1;">
                                        S√≠, cambiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', confirmHtml);
            },

            showHelp: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            },
            
            hideHelp: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            },
            
            showHelpTab: (tabId) => {
                // Ocultar todos los contenidos
                document.querySelectorAll('.help-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Remover clase active de todas las pesta√±as
                document.querySelectorAll('.help-tab').forEach(tab => {
                    tab.style.color = 'var(--text-secondary)';
                    tab.style.borderBottomColor = 'transparent';
                });
                
                // Mostrar contenido seleccionado
                const content = document.getElementById(`help-content-${tabId}`);
                if (content) {
                    content.style.display = 'block';
                }
                
                // Activar pesta√±a seleccionada
                const tab = document.getElementById(`help-tab-${tabId}`);
                if (tab) {
                    tab.style.color = 'var(--primary)';
                    tab.style.borderBottomColor = 'var(--primary)';
                }
            },
            
            initHelpModal: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    // Cerrar al hacer click fuera del contenido
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            app.hideHelp();
                        }
                    });
                    // Cerrar con tecla Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.style.display === 'flex') {
                            app.hideHelp();
                        }
                    });
                }
            },
            
            // Gesti√≥n de tama√±o de fuente
            loadFontSize: () => {
                const savedSize = localStorage.getItem('viu_font_size');
                if (savedSize) {
                    app.fontSize = parseInt(savedSize);
                } else {
                    app.fontSize = 100;
                }
                app.applyFontSize();
            },
            
            saveFontSize: (size) => {
                app.fontSize = size;
                localStorage.setItem('viu_font_size', size.toString());
                app.applyFontSize();
            },
            
            applyFontSize: () => {
                document.documentElement.style.fontSize = `${app.fontSize}%`;
            },
            
            // Cargar preguntas marcadas desde localStorage
            loadMarkedQuestions: () => {
                try {
                    const marked = localStorage.getItem('viu_marked_questions');
                    if (marked) {
                        app.markedQuestions = new Set(JSON.parse(marked));
                    }
                } catch (e) {
                    app.markedQuestions = new Set();
                }
            },
            
            // Guardar preguntas marcadas en localStorage
            saveMarkedQuestions: () => {
                try {
                    localStorage.setItem('viu_marked_questions', JSON.stringify([...app.markedQuestions]));
                } catch (e) {
                    console.error('Error guardando preguntas marcadas:', e);
                }
            },
            
            // Alternar marcado de pregunta
            toggleMarkQuestion: (questionId) => {
                if (app.markedQuestions.has(questionId)) {
                    app.markedQuestions.delete(questionId);
                    app.showToast('Pregunta desmarcada ‚≠ê');
                } else {
                    app.markedQuestions.add(questionId);
                    app.showToast('Pregunta marcada como dif√≠cil üîñ');
                }
                app.saveMarkedQuestions();
                app.renderQuiz(document.getElementById('app-container'));
            },
            
            // Limpiar todas las preguntas marcadas
            clearAllMarkedQuestions: () => {
                const count = app.markedQuestions.size;
                if (count === 0) {
                    app.showToast('No hay preguntas marcadas');
                    return;
                }
                if (confirm(`¬øEliminar todas las ${count} preguntas marcadas?`)) {
                    app.markedQuestions.clear();
                    app.saveMarkedQuestions();
                    // Desmarcar el checkbox si estaba marcado
                    app.quizSettings.onlyMarked = false;
                    app.showToast('‚úÖ Todas las preguntas desmarcadas');
                    // Recargar la vista actual para actualizar la UI
                    app.navigate('home');
                }
            },
            
            // ==========================================
            // === SISTEMA DE VOTACI√ìN DE PREGUNTAS ===
            // ==========================================
            
            // Cargar votos del usuario desde localStorage
            loadUserVotes: () => {
                try {
                    const votes = localStorage.getItem('viu_user_votes');
                    if (votes) {
                        app.userVotes = JSON.parse(votes);
                    }
                } catch (e) {
                    app.userVotes = {};
                }
            },
            
            // Guardar votos del usuario en localStorage
            saveUserVotes: () => {
                try {
                    localStorage.setItem('viu_user_votes', JSON.stringify(app.userVotes));
                } catch (e) {
                    console.error('Error guardando votos:', e);
                }
            },
            
            // Votar una pregunta (up/down/null para quitar voto)
            voteQuestion: async (questionId, voteType) => {
                const currentVote = app.userVotes[questionId];
                
                // Si el voto es el mismo, quitar el voto
                if (currentVote === voteType) {
                    voteType = null;
                }
                
                try {
                    // Calcular el cambio en la BD
                    let positiveChange = 0;
                    let negativeChange = 0;
                    
                    // Quitar voto anterior si existe
                    if (currentVote === 'up') positiveChange--;
                    if (currentVote === 'down') negativeChange--;
                    
                    // A√±adir nuevo voto si existe
                    if (voteType === 'up') positiveChange++;
                    if (voteType === 'down') negativeChange++;
                    
                    // Obtener valores actuales de la pregunta
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${questionId}&select=votos_positivos,votos_negativos`, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error obteniendo pregunta');
                    
                    const data = await response.json();
                    if (!data || data.length === 0) throw new Error('Pregunta no encontrada');
                    
                    const currentPositive = data[0].votos_positivos || 0;
                    const currentNegative = data[0].votos_negativos || 0;
                    
                    // Actualizar en la BD
                    const updateResponse = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${questionId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            votos_positivos: Math.max(0, currentPositive + positiveChange),
                            votos_negativos: Math.max(0, currentNegative + negativeChange)
                        })
                    });
                    
                    if (!updateResponse.ok) throw new Error('Error actualizando voto');
                    
                    // Guardar voto del usuario localmente
                    if (voteType) {
                        app.userVotes[questionId] = voteType;
                    } else {
                        delete app.userVotes[questionId];
                    }
                    app.saveUserVotes();
                    
                    // Actualizar UI
                    app.updateVoteUI(questionId, 
                        Math.max(0, currentPositive + positiveChange), 
                        Math.max(0, currentNegative + negativeChange)
                    );
                    
                    // Mostrar feedback
                    if (voteType === 'up') {
                        app.showToast('üëç Pregunta valorada positivamente');
                    } else if (voteType === 'down') {
                        app.showToast('üëé Pregunta valorada negativamente');
                    } else {
                        app.showToast('üîÑ Voto eliminado');
                    }
                    
                    // Limpiar cach√© para refrescar datos
                    localStorage.removeItem(app.CACHE_KEYS.questions);
                    localStorage.removeItem(app.CACHE_KEYS.cacheTime);
                    
                } catch (error) {
                    console.error('Error votando:', error);
                    app.showToast('‚ùå Error al votar');
                }
            },
            
            // Actualizar UI de votos
            updateVoteUI: (questionId, positive, negative) => {
                const voteContainer = document.getElementById(`vote-container-${questionId}`);
                if (voteContainer) {
                    const userVote = app.userVotes[questionId];
                    voteContainer.innerHTML = app.getVoteHTML(questionId, positive, negative, userVote);
                }
            },
            
            // Obtener etiqueta de verificaci√≥n seg√∫n votos
            getVerificationBadge: (positive, negative) => {
                const total = positive + negative;
                
                if (total < 3) {
                    return `<span style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">‚ö™ Sin verificar</span>`;
                }
                
                const ratio = positive / total;
                
                if (ratio >= 0.8 && positive >= 5) {
                    return `<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">‚úÖ Verificada</span>`;
                } else if (ratio >= 0.6) {
                    return `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">üü¢ Probablemente correcta</span>`;
                } else if (ratio <= 0.4) {
                    return `<span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">üî¥ Posible error</span>`;
                } else {
                    return `<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">üü° Dudosa</span>`;
                }
            },
            
            // Generar HTML de votaci√≥n
            getVoteHTML: (questionId, positive, negative, userVote) => {
                positive = positive || 0;
                negative = negative || 0;
                
                // Si el usuario vot√≥ pero el cach√© no refleja su voto, a√±adirlo visualmente
                // Esto asegura que el usuario vea su voto aunque el cach√© no est√© actualizado
                if (userVote === 'up' && positive === 0) {
                    positive = 1;
                }
                if (userVote === 'down' && negative === 0) {
                    negative = 1;
                }
                
                const upActive = userVote === 'up' ? 'background: #dcfce7; border-color: #10b981;' : '';
                const downActive = userVote === 'down' ? 'background: #fee2e2; border-color: #ef4444;' : '';
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        ${app.getVerificationBadge(positive, negative)}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button onclick="app.voteQuestion('${questionId}', 'up')" 
                                    style="display: flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; border: 2px solid #e5e7eb; background: white; cursor: pointer; transition: all 0.2s; ${upActive}"
                                    title="Esta pregunta est√° bien">
                                üëç <span style="font-size: 0.85rem; font-weight: 600; color: #10b981;">${positive}</span>
                            </button>
                            <button onclick="app.voteQuestion('${questionId}', 'down')" 
                                    style="display: flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; border: 2px solid #e5e7eb; background: white; cursor: pointer; transition: all 0.2s; ${downActive}"
                                    title="Esta pregunta tiene un error">
                                üëé <span style="font-size: 0.85rem; font-weight: 600; color: #ef4444;">${negative}</span>
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // Cargar notas de preguntas desde localStorage
            loadQuestionNotes: () => {
                try {
                    const notes = localStorage.getItem('viu_question_notes');
                    if (notes) {
                        app.questionNotes = JSON.parse(notes);
                    }
                } catch (e) {
                    app.questionNotes = {};
                }
            },
            
            // Guardar notas de preguntas en localStorage
            saveQuestionNotes: () => {
                try {
                    localStorage.setItem('viu_question_notes', JSON.stringify(app.questionNotes));
                } catch (e) {
                    console.error('Error guardando notas:', e);
                }
            },
            
            // Guardar/actualizar nota de una pregunta
            saveQuestionNote: (questionId, note) => {
                if (note && note.trim()) {
                    app.questionNotes[questionId] = note.trim();
                } else {
                    delete app.questionNotes[questionId];
                }
                app.saveQuestionNotes();
            },
            
            // Cargar contribuciones del usuario
            loadContributions: () => {
                try {
                    const contributions = localStorage.getItem('viu_user_contributions');
                    if (contributions) {
                        app.userContributions = JSON.parse(contributions);
                    }
                } catch (e) {
                    app.userContributions = [];
                }
            },
            
            // Guardar contribuciones del usuario
            saveContributions: () => {
                try {
                    localStorage.setItem('viu_user_contributions', JSON.stringify(app.userContributions));
                } catch (e) {
                    console.error('Error guardando contribuciones:', e);
                }
            },
            
            // Cargar estado de contribuci√≥n
            loadContribState: () => {
                try {
                    const state = localStorage.getItem('viu_contrib_state');
                    if (state) {
                        app.contribState = JSON.parse(state);
                    }
                } catch (e) {
                    app.contribState = { especialidad: '', asignatura: '', tema: '' };
                }
            },
            
            // Guardar estado de contribuci√≥n
            saveContribState: () => {
                try {
                    localStorage.setItem('viu_contrib_state', JSON.stringify(app.contribState));
                } catch (e) {
                    console.error('Error guardando estado de contribuci√≥n:', e);
                }
            },
            
            // Cargar historial de preguntas falladas
            loadFailedHistory: () => {
                try {
                    const failed = localStorage.getItem('viu_failed_questions');
                    if (failed) {
                        app.failedQuestionsHistory = JSON.parse(failed);
                    }
                } catch (e) {
                    console.error('Error cargando historial de fallos:', e);
                    app.failedQuestionsHistory = [];
                }
            },
            
            // Guardar historial de preguntas falladas
            saveFailedHistory: () => {
                try {
                    localStorage.setItem('viu_failed_questions', JSON.stringify(app.failedQuestionsHistory));
                } catch (e) {
                    console.error('Error guardando historial de fallos:', e);
                }
            },
            
            // ==========================================
            // === FUNCIONES RESTDB.IO ===
            // ==========================================
            
            // Obtener o crear ID √∫nico del usuario
            getUserId: () => {
                if (app.userId) return app.userId;
                let stored = localStorage.getItem('viu_user_id');
                if (!stored) {
                    stored = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('viu_user_id', stored);
                }
                app.userId = stored;
                return stored;
            },
            
            // Refrescar cache de preguntas manualmente
            refreshDbCache: async () => {
                try {
                    const url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*&or=(aprobada.is.null,aprobada.eq.true)&limit=1000`;
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (response.status === 429) {
                        app.showToast('‚ö†Ô∏è L√≠mite de BD alcanzado. Intenta m√°s tarde.');
                        return false;
                    }
                    
                    if (response.ok) {
                        const questions = await response.json();
                        localStorage.setItem(app.CACHE_KEYS.questions, JSON.stringify(questions));
                        localStorage.setItem(app.CACHE_KEYS.cacheTime, Date.now().toString());
                        console.log('‚úÖ Cache actualizado:', questions.length, 'preguntas');
                        return true;
                    }
                } catch (error) {
                    console.error('Error actualizando cache:', error);
                    app.showToast('‚ùå Error actualizando preguntas');
                }
                return false;
            },
            
            // Cargar preguntas de la base de datos (SIEMPRE usa cache si existe, solo descarga si expira)
            loadDbQuestions: async (especialidad = '', asignatura = '') => {
                // Usar cache global
                const cachedData = localStorage.getItem(app.CACHE_KEYS.questions);
                const cacheTime = localStorage.getItem(app.CACHE_KEYS.cacheTime);
                const now = Date.now();
                
                // Si hay cache v√°lido (menos de 24h), filtrar desde cache
                if (cachedData && cacheTime && (now - parseInt(cacheTime)) < app.CACHE_DURATION) {
                    try {
                        let allQuestions = JSON.parse(cachedData);
                        // Nunca devolver preguntas desactivadas
                        allQuestions = allQuestions.filter(q => q.aprobada !== false);
                        // Filtrar por especialidad y asignatura si se especifica
                        // IMPORTANTE: Incluir tambi√©n preguntas sin especialidad (obligatorias/comunes)
                        if (especialidad) {
                            allQuestions = allQuestions.filter(q => q.especialidad === especialidad || q.especialidad === '' || !q.especialidad);
                        }
                        if (asignatura) {
                            allQuestions = allQuestions.filter(q => q.asignatura === asignatura);
                        }
                        console.log(`üì¶ Usando cache local: ${allQuestions.length} preguntas (no se hizo petici√≥n al servidor)`);
                        return allQuestions;
                    } catch (e) {
                        console.warn('Error parseando cache:', e);
                    }
                }
                
                // Si no hay cache, cargar de la BD
                try {
                    let url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*`;
                    const andParts = [];
                    // Excluir desactivadas
                    andParts.push('or(aprobada.is.null,aprobada.eq.true)');
                    
                    // Construir filtros Supabase
                    // Para especialidad, usar OR para incluir preguntas comunes (especialidad vac√≠a)
                    if (especialidad) {
                        andParts.push(`or(especialidad.eq.${especialidad},especialidad.eq.,especialidad.is.null)`);
                    }
                    if (andParts.length) {
                        url += `&and=(${andParts.join(',')})`;
                    }
                    if (asignatura) {
                        url += `&asignatura=eq.${asignatura}`;
                    }
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (response.status === 429) {
                        console.warn('‚ö†Ô∏è L√≠mite de peticiones (429)');
                        app.showToast('‚ö†Ô∏è L√≠mite de BD alcanzado. Espera unos minutos.');
                        return [];
                    }
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    app.dbQuestions = data;
                    app.dbQuestionsLoaded = true;
                    console.log(`‚úÖ Cargadas ${data.length} preguntas de la BD`);
                    return data;
                } catch (error) {
                    console.error('Error cargando preguntas de BD:', error);
                    app.showToast('‚ö†Ô∏è Error conectando con la base de datos');
                    return [];
                }
            },
            
            // Guardar pregunta en la base de datos
            saveQuestionToDb: async (questionData) => {
                try {
                    console.log('üíæ Guardando pregunta en BD...');
                    console.log('üì¶ Datos:', questionData);
                    
                    // Convertir opciones a JSONB si es string
                    const dataToSave = {
                        ...questionData,
                        opciones: typeof questionData.opciones === 'string' 
                            ? JSON.parse(questionData.opciones) 
                            : questionData.opciones
                    };
                    
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(dataToSave)
                    });
                    
                    console.log('üì¨ Response status:', response.status);
                    
                    if (response.status === 429) {
                        app.showToast('‚ö†Ô∏è L√≠mite de BD alcanzado. Espera unos minutos.');
                        throw new Error('Rate limit exceeded');
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const saved = await response.json();
                    console.log('‚úÖ Pregunta guardada en BD:', saved[0]?.id || saved.id);
                    
                    // Limpiar cache para que se recargue con la nueva pregunta
                    localStorage.removeItem(app.CACHE_KEYS.questions);
                    localStorage.removeItem(app.CACHE_KEYS.cacheTime);
                    
                    return saved;
                } catch (error) {
                    console.error('Error guardando pregunta:', error);
                    throw error;
                }
            },
            
            // Desactivar pregunta en la base de datos (opci√≥n A: no se borra desde usuario)
            // Nota: Para que esto sea realmente seguro contra abuso, debe protegerse con RLS + Auth o v√≠a Edge Function.
            deleteQuestionFromDb: async (questionId) => {
                try {
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${questionId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({ aprobada: false })
                    });
                    
                    if (response.status === 429) {
                        app.showToast('‚ö†Ô∏è L√≠mite de BD alcanzado. Espera unos minutos.');
                        throw new Error('Rate limit exceeded');
                    }
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    // Limpiar cache
                    localStorage.removeItem(app.CACHE_KEYS.questions);
                    localStorage.removeItem(app.CACHE_KEYS.cacheTime);
                    
                    // Eliminar de arrays locales para evitar preguntas fantasma
                    app.filteredQuestions = app.filteredQuestions.filter(q => q.id !== questionId);
                    
                    // Eliminar de preguntas marcadas (es un Set)
                    app.markedQuestions.delete(questionId);
                    app.saveMarkedQuestions();
                    
                    // Eliminar del historial de falladas (es un array de objetos)
                    app.failedQuestionsHistory = app.failedQuestionsHistory.filter(q => q.id !== questionId);
                    app.saveFailedHistory();
                    
                    console.log('üö´ Pregunta desactivada en BD:', questionId);
                    return true;
                } catch (error) {
                    console.error('Error eliminando pregunta:', error);
                    throw error;
                }
            },
            
            // Convertir preguntas de BD a formato del sistema
            convertDbQuestionsToFormat: (dbQuestions) => {
                const byTema = {};
                dbQuestions.forEach(q => {
                    const tema = q.tema || 1;
                    if (!byTema[tema]) {
                        byTema[tema] = {
                            numero: tema,
                            nombre: `Tema ${tema}`,
                            preguntas: []
                        };
                    }
                    
                    // Parsear opciones si es string JSON
                    let opciones = q.opciones;
                    if (typeof opciones === 'string') {
                        try {
                            opciones = JSON.parse(opciones);
                        } catch (e) {
                            opciones = [opciones];
                        }
                    }
                    
                    byTema[tema].preguntas.push({
                        id: q.id,
                        pregunta: q.pregunta,
                        opciones: opciones,
                        respuesta_correcta: q.respuesta_correcta,
                        autor: q.autor,
                        fromDb: true
                    });
                });
                
                return Object.values(byTema).sort((a, b) => a.numero - b.numero);
            },
            
            // Obtener preguntas combinadas (JSON local + BD)
            getCombinedQuestions: async (asignaturaId, especialidadId = '') => {
                // AHORA SOLO USAMOS PREGUNTAS DE LA BASE DE DATOS
                // Los archivos JSON ya no se usan para los tests
                
                // Detectar si es asignatura obligatoria (no filtrar por especialidad)
                const asignaturaInfo = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                const esObligatoria = asignaturaInfo && asignaturaInfo.tipo === 'obligatoria';
                const especialidadFiltro = esObligatoria ? '' : especialidadId;
                
                // Cargar preguntas de la BD para esta asignatura
                const dbQuestions = await app.loadDbQuestions(especialidadFiltro, asignaturaId);
                const dbTemas = app.convertDbQuestionsToFormat(dbQuestions);
                
                // Ordenar temas por n√∫mero
                dbTemas.sort((a, b) => a.numero - b.numero);
                
                // Buscar nombre de asignatura
                const localData = app.loadedData[asignaturaId];
                const asignaturaNombre = localData?.nombre || asignaturaId;
                
                return {
                    id: asignaturaId,
                    nombre: asignaturaNombre,
                    temas: dbTemas,
                    totalDbQuestions: dbQuestions.length
                };
            },
            
            // ==========================================
            // === FIN FUNCIONES RESTDB.IO ===
            // ==========================================
            
            // A√±adir nueva contribuci√≥n
            addContribution: (contribution) => {
                contribution.id = 'contrib_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                contribution.timestamp = new Date().toISOString();
                app.userContributions.push(contribution);
                app.saveContributions();
                app.showToast('‚úÖ Pregunta a√±adida a tus contribuciones');
            },
            
            // Editar contribuci√≥n
            editContribution: (id) => {
                const contrib = app.userContributions.find(c => c.id === id);
                if (!contrib) return;
                
                // Guardar ID de contribuci√≥n que se est√° editando
                app.editingContribId = id;
                
                // Restaurar estado de la contribuci√≥n
                app.contribState.especialidad = '';
                app.contribState.asignatura = contrib.asignaturaId;
                app.contribState.tema = contrib.tema;
                
                // Detectar si es de especialidad
                const parts = contrib.asignaturaId.split('-');
                if (parts.length > 2) {
                    app.contribState.especialidad = parts[0] + '-' + parts[1];
                }
                
                // Navegar a la vista de contribuir
                app.navigate('contribute');
                
                // Esperar a que se renderice y luego cargar los datos
                setTimeout(async () => {
                    // Seleccionar asignatura
                    const asigSelect = document.getElementById('contrib-asignatura');
                    if (asigSelect) {
                        asigSelect.value = contrib.asignaturaId;
                    }
                    
                    // Iniciar el formulario de contribuci√≥n
                    app.startContributing();
                    
                    // Cargar los datos de la contribuci√≥n en el formulario
                    setTimeout(() => {
                        document.getElementById('contrib-tema').value = contrib.tema;
                        document.getElementById('contrib-question').value = contrib.question;
                        document.getElementById('contrib-option-1').value = contrib.options[0];
                        document.getElementById('contrib-option-2').value = contrib.options[1];
                        document.getElementById('contrib-option-3').value = contrib.options[2];
                        document.getElementById('contrib-option-4').value = contrib.options[3];
                        
                        // Seleccionar la respuesta correcta
                        const correctIdx = contrib.options.indexOf(contrib.answer) + 1;
                        document.getElementById('contrib-correct').value = correctIdx;
                        
                        // Cambiar el bot√≥n de enviar
                        const submitBtn = document.querySelector('#contrib-form-area button[onclick="app.submitContribution()"]');
                        if (submitBtn) {
                            submitBtn.innerHTML = 'üíæ Guardar Cambios';
                            submitBtn.style.background = '#3b82f6';
                        }
                        
                        app.showToast('‚úèÔ∏è Editando contribuci√≥n');
                    }, 100);
                }, 200);
            },
            
            // Eliminar contribuci√≥n
            deleteContribution: (id) => {
                if (confirm('¬øEliminar esta contribuci√≥n?')) {
                    app.userContributions = app.userContributions.filter(c => c.id !== id);
                    app.saveContributions();
                    app.showToast('üóëÔ∏è Contribuci√≥n eliminada');
                    // Solo actualizar la lista, no recargar toda la vista
                    app.renderContributionsList();
                }
            },
            
            // Limpiar todas las contribuciones
            clearAllContributions: () => {
                if (confirm(`¬øEliminar todas las ${app.userContributions.length} contribuciones?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                    app.userContributions = [];
                    app.saveContributions();
                    app.showToast('‚úÖ Todas las contribuciones eliminadas');
                    // Solo actualizar la lista, no recargar toda la vista
                    app.renderContributionsList();
                }
            },
            
            // Exportar contribuciones como JSON
            exportContributions: () => {
                if (app.userContributions.length === 0) {
                    app.showToast('‚ö†Ô∏è No hay contribuciones para exportar');
                    return;
                }
                
                // Reparar contribuciones antiguas que no tienen baseFileName
                const repairedContributions = app.userContributions.map(contrib => {
                    if (!contrib.baseFileName) {
                        // Intentar encontrar la asignatura para obtener el baseFileName
                        const asignatura = app.asignaturasDisponibles.find(a => a.id === contrib.asignaturaId);
                        if (asignatura && asignatura.archivo) {
                            contrib.baseFileName = asignatura.archivo.split('/').pop().replace('.json', '');
                        } else {
                            // Fallback: intentar derivarlo del asignaturaId
                            // Si tiene prefijo de especialidad (3+ partes), quitar las primeras 2
                            const parts = contrib.asignaturaId.split('-');
                            contrib.baseFileName = parts.length > 3 ? parts.slice(2).join('-') : contrib.asignaturaId;
                        }
                    }
                    return contrib;
                });
                
                const dataStr = JSON.stringify(repairedContributions, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `contribuciones_viu_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                // Guardar las contribuciones reparadas
                app.userContributions = repairedContributions;
                app.saveContributions();
                
                app.showToast('üì• Archivo descargado. Las contribuciones se mantienen guardadas.');
            },
            
            // Configurar atajos de teclado
            setupKeyboardShortcuts: () => {
                document.addEventListener('keydown', (e) => {
                    // Solo en vista de quiz
                    if (!window.location.hash.includes('quiz') && app.quiz.index >= 0) {
                        const container = document.getElementById('app-container');
                        if (!container || !container.querySelector('.option-btn')) return;
                    }
                    
                    // Si est√° escribiendo en un input/textarea, ignorar
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    // N√∫meros 1-4 para seleccionar opciones
                    if (['1', '2', '3', '4'].includes(e.key)) {
                        const index = parseInt(e.key) - 1;
                        const buttons = document.querySelectorAll('.option-btn');
                        if (buttons[index] && !buttons[index].disabled && !app.quiz.answered) {
                            e.preventDefault();
                            buttons[index].click();
                        }
                    }
                    
                    // Enter para siguiente
                    if (e.key === 'Enter') {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn && !nextBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            nextBtn.click();
                        }
                    }
                    
                    // Flechas para navegar
                    if (e.key === 'ArrowLeft') {
                        const prevBtn = document.querySelector('button[onclick="app.previousQuestion()"]');
                        if (prevBtn) {
                            e.preventDefault();
                            prevBtn.click();
                        }
                    }
                    
                    if (e.key === 'ArrowRight') {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn && !nextBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            nextBtn.click();
                        }
                    }
                });
            },
            
            // Cargar historial de tests
            loadTestHistory: () => {
                try {
                    const history = localStorage.getItem('viu_test_history');
                    if (history) {
                        app.testHistory = JSON.parse(history);
                    }
                } catch (e) {
                    app.testHistory = [];
                }
            },
            
            // Guardar historial de tests
            saveTestHistory: () => {
                try {
                    localStorage.setItem('viu_test_history', JSON.stringify(app.testHistory));
                } catch (e) {
                    console.error('Error guardando historial:', e);
                }
            },
            
            // Cargar estad√≠sticas
            loadStats: () => {
                try {
                    const stats = localStorage.getItem('viu_stats');
                    if (stats) {
                        app.stats = JSON.parse(stats);
                    }
                } catch (e) {
                    app.stats = {};
                }
            },
            
            // Guardar estad√≠sticas
            saveStats: () => {
                try {
                    localStorage.setItem('viu_stats', JSON.stringify(app.stats));
                } catch (e) {
                    console.error('Error guardando estad√≠sticas:', e);
                }
            },
            
            // Cargar preferencias del usuario
            loadPreferences: () => {
                try {
                    const prefs = localStorage.getItem('viu_preferences');
                    if (prefs) {
                        const saved = JSON.parse(prefs);
                        app.savedPreferences = saved;
                    }
                } catch (e) {
                    app.savedPreferences = null;
                }
            },
            
            // Guardar preferencias del usuario
            savePreferences: () => {
                try {
                    const prefs = {
                        lastAsignatura: app.currentAsignatura ? app.currentAsignatura.id : null,
                        lastEspecialidad: app.currentEspecialidad,
                        lastTema: app.currentTema,
                        randomOrder: app.quizSettings.randomOrder,
                        onlyMarked: app.quizSettings.onlyMarked,
                        // Filtros de tipo de pregunta
                        includeTest: app.quizSettings.includeTest,
                        includeAI: app.quizSettings.includeAI,
                        includeDesarrollo: app.quizSettings.includeDesarrollo
                    };
                    localStorage.setItem('viu_preferences', JSON.stringify(prefs));
                } catch (e) {
                    console.error('Error guardando preferencias:', e);
                }
            },
            
            // Registrar test completado
            recordTestCompletion: (score, total, asignatura, tema) => {
                const percentage = Math.round((score / total) * 100);
                const testRecord = {
                    date: new Date().toISOString(),
                    asignatura: asignatura,
                    tema: tema || 'Todos',
                    score: score,
                    total: total,
                    percentage: percentage
                };
                
                // A√±adir al historial
                app.testHistory.unshift(testRecord);
                // Mantener solo los √∫ltimos 50 tests
                if (app.testHistory.length > 50) {
                    app.testHistory = app.testHistory.slice(0, 50);
                }
                app.saveTestHistory();
                
                // Guardar preguntas falladas en el historial
                if (app.quiz.failedQuestions && app.quiz.failedQuestions.length > 0) {
                    app.quiz.failedQuestions.forEach(q => {
                        // Buscar si ya existe en el historial
                        const existing = app.failedQuestionsHistory.find(fq => fq.id === q.id && fq.subject === q.subject);
                        if (existing) {
                            existing.failCount = (existing.failCount || 1) + 1;
                            existing.lastFailed = new Date().toISOString();
                        } else {
                            app.failedQuestionsHistory.push({
                                ...q,
                                failCount: 1,
                                lastFailed: new Date().toISOString()
                            });
                        }
                    });
                    // Mantener solo las √∫ltimas 200 preguntas falladas
                    if (app.failedQuestionsHistory.length > 200) {
                        app.failedQuestionsHistory = app.failedQuestionsHistory.slice(0, 200);
                    }
                    app.saveFailedHistory();
                }
                
                // Actualizar estad√≠sticas por asignatura
                if (!app.stats[asignatura]) {
                    app.stats[asignatura] = {
                        totalTests: 0,
                        totalQuestions: 0,
                        correctAnswers: 0,
                        lastTest: null
                    };
                }
                
                app.stats[asignatura].totalTests++;
                app.stats[asignatura].totalQuestions += total;
                app.stats[asignatura].correctAnswers += score;
                app.stats[asignatura].lastTest = testRecord.date;
                app.saveStats();
            },

            // Cargar datos iniciales
            loadInitialData: async () => {
                try {
                    // Intentar cargar todas las asignaturas obligatorias
                for (const asig of CONFIG.asignaturas.obligatorias) {
                    try {
                        const response = await fetch(`data/asignaturas/${asig.archivo}?t=${Date.now()}`);
                        if (response.ok) {
                            const data = await response.json();
                            app.loadedData[asig.id] = data;
                        }
                    } catch (error) {
                        console.warn(`No se pudo cargar ${asig.nombre}`);
                    }
                }                    // Intentar cargar optativas comunes
                for (const asig of CONFIG.asignaturas.optativas) {
                    try {
                        const response = await fetch(`data/asignaturas/${asig.archivo}?t=${Date.now()}`);
                        if (response.ok) {
                            const data = await response.json();
                            app.loadedData[asig.id] = data;
                        }
                    } catch (error) {
                        console.warn(`No se pudo cargar ${asig.nombre}`);
                    }
                }                    app.updateAvailableSubjects();
                } catch (error) {
                    console.error('Error cargando datos:', error);
                }
            },
            
            // Cargar asignaturas de especialidad
            loadEspecialidadData: async (especialidadId) => {
                const especialidadPath = `data/asignaturas/especialidades/${especialidadId}`;
                const asignaturasEsp = especialidadId === 'orientacion-educativa' 
                    ? CONFIG.asignaturas.especialidadOrientacion 
                    : CONFIG.asignaturas.especialidad;
                
                for (const asig of asignaturasEsp) {
                    const key = `${especialidadId}-${asig.id}`;
                    if (!app.loadedData[key]) {
                        try {
                            const url = `${especialidadPath}/${asig.archivo}?t=${Date.now()}`;
                            const response = await fetch(url);
                            if (response.ok) {
                                const data = await response.json();
                                app.loadedData[key] = data;
                            }
                        } catch (error) {
                            console.warn(`No se pudo cargar ${asig.nombre} de ${especialidadId}`);
                        }
                    }
                }
                app.updateAvailableSubjects();
            },
            
            // Actualizar lista de asignaturas disponibles
            updateAvailableSubjects: () => {
                app.asignaturasDisponibles = [];
                
                // Obligatorias
                CONFIG.asignaturas.obligatorias.forEach(asig => {
                    if (app.loadedData[asig.id]) {
                        app.asignaturasDisponibles.push({
                            id: asig.id,
                            nombre: asig.nombre,
                            tipo: 'obligatoria',
                            archivo: asig.archivo,
                            data: app.loadedData[asig.id]
                        });
                    }
                });
                
                // Optativas
                CONFIG.asignaturas.optativas.forEach(asig => {
                    if (app.loadedData[asig.id]) {
                        app.asignaturasDisponibles.push({
                            id: asig.id,
                            nombre: asig.nombre,
                            tipo: 'optativa',
                            archivo: asig.archivo,
                            data: app.loadedData[asig.id]
                        });
                    }
                });
                
                // Especialidad seleccionada
                if (app.currentEspecialidad) {
                    const asignaturasEsp = app.currentEspecialidad === 'orientacion-educativa' 
                        ? CONFIG.asignaturas.especialidadOrientacion 
                        : CONFIG.asignaturas.especialidad;
                    
                    asignaturasEsp.forEach(asig => {
                        const key = `${app.currentEspecialidad}-${asig.id}`;
                        if (app.loadedData[key]) {
                            app.asignaturasDisponibles.push({
                                id: key,
                                nombre: asig.nombre,
                                tipo: 'especialidad',
                                especialidad: CONFIG.especialidades[app.currentEspecialidad],
                                archivo: asig.archivo,
                                baseId: asig.id,
                                data: app.loadedData[key]
                            });
                        }
                    });
                }
                
                // Seleccionar primera asignatura con preguntas si no hay ninguna seleccionada
                if (!app.currentAsignatura && app.asignaturasDisponibles.length > 0) {
                    const firstWithQuestions = app.asignaturasDisponibles.find(a => 
                        a.data.temas && a.data.temas.some(t => t.preguntas && t.preguntas.length > 0)
                    );
                    if (firstWithQuestions) {
                        app.selectAsignatura(firstWithQuestions.id);
                    }
                }
            },
            
            // Seleccionar asignatura
            selectAsignatura: async (asigId) => {
                const asig = app.asignaturasDisponibles.find(a => a.id === asigId);
                if (asig) {
                    app.currentAsignatura = asig;
                    await app.updateQuestionsFromAsignatura();
                }
            },
            
            // Actualizar preguntas desde la asignatura actual (incluyendo BD)
            updateQuestionsFromAsignatura: async () => {
                if (!app.currentAsignatura) {
                    app.filteredQuestions = [];
                    return;
                }
                
                app.filteredQuestions = [];
                
                // SOLO cargar preguntas de la BD (ya no usamos JSON locales)
                try {
                    // Para asignaturas obligatorias, no filtrar por especialidad (son comunes a todas)
                    const esObligatoria = app.currentAsignatura.tipo === 'obligatoria';
                    const especialidadFiltro = esObligatoria ? '' : app.currentEspecialidad;
                    const dbQuestions = await app.loadDbQuestions(especialidadFiltro, app.currentAsignatura.id);
                    dbQuestions.forEach(q => {
                        let opciones = q.opciones;
                        if (typeof opciones === 'string') {
                            try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                        }
                        
                        app.filteredQuestions.push({
                            id: q.id,
                            subject: q.asignatura_nombre || app.currentAsignatura.nombre,
                            unit: q.tema,
                            question: q.pregunta,
                            options: opciones,
                            answer: q.respuesta_correcta,
                            fromDb: true,
                            autor: q.autor,
                            votos_positivos: q.votos_positivos || 0,
                            votos_negativos: q.votos_negativos || 0,
                            // Nuevos campos para tipo de pregunta
                            is_ai: q.is_ai === true,
                            tipo: q.tipo || 'test' // 'test' o 'desarrollo'
                        });
                    });
                    
                    console.log(`üìö Cargadas ${dbQuestions.length} preguntas de la BD`);
                } catch (error) {
                    console.warn('No se pudieron cargar preguntas de la BD:', error);
                }
            },

            // Aplicar filtro de tema espec√≠fico (incluyendo BD)
            applyTemaFilter: async (temaNum) => {
                if (!app.currentAsignatura || temaNum === 'all') {
                    await app.updateQuestionsFromAsignatura();
                    return;
                }
                
                app.filteredQuestions = [];
                
                // Para asignaturas obligatorias, no filtrar por especialidad (son comunes a todas)
                const esObligatoria = app.currentAsignatura.tipo === 'obligatoria';
                const especialidadFiltro = esObligatoria ? '' : app.currentEspecialidad;
                
                // Primero intentar usar el cach√© local
                const cachedData = localStorage.getItem(app.CACHE_KEYS.questions);
                const cacheTime = localStorage.getItem(app.CACHE_KEYS.cacheTime);
                const now = Date.now();
                
                if (cachedData && cacheTime && (now - parseInt(cacheTime)) < app.CACHE_DURATION) {
                    try {
                        let allQuestions = JSON.parse(cachedData);
                        
                        // Filtrar por asignatura
                        allQuestions = allQuestions.filter(q => q.asignatura === app.currentAsignatura.id);
                        
                        // Filtrar por tema
                        allQuestions = allQuestions.filter(q => q.tema === parseInt(temaNum));
                        
                        // Filtrar por especialidad solo si NO es obligatoria
                        if (!esObligatoria && especialidadFiltro) {
                            allQuestions = allQuestions.filter(q => 
                                q.especialidad === especialidadFiltro || 
                                q.especialidad === '' || 
                                !q.especialidad
                            );
                        }
                        
                        allQuestions.forEach(q => {
                            let opciones = q.opciones;
                            if (typeof opciones === 'string') {
                                try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                            }
                            
                            app.filteredQuestions.push({
                                id: q.id,
                                subject: q.asignatura_nombre || app.currentAsignatura.nombre,
                                unit: q.tema,
                                question: q.pregunta,
                                options: opciones,
                                answer: q.respuesta_correcta,
                                fromDb: true,
                                autor: q.autor,
                                votos_positivos: q.votos_positivos || 0,
                                votos_negativos: q.votos_negativos || 0,
                                is_ai: q.is_ai === true,
                                tipo: q.tipo || 'test'
                            });
                        });
                        
                        console.log(`üì¶ Tema ${temaNum}: ${app.filteredQuestions.length} preguntas desde cach√©`);
                        return;
                    } catch (e) {
                        console.warn('Error parseando cache en applyTemaFilter:', e);
                    }
                }
                
                // Si no hay cach√©, cargar de la BD
                try {
                    let url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*&asignatura=eq.${app.currentAsignatura.id}&tema=eq.${parseInt(temaNum)}`;
                    
                    // Solo filtrar por especialidad para asignaturas de especialidad
                    if (!esObligatoria && especialidadFiltro) {
                        url += `&or=(especialidad.eq.${especialidadFiltro},especialidad.eq.,especialidad.is.null)`;
                    }
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (response.ok) {
                        const dbQuestions = await response.json();
                        dbQuestions.forEach(q => {
                            let opciones = q.opciones;
                            if (typeof opciones === 'string') {
                                try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                            }
                            
                            app.filteredQuestions.push({
                                id: q.id,
                                subject: q.asignatura_nombre || app.currentAsignatura.nombre,
                                unit: q.tema,
                                question: q.pregunta,
                                options: opciones,
                                answer: q.respuesta_correcta,
                                fromDb: true,
                                autor: q.autor,
                                votos_positivos: q.votos_positivos || 0,
                                votos_negativos: q.votos_negativos || 0,
                                is_ai: q.is_ai === true,
                                tipo: q.tipo || 'test'
                            });
                        });
                    }
                } catch (error) {
                    console.warn('No se pudieron cargar preguntas de la BD:', error);
                }
            },
            
            showLoading: (message = 'Cargando...') => {
                const container = document.getElementById('app-container');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-box">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                            <p>${message}</p>
                        </div>
                    `;
                }
            },
            
            // Navegaci√≥n
            navigate: async (viewId, param = null) => {
                // Cerrar dropdown si est√° abierto
                app.closeDropdown();
                
                // Guardar vista actual
                localStorage.setItem('viu_current_view', viewId);
                
                // Actualizar men√∫
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                
                // Limpiar estado de b√∫squeda si no vamos a la vista de b√∫squeda o detalle
                if (viewId !== 'search' && viewId !== 'detail') {
                    app.searchState = { term: '', resultsHTML: '' };
                }

                // L√≥gica segura para encontrar el bot√≥n activo
                let activeBtn = null;
                try {
                    // Si navegamos a 'detail', el bot√≥n activo sigue siendo 'search'
                    const targetView = viewId === 'detail' ? 'search' : viewId;
                    
                    // Para vistas de test (quiz, exam-mode, review-mode), no marcar ning√∫n bot√≥n principal como activo
                    if (['quiz', 'exam-mode', 'review-mode'].includes(viewId)) {
                        // No marcar ninguno
                    } else {
                        activeBtn = document.querySelector(`button[onclick="app.navigate('${targetView}')"]`);
                    }
                } catch(e) { /* Bot√≥n no encontrado */ }

                if (activeBtn) activeBtn.classList.add('active');

                const container = document.getElementById('app-container');
                container.innerHTML = '';

                switch(viewId) {
                    case 'home': await app.renderHome(container); break;
                    case 'quiz': app.renderQuiz(container); break;
                    case 'exam-mode': app.renderExamMode(container); break;
                    case 'review-mode': await app.renderReviewMode(container); break;
                    case 'summary': await app.renderSummary(container); break;
                    case 'stats': await app.renderStatsPage(container); break;
                    case 'stats-advanced': app.renderAdvancedStats(container); break;
                    case 'search': app.renderSearch(container); break;
                    case 'detail': app.renderDetail(container, param); break;
                    case 'history': app.renderHistory(container); break;
                    case 'contribute': app.renderContribute(container); break;
                    case 'admin': app.renderAdmin(container); break;
                    default: await app.renderHome(container);
                }
            },

            // --- VISTAS ---
            renderHome: async (container) => {
                // Mostrar loading mientras cargamos datos de BD
                container.innerHTML = '<div class="loading-box"><p>‚è≥ Cargando preguntas...</p></div>';
                
                // Usar cache si existe y no es muy antiguo (24 horas)
                let allDbQuestions = [];
                const cachedData = localStorage.getItem(app.CACHE_KEYS.questions);
                const cacheTime = localStorage.getItem(app.CACHE_KEYS.cacheTime);
                const now = Date.now();
                
                // Usar cache si existe y es reciente
                if (cachedData && cacheTime && (now - parseInt(cacheTime)) < app.CACHE_DURATION) {
                    try {
                        allDbQuestions = JSON.parse(cachedData);
                        console.log('üì¶ Usando cache de BD:', allDbQuestions.length, 'preguntas');
                    } catch (e) {
                        console.warn('Error parseando cache:', e);
                    }
                }
                
                // Si no hay cache v√°lido, cargar de la BD
                if (allDbQuestions.length === 0) {
                    try {
                        const url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*&limit=1000`;
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'apikey': SUPABASE_CONFIG.anonKey,
                                'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                            }
                        });
                        if (response.ok) {
                            allDbQuestions = await response.json();
                            console.log('üìö Total preguntas en BD:', allDbQuestions.length);
                            // Guardar en cache
                            localStorage.setItem(app.CACHE_KEYS.questions, JSON.stringify(allDbQuestions));
                            localStorage.setItem(app.CACHE_KEYS.cacheTime, now.toString());
                            // Debug: mostrar las asignaturas √∫nicas en BD
                            const asignaturasEnBD = [...new Set(allDbQuestions.map(q => q.asignatura))];
                            console.log('üìã Asignaturas en BD:', asignaturasEnBD);
                        } else if (response.status === 429) {
                            console.warn('‚ö†Ô∏è L√≠mite de peticiones alcanzado (429). Usando datos locales.');
                            app.showToast('‚ö†Ô∏è L√≠mite de BD alcanzado. Espera unos minutos.');
                        }
                    } catch (e) {
                        console.warn('Error cargando preguntas de BD:', e);
                    }
                }
                
                // Funci√≥n para contar preguntas por asignatura (desde datos ya cargados)
                const countByAsignatura = (asignaturaId) => {
                    const count = allDbQuestions.filter(q => q.asignatura === asignaturaId).length;
                    if (count > 0) console.log(`üìä ${asignaturaId}: ${count} preguntas`);
                    return count;
                };
                
                // Funci√≥n para obtener temas de una asignatura (desde datos ya cargados)
                const getTemasForAsignatura = (asignaturaId) => {
                    const questions = allDbQuestions.filter(q => q.asignatura === asignaturaId);
                    const temasMap = {};
                    questions.forEach(q => {
                        const tema = q.tema || 1;
                        if (!temasMap[tema]) {
                            temasMap[tema] = { numero: tema, nombre: `Tema ${tema}`, count: 0, countTest: 0, countIA: 0, countDesarrollo: 0 };
                        }
                        temasMap[tema].count++;
                        // Conteo por tipo
                        if (q.tipo === 'desarrollo') {
                            temasMap[tema].countDesarrollo++;
                        } else if (q.is_ai === true) {
                            temasMap[tema].countIA++;
                        } else {
                            temasMap[tema].countTest++;
                        }
                    });
                    return Object.values(temasMap).sort((a, b) => a.numero - b.numero);
                };
                
                // Funci√≥n para contar preguntas por tipo de toda la asignatura
                const countByTipo = (asignaturaId) => {
                    const questions = allDbQuestions.filter(q => q.asignatura === asignaturaId);
                    let countTest = 0, countIA = 0, countDesarrollo = 0;
                    questions.forEach(q => {
                        if (q.tipo === 'desarrollo') countDesarrollo++;
                        else if (q.is_ai === true) countIA++;
                        else countTest++;
                    });
                    return { test: countTest, ia: countIA, desarrollo: countDesarrollo, total: questions.length };
                };
                
                // Agrupar asignaturas por tipo
                const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                const especialidad = app.asignaturasDisponibles.filter(a => a.tipo === 'especialidad');
                
                let asignaturaOptions = '';
                
                if (obligatorias.length > 0) {
                    asignaturaOptions += '<optgroup label="üìï Obligatorias">';
                    obligatorias.forEach(a => {
                        const numPreguntas = countByAsignatura(a.id);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (optativas.length > 0) {
                    asignaturaOptions += '<optgroup label="üìó Optativas Comunes">';
                    optativas.forEach(a => {
                        const numPreguntas = countByAsignatura(a.id);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (especialidad.length > 0) {
                    asignaturaOptions += `<optgroup label="üìò ${app.currentAsignatura?.especialidad || 'Especialidad'}">`;
                    especialidad.forEach(a => {
                        const numPreguntas = countByAsignatura(a.id);
                        console.log(`üîç Buscando asignatura especialidad: "${a.id}"`);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                const totalPreguntas = app.filteredQuestions.length;
                const canStartQuiz = totalPreguntas > 0;
                
                // Obtener temas disponibles para la asignatura actual
                let temasDisponibles = [];
                let totalPreguntasAsignatura = 0;
                let tiposCounts = { test: 0, ia: 0, desarrollo: 0, total: 0 };
                if (app.currentAsignatura) {
                    temasDisponibles = getTemasForAsignatura(app.currentAsignatura.id);
                    totalPreguntasAsignatura = countByAsignatura(app.currentAsignatura.id);
                    tiposCounts = countByTipo(app.currentAsignatura.id);
                }
                
                // Opciones de temas con detalle de tipos
                const unitOptions = temasDisponibles.map(tema => {
                    let tipoDetail = [];
                    if (tema.countTest > 0) tipoDetail.push(`üìù${tema.countTest}`);
                    if (tema.countIA > 0) tipoDetail.push(`ü§ñ${tema.countIA}`);
                    if (tema.countDesarrollo > 0) tipoDetail.push(`üìÑ${tema.countDesarrollo}`);
                    const tipoStr = tipoDetail.length > 0 ? ` [${tipoDetail.join(' ')}]` : '';
                    return `<option value="${tema.numero}" ${app.currentTema == tema.numero ? 'selected' : ''}>${tema.nombre} (${tema.count})${tipoStr}</option>`;
                }).join('');
                
                // Determinar el tema seleccionado para mostrar en el mensaje
                const temaInfo = app.currentTema !== 'all' 
                    ? `‚úÖ ${totalPreguntas} preguntas disponibles - Tema ${app.currentTema}`
                    : `‚úÖ ${totalPreguntas} preguntas disponibles (${temasDisponibles.length} temas)`;
                
                container.innerHTML = `
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                        <h1>ZONA DE ESTUDIO VIU</h1>
                        <p class="text-muted" style="margin-bottom: 2rem;">Master en Formaci√≥n del Profesorado</p>
                        
                        <div style="max-width:500px; margin: 2rem auto; text-align:left;">
                            <div class="form-group">
                                <label class="form-label">üéì Tu Especialidad:</label>
                                <div class="especialidad-display">
                                    <span class="badge">${CONFIG.especialidades[app.userEspecialidad] || 'No configurada'}</span>
                                    <button class="config-btn" onclick="app.promptChangeEspecialidad()" title="Cambiar especialidad">
                                        ‚öôÔ∏è
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìñ Asignatura:</label>
                                <select id="asignatura-selector" class="form-select" onchange="app.changeAsignatura(this.value)" ${!asignaturaOptions ? 'disabled' : ''}>
                                    ${asignaturaOptions || '<option value="">No hay asignaturas disponibles</option>'}
                                </select>
                            </div>
                            
                            ${temasDisponibles.length > 0 ? `
                            <div class="form-group">
                                <label class="form-label">üìë Tema:</label>
                                <select id="tema-selector" class="form-select" onchange="app.changeTema(this.value)">
                                    <option value="all" ${app.currentTema === 'all' ? 'selected' : ''}>Todos los temas (${totalPreguntasAsignatura} preguntas)</option>
                                    ${unitOptions}
                                </select>
                            </div>
                            ` : ''}
                            
                            <div class="form-group">
                                <label class="form-label">‚öôÔ∏è Configuraci√≥n:</label>
                                <div class="bg-light-box border-light" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; border: 1px solid;">
                                    ${canStartQuiz ? `
                                    <label class="text-dark" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                                        <input type="checkbox" id="random-order-check" ${app.quizSettings.randomOrder ? 'checked' : ''} 
                                               onchange="app.quizSettings.randomOrder = this.checked" 
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>üé≤ Orden aleatorio de preguntas</span>
                                    </label>
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                                        <label class="text-dark" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; flex: 1;">
                                            <input type="checkbox" id="only-marked-check" ${app.quizSettings.onlyMarked ? 'checked' : ''} 
                                                   onchange="app.quizSettings.onlyMarked = this.checked; app.updateMarkedCount()" 
                                                   style="width: 18px; height: 18px; cursor: pointer;"
                                                   ${app.markedQuestions.size === 0 ? 'disabled' : ''}>
                                            <span id="marked-label" style="${app.markedQuestions.size === 0 ? 'opacity: 0.5;' : ''}">üîñ Solo preguntas marcadas (<span id="marked-count">0</span>)</span>
                                        </label>
                                        <button id="clear-marked-btn"
                                                style="padding: 0.25rem 0.4rem; background: #fca5a5; color: #7f1d1d; border: 1px solid #f87171; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; display: ${app.markedQuestions.size > 0 ? 'flex' : 'none'}; align-items: center; justify-content: center; min-width: 28px; height: 28px;"
                                                title="Limpiar todas las preguntas marcadas">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                    <!-- Filtros de tipo de pregunta -->
                                    <div style="border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.25rem;">
                                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üìã Tipos de pregunta a incluir:</div>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                            <!-- Test Normal -->
                                            <label class="tipo-filter-btn" style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid ${app.quizSettings.includeTest !== false ? 'var(--primary)' : 'var(--border)'}; background: ${app.quizSettings.includeTest !== false ? 'rgba(79, 70, 229, 0.1)' : 'transparent'};">
                                                <input type="checkbox" id="include-test-check" ${app.quizSettings.includeTest !== false ? 'checked' : ''} 
                                                       onchange="app.quizSettings.includeTest = this.checked; app.updateTipoFilters(); app.savePreferences()" 
                                                       style="display: none;">
                                                <span style="font-size: 1.3rem;">üìù</span>
                                                <span style="font-size: 0.75rem; font-weight: 600; color: var(--primary);">Test</span>
                                                <span style="font-size: 0.7rem; color: var(--text-secondary);">${tiposCounts.test}</span>
                                            </label>
                                            <!-- Test IA -->
                                            <label class="tipo-filter-btn" style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid ${app.quizSettings.includeAI !== false ? '#8b5cf6' : 'var(--border)'}; background: ${app.quizSettings.includeAI !== false ? 'rgba(139, 92, 246, 0.1)' : 'transparent'};">
                                                <input type="checkbox" id="include-ai-check" ${app.quizSettings.includeAI !== false ? 'checked' : ''} 
                                                       onchange="app.quizSettings.includeAI = this.checked; app.updateTipoFilters(); app.savePreferences()" 
                                                       style="display: none;">
                                                <span style="font-size: 1.3rem;">ü§ñ</span>
                                                <span style="font-size: 0.75rem; font-weight: 600; color: #8b5cf6;">IA</span>
                                                <span style="font-size: 0.7rem; color: var(--text-secondary);">${tiposCounts.ia}</span>
                                            </label>
                                            <!-- Desarrollo -->
                                            <label class="tipo-filter-btn" style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid ${app.quizSettings.includeDesarrollo !== false ? '#f59e0b' : 'var(--border)'}; background: ${app.quizSettings.includeDesarrollo !== false ? 'rgba(245, 158, 11, 0.1)' : 'transparent'};">
                                                <input type="checkbox" id="include-desarrollo-check" ${app.quizSettings.includeDesarrollo !== false ? 'checked' : ''} 
                                                       onchange="app.quizSettings.includeDesarrollo = this.checked; app.updateTipoFilters(); app.savePreferences()" 
                                                       style="display: none;">
                                                <span style="font-size: 1.3rem;">üìÑ</span>
                                                <span style="font-size: 0.75rem; font-weight: 600; color: #f59e0b;">Desarrollo</span>
                                                <span style="font-size: 0.7rem; color: var(--text-secondary);">${tiposCounts.desarrollo}</span>
                                            </label>
                                        </div>
                                        <p id="tipo-filter-warning" style="display: none; font-size: 0.75rem; color: #dc2626; margin: 0.5rem 0 0 0; text-align: center;">‚ö†Ô∏è Selecciona al menos un tipo</p>
                                    </div>
                                    ` : ''}
                                    <div class="text-dark" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <label style="font-weight: 500; display: flex; align-items: center; justify-content: space-between;">
                                            <span>üî§ Tama√±o de letra</span>
                                            <span id="font-size-value" style="font-size: 0.9rem; color: var(--text-secondary);">${app.fontSize || 100}%</span>
                                        </label>
                                        <input type="range" id="font-size-slider" min="80" max="120" step="5" value="${app.fontSize || 100}"
                                               style="width: 100%; cursor: pointer; accent-color: var(--primary);">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="quiz-info-box" style="background:${canStartQuiz ? '#dcfce7' : '#fee2e2'}; padding:1rem; border-radius:8px; margin-bottom:1rem; border: 2px solid ${canStartQuiz ? 'var(--success)' : 'var(--error)'};">
                            <p style="margin:0; font-weight:600; color: ${canStartQuiz ? '#065f46' : '#991b1b'};">
                                ${canStartQuiz 
                                    ? temaInfo
                                    : '‚ö†Ô∏è Esta asignatura a√∫n no tiene preguntas disponibles'}
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 1rem; max-width: 400px; margin: 0 auto;">
                            <button class="btn ${!canStartQuiz ? 'btn-secondary' : ''}" onclick="app.startQuiz()" ${!canStartQuiz ? 'disabled' : ''}>
                                üìù Comenzar Test Normal
                            </button>
                            <button class="btn ${!canStartQuiz ? 'btn-secondary' : ''}" style="background: ${canStartQuiz ? '#dc2626' : ''}; border-color: ${canStartQuiz ? '#dc2626' : ''};" onclick="app.navigate('exam-mode')" ${!canStartQuiz ? 'disabled' : ''}>
                                üìù Modo Examen (con tiempo)
                            </button>
                            <button class="btn ${(() => {
                                const asigNombre = app.currentAsignatura?.nombre || '';
                                const failedForAsig = app.failedQuestionsHistory.filter(q => q.subject === asigNombre).length;
                                return failedForAsig === 0 ? 'btn-secondary' : '';
                            })()}" style="background: ${(() => {
                                const asigNombre = app.currentAsignatura?.nombre || '';
                                const failedForAsig = app.failedQuestionsHistory.filter(q => q.subject === asigNombre).length;
                                return failedForAsig > 0 ? '#0891b2' : '';
                            })()}; border-color: ${(() => {
                                const asigNombre = app.currentAsignatura?.nombre || '';
                                const failedForAsig = app.failedQuestionsHistory.filter(q => q.subject === asigNombre).length;
                                return failedForAsig > 0 ? '#0891b2' : '';
                            })()};" onclick="app.navigate('review-mode')" ${(() => {
                                const asigNombre = app.currentAsignatura?.nombre || '';
                                const failedForAsig = app.failedQuestionsHistory.filter(q => q.subject === asigNombre).length;
                                return failedForAsig === 0 ? 'disabled' : '';
                            })()}>
                                üîÑ Repasar Preguntas Falladas (${(() => {
                                    const asigNombre = app.currentAsignatura?.nombre || '';
                                    return app.failedQuestionsHistory.filter(q => q.subject === asigNombre).length;
                                })()})
                            </button>
                            <button class="btn btn-outline ${!canStartQuiz ? 'btn-secondary' : ''}" onclick="app.navigate('summary')" ${!canStartQuiz ? 'disabled' : ''}>
                                üìñ Ver Resumen del Tema
                            </button>
                            <button class="btn btn-outline ${!canStartQuiz ? 'btn-secondary' : ''}" onclick="app.exportToPDF()" style="background: #fef3c7; color: #92400e; border-color: #fcd34d;" ${!canStartQuiz ? 'disabled' : ''}>
                                üìÑ Exportar a PDF
                            </button>
                            <button id="refresh-btn" class="btn btn-outline" onclick="app.refreshAndReload()" style="background: #f0fdf4; color: #15803d; border-color: #86efac;" ${app.isRefreshOnCooldown() ? 'disabled' : ''}>
                                üîÑ Actualizar Preguntas ${app.isRefreshOnCooldown() ? `(espera ${app.getCooldownRemaining()}s)` : ''}
                            </button>
                        </div>
                        
                        ${(() => {
                            const cacheInfo = app.getCacheInfo();
                            if (cacheInfo.hasCache) {
                                const bgColor = cacheInfo.isExpired ? '#fef3c7' : '#e0f2fe';
                                const borderColor = cacheInfo.isExpired ? '#fcd34d' : '#7dd3fc';
                                const textColor = cacheInfo.isExpired ? '#92400e' : '#0369a1';
                                const icon = cacheInfo.isExpired ? '‚ö†Ô∏è' : 'üì¶';
                                const status = cacheInfo.isExpired ? '(expirado - se actualizar√°)' : '(datos locales)';
                                return `
                                <div style="background:${bgColor}; padding:0.75rem; border-radius:6px; margin-top:1rem; border: 1px solid ${borderColor}; max-width: 400px; margin-left: auto; margin-right: auto;">
                                    <p style="margin:0; font-size:0.85rem; color: ${textColor}; text-align: center;">
                                        ${icon} ${allDbQuestions.length} preguntas ¬∑ Actualizado ${cacheInfo.ageText} ${status}
                                    </p>
                                </div>`;
                            }
                            return '';
                        })()}
                    </div>
                `;
                
                // Actualizar contador de preguntas marcadas despu√©s de renderizar
                setTimeout(() => {
                    app.updateMarkedCount();
                    
                    // Si el bot√≥n est√° en cooldown, iniciar contador regresivo
                    if (app.isRefreshOnCooldown()) {
                        const refreshBtn = document.getElementById('refresh-btn');
                        const updateCooldown = () => {
                            if (!app.isRefreshOnCooldown()) {
                                if (refreshBtn) {
                                    refreshBtn.disabled = false;
                                    refreshBtn.innerHTML = 'üîÑ Actualizar Preguntas';
                                }
                                return;
                            }
                            const remaining = app.getCooldownRemaining();
                            if (refreshBtn) {
                                refreshBtn.innerHTML = `üîÑ Actualizar Preguntas (espera ${remaining}s)`;
                            }
                            setTimeout(updateCooldown, 1000);
                        };
                        updateCooldown();
                    }
                    
                    // Registrar evento del bot√≥n de limpiar marcadas
                    const clearBtn = document.getElementById('clear-marked-btn');
                    if (clearBtn) {
                        clearBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            app.clearAllMarkedQuestions();
                        });
                    }
                    
                    // Guardar preferencias cuando cambian los checkboxes
                    const randomCheck = document.getElementById('random-order-check');
                    const onlyMarkedCheck = document.getElementById('only-marked-check');
                    const fontSizeSlider = document.getElementById('font-size-slider');
                    const fontSizeValue = document.getElementById('font-size-value');
                    
                    if (randomCheck) {
                        randomCheck.addEventListener('change', () => app.savePreferences());
                    }
                    if (onlyMarkedCheck) {
                        onlyMarkedCheck.addEventListener('change', () => app.savePreferences());
                    }
                    if (fontSizeSlider && fontSizeValue) {
                        fontSizeSlider.addEventListener('input', (e) => {
                            const value = parseInt(e.target.value);
                            fontSizeValue.textContent = value + '%';
                            app.saveFontSize(value);
                        });
                    }
                }, 0);
            },
            
            renderQuiz: (container) => {
                // Usamos activeQuizQuestions en lugar de filteredQuestions
                const questions = app.activeQuizQuestions;
                if (!questions || questions.length === 0) {
                    container.innerHTML = `<div class="card text-center"><h3>‚ö†Ô∏è No hay preguntas activas.</h3><p>Ve al inicio para configurar el test.</p><button class="btn" onclick="app.navigate('home')">Ir al Inicio</button></div>`;
                    return;
                }
                if (app.quiz.index >= questions.length) {
                    app.renderQuizResult(container);
                    return;
                }
                
                const q = questions[app.quiz.index];
                const progress = ((app.quiz.index) / questions.length) * 100;
                const isDesarrollo = q.tipo === 'desarrollo';
                
                // Verificar si esta pregunta ya fue respondida
                const previousAnswer = app.quiz.answers[app.quiz.index];
                app.quiz.answered = !!previousAnswer;
                
                // Mezclar opciones solo si no hay respuesta previa (para mantener consistencia)
                const shuffledOptions = previousAnswer ? q.options : app.shuffle([...q.options]);
                
                // Contenido de opciones seg√∫n tipo de pregunta
                let optionsHTML = '';
                let feedbackHTML = '';
                
                if (isDesarrollo) {
                    // Para preguntas de desarrollo, mostrar bot√≥n para ver respuesta
                    const yaVista = previousAnswer && previousAnswer.vista;
                    optionsHTML = `
                        <div id="desarrollo-container" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <p style="color: #92400e; font-weight: 600; margin: 0 0 1rem 0; font-size: 1rem;">
                                üìÑ Pregunta de Desarrollo
                            </p>
                            <p style="color: #78350f; font-size: 0.9rem; margin: 0 0 1.5rem 0;">
                                Piensa en la respuesta y cuando est√©s listo, pulsa para ver la respuesta modelo.
                            </p>
                            <button id="ver-respuesta-btn" class="btn" onclick="app.showDesarrolloAnswer()" 
                                    style="background: #f59e0b; border-color: #f59e0b; font-size: 1rem; padding: 0.75rem 2rem; ${yaVista ? 'display: none;' : ''}">
                                üëÅÔ∏è Ver Respuesta Modelo
                            </button>
                            <div id="desarrollo-answer" style="${yaVista ? '' : 'display: none;'}">
                                <div style="background: white; border-radius: 8px; padding: 1rem; text-align: left; margin-bottom: 1rem; border: 1px solid #fcd34d;">
                                    <p style="font-weight: 600; color: #92400e; margin: 0 0 0.5rem 0;">üìñ Respuesta Modelo:</p>
                                    <div style="color: #1f2937; line-height: 1.6; white-space: pre-wrap;">${q.answer}</div>
                                </div>
                                <p style="color: #78350f; font-size: 0.9rem; margin: 0 0 1rem 0;">
                                    ¬øC√≥mo ha ido tu respuesta mental?
                                </p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                    <button class="btn desarrollo-eval-btn ${previousAnswer?.evaluation === 'sabia' ? 'selected' : ''}" 
                                            onclick="app.evaluateDesarrollo('sabia')"
                                            style="background: ${previousAnswer?.evaluation === 'sabia' ? '#22c55e' : '#dcfce7'}; 
                                                   border: 2px solid #22c55e; 
                                                   color: ${previousAnswer?.evaluation === 'sabia' ? 'white' : '#166534'}; 
                                                   padding: 0.75rem;">
                                        ‚úÖ La sab√≠a
                                    </button>
                                    <button class="btn desarrollo-eval-btn ${previousAnswer?.evaluation === 'no_sabia' ? 'selected' : ''}" 
                                            onclick="app.evaluateDesarrollo('no_sabia')"
                                            style="background: ${previousAnswer?.evaluation === 'no_sabia' ? '#ef4444' : '#fee2e2'}; 
                                                   border: 2px solid #ef4444; 
                                                   color: ${previousAnswer?.evaluation === 'no_sabia' ? 'white' : '#991b1b'}; 
                                                   padding: 0.75rem;">
                                        ‚ùå No la sab√≠a
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Para preguntas de test, mostrar opciones normales
                    optionsHTML = `
                        <div id="options-container">
                            ${shuffledOptions.map((opt, idx) => `
                                <button class="option-btn" data-option="${idx}" onclick="app.checkAnswer(this)" ${previousAnswer ? 'disabled' : ''}>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }
                
                container.innerHTML = `
                    <div class="card">
                        ${app.examMode.active ? `
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #dc2626;">
                            <div style="text-align: center; margin-bottom: 0.75rem;">
                                <div id="exam-timer" style="font-size: 1.5rem; font-weight: 600; color: #dc2626;">‚è±Ô∏è --:--</div>
                                <div style="font-size: 0.85rem; color: #991b1b; margin-top: 0.25rem;">Modo Examen - Tiempo restante</div>
                            </div>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap; justify-content: center;">
                                ${app.activeQuizQuestions.map((_, idx) => {
                                    const answered = app.quiz.answers[idx];
                                    const isCurrent = idx === app.quiz.index;
                                    return `<div style="width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: 2px solid ${isCurrent ? '#dc2626' : answered ? '#22c55e' : '#cbd5e1'}; background: ${answered ? '#dcfce7' : 'white'}; color: ${isCurrent ? '#dc2626' : answered ? '#166534' : '#64748b'};" onclick="app.jumpToQuestion(${idx})" title="${answered ? 'Respondida' : 'Sin responder'}">${idx + 1}</div>`;
                                }).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.75rem; color: #991b1b;">
                                Respondidas: ${app.quiz.answers.filter(a => a).length} / ${app.activeQuizQuestions.length}
                            </div>
                        </div>
                        ` : ''}
                        <div class="quiz-header">
                            <span>Pregunta ${app.quiz.index + 1} de ${questions.length}</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${q.is_ai ? '<span style="background: #ede9fe; color: #6d28d9; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ü§ñ IA</span>' : ''}
                                ${isDesarrollo ? '<span style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üìÑ Desarrollo</span>' : ''}
                                <span class="tag tag-subject">${q.subject} - U${q.unit}</span>
                            </div>
                        </div>
                        <div class="quiz-progress"><div class="progress-bar" style="width: ${progress}%"></div></div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div class="question-text" style="flex: 1;">${q.question}</div>
                            <button onclick="app.toggleMarkQuestion('${q.id}')" 
                                    style="background: ${app.markedQuestions.has(q.id) ? '#f59e0b' : 'transparent'}; 
                                           border: 2px solid ${app.markedQuestions.has(q.id) ? '#f59e0b' : '#cbd5e1'}; 
                                           color: ${app.markedQuestions.has(q.id) ? 'white' : '#64748b'}; 
                                           padding: 0.5rem 0.75rem; 
                                           border-radius: 8px; 
                                           cursor: pointer; 
                                           font-size: 1.2rem; 
                                           transition: all 0.2s;
                                           flex-shrink: 0;
                                           margin-left: 1rem;"
                                    title="${app.markedQuestions.has(q.id) ? 'Desmarcar pregunta' : 'Marcar como dif√≠cil'}">
                                ${app.markedQuestions.has(q.id) ? 'üîñ' : '‚≠ê'}
                            </button>
                        </div>
                        
                        ${optionsHTML}
                        
                        ${!isDesarrollo ? `<div id="feedback-area" class="${previousAnswer ? '' : 'hidden'} bg-light-box" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px;"></div>` : ''}
                        
                        ${!app.examMode.active ? `
                        <!-- Sistema de votaci√≥n de preguntas -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--card); border-radius: 8px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">¬øEsta pregunta est√° bien?</span>
                                <div id="vote-container-${q.id}">
                                    ${app.getVoteHTML(q.id, q.votos_positivos, q.votos_negativos, app.userVotes[q.id])}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${!app.examMode.active ? `
                        <div class="bg-light-box" style="margin-top: 1rem; padding: 1rem; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">
                                üìù Notas personales:
                            </label>
                            <textarea id="question-note" 
                                      placeholder="Escribe aqu√≠ tus apuntes o recordatorios sobre esta pregunta..."
                                      style="width: 100%; 
                                             min-height: 80px; 
                                             padding: 0.75rem; 
                                             border: 1px solid var(--border); 
                                             border-radius: 6px; 
                                             font-family: inherit; 
                                             font-size: 0.95rem; 
                                             resize: vertical;
                                             background: var(--card);
                                             color: var(--text-primary);">${app.questionNotes[q.id] || ''}</textarea>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                            <div>
                                ${app.quiz.index > 0 ? `
                                <button class="btn btn-outline" style="width: auto;" onclick="app.previousQuestion()">‚¨Ö Anterior</button>
                                ` : ''}
                            </div>
                            ${app.examMode.active ? `
                            <div style="flex: 1; display: flex; justify-content: center;">
                                <button class="btn" style="background: #dc2626; border-color: #dc2626;" onclick="app.finishExam()">‚úÖ Finalizar Examen</button>
                            </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px;">
                                ${app.examMode.active && app.quiz.index < questions.length - 1 ? `
                                <button class="btn" style="width: auto;" onclick="app.nextQuestion()">Siguiente ‚ûú</button>
                                ` : !app.examMode.active && !previousAnswer && !isDesarrollo ? `
                                <button class="btn btn-warning" style="width: auto;" onclick="app.skipQuestion()">Saltar ‚Ü∑</button>
                                ` : ''}
                                ${!app.examMode.active && app.quiz.index < questions.length - 1 ? `
                                <button id="next-btn" class="btn ${previousAnswer ? '' : 'hidden'}" style="width: auto;" onclick="app.nextQuestion()">Siguiente ‚ûú</button>
                                ` : !app.examMode.active ? `
                                <button id="next-btn" class="btn ${previousAnswer ? '' : 'hidden'}" style="width: auto;" onclick="app.nextQuestion()">Ver Resultados üèÅ</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-center"><button class="btn-outline" style="border:none; font-size:0.8rem;" onclick="app.navigate('home')">Salir del test</button></div>
                `;
                
                // Si ya fue respondida, mostrar el feedback guardado
                if (previousAnswer && !isDesarrollo) {
                    const feedback = document.getElementById('feedback-area');
                    const optionButtons = document.querySelectorAll('.option-btn');
                    
                    // En modo examen, solo mostrar selecci√≥n sin revelar si es correcta (y permitir cambio)
                    if (app.examMode.active) {
                        optionButtons.forEach(btn => {
                            const optText = btn.innerText.trim();
                            if (optText === previousAnswer.selectedOption) {
                                btn.classList.add('selected');
                            }
                            // NO deshabilitar botones para permitir cambiar
                            btn.disabled = false;
                        });
                    } else {
                        // Modo normal: mostrar correctas e incorrectas
                        optionButtons.forEach(btn => {
                            const optText = btn.innerText.trim();
                            if (optText === previousAnswer.selectedOption) {
                                btn.classList.add(previousAnswer.isCorrect ? 'correct' : 'incorrect');
                            }
                            if (optText === q.answer) {
                                btn.classList.add('correct');
                            }
                        });
                        
                        if (previousAnswer.isCorrect) {
                            feedback.innerHTML = `<b style="color:var(--success)">¬°Correcto! üéâ</b>`;
                        } else {
                            feedback.innerHTML = `<b style="color:var(--error)">Incorrecto.</b><br>La respuesta correcta es: <b>${q.answer}</b>`;
                        }
                    }
                }
                
                // Event listener para guardar notas
                const noteTextarea = document.getElementById('question-note');
                if (noteTextarea) {
                    noteTextarea.addEventListener('blur', () => {
                        app.saveQuestionNote(q.id, noteTextarea.value);
                    });
                    // Tambi√©n guardar al escribir (con debounce simple)
                    let saveTimeout;
                    noteTextarea.addEventListener('input', () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(() => {
                            app.saveQuestionNote(q.id, noteTextarea.value);
                        }, 1000);
                    });
                }
            },
            
            // Mostrar respuesta de pregunta de desarrollo
            showDesarrolloAnswer: () => {
                document.getElementById('ver-respuesta-btn').style.display = 'none';
                document.getElementById('desarrollo-answer').style.display = 'block';
            },
            
            // Evaluar pregunta de desarrollo (si la sab√≠a o no)
            evaluateDesarrollo: (evaluation) => {
                const questions = app.activeQuizQuestions;
                const q = questions[app.quiz.index];
                const isCorrect = evaluation === 'sabia';
                
                // Guardar respuesta
                app.quiz.answers[app.quiz.index] = {
                    selectedOption: evaluation,
                    isCorrect: isCorrect,
                    vista: true,
                    evaluation: evaluation
                };
                
                // Actualizar contador
                if (isCorrect) {
                    app.quiz.score++;
                }
                
                app.quiz.answered = true;
                
                // Actualizar botones visualmente
                document.querySelectorAll('.desarrollo-eval-btn').forEach(btn => {
                    btn.style.opacity = '0.5';
                });
                
                // Resaltar el bot√≥n seleccionado
                const selectedBtn = event.target;
                selectedBtn.style.opacity = '1';
                if (evaluation === 'sabia') {
                    selectedBtn.style.background = '#22c55e';
                    selectedBtn.style.color = 'white';
                } else {
                    selectedBtn.style.background = '#ef4444';
                    selectedBtn.style.color = 'white';
                }
                
                // Mostrar bot√≥n siguiente
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                }
                
                app.showToast(isCorrect ? '‚úÖ ¬°Bien! Marcada como correcta' : '‚ùå Marcada para repasar');
            },
            
            // Nueva p√°gina de estad√≠sticas completa
            renderStatsPage: async (container) => {
                const totalTests = app.testHistory.length;
                const totalPreguntas = app.testHistory.reduce((sum, t) => sum + t.total, 0);
                const totalCorrectas = app.testHistory.reduce((sum, t) => sum + t.score, 0);
                const promedioGlobal = totalPreguntas > 0 ? Math.round((totalCorrectas / totalPreguntas) * 100) : 0;
                
                // Estad√≠sticas por asignatura
                const statsByAsig = {};
                app.testHistory.forEach(test => {
                    if (!statsByAsig[test.asignatura]) {
                        statsByAsig[test.asignatura] = { nombre: test.asignatura, tests: 0, preguntas: 0, correctas: 0 };
                    }
                    statsByAsig[test.asignatura].tests++;
                    statsByAsig[test.asignatura].preguntas += test.total;
                    statsByAsig[test.asignatura].correctas += test.score;
                });
                
                const asignaturasOrdenadas = Object.values(statsByAsig).sort((a, b) => b.tests - a.tests);
                
                // Preguntas falladas
                const falladasPorAsig = {};
                app.failedQuestionsHistory.forEach(q => {
                    falladasPorAsig[q.subject] = (falladasPorAsig[q.subject] || 0) + 1;
                });
                
                container.innerHTML = `
                    <div class="card">
                        <h2 style="margin-bottom: 1rem;">üìä Estad√≠sticas y Progreso</h2>
                        
                        ${totalTests === 0 ? `
                            <div style="padding: 2rem; text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìà</div>
                                <p class="text-muted">Completa algunos tests para ver tu progreso.</p>
                                <button class="btn" onclick="app.navigate('home')" style="margin-top: 1rem;">üè† Ir al Inicio</button>
                            </div>
                        ` : `
                            <!-- M√©tricas principales -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 0.6rem; border-radius: 6px; text-align: center; color: white;">
                                    <div style="font-size: 1.3rem; font-weight: 700;">${totalTests}</div>
                                    <div style="font-size: 0.65rem; opacity: 0.9;">Tests</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); padding: 0.6rem; border-radius: 6px; text-align: center; color: white;">
                                    <div style="font-size: 1.3rem; font-weight: 700;">${totalPreguntas}</div>
                                    <div style="font-size: 0.65rem; opacity: 0.9;">Preguntas</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #22c55e, #15803d); padding: 0.6rem; border-radius: 6px; text-align: center; color: white;">
                                    <div style="font-size: 1.3rem; font-weight: 700;">${totalCorrectas}</div>
                                    <div style="font-size: 0.65rem; opacity: 0.9;">Correctas</div>
                                </div>
                                <div style="background: linear-gradient(135deg, ${promedioGlobal >= 70 ? '#22c55e' : promedioGlobal >= 50 ? '#f59e0b' : '#ef4444'}, ${promedioGlobal >= 70 ? '#15803d' : promedioGlobal >= 50 ? '#d97706' : '#dc2626'}); padding: 0.6rem; border-radius: 6px; text-align: center; color: white;">
                                    <div style="font-size: 1.3rem; font-weight: 700;">${promedioGlobal}%</div>
                                    <div style="font-size: 0.65rem; opacity: 0.9;">Media</div>
                                </div>
                            </div>
                            
                            <!-- Gr√°fico de Tendencia -->
                            <div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">üìà Tendencia (√∫ltimos 15)</div>
                                <div style="display: flex; align-items: flex-end; height: 60px; gap: 2px;">
                                    ${app.testHistory.slice(0, 15).reverse().map(test => {
                                        const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                                        return `<div style="flex: 1; height: ${test.percentage}%; background: ${color}; border-radius: 2px 2px 0 0; min-height: 2px;" title="${test.asignatura}: ${test.percentage}%"></div>`;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Por Asignatura compacto -->
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">üìö Por Asignatura</div>
                                <div style="display: flex; flex-direction: column; gap: 0.4rem; max-height: 200px; overflow-y: auto;">
                                    ${asignaturasOrdenadas.map(asig => {
                                        const prom = Math.round((asig.correctas / asig.preguntas) * 100);
                                        const color = prom >= 70 ? '#22c55e' : prom >= 50 ? '#f59e0b' : '#ef4444';
                                        const falladas = falladasPorAsig[asig.nombre] || 0;
                                        return `
                                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: var(--bg-secondary); border-radius: 4px; border-left: 3px solid ${color};">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${asig.nombre}</div>
                                                    <div style="font-size: 0.65rem; color: var(--text-secondary);">${asig.tests} tests ¬∑ ${asig.correctas}/${asig.preguntas}${falladas > 0 ? ` ¬∑ <span style="color:#ef4444">${falladas} repasar</span>` : ''}</div>
                                                </div>
                                                <div style="font-size: 1rem; font-weight: 700; color: ${color};">${prom}%</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Actividad reciente compacta -->
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">üïí √öltimos Tests</div>
                                <div style="display: grid; gap: 0.3rem; max-height: 150px; overflow-y: auto;">
                                    ${app.testHistory.slice(0, 8).map(test => {
                                        const date = new Date(test.date);
                                        const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                                        const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                                        return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0.5rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.75rem;">
                                                <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${test.asignatura}</span>
                                                <span style="color: var(--text-secondary); margin: 0 0.5rem;">${dateStr}</span>
                                                <span style="font-weight: 700; color: ${color};">${test.percentage}%</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Pendientes de repasar -->
                            ${app.failedQuestionsHistory.length > 0 ? `
                                <div style="background: #fef2f2; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #fca5a5;">
                                    <div style="font-size: 0.8rem; font-weight: 600; color: #dc2626; margin-bottom: 0.3rem;">üîÑ ${app.failedQuestionsHistory.length} preguntas por repasar</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                        ${Object.entries(falladasPorAsig).slice(0, 5).map(([asig, count]) => `
                                            <span style="background: #fee2e2; color: #991b1b; padding: 0.15rem 0.5rem; border-radius: 9999px; font-size: 0.65rem;">${asig.substring(0,20)}${asig.length > 20 ? '...' : ''}: ${count}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Acciones -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn btn-outline" onclick="app.navigate('history')" style="padding: 0.5rem; font-size: 0.85rem;">üìú Historial</button>
                                <button class="btn btn-outline" onclick="app.navigate('stats-advanced')" style="padding: 0.5rem; font-size: 0.85rem;">üìä Avanzadas</button>
                            </div>
                            
                            <button onclick="app.confirmResetAllData()" 
                                    style="width: 100%; margin-top: 0.75rem; padding: 0.4rem; background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                üóëÔ∏è Reiniciar datos
                            </button>
                        `}
                    </div>
                `;
            },
            
            // Renderizar secci√≥n de estad√≠sticas (legacy - para compatibilidad)
            renderStatsSection: () => {
                const currentAsigName = app.currentAsignatura ? app.currentAsignatura.nombre : null;
                const asigStats = currentAsigName && app.stats[currentAsigName] ? app.stats[currentAsigName] : null;
                
                // √öltimos 5 tests
                const recentTests = app.testHistory.slice(0, 5);
                
                if (!asigStats && recentTests.length === 0) {
                    return ''; // No mostrar nada si no hay datos
                }
                
                let statsHTML = '<div class="bg-blue-light" style="margin-top: 2rem; padding: 1rem; border-radius: 8px; border: 2px solid var(--primary); text-align: left;">';
                statsHTML += '<h3 class="text-dark" style="font-size: 1rem; margin-top:0;">üìä Estad√≠sticas y Progreso</h3>';
                
                if (asigStats) {
                    const avgPercentage = Math.round((asigStats.correctAnswers / asigStats.totalQuestions) * 100);
                    const failedAnswers = asigStats.totalQuestions - asigStats.correctAnswers;
                    const successRate = avgPercentage;
                    const failRate = 100 - avgPercentage;
                    
                    statsHTML += `
                        <div class="bg-white-box" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 3px var(--shadow);">
                            <p class="text-dark" style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 0.95rem;">${currentAsigName}</p>
                            
                            <!-- Gr√°fico circular de aciertos/fallos -->
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="position: relative; width: 100px; height: 100px;">
                                    <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                                        <!-- C√≠rculo de fondo -->
                                        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#fee2e2" stroke-width="3"></circle>
                                        <!-- C√≠rculo de progreso -->
                                        <circle cx="18" cy="18" r="15.915" fill="none" 
                                                stroke="${avgPercentage >= 70 ? '#22c55e' : avgPercentage >= 50 ? '#f59e0b' : '#ef4444'}" 
                                                stroke-width="3" 
                                                stroke-dasharray="${avgPercentage}, 100"
                                                stroke-linecap="round"></circle>
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${avgPercentage >= 70 ? 'var(--success)' : avgPercentage >= 50 ? '#f59e0b' : 'var(--error)'};">
                                            ${avgPercentage}%
                                        </div>
                                        <div class="text-muted" style="font-size: 0.7rem;">Acierto</div>
                                    </div>
                                </div>
                                
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                            <span style="color: #22c55e; font-weight: 600;">‚úì Correctas</span>
                                            <span style="font-weight: 700;">${asigStats.correctAnswers}</span>
                                        </div>
                                        <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 8px;">
                                            <div style="background: #22c55e; height: 100%; width: ${successRate}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                            <span style="color: #ef4444; font-weight: 600;">‚úó Falladas</span>
                                            <span style="font-weight: 700;">${failedAnswers}</span>
                                        </div>
                                        <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 8px;">
                                            <div style="background: #ef4444; height: 100%; width: ${failRate}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estad√≠sticas adicionales -->
                            <div class="border-light" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #0ea5e9;">${asigStats.totalTests}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Tests</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6;">${asigStats.totalQuestions}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Preguntas</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: ${avgPercentage >= 70 ? '#22c55e' : avgPercentage >= 50 ? '#f59e0b' : '#ef4444'};">${avgPercentage}%</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Promedio</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (recentTests.length > 0) {
                    // Mini gr√°fico de tendencia
                    statsHTML += '<div class="bg-white-box" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 3px var(--shadow);">';
                    statsHTML += '<p class="text-dark" style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 0.9rem;">üìà Tendencia reciente</p>';
                    statsHTML += '<div class="bg-light-box" style="display: flex; align-items: flex-end; justify-content: space-between; height: 80px; gap: 3px; padding: 0.5rem; border-radius: 4px;">';
                    
                    const last8 = recentTests.slice(0, 8).reverse();
                    last8.forEach((test, idx) => {
                        const height = test.percentage;
                        const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                        statsHTML += `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;" title="${test.percentage}% - ${test.asignatura}">
                                <div style="font-size: 0.65rem; font-weight: 600; margin-bottom: 2px; color: ${color};">${test.percentage}%</div>
                                <div style="width: 100%; height: ${height}%; background: ${color}; border-radius: 3px 3px 0 0; min-height: 4px; transition: all 0.3s; box-shadow: 0 -1px 3px rgba(0,0,0,0.1);"></div>
                            </div>
                        `;
                    });
                    
                    statsHTML += '</div>';
                    statsHTML += `<p class="text-muted" style="margin: 0.5rem 0 0 0; font-size: 0.75rem; text-align: center;">√öltimos ${last8.length} tests realizados</p>`;
                    statsHTML += '</div>';
                    
                    // Lista de √∫ltimos tests
                    statsHTML += '<div style="margin-top: 1rem;">';
                    statsHTML += '<p class="text-dark" style="margin: 0 0 0.5rem 0; font-weight: 600; font-size: 0.9rem;">üïí Actividad reciente</p>';
                    statsHTML += '<div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">';
                    
                    recentTests.forEach(test => {
                        const date = new Date(test.date);
                        const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        const percentColor = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                        const icon = test.percentage >= 70 ? 'üéâ' : test.percentage >= 50 ? 'üëç' : 'üí™';
                        
                        statsHTML += `
                            <div class="bg-white-box" style="padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; border-left: 3px solid ${percentColor}; box-shadow: 0 1px 2px var(--shadow);">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div class="text-dark" style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${test.asignatura}</div>
                                        <div class="text-muted" style="font-size: 0.75rem;">${test.tema} ¬∑ ${dateStr}</div>
                                        <div class="text-muted" style="margin-top: 0.25rem; font-size: 0.75rem;">
                                            ${test.score}/${test.total} correctas
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                        <div style="font-size: 1.2rem;">${icon}</div>
                                        <div style="font-weight: 700; font-size: 1rem; color: ${percentColor};">
                                            ${test.percentage}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    statsHTML += '</div>';
                    statsHTML += '</div>';
                    
                    if (app.testHistory.length > 5) {
                        statsHTML += `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem;">
                                <button class="btn btn-outline" onclick="app.navigate('history')" style="font-size: 0.85rem;">
                                    üìà Historial
                                </button>
                                <button class="btn btn-outline" onclick="app.navigate('stats-advanced')" style="font-size: 0.85rem;">
                                    üìä Estad√≠sticas avanzadas
                                </button>
                            </div>
                        `;
                    } else if (app.testHistory.length > 0) {
                        statsHTML += `
                            <button class="btn btn-outline" onclick="app.navigate('stats-advanced')" style="margin-top: 0.75rem; width: 100%; font-size: 0.9rem;">
                                üìä Ver estad√≠sticas avanzadas
                            </button>
                        `;
                    }
                }
                
                // Bot√≥n de reiniciar datos
                if (app.testHistory.length > 0 || Object.keys(app.stats).length > 0) {
                    statsHTML += `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <button onclick="app.confirmResetAllData()" 
                                    style="width: 100%; padding: 0.6rem; background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;"
                                    onmouseover="this.style.background='#fee2e2'; this.style.borderColor='#f87171'"
                                    onmouseout="this.style.background='#fef2f2'; this.style.borderColor='#fca5a5'">
                                üîÑ Reiniciar todos los datos
                            </button>
                        </div>
                    `;
                }
                
                statsHTML += '</div>';
                return statsHTML;
            },
            
            // Renderizar vista de historial completo
            renderHistory: (container) => {
                if (app.testHistory.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h2 style="margin-bottom: 1rem;">üìà Historial</h2>
                            <p class="text-muted">No has completado ning√∫n test todav√≠a.</p>
                            <button class="btn" onclick="app.navigate('stats')" style="margin-top: 1rem;">üìä Volver</button>
                        </div>
                    `;
                    return;
                }
                
                // Agrupar por asignatura
                const byAsignatura = {};
                app.testHistory.forEach(test => {
                    if (!byAsignatura[test.asignatura]) byAsignatura[test.asignatura] = [];
                    byAsignatura[test.asignatura].push(test);
                });
                
                container.innerHTML = `
                    <div class="card">
                        <h2 style="margin-bottom: 0.75rem;">üìà Historial (${app.testHistory.length} tests)</h2>
                        
                        <!-- Gr√°fico compacto -->
                        <div style="background: var(--bg-secondary); padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.4rem;">√öltimos 10 tests</div>
                            <div style="display: flex; align-items: flex-end; height: 50px; gap: 2px;">
                                ${app.testHistory.slice(0, 10).reverse().map(test => {
                                    const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                                    return `<div style="flex: 1; height: ${test.percentage}%; background: ${color}; border-radius: 2px 2px 0 0; min-height: 2px;" title="${test.percentage}%"></div>`;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Por asignatura -->
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
                            ${Object.entries(byAsignatura).map(([asigName, tests]) => {
                                const avg = Math.round(tests.reduce((sum, t) => sum + t.percentage, 0) / tests.length);
                                const color = avg >= 70 ? '#22c55e' : avg >= 50 ? '#f59e0b' : '#ef4444';
                                return `
                                    <details style="background: #f0f9ff; border-radius: 6px; border-left: 3px solid ${color};">
                                        <summary style="padding: 0.6rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                                            <span style="font-weight: 600;">${asigName}</span>
                                            <span style="font-size: 0.75rem; color: var(--text-secondary);">${tests.length} tests ¬∑ <span style="color: ${color}; font-weight: 700;">${avg}%</span></span>
                                        </summary>
                                        <div style="padding: 0.5rem; display: flex; flex-direction: column; gap: 0.3rem;">
                                            ${tests.map(test => {
                                                const date = new Date(test.date);
                                                const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                                                const pColor = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                                                return `
                                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.6rem; background: white; border-radius: 4px; font-size: 0.75rem; border-left: 2px solid ${pColor};">
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 500;">${test.tema}</div>
                                                            <div style="color: var(--text-secondary); font-size: 0.7rem;">${dateStr} ¬∑ ${test.score}/${test.total}</div>
                                                        </div>
                                                        <div style="font-weight: 700; color: ${pColor};">${test.percentage}%</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </details>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Acciones -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-outline" onclick="app.navigate('stats')" style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">üìä Volver</button>
                            <button class="btn" onclick="if(confirm('¬øEliminar historial?')) app.clearHistory();" style="flex: 1; padding: 0.5rem; font-size: 0.85rem; background: var(--error); border-color: var(--error);">üóëÔ∏è Limpiar</button>
                        </div>
                    </div>
                `;
            },
            
            // Limpiar historial
            clearHistory: () => {
                app.testHistory = [];
                app.stats = {};
                app.saveTestHistory();
                app.saveStats();
                app.showToast('‚úÖ Historial limpiado');
                app.navigate('history');
            },
            
            // === NUEVAS FUNCIONALIDADES ===
            
            // 1. MODO EXAMEN SIMULADO
            renderExamMode: (container) => {
                const totalPreguntas = app.filteredQuestions.length;
                const canStart = totalPreguntas > 0 && app.currentAsignatura;
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üìù Modo Examen Simulado</h1>
                        <p class="text-muted">Prep√°rate para el examen real con l√≠mite de tiempo</p>
                        
                        ${canStart ? `
                        <div style="max-width: 500px; margin: 2rem auto; text-align: left;">
                            <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h3 style="margin-top: 0; font-size: 1.1rem;">‚öôÔ∏è Configuraci√≥n del Examen</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">üìö Asignatura seleccionada:</label>
                                    <div style="padding: 0.75rem; background: var(--card); border: 2px solid var(--primary); border-radius: 6px; font-weight: 600;">
                                        ${app.currentAsignatura.nombre}
                                    </div>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                        Total disponible: ${totalPreguntas} preguntas
                                    </p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìä N√∫mero de preguntas:</label>
                                    <input type="number" id="exam-question-count" class="form-select" 
                                           value="30" min="5" max="${totalPreguntas}" style="font-size: 1.1rem; font-weight: 600;">
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                        M√≠nimo 5, m√°ximo ${totalPreguntas}
                                    </p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">‚è±Ô∏è Tiempo l√≠mite (minutos):</label>
                                    <input type="number" id="exam-time-limit" class="form-select" 
                                           value="30" min="5" max="180" style="font-size: 1.1rem; font-weight: 600;">
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                        Recomendado: 1 minuto por pregunta
                                    </p>
                                </div>
                            </div>
                            
                            <div class="bg-light-box" style="padding: 1rem; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 1.5rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #dc2626; font-size: 0.95rem;">‚ö†Ô∏è Condiciones del examen:</h4>
                                <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                    <li>El tiempo comenzar√° al iniciar el examen</li>
                                    <li>Las preguntas se presentar√°n en orden aleatorio</li>
                                    <li>Cuando el tiempo termine, el examen se enviar√° autom√°ticamente</li>
                                    <li>No podr√°s volver atr√°s en las preguntas</li>
                                </ul>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-outline" onclick="app.navigate('home')" style="flex: 1;">
                                    ‚Üê Volver
                                </button>
                                <button class="btn" onclick="app.startExamMode()" style="flex: 2; background: #dc2626; border-color: #dc2626;">
                                    üöÄ Comenzar Examen
                                </button>
                            </div>
                        </div>
                        ` : `
                        <div style="padding: 2rem; text-align: center;">
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Primero debes seleccionar una asignatura desde la p√°gina de inicio.
                            </p>
                            <button class="btn" onclick="app.navigate('home')">
                                üè† Ir al Inicio
                            </button>
                        </div>
                        `}
                    </div>
                `;
            },
            
            startExamMode: () => {
                // Validar que al menos un tipo de pregunta est√© seleccionado
                if (!app.quizSettings.includeTest && !app.quizSettings.includeAI && !app.quizSettings.includeDesarrollo) {
                    app.showToast("‚ö†Ô∏è Selecciona al menos un tipo de pregunta (Test, IA o Desarrollo)");
                    return;
                }
                
                const questionCount = parseInt(document.getElementById('exam-question-count').value);
                const timeLimit = parseInt(document.getElementById('exam-time-limit').value);
                
                // Filtrar por tipo de pregunta antes de contar
                let availableQuestions = [...app.filteredQuestions].filter(q => {
                    const isTestNormal = q.tipo !== 'desarrollo' && !q.is_ai;
                    const isIA = q.is_ai === true;
                    const isDesarrollo = q.tipo === 'desarrollo';
                    
                    if (isDesarrollo && app.quizSettings.includeDesarrollo) return true;
                    if (isIA && app.quizSettings.includeAI) return true;
                    if (isTestNormal && app.quizSettings.includeTest) return true;
                    return false;
                });
                
                if (questionCount < 5 || questionCount > availableQuestions.length) {
                    app.showToast('‚ö†Ô∏è N√∫mero de preguntas inv√°lido (m√°ximo ' + availableQuestions.length + ' disponibles)');
                    return;
                }
                
                if (timeLimit < 5 || timeLimit > 180) {
                    app.showToast('‚ö†Ô∏è Tiempo l√≠mite inv√°lido');
                    return;
                }
                
                // Configurar modo examen
                app.examMode.active = true;
                app.examMode.questionCount = questionCount;
                app.examMode.timeLimit = timeLimit;
                app.examMode.startTime = Date.now();
                app.examMode.endTime = Date.now() + (timeLimit * 60 * 1000);
                
                // Seleccionar preguntas aleatorias de las filtradas
                const shuffled = app.shuffle(availableQuestions);
                app.activeQuizQuestions = shuffled.slice(0, questionCount);
                
                // Reiniciar quiz
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                // Iniciar temporizador
                app.startExamTimer();
                
                app.navigate('quiz');
            },
            
            startExamTimer: () => {
                const updateTimer = () => {
                    const now = Date.now();
                    const remaining = app.examMode.endTime - now;
                    
                    if (remaining <= 0) {
                        // Tiempo terminado
                        clearInterval(app.examMode.timer);
                        app.examMode.active = false;
                        app.showToast('‚è∞ ¬°Tiempo terminado!');
                        // Forzar finalizaci√≥n
                        app.quiz.index = app.activeQuizQuestions.length;
                        app.navigate('quiz');
                        return;
                    }
                    
                    // Actualizar display del timer
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    const timerDisplay = document.getElementById('exam-timer');
                    if (timerDisplay) {
                        const isUrgent = remaining < 60000; // Menos de 1 minuto
                        timerDisplay.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;
                        timerDisplay.style.color = isUrgent ? '#dc2626' : 'var(--text-primary)';
                        timerDisplay.style.fontWeight = isUrgent ? '800' : '600';
                    }
                };
                
                updateTimer();
                app.examMode.timer = setInterval(updateTimer, 1000);
            },
            
            // 2. MODO REPASO DE FALLOS
            renderReviewMode: async (container) => {
                // Cargar preguntas de BD para verificar cu√°les existen
                const dbQuestions = await app.loadDbQuestions();
                const existingIds = new Set(dbQuestions.map(q => String(q.id)));
                
                // Limpiar del historial las preguntas que ya no existen en BD
                const originalCount = app.failedQuestionsHistory.length;
                if (existingIds.size > 0) {
                    app.failedQuestionsHistory = app.failedQuestionsHistory.filter(q => existingIds.has(String(q.id)));
                    if (app.failedQuestionsHistory.length !== originalCount) {
                        app.saveFailedHistory(); // Guardar historial limpio
                    }
                }
                
                // Filtrar solo las preguntas falladas de la asignatura actual
                const asigNombre = app.currentAsignatura?.nombre || '';
                const failedForAsig = app.failedQuestionsHistory.filter(q => q.subject === asigNombre);
                const failedCount = failedForAsig.length;
                
                if (failedCount === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üîÑ Modo Repaso</h1>
                            <p class="text-muted">Repasa las preguntas que has fallado en ${asigNombre || 'esta asignatura'}</p>
                            <div style="font-size: 3rem; margin: 2rem 0;">‚úÖ</div>
                            <h3 style="color: var(--success);">¬°No tienes preguntas falladas en esta asignatura!</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                                Completa algunos tests de ${asigNombre || 'esta asignatura'} para que aparezcan aqu√≠ las preguntas que necesitas repasar.
                            </p>
                            <button class="btn" onclick="app.navigate('home')">
                                üè† Volver al Inicio
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Agrupar por tema
                const byTema = {};
                failedForAsig.forEach(q => {
                    const tema = q.unit || 'Sin tema';
                    if (!byTema[tema]) {
                        byTema[tema] = [];
                    }
                    byTema[tema].push(q);
                });
                
                let optionsHTML = Object.keys(byTema).map(tema => {
                    const count = byTema[tema].length;
                    return `<option value="${tema}">Tema ${tema} (${count} pregunta${count > 1 ? 's' : ''})</option>`;
                }).join('');
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üîÑ Modo Repaso</h1>
                        <p class="text-muted">Preguntas falladas en ${asigNombre}</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin: 2rem 0; border: 2px solid #0891b2;">
                            <h3 style="margin-top: 0; font-size: 1.1rem; color: #0e7490;">üìä Estad√≠sticas de Repaso</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: var(--card); border-radius: 6px;">
                                    <div style="font-size: 2rem; font-weight: 700; color: #dc2626;">${failedCount}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Preguntas falladas</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--card); border-radius: 6px;">
                                    <div style="font-size: 2rem; font-weight: 700; color: #0891b2;">${Object.keys(byTema).length}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Temas</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div class="form-group">
                                <label class="form-label">üìö Filtrar por tema:</label>
                                <select id="review-subject-filter" class="form-select">
                                    <option value="all">Todos los temas (${failedCount})</option>
                                    ${optionsHTML}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üî¢ Ordenar por:</label>
                                <select id="review-sort" class="form-select">
                                    <option value="recent">M√°s recientes primero</option>
                                    <option value="most-failed">M√°s falladas primero</option>
                                    <option value="random">Orden aleatorio</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button class="btn btn-outline" onclick="app.navigate('home')" style="flex: 1;">
                                    ‚Üê Volver
                                </button>
                                <button class="btn" onclick="app.startReviewMode()" style="flex: 2; background: #0891b2; border-color: #0891b2;">
                                    üöÄ Comenzar Repaso
                                </button>
                            </div>
                            
                            <button class="btn" onclick="app.clearFailedHistoryForAsig()" 
                                    style="width: 100%; margin-top: 1rem; background: #fef2f2; color: #991b1b; border-color: #fca5a5;">
                                üóëÔ∏è Limpiar fallos de ${asigNombre || 'esta asignatura'}
                            </button>
                        </div>
                    </div>
                `;
            },
            
            startReviewMode: () => {
                // RESETEAR MODO EXAMEN - esto es un test normal de repaso
                if (app.examMode.timer) {
                    clearInterval(app.examMode.timer);
                }
                app.examMode = {
                    active: false,
                    timeLimit: 30,
                    questionCount: 30,
                    startTime: null,
                    endTime: null,
                    timer: null
                };
                
                const temaFilter = document.getElementById('review-subject-filter').value;
                const sortBy = document.getElementById('review-sort').value;
                
                // Filtrar solo las de la asignatura actual
                const asigNombre = app.currentAsignatura?.nombre || '';
                let questions = app.failedQuestionsHistory.filter(q => q.subject === asigNombre);
                
                // Filtrar por tema si no es "all"
                if (temaFilter !== 'all') {
                    questions = questions.filter(q => q.unit == temaFilter);
                }
                
                // Ordenar
                if (sortBy === 'recent') {
                    questions.sort((a, b) => new Date(b.lastFailed) - new Date(a.lastFailed));
                } else if (sortBy === 'most-failed') {
                    questions.sort((a, b) => (b.failCount || 1) - (a.failCount || 1));
                } else {
                    questions = app.shuffle(questions);
                }
                
                if (questions.length === 0) {
                    app.showToast('‚ö†Ô∏è No hay preguntas con ese filtro');
                    return;
                }
                
                // Configurar quiz
                app.activeQuizQuestions = questions;
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            
            clearFailedHistory: () => {
                if (confirm('¬øSeguro que quieres limpiar el historial de preguntas falladas?')) {
                    app.failedQuestionsHistory = [];
                    app.saveFailedHistory();
                    app.showToast('‚úÖ Historial de fallos limpiado');
                    app.navigate('home');
                }
            },
            
            // Limpiar solo las preguntas falladas de la asignatura actual
            clearFailedHistoryForAsig: () => {
                const asigNombre = app.currentAsignatura?.nombre || '';
                if (confirm(`¬øSeguro que quieres limpiar los fallos de ${asigNombre}?`)) {
                    app.failedQuestionsHistory = app.failedQuestionsHistory.filter(q => q.subject !== asigNombre);
                    app.saveFailedHistory();
                    app.showToast(`‚úÖ Fallos de ${asigNombre} limpiados`);
                    app.navigate('home');
                }
            },
            
            // 3. MODO RESUMEN DE TEMA
            renderSummary: async (container) => {
                if (!app.currentAsignatura) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üìñ Resumen de Temas</h1>
                            <p class="text-muted">Selecciona una asignatura primero</p>
                            <button class="btn" onclick="app.navigate('home')">üè† Ir al Inicio</button>
                        </div>
                    `;
                    return;
                }
                
                // Mostrar loading
                container.innerHTML = `
                    <div class="card text-center">
                        <h1>üìñ Resumen de Temas</h1>
                        <div class="loading-box"><p>‚è≥ Cargando preguntas...</p></div>
                    </div>
                `;
                
                // Cargar preguntas de la BD (usa cache local)
                // Para asignaturas obligatorias, no filtrar por especialidad (son comunes a todas)
                const esObligatoria = app.currentAsignatura.tipo === 'obligatoria';
                const especialidadFiltro = esObligatoria ? '' : app.currentEspecialidad;
                const dbQuestions = await app.loadDbQuestions(especialidadFiltro, app.currentAsignatura.id);
                
                // Agrupar por tema
                const temasMap = {};
                dbQuestions.forEach(q => {
                    const temaNum = q.tema || 1;
                    if (!temasMap[temaNum]) {
                        temasMap[temaNum] = {
                            numero: temaNum,
                            nombre: `Tema ${temaNum}`,
                            preguntas: []
                        };
                    }
                    
                    let opciones = q.opciones;
                    if (typeof opciones === 'string') {
                        try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                    }
                    
                    temasMap[temaNum].preguntas.push({
                        id: q.id,
                        pregunta: q.pregunta,
                        opciones: opciones,
                        respuesta_correcta: q.respuesta_correcta
                    });
                });
                
                const temas = Object.values(temasMap).sort((a, b) => a.numero - b.numero);
                
                if (temas.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üìñ Resumen de Temas</h1>
                            <p class="text-muted">${app.currentAsignatura.nombre}</p>
                            <div style="font-size: 3rem; margin: 2rem 0;">üì≠</div>
                            <p>No hay preguntas disponibles para esta asignatura.</p>
                            <button class="btn btn-outline" onclick="app.navigate('home')">‚Üê Volver al Inicio</button>
                        </div>
                    `;
                    return;
                }
                
                // Guardar temas para showTemaSummary
                app.currentSummaryTemas = temas;
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üìñ Resumen de Temas</h1>
                        <p class="text-muted">${app.currentAsignatura.nombre}</p>
                        
                        <div style="max-width: 600px; margin: 2rem auto;">
                            <div class="form-group">
                                <label class="form-label">üìö Selecciona un tema:</label>
                                <select id="summary-tema-select" class="form-select" onchange="app.showTemaSummary(this.value)">
                                    <option value="">-- Selecciona un tema --</option>
                                    ${temas.map(t => `<option value="${t.numero}">${t.nombre} (${t.preguntas.length} preguntas)</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div id="summary-content" style="margin-top: 2rem;"></div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn btn-outline" onclick="app.navigate('home')">‚Üê Volver al Inicio</button>
                        </div>
                    </div>
                `;
            },
            
            showTemaSummary: (temaNumero) => {
                const summaryContent = document.getElementById('summary-content');
                
                if (!temaNumero) {
                    summaryContent.innerHTML = '';
                    return;
                }
                
                // Usar los temas cargados de la BD
                const tema = app.currentSummaryTemas?.find(t => t.numero == temaNumero);
                if (!tema) {
                    summaryContent.innerHTML = '<p class="text-muted">No se encontr√≥ el tema.</p>';
                    return;
                }
                
                let html = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; border: 2px solid var(--primary); text-align: left;">
                        <h2 style="margin-top: 0; color: var(--primary);">${tema.nombre}</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                            üìä ${tema.preguntas.length} pregunta${tema.preguntas.length > 1 ? 's' : ''} en este tema
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                `;
                
                tema.preguntas.forEach((p, idx) => {
                    const isMarked = app.markedQuestions.has(p.id);
                    const hasNote = app.questionNotes[p.id];
                    
                    html += `
                        <div class="bg-white-box" style="padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 4px var(--shadow); border-left: 4px solid ${isMarked ? '#f59e0b' : 'var(--primary)'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">Pregunta ${idx + 1}</h4>
                                ${isMarked ? '<span style="font-size: 1.2rem;">üîñ</span>' : ''}
                            </div>
                            
                            <p style="font-weight: 600; margin-bottom: 1rem; line-height: 1.5;">${p.pregunta}</p>
                            
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; border: 2px solid #22c55e;">
                                <div style="font-weight: 600; color: #166534; margin-bottom: 0.5rem; font-size: 0.9rem;">‚úì Respuesta correcta:</div>
                                <div style="color: #15803d; font-weight: 500;">${p.respuesta_correcta}</div>
                            </div>
                            
                            ${hasNote ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #fffbeb; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem; font-size: 0.85rem;">üìù Tus notas:</div>
                                <div style="color: #78350f; font-size: 0.9rem; white-space: pre-wrap;">${hasNote}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <button class="btn" onclick="app.studyThisTema(${temaNumero})" style="width: 100%;">
                                üìù Practicar este tema ahora
                            </button>
                        </div>
                    </div>
                `;
                
                summaryContent.innerHTML = html;
            },
            
            studyThisTema: async (temaNumero) => {
                // Aplicar filtro de tema
                await app.applyTemaFilter(temaNumero);
                app.savePreferences();
                
                // Iniciar test
                app.navigate('home');
                setTimeout(() => {
                    app.startQuiz();
                }, 500);
            },
            
            // 4. ESTAD√çSTICAS AVANZADAS CON PREDICTOR
            renderAdvancedStats: (container) => {
                if (app.testHistory.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üìä Estad√≠sticas Avanzadas</h1>
                            <p class="text-muted">Completa algunos tests para ver tus estad√≠sticas avanzadas</p>
                            <button class="btn" onclick="app.navigate('stats')">üìä Volver a Estad√≠sticas</button>
                        </div>
                    `;
                    return;
                }
                
                // Calcular m√©tricas globales
                const totalTests = app.testHistory.length;
                const totalPreguntas = app.testHistory.reduce((sum, t) => sum + t.total, 0);
                const totalCorrectas = app.testHistory.reduce((sum, t) => sum + t.score, 0);
                const promedioGlobal = Math.round((totalCorrectas / totalPreguntas) * 100);
                
                // Calcular tendencias
                const last5 = app.testHistory.slice(0, 5);
                const prev5 = app.testHistory.slice(5, 10);
                const avgLast5 = last5.length > 0 ? Math.round(last5.reduce((sum, t) => sum + t.percentage, 0) / last5.length) : 0;
                const avgPrev5 = prev5.length > 0 ? Math.round(prev5.reduce((sum, t) => sum + t.percentage, 0) / prev5.length) : avgLast5;
                const trend = avgLast5 - avgPrev5;
                
                // Mejor y peor test
                const bestTest = app.testHistory.reduce((best, t) => t.percentage > best.percentage ? t : best, app.testHistory[0]);
                const worstTest = app.testHistory.reduce((worst, t) => t.percentage < worst.percentage ? t : worst, app.testHistory[0]);
                
                // Racha actual (tests consecutivos >= 70%)
                let rachaActual = 0;
                for (const t of app.testHistory) {
                    if (t.percentage >= 70) rachaActual++;
                    else break;
                }
                
                // Mejor racha hist√≥rica
                let mejorRacha = 0, rachaTemp = 0;
                app.testHistory.slice().reverse().forEach(t => {
                    if (t.percentage >= 70) { rachaTemp++; mejorRacha = Math.max(mejorRacha, rachaTemp); }
                    else rachaTemp = 0;
                });
                
                // Estad√≠sticas por asignatura con temas
                let byAsignatura = {};
                app.testHistory.forEach(t => {
                    if (!byAsignatura[t.asignatura]) {
                        byAsignatura[t.asignatura] = { tests: 0, total: 0, correct: 0, temas: {}, fechas: [] };
                    }
                    byAsignatura[t.asignatura].tests++;
                    byAsignatura[t.asignatura].total += t.total;
                    byAsignatura[t.asignatura].correct += t.score;
                    byAsignatura[t.asignatura].fechas.push(t.date);
                    
                    const tema = t.tema || 'General';
                    if (!byAsignatura[t.asignatura].temas[tema]) {
                        byAsignatura[t.asignatura].temas[tema] = { total: 0, correct: 0 };
                    }
                    byAsignatura[t.asignatura].temas[tema].total += t.total;
                    byAsignatura[t.asignatura].temas[tema].correct += t.score;
                });
                
                // Ordenar asignaturas
                const asignaturasSorted = Object.entries(byAsignatura).sort((a, b) => 
                    (b[1].correct / b[1].total) - (a[1].correct / a[1].total)
                );
                
                // Predicci√≥n
                const prediction = Math.round(avgLast5 + (trend * 0.5));
                const predictionClamped = Math.max(0, Math.min(100, prediction));
                const predColor = predictionClamped >= 70 ? '#22c55e' : predictionClamped >= 50 ? '#f59e0b' : '#ef4444';
                
                // Distribuci√≥n de notas
                const distribucion = { excelente: 0, bien: 0, regular: 0, mal: 0 };
                app.testHistory.forEach(t => {
                    if (t.percentage >= 80) distribucion.excelente++;
                    else if (t.percentage >= 60) distribucion.bien++;
                    else if (t.percentage >= 40) distribucion.regular++;
                    else distribucion.mal++;
                });
                
                // Tiempo de estudio (estimaci√≥n basada en tests)
                const tiempoEstimado = totalPreguntas * 0.5; // 30 segundos por pregunta aprox
                
                container.innerHTML = `
                    <div class="card">
                        <h2 style="margin-bottom: 1rem;">üìä Estad√≠sticas Avanzadas</h2>
                        
                        <!-- M√©tricas principales en grid compacto -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 0.75rem; border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${totalTests}</div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">Tests</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); padding: 0.75rem; border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${totalPreguntas}</div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">Preguntas</div>
                            </div>
                            <div style="background: linear-gradient(135deg, ${promedioGlobal >= 70 ? '#22c55e' : promedioGlobal >= 50 ? '#f59e0b' : '#ef4444'}, ${promedioGlobal >= 70 ? '#15803d' : promedioGlobal >= 50 ? '#d97706' : '#dc2626'}); padding: 0.75rem; border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${promedioGlobal}%</div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">Media</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 0.75rem; border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${rachaActual}üî•</div>
                                <div style="font-size: 0.7rem; opacity: 0.9;">Racha</div>
                            </div>
                        </div>
                        
                        <!-- Predictor y Tendencia lado a lado -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- Predictor -->
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; border: 2px solid ${predColor}; text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">üîÆ Predicci√≥n Examen</div>
                                <div style="font-size: 2.5rem; font-weight: 800; color: ${predColor};">${predictionClamped}%</div>
                                <div style="font-size: 0.75rem; color: ${predColor};">
                                    ${trend > 3 ? 'üìà Subiendo' : trend < -3 ? 'üìâ Bajando' : '‚û°Ô∏è Estable'}
                                </div>
                            </div>
                            
                            <!-- Mejor/Peor -->
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">üèÜ Mejor</span>
                                    <span style="font-weight: 700; color: #22c55e;">${bestTest.percentage}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">üìâ Peor</span>
                                    <span style="font-weight: 700; color: #ef4444;">${worstTest.percentage}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">üî• Mejor racha</span>
                                    <span style="font-weight: 700; color: #f59e0b;">${mejorRacha}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">‚è±Ô∏è Tiempo est.</span>
                                    <span style="font-weight: 700; color: #3b82f6;">${Math.round(tiempoEstimado)}min</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Distribuci√≥n de notas -->
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem;">üìä Distribuci√≥n de Resultados</div>
                            <div style="display: flex; gap: 0.25rem; height: 24px; border-radius: 4px; overflow: hidden;">
                                ${distribucion.excelente > 0 ? `<div style="flex: ${distribucion.excelente}; background: #22c55e;" title="Excelente (‚â•80%): ${distribucion.excelente}"></div>` : ''}
                                ${distribucion.bien > 0 ? `<div style="flex: ${distribucion.bien}; background: #84cc16;" title="Bien (60-79%): ${distribucion.bien}"></div>` : ''}
                                ${distribucion.regular > 0 ? `<div style="flex: ${distribucion.regular}; background: #f59e0b;" title="Regular (40-59%): ${distribucion.regular}"></div>` : ''}
                                ${distribucion.mal > 0 ? `<div style="flex: ${distribucion.mal}; background: #ef4444;" title="Bajo (<40%): ${distribucion.mal}"></div>` : ''}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.7rem;">
                                <span style="color: #22c55e;">‚óèExcelente: ${distribucion.excelente}</span>
                                <span style="color: #84cc16;">‚óèBien: ${distribucion.bien}</span>
                                <span style="color: #f59e0b;">‚óèRegular: ${distribucion.regular}</span>
                                <span style="color: #ef4444;">‚óèBajo: ${distribucion.mal}</span>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico de evoluci√≥n compacto -->
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">üìà Evoluci√≥n (√∫ltimos 20 tests)</div>
                            <div style="display: flex; align-items: flex-end; height: 80px; gap: 2px;">
                                ${app.testHistory.slice(0, 20).reverse().map(test => {
                                    const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                                    return `<div style="flex: 1; height: ${test.percentage}%; background: ${color}; border-radius: 2px 2px 0 0; min-height: 2px;" title="${test.asignatura}: ${test.percentage}%"></div>`;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Rendimiento por asignatura compacto -->
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem;">üìö Por Asignatura</div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 250px; overflow-y: auto;">
                                ${asignaturasSorted.map(([nombre, data]) => {
                                    const avg = Math.round((data.correct / data.total) * 100);
                                    const color = avg >= 70 ? '#22c55e' : avg >= 50 ? '#f59e0b' : '#ef4444';
                                    const temaKeys = Object.keys(data.temas);
                                    return `
                                        <div style="padding: 0.5rem; background: var(--card); border-radius: 6px; border-left: 3px solid ${color};">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${nombre}</div>
                                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">${data.tests} tests ¬∑ ${data.correct}/${data.total} ¬∑ ${temaKeys.length} tema${temaKeys.length > 1 ? 's' : ''}</div>
                                                </div>
                                                <div style="font-size: 1.1rem; font-weight: 700; color: ${color}; margin-left: 0.5rem;">${avg}%</div>
                                            </div>
                                            ${temaKeys.length > 1 ? `
                                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem;">
                                                    ${temaKeys.slice(0, 6).map(tema => {
                                                        const tAvg = Math.round((data.temas[tema].correct / data.temas[tema].total) * 100);
                                                        const tColor = tAvg >= 70 ? '#22c55e' : tAvg >= 50 ? '#f59e0b' : '#ef4444';
                                                        return `<span style="font-size: 0.65rem; padding: 0.15rem 0.4rem; background: ${tColor}20; color: ${tColor}; border-radius: 4px;">${tema}: ${tAvg}%</span>`;
                                                    }).join('')}
                                                    ${temaKeys.length > 6 ? `<span style="font-size: 0.65rem; color: var(--text-secondary);">+${temaKeys.length - 6} m√°s</span>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Recomendaciones compactas -->
                        <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">üí° Recomendaciones</div>
                            <div style="font-size: 0.8rem; color: #1e40af; line-height: 1.5;">
                                ${app.failedQuestionsHistory.length > 0 ? 
                                    `‚Ä¢ Repasa las <strong>${app.failedQuestionsHistory.length}</strong> preguntas falladas<br>` : ''}
                                ${trend < -3 ? '‚Ä¢ Tu rendimiento baja, toma un descanso<br>' : ''}
                                ${trend > 5 ? '‚Ä¢ ¬°Excelente progreso! Sigue as√≠<br>' : ''}
                                ${promedioGlobal < 60 ? '‚Ä¢ C√©ntrate en los temas con peor puntuaci√≥n<br>' : ''}
                                ${promedioGlobal >= 70 ? '‚Ä¢ Est√°s listo para el modo examen<br>' : ''}
                                ${rachaActual >= 3 ? `‚Ä¢ ¬°Racha de ${rachaActual}! No la pierdas` : '‚Ä¢ Intenta conseguir una racha de 3+'}
                            </div>
                        </div>
                        
                        <!-- Bot√≥n Volver al final -->
                        <button class="btn btn-outline" onclick="app.navigate('stats')" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">üìä Volver a Estad√≠sticas</button>
                    </div>
                `;
            },
            
            // === FIN DE NUEVAS FUNCIONALIDADES ===
            
            // Renderizar vista de contribuciones
            renderContribute: (container) => {
                // Agrupar asignaturas disponibles
                const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                const especialidad = app.asignaturasDisponibles.filter(a => a.tipo === 'especialidad');
                
                let asignaturaOptions = '';
                
                if (obligatorias.length > 0) {
                    asignaturaOptions += '<optgroup label="üìï Obligatorias">';
                    obligatorias.forEach(a => {
                        asignaturaOptions += `<option value="${a.id}">${a.nombre}</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (optativas.length > 0) {
                    asignaturaOptions += '<optgroup label="üìó Optativas Comunes">';
                    optativas.forEach(a => {
                        asignaturaOptions += `<option value="${a.id}">${a.nombre}</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (especialidad.length > 0) {
                    asignaturaOptions += `<optgroup label="üìò ${CONFIG.especialidades[app.userEspecialidad] || 'Especialidad'}">`;
                    especialidad.forEach(a => {
                        asignaturaOptions += `<option value="${a.id}">${a.nombre}</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                container.innerHTML = `
                    <div class="card">
                        <h2>‚ûï Contribuir con Preguntas</h2>
                        <p class="text-muted" style="margin-bottom: 2rem;">Ayuda a ampliar el banco de preguntas. Selecciona la asignatura y a√±ade preguntas una tras otra.</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">1Ô∏è‚É£ Selecciona la Asignatura</h3>
                            
                            <div class="form-group">
                                <label class="form-label">üéì Tu Especialidad:</label>
                                <div class="especialidad-display">
                                    <span class="badge">${CONFIG.especialidades[app.userEspecialidad] || 'No configurada'}</span>
                                    <button class="config-btn" onclick="app.promptChangeEspecialidad()" title="Cambiar especialidad">
                                        ‚öôÔ∏è
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìñ Asignatura:</label>
                                <select id="contrib-asignatura" class="form-select" onchange="app.renderDbContributionsList()">
                                    <option value="">Selecciona una asignatura</option>
                                    ${asignaturaOptions}
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn" onclick="app.startContributing()" style="width: 100%;">
                                    ‚û°Ô∏è Individual
                                </button>
                                <button class="btn btn-outline" onclick="app.showBulkUpload()" style="width: 100%; border-color: #8b5cf6; color: #8b5cf6;">
                                    üì¶ Carga Masiva
                                </button>
                            </div>
                        </div>
                        
                        <div id="bulk-upload-area" style="display: none;"></div>
                        <div id="contrib-form-area" style="display: none;"></div>
                        <div id="contributions-list"></div>
                    </div>
                `;
                
                // Cargar preguntas del usuario desde la BD (filtradas por selecci√≥n)
                app.renderDbContributionsList();
                
                // Restaurar valores guardados
                setTimeout(() => {
                    const asigSelect = document.getElementById('contrib-asignatura');
                    if (asigSelect && app.contribState.asignatura) {
                        asigSelect.value = app.contribState.asignatura;
                    }
                }, 100);
            },
            
            // Actualizar asignaturas (simplificado - usa la especialidad fija del usuario)
            updateContribAsignaturas: async () => {
                // Esta funci√≥n ya no es necesaria porque la especialidad es fija
                // Las asignaturas se cargan autom√°ticamente bas√°ndose en app.userEspecialidad
                app.renderDbContributionsList();
            },
            
            // Iniciar proceso de contribuci√≥n
            startContributing: () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                
                if (!asignaturaId) {
                    app.showToast('‚ö†Ô∏è Selecciona una asignatura');
                    return;
                }
                
                // Guardar estado (usar especialidad fija del usuario)
                app.contribState.especialidad = app.userEspecialidad;
                app.contribState.asignatura = asignaturaId;
                app.saveContribState();
                
                // Ocultar panel de carga masiva si est√° visible
                const bulkArea = document.getElementById('bulk-upload-area');
                if (bulkArea) bulkArea.style.display = 'none';
                
                const formArea = document.getElementById('contrib-form-area');
                formArea.style.display = 'block';
                formArea.innerHTML = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="font-size: 1.1rem; margin-top: 0;">2Ô∏è‚É£ A√±ade Preguntas</h3>
                        <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                            Asignatura seleccionada: <strong id="selected-asig-name"></strong>
                        </p>
                        
                        <!-- Tipo de pregunta -->
                        <div class="form-group">
                            <label class="form-label">üéØ Tipo de Pregunta:</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;" id="contrib-tipo-btns">
                                <button type="button" class="tipo-btn active" data-tipo="test" onclick="app.setContribTipo('test')" 
                                    style="padding: 0.75rem; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                    üìù Test
                                </button>
                                <button type="button" class="tipo-btn" data-tipo="ia" onclick="app.setContribTipo('ia')"
                                    style="padding: 0.75rem; border: 2px solid #8b5cf6; background: transparent; color: #8b5cf6; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                    ü§ñ Test IA
                                </button>
                                <button type="button" class="tipo-btn" data-tipo="desarrollo" onclick="app.setContribTipo('desarrollo')"
                                    style="padding: 0.75rem; border: 2px solid #f59e0b; background: transparent; color: #f59e0b; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                    üìÑ Desarrollo
                                </button>
                            </div>
                            <p id="tipo-hint" style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                Preguntas de test tipo examen con 4 opciones
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìö N√∫mero de Tema (<span id="tema-range">1-50</span>):</label>
                            <input type="number" id="contrib-tema" class="form-select" placeholder="Ej: 1, 2, 3..." min="1" max="50" step="1" value="${app.contribState.tema || ''}" style="font-size: 1.1rem; font-weight: 600;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‚ùì Pregunta:</label>
                            <textarea id="contrib-question" class="form-select" rows="3" placeholder="Escribe la pregunta aqu√≠..." style="resize: vertical;"></textarea>
                        </div>
                        
                        <!-- Opciones para TEST -->
                        <div id="test-options-section">
                            <div class="form-group">
                                <label class="form-label">üìù Opciones de respuesta:</label>
                                <input type="text" id="contrib-option-1" class="form-select" placeholder="Opci√≥n 1" style="margin-bottom: 0.5rem;">
                                <input type="text" id="contrib-option-2" class="form-select" placeholder="Opci√≥n 2" style="margin-bottom: 0.5rem;">
                                <input type="text" id="contrib-option-3" class="form-select" placeholder="Opci√≥n 3" style="margin-bottom: 0.5rem;">
                                <input type="text" id="contrib-option-4" class="form-select" placeholder="Opci√≥n 4">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">‚úÖ Respuesta correcta:</label>
                                <select id="contrib-correct" class="form-select">
                                    <option value="">Selecciona la opci√≥n correcta</option>
                                    <option value="1">Opci√≥n 1</option>
                                    <option value="2">Opci√≥n 2</option>
                                    <option value="3">Opci√≥n 3</option>
                                    <option value="4">Opci√≥n 4</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Respuesta para DESARROLLO -->
                        <div id="desarrollo-section" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">üìñ Respuesta modelo:</label>
                                <textarea id="contrib-respuesta-desarrollo" class="form-select" rows="6" placeholder="Escribe la respuesta modelo o gu√≠a de estudio aqu√≠..." style="resize: vertical;"></textarea>
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                    Esta respuesta servir√° como gu√≠a de estudio para los usuarios
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="app.submitContribution()" style="flex: 1;">
                                ‚ûï A√±adir Pregunta
                            </button>
                            <button class="btn btn-outline" onclick="app.finishContributing()" style="flex: 1;">
                                ‚úÖ Finalizar
                            </button>
                        </div>
                    </div>
                `;
                
                // Inicializar tipo seleccionado
                app.contribTipo = 'test';
                
                // Obtener nombre de asignatura
                const asig = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                const nameElement = document.getElementById('selected-asig-name');
                if (nameElement && asig) {
                    nameElement.textContent = asig.nombre;
                }
                
                // Scroll al formulario
                formArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            },
            
            // Cambiar tipo de contribuci√≥n
            setContribTipo: (tipo) => {
                app.contribTipo = tipo;
                
                // Actualizar botones
                document.querySelectorAll('#contrib-tipo-btns .tipo-btn').forEach(btn => {
                    const btnTipo = btn.dataset.tipo;
                    if (btnTipo === tipo) {
                        btn.classList.add('active');
                        if (tipo === 'test') {
                            btn.style.background = 'var(--primary)';
                            btn.style.color = 'white';
                        } else if (tipo === 'ia') {
                            btn.style.background = '#8b5cf6';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '#f59e0b';
                            btn.style.color = 'white';
                        }
                    } else {
                        btn.classList.remove('active');
                        btn.style.background = 'transparent';
                        if (btnTipo === 'test') btn.style.color = 'var(--primary)';
                        else if (btnTipo === 'ia') btn.style.color = '#8b5cf6';
                        else btn.style.color = '#f59e0b';
                    }
                });
                
                // Mostrar/ocultar secciones
                const testSection = document.getElementById('test-options-section');
                const desarrolloSection = document.getElementById('desarrollo-section');
                const temaRange = document.getElementById('tema-range');
                const temaInput = document.getElementById('contrib-tema');
                const tipoHint = document.getElementById('tipo-hint');
                
                if (tipo === 'desarrollo') {
                    testSection.style.display = 'none';
                    desarrolloSection.style.display = 'block';
                    tipoHint.textContent = 'Preguntas de desarrollo con respuesta modelo para estudio';
                } else {
                    testSection.style.display = 'block';
                    desarrolloSection.style.display = 'none';
                    if (tipo === 'ia') {
                        tipoHint.textContent = 'ü§ñ Preguntas generadas con IA - se mostrar√°n con badge especial';
                    } else {
                        tipoHint.textContent = 'Preguntas de test tipo examen con 4 opciones';
                    }
                }
            },
            
            // Mostrar formulario de carga masiva
            showBulkUpload: () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                
                if (!asignaturaId) {
                    app.showToast('‚ö†Ô∏è Selecciona una asignatura primero');
                    return;
                }
                
                // Guardar estado
                app.contribState.especialidad = app.userEspecialidad;
                app.contribState.asignatura = asignaturaId;
                app.saveContribState();
                
                // Ocultar formulario individual si est√° visible
                const formArea = document.getElementById('contrib-form-area');
                if (formArea) formArea.style.display = 'none';
                
                const bulkArea = document.getElementById('bulk-upload-area');
                
                // Obtener nombre de asignatura
                const asig = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                const asigNombre = asig ? asig.nombre : asignaturaId;
                
                bulkArea.style.display = 'block';
                bulkArea.innerHTML = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 2px solid #8b5cf6;">
                        <h3 style="font-size: 1.1rem; margin-top: 0; color: #8b5cf6;">üì¶ Carga Masiva de Preguntas</h3>
                        <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                            Asignatura: <strong>${asigNombre}</strong>
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">üìö N√∫mero de Tema para todas las preguntas:</label>
                            <input type="number" id="bulk-tema" class="form-select" placeholder="Ej: 1, 2, 3..." min="1" max="50" value="${app.contribState.tema || 1}" style="font-size: 1.1rem; font-weight: 600;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üéØ Tipo de preguntas:</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;" id="bulk-tipo-btns">
                                <button type="button" class="bulk-tipo-btn active" data-tipo="test" onclick="app.setBulkTipo('test')" 
                                    style="padding: 0.75rem; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                    üìù Test
                                </button>
                                <button type="button" class="bulk-tipo-btn" data-tipo="ia" onclick="app.setBulkTipo('ia')"
                                    style="padding: 0.75rem; border: 2px solid #8b5cf6; background: transparent; color: #8b5cf6; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                    ü§ñ Test IA
                                </button>
                                <button type="button" class="bulk-tipo-btn" data-tipo="desarrollo" onclick="app.setBulkTipo('desarrollo')"
                                    style="padding: 0.75rem; border: 2px solid #f59e0b; background: transparent; color: #f59e0b; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                    üìÑ Desarrollo
                                </button>
                            </div>
                            <input type="hidden" id="bulk-tipo" value="test">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìù Formato del texto:</label>
                            <div id="bulk-format-hint" style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìã Pega aqu√≠ todas las preguntas:</label>
                            <textarea id="bulk-text" class="form-select" rows="12" placeholder="Pega aqu√≠ el texto con las preguntas siguiendo el formato indicado..." style="resize: vertical; font-family: monospace; font-size: 0.85rem;"></textarea>
                        </div>
                        
                        <div id="bulk-preview" style="display: none; margin-bottom: 1rem;"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="app.previewBulkUpload()" style="border-color: #8b5cf6; color: #8b5cf6;">
                                üëÅÔ∏è Vista Previa
                            </button>
                            <button class="btn" onclick="app.processBulkUpload()" style="background: #8b5cf6; border-color: #8b5cf6;">
                                üì§ Subir Todo
                            </button>
                            <button class="btn btn-outline" onclick="app.cancelBulkUpload()">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                // Inicializar tipo
                app.bulkTipo = 'test';
                
                // Mostrar formato inicial
                app.updateBulkFormatHint();
                
                bulkArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            },
            
            // Cambiar tipo de carga masiva
            setBulkTipo: (tipo) => {
                app.bulkTipo = tipo;
                document.getElementById('bulk-tipo').value = tipo;
                
                // Actualizar botones
                document.querySelectorAll('#bulk-tipo-btns .bulk-tipo-btn').forEach(btn => {
                    const btnTipo = btn.dataset.tipo;
                    if (btnTipo === tipo) {
                        btn.classList.add('active');
                        if (tipo === 'test') {
                            btn.style.background = 'var(--primary)';
                            btn.style.color = 'white';
                        } else if (tipo === 'ia') {
                            btn.style.background = '#8b5cf6';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '#f59e0b';
                            btn.style.color = 'white';
                        }
                    } else {
                        btn.classList.remove('active');
                        btn.style.background = 'transparent';
                        if (btnTipo === 'test') btn.style.color = 'var(--primary)';
                        else if (btnTipo === 'ia') btn.style.color = '#8b5cf6';
                        else btn.style.color = '#f59e0b';
                    }
                });
                
                // Actualizar hint de formato
                app.updateBulkFormatHint();
            },
            
            // Actualizar hint de formato seg√∫n tipo seleccionado
            updateBulkFormatHint: () => {
                const tipo = app.bulkTipo || 'test';
                const hintDiv = document.getElementById('bulk-format-hint');
                
                if (tipo === 'desarrollo') {
                    hintDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">üìÑ Desarrollo</span>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Preguntas con respuesta larga</span>
                        </div>
                        <pre style="font-size: 0.75rem; background: var(--bg); padding: 0.75rem; border-radius: 4px; overflow-x: auto; margin: 0; border-left: 3px solid #f59e0b;">PREGUNTA: ¬øQu√© es la metacognici√≥n?
RESPUESTA: La metacognici√≥n es el conocimiento sobre los propios procesos cognitivos...

PREGUNTA: Explica el constructivismo
RESPUESTA: El constructivismo es una teor√≠a del aprendizaje que sostiene...</pre>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                            ‚ö° Cada pregunta debe empezar con <code style="background: #fef3c7; padding: 0.1rem 0.3rem; border-radius: 3px;">PREGUNTA:</code> y su respuesta con <code style="background: #fef3c7; padding: 0.1rem 0.3rem; border-radius: 3px;">RESPUESTA:</code>
                        </p>
                    `;
                } else {
                    const isIA = tipo === 'ia';
                    const badgeColor = isIA ? '#ede9fe' : '#dbeafe';
                    const textColor = isIA ? '#6d28d9' : '#1e40af';
                    const borderColor = isIA ? '#8b5cf6' : '#3b82f6';
                    const icon = isIA ? 'ü§ñ' : 'üìù';
                    const label = isIA ? 'Test IA' : 'Test';
                    
                    hintDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="background: ${badgeColor}; color: ${textColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${icon} ${label}</span>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Preguntas tipo test con 4 opciones</span>
                        </div>
                        <pre style="font-size: 0.75rem; background: var(--bg); padding: 0.75rem; border-radius: 4px; overflow-x: auto; margin: 0; border-left: 3px solid ${borderColor};">¬øCu√°l es la capital de Francia?
a) Madrid
b) Par√≠s
c) Londres
d) Roma
Respuesta: b

¬øQu√© a√±o comenz√≥ la Segunda Guerra Mundial?
a) 1935
b) 1939
c) 1941
d) 1945
Respuesta: b</pre>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                            ‚ö° Cada pregunta necesita 4 opciones <code style="background: ${badgeColor}; padding: 0.1rem 0.3rem; border-radius: 3px;">a) b) c) d)</code> y una l√≠nea <code style="background: ${badgeColor}; padding: 0.1rem 0.3rem; border-radius: 3px;">Respuesta: x</code>
                        </p>
                    `;
                }
            },
            
            // Cancelar carga masiva
            cancelBulkUpload: () => {
                const bulkArea = document.getElementById('bulk-upload-area');
                if (bulkArea) bulkArea.style.display = 'none';
            },
            
            // Parsear texto de preguntas
            parseBulkQuestions: (text, tipo) => {
                const questions = [];
                
                if (tipo === 'desarrollo') {
                    // Formato: PREGUNTA: ... RESPUESTA: ...
                    const blocks = text.split(/(?=PREGUNTA:)/i).filter(b => b.trim());
                    
                    for (const block of blocks) {
                        const preguntaMatch = block.match(/PREGUNTA:\s*(.+?)(?=RESPUESTA:|$)/is);
                        const respuestaMatch = block.match(/RESPUESTA:\s*(.+?)(?=PREGUNTA:|$)/is);
                        
                        if (preguntaMatch && respuestaMatch) {
                            questions.push({
                                pregunta: preguntaMatch[1].trim(),
                                respuesta: respuestaMatch[1].trim(),
                                opciones: [],
                                tipo: 'desarrollo'
                            });
                        }
                    }
                } else {
                    // Formato TEST: Pregunta, a) b) c) d), Respuesta: x
                    // Separar por l√≠neas vac√≠as o por "Respuesta:"
                    const blocks = text.split(/\n\s*\n/).filter(b => b.trim());
                    
                    for (const block of blocks) {
                        const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                        
                        if (lines.length < 5) continue; // M√≠nimo: pregunta + 4 opciones
                        
                        let pregunta = '';
                        const opciones = [];
                        let respuestaCorrecta = '';
                        
                        for (const line of lines) {
                            // Detectar opciones a), b), c), d) o A), B), C), D)
                            const opcionMatch = line.match(/^([a-dA-D])\)\s*(.+)$/);
                            // Detectar respuesta
                            const respuestaMatch = line.match(/^Respuesta:\s*([a-dA-D])/i);
                            
                            if (opcionMatch) {
                                opciones.push(opcionMatch[2].trim());
                            } else if (respuestaMatch) {
                                const letra = respuestaMatch[1].toLowerCase();
                                const idx = letra.charCodeAt(0) - 'a'.charCodeAt(0);
                                if (idx >= 0 && idx < opciones.length) {
                                    respuestaCorrecta = opciones[idx];
                                }
                            } else if (!pregunta && !line.match(/^[a-dA-D]\)/)) {
                                pregunta = line;
                            }
                        }
                        
                        // Si hay exactamente 4 opciones y una respuesta
                        if (pregunta && opciones.length === 4 && respuestaCorrecta) {
                            questions.push({
                                pregunta: pregunta,
                                opciones: opciones,
                                respuesta: respuestaCorrecta,
                                tipo: tipo // 'test' o 'ia'
                            });
                        }
                    }
                }
                
                return questions;
            },
            
            // Vista previa de carga masiva
            previewBulkUpload: () => {
                const text = document.getElementById('bulk-text').value;
                const tipo = app.bulkTipo || 'test';
                const previewDiv = document.getElementById('bulk-preview');
                
                if (!text.trim()) {
                    app.showToast('‚ö†Ô∏è Pega las preguntas primero');
                    return;
                }
                
                const questions = app.parseBulkQuestions(text, tipo);
                
                if (questions.length === 0) {
                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 1rem;">
                            <p style="color: #991b1b; font-weight: 600; margin: 0 0 0.5rem 0;">‚ùå No se detectaron preguntas v√°lidas</p>
                            <p style="color: #991b1b; font-size: 0.85rem; margin: 0;">Revisa que el formato sea correcto seg√∫n el tipo seleccionado.</p>
                        </div>
                    `;
                    return;
                }
                
                // Determinar badge seg√∫n tipo
                let tipoBadge = '';
                let tipoLabel = '';
                if (tipo === 'ia') {
                    tipoBadge = '<span style="background: #ede9fe; color: #6d28d9; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">ü§ñ Test IA</span>';
                    tipoLabel = 'Test IA';
                } else if (tipo === 'desarrollo') {
                    tipoBadge = '<span style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üìÑ Desarrollo</span>';
                    tipoLabel = 'Desarrollo';
                } else {
                    tipoBadge = '<span style="background: #dbeafe; color: #1e40af; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üìù Test</span>';
                    tipoLabel = 'Test';
                }
                
                let html = `
                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <p style="color: #166534; font-weight: 600; margin: 0;">‚úÖ ${questions.length} pregunta(s) detectadas</p>
                            ${tipoBadge}
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                questions.forEach((q, idx) => {
                    if (q.tipo === 'desarrollo') {
                        html += `
                            <div style="background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid #f59e0b;">
                                <p style="font-weight: 600; margin: 0 0 0.5rem 0; font-size: 0.9rem;">${idx + 1}. ${q.pregunta.substring(0, 100)}${q.pregunta.length > 100 ? '...' : ''}</p>
                                <p style="color: var(--success); font-size: 0.8rem; margin: 0;">üìñ Respuesta: ${q.respuesta.substring(0, 80)}${q.respuesta.length > 80 ? '...' : ''}</p>
                            </div>
                        `;
                    } else {
                        const borderColor = tipo === 'ia' ? '#8b5cf6' : 'var(--border)';
                        html += `
                            <div style="background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid ${borderColor};">
                                <p style="font-weight: 600; margin: 0 0 0.5rem 0; font-size: 0.9rem;">${idx + 1}. ${q.pregunta.substring(0, 100)}${q.pregunta.length > 100 ? '...' : ''}</p>
                                <p style="color: var(--success); font-size: 0.8rem; margin: 0;">‚úÖ ${q.respuesta}</p>
                            </div>
                        `;
                    }
                });
                
                html += '</div></div>';
                previewDiv.style.display = 'block';
                previewDiv.innerHTML = html;
            },
            
            // Procesar y subir carga masiva
            processBulkUpload: async () => {
                const text = document.getElementById('bulk-text').value;
                const tipo = app.bulkTipo || 'test';
                const tema = parseInt(document.getElementById('bulk-tema').value);
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                
                if (!text.trim()) {
                    app.showToast('‚ö†Ô∏è Pega las preguntas primero');
                    return;
                }
                
                if (!tema || tema < 1 || tema > 50) {
                    app.showToast('‚ö†Ô∏è El tema debe ser un n√∫mero entre 1 y 50');
                    return;
                }
                
                const questions = app.parseBulkQuestions(text, tipo);
                
                if (questions.length === 0) {
                    app.showToast('‚ùå No se detectaron preguntas v√°lidas');
                    return;
                }
                
                // Buscar asignatura
                let asignatura = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                let asignaturaNombre = asignatura ? asignatura.nombre : asignaturaId;
                const esObligatoria = asignatura && asignatura.tipo === 'obligatoria';
                
                // Preparar todas las preguntas para subir
                const questionsToUpload = questions.map(q => ({
                    pregunta: q.pregunta,
                    opciones: q.tipo === 'desarrollo' ? [] : q.opciones,
                    respuesta_correcta: q.respuesta,
                    especialidad: esObligatoria ? '' : (app.userEspecialidad || ''),
                    asignatura: asignaturaId,
                    asignatura_nombre: asignaturaNombre,
                    tema: tema,
                    autor: app.getUserId(),
                    fecha_creacion: new Date().toISOString(),
                    aprobada: true,
                    tipo: q.tipo === 'desarrollo' ? 'desarrollo' : 'test',
                    is_ai: tipo === 'ia'
                }));
                
                // Mostrar progreso
                const previewDiv = document.getElementById('bulk-preview');
                previewDiv.style.display = 'block';
                previewDiv.innerHTML = `
                    <div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #1e40af; font-weight: 600; margin: 0;">‚è≥ Subiendo ${questionsToUpload.length} preguntas...</p>
                        <div id="bulk-progress" style="margin-top: 0.5rem;">
                            <div style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="bulk-progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="bulk-progress-text" style="font-size: 0.8rem; color: #1e40af; margin: 0.5rem 0 0 0;">0/${questionsToUpload.length}</p>
                        </div>
                    </div>
                `;
                
                // Deshabilitar botones
                const btns = document.querySelectorAll('#bulk-upload-area button');
                btns.forEach(b => b.disabled = true);
                
                let uploaded = 0;
                let failed = 0;
                const errors = [];
                
                // Subir en lotes de 10 para no sobrecargar
                const batchSize = 10;
                for (let i = 0; i < questionsToUpload.length; i += batchSize) {
                    const batch = questionsToUpload.slice(i, i + batchSize);
                    
                    try {
                        const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_CONFIG.anonKey,
                                'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify(batch)
                        });
                        
                        if (response.ok) {
                            uploaded += batch.length;
                        } else {
                            failed += batch.length;
                            errors.push(`Lote ${Math.floor(i/batchSize)+1}: HTTP ${response.status}`);
                        }
                    } catch (error) {
                        failed += batch.length;
                        errors.push(`Lote ${Math.floor(i/batchSize)+1}: ${error.message}`);
                    }
                    
                    // Actualizar progreso
                    const progress = Math.round(((i + batch.length) / questionsToUpload.length) * 100);
                    document.getElementById('bulk-progress-bar').style.width = `${progress}%`;
                    document.getElementById('bulk-progress-text').textContent = `${i + batch.length}/${questionsToUpload.length}`;
                }
                
                // Mostrar resultado
                const tipoLabel = tipo === 'ia' ? 'ü§ñ Test IA' : tipo === 'desarrollo' ? 'üìÑ Desarrollo' : 'üìù Test';
                
                if (failed === 0) {
                    previewDiv.innerHTML = `
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; text-align: center;">
                            <p style="color: #166534; font-weight: 600; font-size: 1.1rem; margin: 0 0 0.5rem 0;">üéâ ¬°√âxito!</p>
                            <p style="color: #166534; margin: 0;">${uploaded} preguntas ${tipoLabel} subidas correctamente</p>
                        </div>
                    `;
                    app.showToast(`‚úÖ ${uploaded} preguntas ${tipoLabel} subidas`);
                    
                    // Limpiar y recargar
                    document.getElementById('bulk-text').value = '';
                    setTimeout(() => {
                        app.cancelBulkUpload();
                        app.renderDbContributionsList();
                    }, 2000);
                } else {
                    previewDiv.innerHTML = `
                        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem;">
                            <p style="color: #92400e; font-weight: 600; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Carga parcial</p>
                            <p style="color: #166534; margin: 0 0 0.25rem 0;">‚úÖ ${uploaded} subidas correctamente</p>
                            <p style="color: #991b1b; margin: 0 0 0.5rem 0;">‚ùå ${failed} fallaron</p>
                            ${errors.length > 0 ? `<p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Errores: ${errors.join(', ')}</p>` : ''}
                        </div>
                    `;
                    app.showToast(`‚ö†Ô∏è ${uploaded} subidas, ${failed} fallaron`);
                    app.renderDbContributionsList();
                }
                
                // Rehabilitar botones
                btns.forEach(b => b.disabled = false);
            },
            
            // Finalizar contribuciones
            finishContributing: () => {
                const formArea = document.getElementById('contrib-form-area');
                formArea.style.display = 'none';
                
                if (app.userContributions.length > 0) {
                    app.showToast(`‚úÖ ${app.userContributions.length} pregunta(s) guardadas. No olvides exportarlas.`);
                }
                
                // Actualizar bot√≥n de exportar
                app.navigate('contribute');
            },
            
            // Actualizar lista de contribuciones
            renderContributionsList: () => {
                const listContainer = document.getElementById('contributions-list');
                if (!listContainer) return;
                
                if (app.userContributions.length === 0) {
                    listContainer.innerHTML = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <p class="text-muted">No tienes contribuciones pendientes</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; margin: 0;">üìã Tus Contribuciones (${app.userContributions.length})</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="app.exportContributions()" style="padding: 0.5rem 1rem;">
                                    üì• Exportar
                                </button>
                                <button class="btn" onclick="app.clearAllContributions()" style="padding: 0.5rem 1rem; background: #fca5a5; border-color: #f87171;" title="Limpiar todas">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0 0 1rem 0;">
                            üíæ Las contribuciones se guardan autom√°ticamente y persisten al recargar la p√°gina
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto;">
                `;
                
                app.userContributions.forEach(contrib => {
                    html += `
                        <div class="bg-white-box" style="padding: 1rem; border-radius: 6px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                        ${contrib.asignaturaName} - Tema ${contrib.tema}
                                    </div>
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${contrib.question}</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                        <div>‚úÖ ${contrib.answer}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="app.editContribution('${contrib.id}')" 
                                            style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 4px; padding: 0.5rem; cursor: pointer; flex-shrink: 0;"
                                            title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="app.deleteContribution('${contrib.id}')" 
                                            style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 4px; padding: 0.5rem; cursor: pointer; flex-shrink: 0;"
                                            title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                listContainer.innerHTML = html;
            },
            
            // Actualizar temas disponibles seg√∫n asignatura seleccionada
            updateContribTemas: () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                const temaInput = document.getElementById('contrib-tema');
                
                if (asignaturaId) {
                    // Con BD, permitimos hasta 50 temas (ya no dependemos del JSON)
                    temaInput.max = 50;
                    temaInput.placeholder = 'N√∫mero de tema (1-50)';
                } else {
                    temaInput.max = 50;
                    temaInput.placeholder = 'N√∫mero de tema (ej: 1, 2, 3...)';
                }
            },
            
            // Enviar contribuci√≥n
            submitContribution: async () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                const especialidadId = app.userEspecialidad; // Usar especialidad fija del usuario
                const tema = document.getElementById('contrib-tema').value;
                const question = document.getElementById('contrib-question').value.trim();
                const tipo = app.contribTipo || 'test'; // test, ia, desarrollo
                
                // Validaciones b√°sicas
                if (!asignaturaId) {
                    app.showToast('‚ö†Ô∏è Selecciona una asignatura');
                    return;
                }
                
                // Validar tema como n√∫mero entero entre 1 y 50
                const temaNum = parseInt(tema);
                if (!tema || isNaN(temaNum) || temaNum < 1 || temaNum > 50 || tema.includes('.')) {
                    app.showToast('‚ö†Ô∏è El tema debe ser un n√∫mero entero entre 1 y 50');
                    document.getElementById('contrib-tema').focus();
                    return;
                }
                if (!question) {
                    app.showToast('‚ö†Ô∏è Escribe una pregunta');
                    return;
                }
                
                let options = [];
                let answer = '';
                let respuestaDesarrollo = '';
                
                // Validaciones seg√∫n tipo
                if (tipo === 'desarrollo') {
                    // Para desarrollo, validar respuesta modelo
                    respuestaDesarrollo = document.getElementById('contrib-respuesta-desarrollo').value.trim();
                    if (!respuestaDesarrollo) {
                        app.showToast('‚ö†Ô∏è Escribe la respuesta modelo');
                        document.getElementById('contrib-respuesta-desarrollo').focus();
                        return;
                    }
                } else {
                    // Para test y ia, validar opciones
                    const option1 = document.getElementById('contrib-option-1').value.trim();
                    const option2 = document.getElementById('contrib-option-2').value.trim();
                    const option3 = document.getElementById('contrib-option-3').value.trim();
                    const option4 = document.getElementById('contrib-option-4').value.trim();
                    const correctIdx = document.getElementById('contrib-correct').value;
                    
                    if (!option1 || !option2 || !option3 || !option4) {
                        app.showToast('‚ö†Ô∏è Completa las 4 opciones');
                        return;
                    }
                    if (!correctIdx) {
                        app.showToast('‚ö†Ô∏è Selecciona la respuesta correcta');
                        return;
                    }
                    
                    options = [option1, option2, option3, option4];
                    answer = options[parseInt(correctIdx) - 1];
                }
                
                // Buscar asignatura
                let asignatura = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                let asignaturaNombre = '';
                
                if (!asignatura && especialidadId) {
                    const asignaturasEsp = especialidadId === 'orientacion-educativa' 
                        ? CONFIG.asignaturas.especialidadOrientacion 
                        : CONFIG.asignaturas.especialidad;
                    
                    for (const asig of asignaturasEsp) {
                        const expectedId = `${especialidadId}-${asig.id}`;
                        if (expectedId === asignaturaId) {
                            asignaturaNombre = asig.nombre;
                            break;
                        }
                    }
                }
                
                if (!asignatura && !asignaturaNombre) {
                    app.showToast('‚ùå Error: Asignatura no encontrada');
                    return;
                }
                
                if (asignatura) {
                    asignaturaNombre = asignatura.nombre;
                }
                
                const isEditing = !!app.editingDbQuestionId;
                const esObligatoria = asignatura && asignatura.tipo === 'obligatoria';
                
                // Crear objeto para guardar en la BD
                const questionData = {
                    pregunta: question,
                    opciones: tipo === 'desarrollo' ? JSON.stringify([]) : JSON.stringify(options),
                    respuesta_correcta: tipo === 'desarrollo' ? respuestaDesarrollo : answer,
                    especialidad: esObligatoria ? '' : (especialidadId || ''),
                    asignatura: asignaturaId,
                    asignatura_nombre: asignaturaNombre,
                    tema: temaNum,
                    autor: app.getUserId(),
                    fecha_creacion: isEditing ? undefined : new Date().toISOString(),
                    aprobada: true,
                    // Nuevos campos para tipo
                    tipo: tipo === 'desarrollo' ? 'desarrollo' : 'test', // test o desarrollo
                    is_ai: tipo === 'ia' // true si es generada con IA
                };
                
                // Mostrar estado de carga
                const submitBtn = document.querySelector('#contrib-form-area button[onclick="app.submitContribution()"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = isEditing ? '‚è≥ Guardando...' : '‚è≥ Enviando...';
                }
                
                try {
                    if (isEditing) {
                        // Actualizar pregunta existente
                        const url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${app.editingDbQuestionId}`;
                        
                        if (!questionData.fecha_creacion) delete questionData.fecha_creacion;
                        
                        const dataToUpdate = {
                            ...questionData,
                            opciones: typeof questionData.opciones === 'string' 
                                ? JSON.parse(questionData.opciones) 
                                : questionData.opciones
                        };
                        
                        const response = await fetch(url, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_CONFIG.anonKey,
                                'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(dataToUpdate)
                        });
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        app.showToast('‚úÖ ¬°Pregunta actualizada correctamente!');
                        app.editingDbQuestionId = null;
                    } else {
                        await app.saveQuestionToDb(questionData);
                        const tipoLabel = tipo === 'ia' ? 'ü§ñ Test IA' : tipo === 'desarrollo' ? 'üìÑ Desarrollo' : 'üìù Test';
                        app.showToast(`‚úÖ ¬°Pregunta ${tipoLabel} enviada!`);
                    }
                    
                    // Guardar el tema para la pr√≥xima pregunta
                    app.contribState.tema = temaNum;
                    app.saveContribState();
                    
                    // Limpiar campos
                    document.getElementById('contrib-question').value = '';
                    if (tipo === 'desarrollo') {
                        document.getElementById('contrib-respuesta-desarrollo').value = '';
                    } else {
                        document.getElementById('contrib-option-1').value = '';
                        document.getElementById('contrib-option-2').value = '';
                        document.getElementById('contrib-option-3').value = '';
                        document.getElementById('contrib-option-4').value = '';
                        document.getElementById('contrib-correct').value = '';
                    }
                    
                    document.getElementById('contrib-question').focus();
                    app.renderDbContributionsList();
                    
                } catch (error) {
                    console.error('Error enviando pregunta:', error);
                    app.showToast('‚ùå Error al enviar. Int√©ntalo de nuevo.');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '‚ûï A√±adir Pregunta';
                    }
                }
            },
            
            // Renderizar lista de contribuciones del usuario desde la BD (filtrada)
            renderDbContributionsList: async () => {
                const listContainer = document.getElementById('contributions-list');
                if (!listContainer) return;
                
                // Obtener filtros seleccionados (usar especialidad fija del usuario)
                const asignaturaSelect = document.getElementById('contrib-asignatura');
                const especialidadFilter = app.userEspecialidad || '';
                const asignaturaFilter = asignaturaSelect ? asignaturaSelect.value : '';
                
                listContainer.innerHTML = '<div class="loading-box"><p>‚è≥ Cargando tus preguntas...</p></div>';
                
                try {
                    // Construir query con filtros
                    const userId = app.getUserId();
                    const query = { autor: userId };
                    
                    // Construir URL evitando m√∫ltiples `or=` (se pisan entre s√≠ en PostgREST)
                    let url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*&autor=eq.${userId}`;
                    const andParts = [];
                    // Solo mostrar preguntas activas (las desactivadas desaparecen de esta lista)
                    andParts.push('or(aprobada.is.null,aprobada.eq.true)');
                    // Para especialidad, incluir tambi√©n preguntas sin especialidad (obligatorias)
                    if (especialidadFilter) {
                        andParts.push(`or(especialidad.eq.${especialidadFilter},especialidad.eq.,especialidad.is.null)`);
                    }
                    if (andParts.length) {
                        url += `&and=(${andParts.join(',')})`;
                    }
                    if (asignaturaFilter) url += `&asignatura=eq.${asignaturaFilter}`;
                    
                    console.log('üîç Cargando preguntas filtradas');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const myQuestions = await response.json();
                    console.log('‚úÖ Preguntas cargadas:', myQuestions.length);
                    
                    // Construir mensaje de filtro activo
                    let filterMsg = '';
                    if (especialidadFilter || asignaturaFilter) {
                        filterMsg = `<p style="font-size: 0.85rem; color: var(--info); margin: 0 0 1rem 0;">üîç Filtrado por: ${especialidadFilter ? CONFIG.especialidades[especialidadFilter] : ''} ${asignaturaFilter ? '‚Üí ' + (asignaturaSelect.options[asignaturaSelect.selectedIndex]?.text || asignaturaFilter) : ''}</p>`;
                    }
                    
                    if (myQuestions.length === 0) {
                        listContainer.innerHTML = `
                            <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; text-align: center;">
                                ${filterMsg}
                                <p class="text-muted">${especialidadFilter || asignaturaFilter ? 'No tienes preguntas con estos filtros' : 'No has enviado preguntas todav√≠a'}</p>
                                <p style="font-size: 0.85rem; color: var(--text-secondary);">Las preguntas que env√≠es aparecer√°n aqu√≠ y estar√°n disponibles para todos los usuarios.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="font-size: 1.1rem; margin: 0;">üìã Tus Preguntas Enviadas (${myQuestions.length})</h3>
                            </div>
                            ${filterMsg}
                            <p style="font-size: 0.85rem; color: var(--success); margin: 0 0 1rem 0;">
                                ‚úÖ Estas preguntas ya est√°n disponibles para todos los usuarios
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto;">
                    `;
                    
                    myQuestions.forEach(q => {
                        let opciones = q.opciones;
                        if (typeof opciones === 'string') {
                            try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                        }
                        
                        // Determinar tipo y badges
                        const isDesarrollo = q.tipo === 'desarrollo';
                        const isAI = q.is_ai === true;
                        let tipoBadge = '';
                        let borderColor = 'var(--border)';
                        
                        if (isDesarrollo) {
                            tipoBadge = '<span style="background: #fef3c7; color: #92400e; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üìÑ Desarrollo</span>';
                            borderColor = '#f59e0b';
                        } else if (isAI) {
                            tipoBadge = '<span style="background: #ede9fe; color: #6d28d9; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ü§ñ IA</span>';
                            borderColor = '#8b5cf6';
                        }
                        
                        // Guardar datos para edici√≥n
                        const qDataStr = encodeURIComponent(JSON.stringify({
                            id: q.id,
                            pregunta: q.pregunta,
                            opciones: opciones,
                            respuesta_correcta: q.respuesta_correcta,
                            tema: q.tema,
                            especialidad: q.especialidad,
                            asignatura: q.asignatura,
                            asignatura_nombre: q.asignatura_nombre,
                            tipo: q.tipo,
                            is_ai: q.is_ai
                        }));
                        
                        html += `
                            <div class="bg-white-box" style="padding: 1rem; border-radius: 6px; border: 1px solid var(--border); border-left: 3px solid ${borderColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                            <span>${q.asignatura_nombre || q.asignatura} - Tema ${q.tema}</span>
                                            ${tipoBadge}
                                            ${q.especialidad ? `<span class="tag tag-especialidad">${CONFIG.especialidades[q.especialidad] || q.especialidad}</span>` : ''}
                                        </div>
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${q.pregunta}</div>
                                        <div style="font-size: 0.9rem; color: ${isDesarrollo ? 'var(--text-secondary)' : 'var(--success)'};">
                                            ${isDesarrollo ? 'üìñ ' : '‚úÖ '}${q.respuesta_correcta.substring(0, 150)}${q.respuesta_correcta.length > 150 ? '...' : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                                        <button onclick="app.editMyQuestion('${qDataStr}')" 
                                                style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 4px; padding: 0.5rem; cursor: pointer;"
                                                title="Editar pregunta">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="app.deactivateMyQuestion('${q.id}')" 
                                                style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 4px; padding: 0.5rem; cursor: pointer;"
                                                title="Desactivar pregunta">
                                            üö´
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                    listContainer.innerHTML = html;
                    
                } catch (error) {
                    console.error('Error cargando contribuciones:', error);
                    listContainer.innerHTML = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <p class="text-muted">‚ö†Ô∏è Error conectando con la base de datos</p>
                            <button class="btn btn-outline" onclick="app.renderDbContributionsList()" style="margin-top: 1rem;">Reintentar</button>
                        </div>
                    `;
                }
            },
            
            // Editar pregunta propia
            editMyQuestion: (qDataStr) => {
                const qData = JSON.parse(decodeURIComponent(qDataStr));
                
                // Guardar ID para actualizaci√≥n (Supabase usa 'id' no '_id')
                app.editingDbQuestionId = qData.id || qData._id;
                
                // Configurar selector de asignatura
                const asigSelect = document.getElementById('contrib-asignatura');
                
                // Mostrar formulario
                app.startContributing();
                
                // Rellenar datos despu√©s de un peque√±o delay
                setTimeout(() => {
                    if (asigSelect) asigSelect.value = qData.asignatura;
                    
                    // Determinar tipo
                    const isDesarrollo = qData.tipo === 'desarrollo';
                    const isAI = qData.is_ai === true;
                    
                    // Activar tipo correcto
                    if (isDesarrollo) {
                        app.setContribTipo('desarrollo');
                    } else if (isAI) {
                        app.setContribTipo('ia');
                    } else {
                        app.setContribTipo('test');
                    }
                    
                    document.getElementById('contrib-tema').value = qData.tema;
                    document.getElementById('contrib-question').value = qData.pregunta;
                    
                    if (isDesarrollo) {
                        document.getElementById('contrib-respuesta-desarrollo').value = qData.respuesta_correcta;
                    } else {
                        document.getElementById('contrib-option-1').value = qData.opciones[0] || '';
                        document.getElementById('contrib-option-2').value = qData.opciones[1] || '';
                        document.getElementById('contrib-option-3').value = qData.opciones[2] || '';
                        document.getElementById('contrib-option-4').value = qData.opciones[3] || '';
                        
                        // Seleccionar respuesta correcta
                        const correctIdx = qData.opciones.indexOf(qData.respuesta_correcta) + 1;
                        document.getElementById('contrib-correct').value = correctIdx > 0 ? correctIdx : '';
                    }
                    
                    // Cambiar bot√≥n de enviar
                    const submitBtn = document.querySelector('#contrib-form-area button[onclick="app.submitContribution()"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = 'üíæ Guardar Cambios';
                        submitBtn.style.background = '#3b82f6';
                    }
                    
                    app.showToast('‚úèÔ∏è Editando pregunta');
                }, 150);
            },
            
            // Desactivar pregunta propia (opci√≥n A: usuarios NO borran, solo desactivan)
            deactivateMyQuestion: async (questionId) => {
                if (!confirm('¬øDesactivar esta pregunta? Dejar√° de aparecer en los tests.')) return;
                
                try {
                    await app.deleteQuestionFromDb(questionId);
                    app.showToast('üö´ Pregunta desactivada');
                    app.renderDbContributionsList();
                } catch (error) {
                    app.showToast('‚ùå Error al desactivar');
                }
            },
            
            // Renderizar vista para explorar todas las preguntas de la BD
            renderBrowseDbQuestions: async (container) => {
                // Opciones de especialidad
                const especialidadOptions = Object.entries(CONFIG.especialidades).map(([id, nombre]) => 
                    `<option value="${id}">${nombre}</option>`
                ).join('');
                
                container.innerHTML = `
                    <div class="card">
                        <h2>üîç Explorar Preguntas de la Base de Datos</h2>
                        <p class="text-muted" style="margin-bottom: 2rem;">Busca y filtra preguntas enviadas por todos los usuarios. Puedes iniciar un test con las preguntas seleccionadas.</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">üîé Filtros</h3>
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 1; min-width: 200px;">
                                    <label class="form-label">üéì Especialidad:</label>
                                    <select id="db-filter-especialidad" class="form-select" onchange="app.loadDbQuestionsFiltered()">
                                        <option value="">Todas</option>
                                        ${especialidadOptions}
                                    </select>
                                </div>
                                
                                <div class="form-group" style="flex: 1; min-width: 200px;">
                                    <label class="form-label">üìö Tema:</label>
                                    <input type="number" id="db-filter-tema" class="form-select" placeholder="Ej: 1, 2, 3..." min="1" max="50" onchange="app.loadDbQuestionsFiltered()">
                                </div>
                            </div>
                            
                            <button class="btn" onclick="app.loadDbQuestionsFiltered()" style="width: 100%;">
                                üîÑ Cargar Preguntas
                            </button>
                        </div>
                        
                        <div id="db-questions-stats" style="margin-bottom: 1rem;"></div>
                        
                        <div id="db-questions-list">
                            <div class="loading-box">
                                <p>Selecciona filtros y pulsa "Cargar Preguntas"</p>
                            </div>
                        </div>
                        
                        <div id="db-test-actions" style="display: none; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-success" onclick="app.startDbQuestionsTest()" style="width: 100%;">
                                üìù Iniciar Test con Preguntas Seleccionadas
                            </button>
                        </div>
                        
                        <button class="btn btn-outline" onclick="app.navigate('contribute')" style="width: 100%; margin-top: 1rem;">
                            ‚¨ÖÔ∏è Volver
                        </button>
                    </div>
                `;
            },
            
            // Cargar preguntas filtradas de la BD
            loadDbQuestionsFiltered: async () => {
                const especialidad = document.getElementById('db-filter-especialidad').value;
                const tema = document.getElementById('db-filter-tema').value;
                const listContainer = document.getElementById('db-questions-list');
                const statsContainer = document.getElementById('db-questions-stats');
                const actionsContainer = document.getElementById('db-test-actions');
                
                listContainer.innerHTML = '<div class="loading-box"><p>‚è≥ Cargando preguntas...</p></div>';
                statsContainer.innerHTML = '';
                actionsContainer.style.display = 'none';
                
                try {
                    let url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*`;
                    
                    if (especialidad) url += `&especialidad=eq.${especialidad}`;
                    if (tema) url += `&tema=eq.${parseInt(tema)}`;
                    
                    console.log('üîç Cargando preguntas filtradas...');
                    console.log('üì° URL:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    console.log('üì¨ Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const questions = await response.json();
                    
                    // Guardar para uso posterior
                    app.dbQuestionsForTest = questions;
                    
                    if (questions.length === 0) {
                        listContainer.innerHTML = `
                            <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <p class="text-muted">No se encontraron preguntas con estos filtros</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Mostrar estad√≠sticas
                    const byAsignatura = {};
                    questions.forEach(q => {
                        const key = q.asignatura_nombre || q.asignatura;
                        if (!byAsignatura[key]) byAsignatura[key] = 0;
                        byAsignatura[key]++;
                    });
                    
                    statsContainer.innerHTML = `
                        <div class="bg-blue-light" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>üìä ${questions.length} preguntas encontradas</strong>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                ${Object.entries(byAsignatura).map(([asig, count]) => 
                                    `${asig}: ${count}`
                                ).join(' ¬∑ ')}
                            </div>
                        </div>
                    `;
                    
                    // Mostrar lista de preguntas
                    let html = '<div style="display: flex; flex-direction: column; gap: 1rem; max-height: 500px; overflow-y: auto;">';
                    
                    questions.forEach((q, idx) => {
                        let opciones = q.opciones;
                        if (typeof opciones === 'string') {
                            try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                        }
                        
                        const isOwner = q.autor === app.getUserId();
                        
                        html += `
                            <div class="bg-white-box" style="padding: 1rem; border-radius: 6px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                            <span class="tag">${q.asignatura_nombre || q.asignatura}</span>
                                            <span class="tag">Tema ${q.tema}</span>
                                            ${q.especialidad ? `<span class="tag tag-especialidad">${CONFIG.especialidades[q.especialidad] || q.especialidad}</span>` : ''}
                                            ${isOwner ? '<span class="tag" style="background: var(--success); color: white;">‚úì Tuya</span>' : ''}
                                        </div>
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${idx + 1}. ${q.pregunta}</div>
                                        <div style="font-size: 0.85rem; margin-left: 1rem;">
                                            ${opciones.map((op, i) => `
                                                <div style="margin-bottom: 0.25rem; ${op === q.respuesta_correcta ? 'color: var(--success); font-weight: 600;' : 'color: var(--text-secondary);'}">
                                                    ${op === q.respuesta_correcta ? '‚úì' : '‚óã'} ${op}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    listContainer.innerHTML = html;
                    
                    // Mostrar bot√≥n de test si hay preguntas
                    if (questions.length > 0) {
                        actionsContainer.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    listContainer.innerHTML = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <p class="text-muted">‚ö†Ô∏è Error conectando con la base de datos</p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Verifica que CORS est√© configurado en restdb.io<br>
                                (Settings ‚Üí Security & API ‚Üí CORS ‚Üí a√±ade <code>*</code>)
                            </p>
                            <button class="btn btn-outline" onclick="app.loadDbQuestionsFiltered()" style="margin-top: 1rem;">Reintentar</button>
                        </div>
                    `;
                }
            },
            
            // Preguntas seleccionadas para test
            dbQuestionsForTest: [],
            
            // Iniciar test con preguntas de la BD
            startDbQuestionsTest: () => {
                if (!app.dbQuestionsForTest || app.dbQuestionsForTest.length === 0) {
                    app.showToast('‚ö†Ô∏è No hay preguntas cargadas');
                    return;
                }
                
                // Convertir preguntas de BD al formato del sistema
                app.activeQuizQuestions = app.dbQuestionsForTest.map(q => {
                    let opciones = q.opciones;
                    if (typeof opciones === 'string') {
                        try { opciones = JSON.parse(opciones); } catch(e) { opciones = [q.respuesta_correcta]; }
                    }
                    
                    return {
                        id: q.id,
                        pregunta: q.pregunta,
                        opciones: opciones,
                        respuesta_correcta: q.respuesta_correcta,
                        subject: q.asignatura_nombre || q.asignatura,
                        tema: q.tema,
                        fromDb: true
                    };
                });
                
                // Resetear estado del quiz
                app.quiz = {
                    index: 0,
                    score: 0,
                    answered: false,
                    failedQuestions: [],
                    answers: []
                };
                
                // Aleatorizar si est√° configurado
                if (app.quizSettings.randomOrder) {
                    app.activeQuizQuestions = app.shuffle([...app.activeQuizQuestions]);
                }
                
                app.showToast(`üìù Iniciando test con ${app.activeQuizQuestions.length} preguntas de la BD`);
                app.navigate('quiz');
            },
            
            // Renderizar vista de administraci√≥n
            renderAdmin: (container) => {
                container.innerHTML = `
                    <div class="card">
                        <h2>üîß Panel de Administraci√≥n</h2>
                        <p class="text-muted" style="margin-bottom: 2rem;">Herramienta para procesar archivos de contribuciones y generar archivos listos para GitHub.</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">üìÅ Procesar y Fusionar Contribuciones</h3>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Sube archivos de contribuciones y opcionalmente el archivo final existente para fusionarlos autom√°ticamente.
                            </p>
                            
                            <div class="form-group">
                                <label class="form-label">üìã Archivos de contribuciones (nuevas preguntas):</label>
                                <input type="file" id="admin-contrib-files" accept=".json" multiple class="form-select" style="cursor: pointer;">
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Archivos exportados desde "Contribuir a Preguntas"
                                </p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìÇ Archivo final existente (opcional):</label>
                                <input type="file" id="admin-existing-file" accept=".json" class="form-select" style="cursor: pointer;">
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Si ya tienes preguntas en producci√≥n, sube el archivo para fusionarlo con las nuevas contribuciones
                                </p>
                            </div>
                            
                            <button class="btn" onclick="app.processContributions()" style="width: 100%;">
                                üîÄ Procesar y Fusionar
                            </button>
                        </div>
                        
                        <div id="process-result" style="display: none;"></div>
                        
                        <button class="btn btn-outline" onclick="app.navigate('contribute')" style="width: 100%; margin-top: 2rem;">
                            ‚¨ÖÔ∏è Volver a Contribuir
                        </button>
                    </div>
                `;
            },
            
            // Fusionar archivos JSON
            processContributions: async () => {
                const contribInput = document.getElementById('admin-contrib-files');
                const existingInput = document.getElementById('admin-existing-file');
                
                if (!contribInput.files.length) {
                    app.showToast('‚ö†Ô∏è Selecciona al menos un archivo de contribuciones');
                    return;
                }
                
                try {
                    // Leer archivo existente si se proporcion√≥
                    let existingData = null;
                    if (existingInput.files.length > 0) {
                        const existingText = await existingInput.files[0].text();
                        existingData = JSON.parse(existingText);
                        console.log('üìÇ Archivo existente cargado:', existingData);
                    }
                    
                    // Leer todos los archivos de contribuciones
                    const allContributions = [];
                    for (let file of contribInput.files) {
                        const text = await file.text();
                        const contributions = JSON.parse(text);
                        if (Array.isArray(contributions)) {
                            allContributions.push(...contributions);
                        }
                    }
                    
                    if (allContributions.length === 0 && !existingData) {
                        app.showToast('‚ö†Ô∏è No se encontraron contribuciones v√°lidas');
                        return;
                    }
                    
                    // Agrupar por asignatura
                    // Importante: Usar el asignaturaId completo (con prefijo de especialidad si existe)
                    // para mantener separadas las asignaturas de diferentes especialidades
                    const byAsignatura = {};
                    allContributions.forEach(contrib => {
                        if (!byAsignatura[contrib.asignaturaId]) {
                            byAsignatura[contrib.asignaturaId] = {
                                name: contrib.asignaturaName,
                                contributions: []
                            };
                        }
                        byAsignatura[contrib.asignaturaId].contributions.push(contrib);
                    });
                    
                    // Generar resumen y archivos por asignatura
                    const resultDiv = document.getElementById('process-result');
                    let resultHTML = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">‚úÖ Procesamiento Completado</h3>
                            <p><strong>${allContributions.length}</strong> contribuciones procesadas de <strong>${contribInput.files.length}</strong> archivo(s)</p>
                            <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                                Agrupadas en <strong>${Object.keys(byAsignatura).length}</strong> asignatura(s):
                            </p>
                        </div>
                    `;
                    
                    // Crear un archivo por cada asignatura
                    for (const [asigId, data] of Object.entries(byAsignatura)) {
                        // Agrupar por tema dentro de cada asignatura
                        const byTema = {};
                        
                        // FUSI√ìN: Si existe archivo previo, cargar sus preguntas primero
                        if (existingData && existingData.temas) {
                            existingData.temas.forEach(tema => {
                                if (!byTema[tema.numero]) {
                                    byTema[tema.numero] = [];
                                }
                                // Las preguntas existentes ya est√°n en formato correcto
                                byTema[tema.numero].push(...tema.preguntas);
                            });
                            console.log('‚úÖ Preguntas existentes cargadas en temas:', Object.keys(byTema));
                        }
                        
                        // Agregar las nuevas contribuciones
                        data.contributions.forEach(contrib => {
                            if (!byTema[contrib.tema]) {
                                byTema[contrib.tema] = [];
                            }
                            // Convertir a formato espa√±ol para que coincida con los archivos existentes
                            byTema[contrib.tema].push({
                                id: contrib.id || `contrib_${Date.now()}`,
                                pregunta: contrib.question,
                                opciones: contrib.options,
                                respuesta_correcta: contrib.answer
                            });
                        });
                        
                        // Crear estructura final
                        const temas = [];
                        for (const [temaNum, preguntas] of Object.entries(byTema)) {
                            temas.push({
                                numero: parseInt(temaNum),
                                nombre: `Tema ${temaNum}`,
                                preguntas: preguntas
                            });
                        }
                        
                        // Ordenar por n√∫mero de tema
                        temas.sort((a, b) => a.numero - b.numero);
                        
                        // Calcular totales
                        const totalPreguntas = temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const nuevasPreguntas = data.contributions.length;
                        const existentes = totalPreguntas - nuevasPreguntas;
                        
                        // Determinar tipo de asignatura basado en el asignaturaId
                        let tipo = 'optativa'; // default
                        if (asigId.includes('-')) {
                            // Si tiene guiones m√∫ltiples, probablemente es de especialidad
                            const parts = asigId.split('-');
                            if (parts.length > 2) {
                                tipo = 'especialidad';
                            } else {
                                // Verificar si es obligatoria
                                const obligatorias = ['aprendizaje-desarrollo-personalidad', 'procesos-contextos-educativos', 'sociedad-familia-educacion'];
                                tipo = obligatorias.includes(asigId) ? 'obligatoria' : 'optativa';
                            }
                        }
                        
                        const outputData = {
                            asignatura: data.name,
                            tipo: tipo,
                            temas: temas
                        };
                        const jsonStr = JSON.stringify(outputData, null, 2);
                        
                        // Obtener baseFileName de la primera contribuci√≥n (todas deber√≠an tener el mismo)
                        const baseFileName = data.contributions[0]?.baseFileName || null;
                        
                        // Crear bot√≥n de descarga para esta asignatura
                        resultHTML += `
                            <div class="bg-white-box" style="padding: 1rem; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${data.name}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${existingData ? `
                                                <span style="color: var(--success);">‚úÖ ${existentes} existentes</span> + 
                                                <span style="color: var(--accent);">‚ûï ${nuevasPreguntas} nuevas</span> = 
                                                <strong>${totalPreguntas} total</strong> ¬∑ ${temas.length} tema(s)
                                            ` : `${data.contributions.length} pregunta(s) ¬∑ ${temas.length} tema(s)`}
                                        </div>
                                        ${baseFileName ? `<div style="font-size: 0.75rem; color: var(--accent); margin-top: 0.25rem;">üìÇ ${baseFileName}.json</div>` : ''}
                                    </div>
                                    <button class="btn" onclick="app.downloadAsignaturaJSON('${asigId}', '${data.name}', ${JSON.stringify(outputData).replace(/"/g, '&quot;')}, '${baseFileName || ''}')" style="padding: 0.5rem 1rem; white-space: nowrap;">
                                        üì• Descargar
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    resultHTML += `
                        <div class="bg-light-box" style="padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                üí° <strong>Siguiente paso:</strong> ${existingData ? 
                                    'El archivo descargado contiene TODAS las preguntas (existentes + nuevas) fusionadas. Reemplaza el archivo en GitHub con este nuevo.' : 
                                    'Descarga cada archivo y reempl√°zalo en la carpeta correspondiente de GitHub.'}
                            </p>
                        </div>
                    `;
                    
                    resultDiv.innerHTML = resultHTML;
                    resultDiv.style.display = 'block';
                    
                    app.showToast('‚úÖ Contribuciones procesadas correctamente');
                } catch (e) {
                    console.error(e);
                    app.showToast('‚ùå Error al procesar los archivos: ' + e.message);
                }
            },
            
            // Descargar JSON de asignatura
            downloadAsignaturaJSON: (asigId, asigName, data, baseFileName) => {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Usar baseFileName si est√° disponible (viene de las contribuciones)
                // Si no, intentar buscar en asignaturasDisponibles o usar el asigId como fallback
                let fileName = baseFileName;
                
                if (!fileName) {
                    const asignatura = app.asignaturasDisponibles.find(a => a.id === asigId);
                    if (asignatura && asignatura.archivo) {
                        fileName = asignatura.archivo.split('/').pop().replace('.json', '');
                    } else {
                        // √öltimo fallback: usar el ID sin prefijo de especialidad
                        // Ej: "tecnologias-informatica-complementos-formacion-disciplinar" ‚Üí "complementos-formacion-disciplinar"
                        const parts = asigId.split('-');
                        if (parts.length > 3) {
                            // Probablemente tiene prefijo de especialidad (2 palabras)
                            fileName = parts.slice(2).join('-');
                        } else {
                            fileName = asigId;
                        }
                    }
                }
                
                link.download = `${fileName}.json`;
                link.click();
                URL.revokeObjectURL(url);
                app.showToast(`üì• ${asigName} descargado`);
            },
            
            // Confirmar y reiniciar todos los datos
            confirmResetAllData: () => {
                if (confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√°:\n\n‚Ä¢ Todo el historial de tests\n‚Ä¢ Todas las estad√≠sticas\n‚Ä¢ Todas las preguntas marcadas\n\n¬øEst√°s seguro de que quieres reiniciar todos los datos?')) {
                    // Limpiar todo
                    app.testHistory = [];
                    app.stats = {};
                    app.markedQuestions.clear();
                    
                    // Guardar cambios
                    app.saveTestHistory();
                    app.saveStats();
                    app.saveMarkedQuestions();
                    
                    app.showToast('‚úÖ Todos los datos han sido reiniciados');
                    app.navigate('home');
                }
            },
            
            renderSearch: (container) => {
                // Usar el estado de b√∫squeda guardado
                const initialTerm = app.searchState.term;
                const initialResults = app.searchState.resultsHTML || '<p style="color:#94a3b8; text-align:center;">Empieza a escribir para buscar en preguntas y respuestas.</p>';
                
                // Inicializar filtros de b√∫squeda si no existen
                if (!app.searchFilters) {
                    app.searchFilters = {
                        especialidad: app.userEspecialidad || '',
                        asignatura: ''
                    };
                }
                
                // Generar opciones de asignaturas basadas en la especialidad seleccionada
                const getAsignaturasOptions = () => {
                    let options = '<option value="">Todas las asignaturas</option>';
                    const filtroEsp = app.searchFilters.especialidad;
                    
                    // Si no hay filtro o es "todas", mostrar todas las categor√≠as
                    if (!filtroEsp) {
                        // Obligatorias
                        options += '<optgroup label="üìò Obligatorias">';
                        CONFIG.asignaturas.obligatorias.forEach(a => {
                            const selected = app.searchFilters.asignatura === a.nombre ? 'selected' : '';
                            options += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                        });
                        options += '</optgroup>';
                        
                        // Optativas
                        options += '<optgroup label="üìñ Optativas">';
                        CONFIG.asignaturas.optativas.forEach(a => {
                            const selected = app.searchFilters.asignatura === a.nombre ? 'selected' : '';
                            options += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                        });
                        options += '</optgroup>';
                        
                        return options;
                    }
                    
                    // Si el filtro es "obligatorias"
                    if (filtroEsp === 'obligatorias') {
                        CONFIG.asignaturas.obligatorias.forEach(a => {
                            const selected = app.searchFilters.asignatura === a.nombre ? 'selected' : '';
                            options += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                        });
                        return options;
                    }
                    
                    // Si el filtro es "optativas"
                    if (filtroEsp === 'optativas') {
                        CONFIG.asignaturas.optativas.forEach(a => {
                            const selected = app.searchFilters.asignatura === a.nombre ? 'selected' : '';
                            options += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                        });
                        return options;
                    }
                    
                    // Si es una especialidad espec√≠fica
                    const espNombre = CONFIG.especialidades[filtroEsp] || filtroEsp;
                    const asigEsp = filtroEsp === 'orientacion-educativa' 
                        ? CONFIG.asignaturas.especialidadOrientacion 
                        : CONFIG.asignaturas.especialidad;
                    
                    asigEsp.forEach(a => {
                        const selected = app.searchFilters.asignatura === a.nombre ? 'selected' : '';
                        options += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                    });
                    
                    return options;
                };
                
                // Generar opciones de especialidades
                const getEspecialidadesOptions = () => {
                    let options = '<option value="">Todas las especialidades</option>';
                    // Opciones especiales para obligatorias y optativas
                    options += '<option value="obligatorias"' + (app.searchFilters.especialidad === 'obligatorias' ? ' selected' : '') + '>üìò Obligatorias</option>';
                    options += '<option value="optativas"' + (app.searchFilters.especialidad === 'optativas' ? ' selected' : '') + '>üìñ Optativas</option>';
                    // Especialidades
                    Object.entries(CONFIG.especialidades).forEach(([id, nombre]) => {
                        const selected = app.searchFilters.especialidad === id ? 'selected' : '';
                        options += `<option value="${id}" ${selected}>üéì ${nombre}</option>`;
                    });
                    return options;
                };

                container.innerHTML = `
                    <div class="card">
                        <h2>üîç Buscador Global</h2>
                        
                        <!-- Filtros -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">üéì Especialidad</label>
                                <select id="search-filter-especialidad" class="form-input" style="padding: 0.5rem; font-size: 0.9rem;"
                                        onchange="app.changeSearchFilter('especialidad', this.value)">
                                    ${getEspecialidadesOptions()}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">üìö Asignatura</label>
                                <select id="search-filter-asignatura" class="form-input" style="padding: 0.5rem; font-size: 0.9rem;"
                                        onchange="app.changeSearchFilter('asignatura', this.value)">
                                    ${getAsignaturasOptions()}
                                </select>
                            </div>
                        </div>
                        
                        <input type="text" id="search-input" class="form-input" 
                                placeholder="Busca en preguntas y respuestas..." 
                                oninput="app.handleSearch(this.value)"
                                value="${initialTerm}">
                        <div id="search-results" style="margin-top:1rem;">
                            ${initialResults}
                        </div>
                    </div>
                `;
            },
            renderDetail: (container, questionId) => {
                // Buscar en el cache de preguntas de la BD
                let foundQuestion = null;
                
                const cachedData = localStorage.getItem(app.CACHE_KEYS.questions);
                if (cachedData) {
                    try {
                        const dbQuestions = JSON.parse(cachedData);
                        const dbQ = dbQuestions.find(p => p.id == questionId);
                        if (dbQ) {
                            let opciones = dbQ.opciones;
                            if (typeof opciones === 'string') {
                                try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                            }
                            
                            foundQuestion = {
                                id: dbQ.id,
                                subject: dbQ.asignatura_nombre || dbQ.asignatura,
                                unit: dbQ.tema,
                                question: dbQ.pregunta,
                                options: opciones || [],
                                answer: dbQ.respuesta_correcta,
                                tipo: dbQ.especialidad ? 'especialidad' : 'obligatoria',
                                especialidad: dbQ.especialidad
                            };
                        }
                    } catch(e) {
                        console.error('Error buscando pregunta en cache:', e);
                    }
                }
                
                if (!foundQuestion) return app.navigate('search');
                
                const q = foundQuestion;
                let tipoClass = 'tag';
                let tipoLabel = q.tipo;
                if (q.tipo === 'obligatoria') {
                    tipoClass += ' tag-obligatoria';
                    tipoLabel = 'Obligatoria';
                } else if (q.tipo === 'optativa') {
                    tipoClass += ' tag-optativa';
                    tipoLabel = 'Optativa';
                } else if (q.tipo === 'especialidad') {
                    tipoClass += ' tag-especialidad';
                    const espNombre = q.especialidad ? (CONFIG.especialidades[q.especialidad] || q.especialidad) : 'Especialidad';
                    tipoLabel = espNombre;
                }
                
                container.innerHTML = `
                    <div class="card">
                        <button class="btn btn-outline" style="width:auto; margin-bottom:1rem;" onclick="app.navigate('search')">‚¨Ö Volver al Buscador</button>
                        <div style="margin-bottom:1rem;">
                            <span class="${tipoClass}">${tipoLabel}</span>
                            <span class="tag tag-subject">${q.subject}</span>
                            <span class="tag">Tema ${q.unit}</span>
                            <small style="color:#94a3b8; display:block; margin-top:8px;">ID: ${q.id}</small>
                        </div>
                        <h2 style="font-size:1.3rem; margin-bottom:1.5rem;">${q.question}</h2>
                        
                        <div>
                            ${q.options.map(opt => {
                                const isCorrect = opt === q.answer;
                                return `
                                    <div class="detail-option ${isCorrect ? 'detail-correct' : ''}">
                                        ${opt} ${isCorrect ? '‚úÖ (Correcta)' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },
            // --- MANEJADORES DE EVENTOS ---
            changeEspecialidad: async (especialidadId) => {
                if (especialidadId && especialidadId !== app.currentEspecialidad) {
                    app.showLoading('Cargando asignaturas de especialidad...');
                    app.currentEspecialidad = especialidadId;
                    app.currentTema = 'all'; // Resetear tema al cambiar de especialidad
                    await app.loadEspecialidadData(especialidadId);
                } else if (!especialidadId) {
                    app.currentEspecialidad = '';
                    app.currentTema = 'all'; // Resetear tema al quitar especialidad
                    app.updateAvailableSubjects();
                }
                app.savePreferences();
                app.navigate('home');
            },
            
            changeAsignatura: async (asigId) => {
                await app.selectAsignatura(asigId);
                app.currentTema = 'all'; // Resetear tema al cambiar de asignatura
                app.savePreferences();
                app.navigate('home');
            },
            
            changeTema: async (temaValue) => {
                app.currentTema = temaValue;
                await app.applyTemaFilter(temaValue);
                app.savePreferences();
                app.navigate('home');
            },
            
            // Actualizar contador de preguntas marcadas
            updateMarkedCount: () => {
                const countEl = document.getElementById('marked-count');
                const checkbox = document.getElementById('only-marked-check');
                const label = document.getElementById('marked-label');
                const clearBtn = document.getElementById('clear-marked-btn');
                
                if (countEl && app.filteredQuestions) {
                    const markedInCurrent = app.filteredQuestions.filter(q => app.markedQuestions.has(q.id)).length;
                    countEl.textContent = markedInCurrent;
                    
                    // Deshabilitar checkbox si no hay preguntas marcadas
                    if (checkbox) {
                        checkbox.disabled = markedInCurrent === 0;
                        if (markedInCurrent === 0) {
                            checkbox.checked = false;
                            app.quizSettings.onlyMarked = false;
                        }
                    }
                    
                    // Actualizar estilo del label
                    if (label) {
                        label.style.opacity = markedInCurrent === 0 ? '0.5' : '1';
                    }
                    
                    // Mostrar/ocultar bot√≥n de limpiar
                    if (clearBtn) {
                        clearBtn.style.display = app.markedQuestions.size > 0 ? 'flex' : 'none';
                    }
                }
            },
            
            // Actualizar filtros de tipo de pregunta (Test, IA, Desarrollo)
            updateTipoFilters: () => {
                const testCheck = document.getElementById('include-test-check');
                const aiCheck = document.getElementById('include-ai-check');
                const desarrolloCheck = document.getElementById('include-desarrollo-check');
                const warning = document.getElementById('tipo-filter-warning');
                
                // Verificar si al menos uno est√° marcado
                const anySelected = app.quizSettings.includeTest || app.quizSettings.includeAI || app.quizSettings.includeDesarrollo;
                
                // Mostrar/ocultar warning
                if (warning) {
                    warning.style.display = anySelected ? 'none' : 'block';
                }
                
                // Actualizar estilos visuales de los botones
                if (testCheck) {
                    const label = testCheck.closest('label');
                    if (label) {
                        label.style.border = app.quizSettings.includeTest ? '2px solid var(--primary)' : '2px solid var(--border)';
                        label.style.background = app.quizSettings.includeTest ? 'rgba(79, 70, 229, 0.1)' : 'transparent';
                    }
                }
                if (aiCheck) {
                    const label = aiCheck.closest('label');
                    if (label) {
                        label.style.border = app.quizSettings.includeAI ? '2px solid #8b5cf6' : '2px solid var(--border)';
                        label.style.background = app.quizSettings.includeAI ? 'rgba(139, 92, 246, 0.1)' : 'transparent';
                    }
                }
                if (desarrolloCheck) {
                    const label = desarrolloCheck.closest('label');
                    if (label) {
                        label.style.border = app.quizSettings.includeDesarrollo ? '2px solid #f59e0b' : '2px solid var(--border)';
                        label.style.background = app.quizSettings.includeDesarrollo ? 'rgba(245, 158, 11, 0.1)' : 'transparent';
                    }
                }
            },
            
            // Aplicar filtros de tipo de pregunta (para refrescar)
            applyQuestionFilters: () => {
                app.updateTipoFilters();
                // Refrescar la p√°gina de inicio para aplicar los nuevos filtros
                if (window.location.hash === '#home' || window.location.hash === '') {
                    app.navigate('home');
                }
            },
            checkAnswer: (btn) => {
                const q = app.activeQuizQuestions[app.quiz.index];
                const selectedOpt = btn.innerText.trim();
                const isCorrect = selectedOpt === q.answer;
                const feedback = document.getElementById('feedback-area');
                const nextBtn = document.getElementById('next-btn');
                
                // MODO EXAMEN: Permitir cambiar selecci√≥n
                if (app.examMode.active) {
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.option-btn').forEach(b => {
                        b.classList.remove('selected');
                        b.disabled = false;
                    });
                    
                    // Marcar nueva selecci√≥n
                    btn.classList.add('selected');
                    app.quiz.answered = true;
                    
                    // Guardar la respuesta en el array
                    app.quiz.answers[app.quiz.index] = {
                        questionIndex: app.quiz.index,
                        selectedOption: selectedOpt,
                        isCorrect: isCorrect
                    };
                    
                    // Mostrar bot√≥n siguiente
                    nextBtn.classList.remove('hidden');
                    return;
                }
                
                // MODO NORMAL: No permitir cambios
                if (app.quiz.answered) return;
                app.quiz.answered = true;
                
                // Guardar la respuesta en el array
                app.quiz.answers[app.quiz.index] = {
                    questionIndex: app.quiz.index,
                    selectedOption: selectedOpt,
                    isCorrect: isCorrect
                };
                
                // Ocultar bot√≥n saltar al responder
                const skipBtn = document.querySelector('.btn-warning');
                if(skipBtn) skipBtn.style.display = 'none';
                
                // Deshabilitar todos los botones
                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                
                // MODO NORMAL: Mostrar feedback inmediato
                if (isCorrect) {
                    btn.classList.add('correct');
                    app.quiz.score++;
                    feedback.innerHTML = `<b style="color:var(--success)">¬°Correcto! üéâ</b>`;
                } else {
                    btn.classList.add('incorrect');
                    feedback.innerHTML = `<b style="color:var(--error)">Incorrecto.</b><br>La respuesta correcta es: <b>${q.answer}</b>`;
                    document.querySelectorAll('.option-btn').forEach(b => {
                        if (b.innerText.trim() === q.answer) b.classList.add('correct');
                    });
                    // Guardar pregunta fallada para repaso
                    app.quiz.failedQuestions.push(q);
                }
                feedback.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            },
            skipQuestion: () => {
                const currentQ = app.activeQuizQuestions[app.quiz.index];
                app.activeQuizQuestions.splice(app.quiz.index, 1);
                app.activeQuizQuestions.push(currentQ);
                
                app.renderQuiz(document.getElementById('app-container'));
                app.showToast("Pregunta saltada ‚Ü∑");
            },
            nextQuestion: () => {
                // En modo examen, recalcular score y preguntas falladas
                if (app.examMode.active) {
                    app.quiz.score = 0;
                    app.quiz.failedQuestions = [];
                    
                    app.quiz.answers.forEach((answer, idx) => {
                        if (answer) {
                            if (answer.isCorrect) {
                                app.quiz.score++;
                            } else {
                                app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                            }
                        }
                    });
                }
                
                app.quiz.index++;
                app.navigate('quiz');
            },
            
            previousQuestion: () => {
                if (app.quiz.index > 0) {
                    // En modo examen, recalcular score y preguntas falladas antes de retroceder
                    if (app.examMode.active) {
                        app.quiz.score = 0;
                        app.quiz.failedQuestions = [];
                        
                        app.quiz.answers.forEach((answer, idx) => {
                            if (answer) {
                                if (answer.isCorrect) {
                                    app.quiz.score++;
                                } else {
                                    app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                                }
                            }
                        });
                    }
                    
                    app.quiz.index--;
                    app.navigate('quiz');
                }
            },
            
            jumpToQuestion: (index) => {
                if (!app.examMode.active) return;
                
                // Recalcular score antes de saltar
                app.quiz.score = 0;
                app.quiz.failedQuestions = [];
                
                app.quiz.answers.forEach((answer, idx) => {
                    if (answer) {
                        if (answer.isCorrect) {
                            app.quiz.score++;
                        } else {
                            app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                        }
                    }
                });
                
                app.quiz.index = index;
                app.navigate('quiz');
            },
            
            finishExam: () => {
                if (!app.examMode.active) return;
                
                const unanswered = app.activeQuizQuestions.length - app.quiz.answers.filter(a => a).length;
                
                if (unanswered > 0) {
                    const confirmMsg = `‚ö†Ô∏è Tienes ${unanswered} pregunta${unanswered > 1 ? 's' : ''} sin responder.\n\n¬øSeguro que quieres finalizar el examen?`;
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                }
                
                // Recalcular puntuaci√≥n final
                app.quiz.score = 0;
                app.quiz.failedQuestions = [];
                
                app.quiz.answers.forEach((answer, idx) => {
                    if (answer) {
                        if (answer.isCorrect) {
                            app.quiz.score++;
                        } else {
                            app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                        }
                    } else {
                        // Preguntas sin responder tambi√©n cuentan como falladas
                        app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                    }
                });
                
                // Ir directamente a resultados
                app.quiz.index = app.activeQuizQuestions.length;
                app.navigate('quiz');
            },
            
            startQuiz: () => {
                // Validar que al menos un tipo de pregunta est√© seleccionado
                if (!app.quizSettings.includeTest && !app.quizSettings.includeAI && !app.quizSettings.includeDesarrollo) {
                    app.showToast("‚ö†Ô∏è Selecciona al menos un tipo de pregunta (Test, IA o Desarrollo)");
                    return;
                }
                
                // RESETEAR MODO EXAMEN - esto es un test normal
                if (app.examMode.timer) {
                    clearInterval(app.examMode.timer);
                }
                app.examMode = {
                    active: false,
                    timeLimit: 30,
                    questionCount: 30,
                    startTime: null,
                    endTime: null,
                    timer: null
                };
                
                // Usar todas las preguntas de la asignatura actual
                let questionsForQuiz = [...app.filteredQuestions];
                
                // Filtrar por tipo de pregunta (Test normal, IA, Desarrollo)
                questionsForQuiz = questionsForQuiz.filter(q => {
                    const isTestNormal = q.tipo !== 'desarrollo' && !q.is_ai;
                    const isIA = q.is_ai === true;
                    const isDesarrollo = q.tipo === 'desarrollo';
                    
                    if (isDesarrollo && app.quizSettings.includeDesarrollo) return true;
                    if (isIA && app.quizSettings.includeAI) return true;
                    if (isTestNormal && app.quizSettings.includeTest) return true;
                    return false;
                });
                
                // Filtrar solo preguntas marcadas si est√° activado
                if (app.quizSettings.onlyMarked) {
                    questionsForQuiz = questionsForQuiz.filter(q => app.markedQuestions.has(q.id));
                    if (questionsForQuiz.length === 0) {
                        app.showToast("No hay preguntas marcadas para esta selecci√≥n.");
                        return;
                    }
                }
                
                if(questionsForQuiz.length === 0) {
                    app.showToast("No hay preguntas para esta selecci√≥n.");
                    return;
                }
                
                // Configurar test: aleatorio o en orden
                if (app.quizSettings.randomOrder) {
                    app.activeQuizQuestions = app.shuffle(questionsForQuiz);
                } else {
                    app.activeQuizQuestions = questionsForQuiz; // Mantener orden original
                }
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            
            startReviewQuiz: () => {
                if (app.quiz.failedQuestions.length === 0) {
                    app.showToast('No hay preguntas falladas para repasar');
                    return;
                }
                
                // Configurar test solo con preguntas falladas
                app.activeQuizQuestions = app.shuffle([...app.quiz.failedQuestions]);
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            renderQuizResult: (container) => {
                // Detener temporizador del modo examen si est√° activo
                if (app.examMode.active && app.examMode.timer) {
                    clearInterval(app.examMode.timer);
                    app.examMode.timer = null;
                }
                
                const total = app.activeQuizQuestions.length;
                const percent = Math.round((app.quiz.score / total) * 100);
                const numFailed = app.quiz.failedQuestions.length;
                let msg = percent >= 50 ? "¬°Buen trabajo! üëç" : "A seguir repasando üí™";
                if(percent === 100) msg = "¬°Impecable! üèÜ";
                
                const asignaturaName = app.currentAsignatura ? app.currentAsignatura.nombre : 'Sin asignatura';
                const wasExamMode = app.examMode.active;
                
                // Resetear modo examen
                if (app.examMode.active) {
                    app.examMode.active = false;
                }
                
                // Registrar test completado
                if (app.currentAsignatura) {
                    // Determinar el tema bas√°ndose en las preguntas del quiz
                    const uniqueTemas = [...new Set(app.activeQuizQuestions.map(q => q.unit))];
                    const temaName = uniqueTemas.length === 1 ? `Tema ${uniqueTemas[0]}` : 'Todos';
                    app.recordTestCompletion(app.quiz.score, total, asignaturaName, temaName);
                }
                
                // Si fue modo examen, mostrar revisi√≥n detallada
                if (wasExamMode) {
                    let reviewHTML = `
                        <div class="card">
                            <h1>üìä Resultados del Examen</h1>
                            <p style="color:#dc2626; font-weight: 600;">üéØ Modo Examen Simulado</p>
                            <p style="color:#64748b">Asignatura: ${asignaturaName}</p>
                            <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin: 1rem 0;">
                                ${app.quiz.score} / ${total}
                            </div>
                            <p style="font-size: 1.5rem;">${percent}%</p>
                            <p style="margin-bottom:1rem;">${msg}</p>
                            
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #0ea5e9;">
                                <h3 style="margin-top: 0; font-size: 1.1rem;">üìã Revisi√≥n Completa</h3>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; text-align: left;">
                    `;
                    
                    app.activeQuizQuestions.forEach((q, idx) => {
                        const answer = app.quiz.answers[idx];
                        const isCorrect = answer && answer.isCorrect;
                        const userAnswer = answer ? answer.selectedOption : 'Sin respuesta';
                        
                        reviewHTML += `
                            <div class="bg-light-box" style="padding: 1.25rem; border-radius: 8px; border-left: 4px solid ${isCorrect ? '#22c55e' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                    <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">Pregunta ${idx + 1} de ${total}</h4>
                                    <span style="font-size: 1.5rem;">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                                
                                <p style="font-weight: 600; margin-bottom: 1rem; line-height: 1.5;">${q.question}</p>
                                
                                ${!isCorrect && answer ? `
                                <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; border: 1px solid #fca5a5;">
                                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem; font-size: 0.9rem;">‚ùå Tu respuesta:</div>
                                    <div style="color: #dc2626;">${userAnswer}</div>
                                </div>
                                ` : answer ? `
                                <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; border: 1px solid #86efac;">
                                    <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem; font-size: 0.9rem;">‚úÖ Tu respuesta:</div>
                                    <div style="color: #15803d;">${userAnswer}</div>
                                </div>
                                ` : ''}
                                
                                <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 6px; border: 2px solid #22c55e;">
                                    <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem; font-size: 0.9rem;">‚úì Respuesta correcta:</div>
                                    <div style="color: #15803d; font-weight: 500;">${q.answer}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    reviewHTML += `
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 300px; margin: 0 auto;">
                                <button class="btn" onclick="app.navigate('exam-mode')">üîÅ Repetir Modo Examen</button>
                                <button class="btn btn-outline" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = reviewHTML;
                    return;
                }
                
                // Modo normal
                container.innerHTML = `
                    <div class="card text-center">
                        <h1>üìä Resultados</h1>
                        <p style="color:#64748b">Asignatura: ${asignaturaName}</p>
                        <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin: 1rem 0;">
                            ${app.quiz.score} / ${total}
                        </div>
                        <p style="font-size: 1.5rem;">${percent}%</p>
                        <p style="margin-bottom:1rem;">${msg}</p>
                        
                        ${numFailed > 0 ? `
                        <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #fca5a5;">
                            <p style="margin: 0; color: #dc2626; font-weight: 600;">
                                ‚ö†Ô∏è Fallaste ${numFailed} pregunta${numFailed > 1 ? 's' : ''}
                            </p>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 300px; margin: 0 auto;">
                            ${numFailed > 0 ? `
                            <button class="btn" onclick="app.startReviewQuiz()" style="background: #dc2626; border-color: #dc2626;">
                                üîÑ Repasar Solo Falladas (${numFailed})
                            </button>
                            ` : ''}
                            <button class="btn" onclick="app.startQuiz()">üîÅ Repetir Test Completo</button>
                            <button class="btn btn-outline" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                        </div>
                    </div>
                `;
            },
            
            // Funci√≥n auxiliar para insertar el resaltado
            highlightText: (text, keyword) => {
                if (!keyword) return text;
                const regex = new RegExp(keyword, 'gi');
                // Usa una funci√≥n de reemplazo para mantener las may√∫sculas/min√∫sculas del texto original
                return text.replace(regex, match => `<span class="highlight">${match}</span>`);
            },
            
            // Cambiar filtro de b√∫squeda
            changeSearchFilter: (filterType, value) => {
                if (!app.searchFilters) {
                    app.searchFilters = { especialidad: '', asignatura: '' };
                }
                
                app.searchFilters[filterType] = value;
                
                // Si cambiamos especialidad, resetear asignatura y regenerar el select
                if (filterType === 'especialidad') {
                    app.searchFilters.asignatura = '';
                    app.navigate('search'); // Recargar para actualizar opciones de asignatura
                    return;
                }
                
                // Re-ejecutar la b√∫squeda actual si hay t√©rmino
                const searchInput = document.getElementById('search-input');
                if (searchInput && searchInput.value.length >= 2) {
                    app.handleSearch(searchInput.value);
                }
            },

            handleSearch: (term) => {
                const resultsDiv = document.getElementById('search-results');
                
                // Inicializar filtros si no existen
                if (!app.searchFilters) {
                    app.searchFilters = { especialidad: app.userEspecialidad || '', asignatura: '' };
                }
                
                if (term.length < 2) {
                    resultsDiv.innerHTML = '<p style="color:#94a3b8; text-align:center;">Empieza a escribir para buscar en preguntas y respuestas de la base de datos.</p>';
                    app.searchState.term = term;
                    app.searchState.resultsHTML = resultsDiv.innerHTML;
                    return;
                }
                
                const termLower = term.toLowerCase();
                
                // Buscar en el cache de preguntas de la BD
                const cachedData = localStorage.getItem(app.CACHE_KEYS.questions);
                let allSearchQuestions = [];
                
                if (cachedData) {
                    try {
                        const dbQuestions = JSON.parse(cachedData);
                        
                        // Lista de nombres de optativas para detectar tipo
                        const nombresOptativas = CONFIG.asignaturas.optativas.map(a => a.nombre);
                        
                        dbQuestions.forEach(q => {
                            let opciones = q.opciones;
                            if (typeof opciones === 'string') {
                                try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                            }
                            
                            // Determinar tipo: especialidad, optativa u obligatoria
                            let tipo = 'obligatoria';
                            if (q.especialidad) {
                                tipo = 'especialidad';
                            } else if (nombresOptativas.includes(q.asignatura_nombre)) {
                                tipo = 'optativa';
                            }
                            
                            allSearchQuestions.push({
                                id: q.id,
                                subject: q.asignatura_nombre || q.asignatura,
                                unit: q.tema,
                                question: q.pregunta,
                                options: opciones || [],
                                answer: q.respuesta_correcta,
                                tipo: tipo,
                                especialidad: q.especialidad,
                                is_ai: q.is_ai === true,
                                question_tipo: q.tipo || 'test' // test o desarrollo
                            });
                        });
                    } catch(e) {
                        console.error('Error parseando cache para b√∫squeda:', e);
                    }
                }
                
                if (allSearchQuestions.length === 0) {
                    resultsDiv.innerHTML = '<p style="color:var(--warning); text-align:center;">No hay preguntas en cache. Pulsa "Actualizar Preguntas" en el inicio.</p>';
                    app.searchState.term = term;
                    app.searchState.resultsHTML = resultsDiv.innerHTML;
                    return;
                }
                
                // Aplicar filtro de especialidad
                const filtroEsp = app.searchFilters.especialidad;
                if (filtroEsp) {
                    allSearchQuestions = allSearchQuestions.filter(q => {
                        // Si el filtro es una especialidad espec√≠fica
                        if (filtroEsp !== 'obligatorias' && filtroEsp !== 'optativas') {
                            return q.especialidad === filtroEsp;
                        }
                        // Si el filtro es "obligatorias"
                        if (filtroEsp === 'obligatorias') {
                            return q.tipo === 'obligatoria';
                        }
                        // Si el filtro es "optativas"
                        if (filtroEsp === 'optativas') {
                            return q.tipo === 'optativa';
                        }
                        return true;
                    });
                }
                
                // Aplicar filtro de asignatura
                const filtroAsig = app.searchFilters.asignatura;
                if (filtroAsig) {
                    allSearchQuestions = allSearchQuestions.filter(q => q.subject === filtroAsig);
                }
                
                const found = allSearchQuestions.filter(q => {
                    if (q.question.toLowerCase().includes(termLower)) return true;
                    return q.options.some(opt => opt.toLowerCase().includes(termLower));
                });
                
                let resultsHTML;
                
                if (found.length === 0) {
                    resultsHTML = '<p style="color:var(--error); text-align:center;">No se encontraron resultados en la base de datos.</p>';
                } else {
                    resultsHTML = found.map(q => {
                        const isTermInQuestion = q.question.toLowerCase().includes(termLower);
                        
                        // 1. Pregunta (siempre se muestra, se resalta si la contiene)
                        const highlightedQuestion = app.highlightText(q.question, isTermInQuestion ? term : null);
                        
                        let snippetsHTML = '<div class="snippet-container">';
                        
                        // 2. Respuesta Correcta (siempre se muestra, con estilo verde)
                        const isTermInCorrectAnswer = q.answer.toLowerCase().includes(termLower);
                        const highlightedCorrectAnswer = app.highlightText(q.answer, isTermInCorrectAnswer ? term : null);
                        
                        snippetsHTML += `
                            <div class="search-snippet snippet-correct">
                                <small style="font-weight:700;">‚úÖ Respuesta Correcta:</small> ${highlightedCorrectAnswer}
                            </div>
                        `;
                        
                        // 3. Respuestas Incorrectas (solo se muestran si contienen el t√©rmino)
                        q.options.forEach(opt => {
                            if (opt !== q.answer) { // Si es una opci√≥n incorrecta
                                const isTermInIncorrectAnswer = opt.toLowerCase().includes(termLower);
                                
                                if (isTermInIncorrectAnswer) {
                                    const highlightedIncorrectAnswer = app.highlightText(opt, term); // Resaltado garantizado
                                    
                                    snippetsHTML += `
                                        <div class="search-snippet snippet-incorrect">
                                            <small style="font-weight:700;">‚ùå Respuesta Incorrecta:</small> ${highlightedIncorrectAnswer}
                                        </div>
                                    `;
                                }
                            }
                        });
                        
                        snippetsHTML += '</div>';

                        // Determinar el tag de tipo y nombre a mostrar
                        let tipoClass = 'tag';
                        let tipoLabel = q.tipo;
                        if (q.tipo === 'obligatoria') {
                            tipoClass += ' tag-obligatoria';
                            tipoLabel = 'Obligatoria';
                        } else if (q.tipo === 'optativa') {
                            tipoClass += ' tag-optativa';
                            tipoLabel = 'Optativa';
                        } else if (q.tipo === 'especialidad') {
                            tipoClass += ' tag-especialidad';
                            // Mostrar el nombre de la especialidad si existe
                            const espNombre = q.especialidad ? (CONFIG.especialidades[q.especialidad] || q.especialidad) : 'Especialidad';
                            tipoLabel = espNombre;
                        }
                        
                        // Badges de tipo de pregunta
                        let tipoBadges = '';
                        if (q.is_ai) {
                            tipoBadges += '<span style="background: #ede9fe; color: #6d28d9; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ü§ñ IA</span> ';
                        }
                        if (q.question_tipo === 'desarrollo') {
                            tipoBadges += '<span style="background: #fef3c7; color: #92400e; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üìÑ Desarrollo</span> ';
                        }
                        
                        // FINAL RESULT CARD RENDERING
                        return `
                            <div class="result-item" onclick="app.navigate('detail', '${q.id}')" style="${q.is_ai ? 'border-left: 3px solid #8b5cf6;' : q.question_tipo === 'desarrollo' ? 'border-left: 3px solid #f59e0b;' : ''}">
                                <div style="margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center;">
                                    <span class="${tipoClass}">${tipoLabel}</span>
                                    <span class="tag tag-subject">${q.subject}</span>
                                    <span class="tag">Tema ${q.unit}</span>
                                    ${tipoBadges}
                                </div>
                                <div style="font-weight: 500; margin-top: 5px; margin-bottom: 5px;">${highlightedQuestion}</div>
                                ${snippetsHTML}
                            </div>
                        `;
                    }).join('');
                }
                
                resultsDiv.innerHTML = resultsHTML;

                // ACTUALIZAR ESTADO DE B√öSQUEDA
                app.searchState.term = term;
                app.searchState.resultsHTML = resultsHTML;
            },
            shuffle: (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },
            showToast: (text) => {
                const toast = document.getElementById("toast");
                toast.innerText = text;
                toast.className = "show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
            },
            
            // ========== PANEL DE ADMINISTRACI√ìN ==========
            adminClickCount: 0,
            adminClickTimer: null,
            isAdmin: false,
            adminPassword: 'VIU2024Admin!', // Cambiar esta contrase√±a
            adminFilters: { especialidad: '', asignatura: '', tema: '', search: '', votosPositivos: '', votosNegativos: '' },
            adminQuestions: [],
            
            // Click secreto en el logo para acceder al admin
            secretAdminClick: () => {
                app.adminClickCount++;
                
                if (app.adminClickTimer) clearTimeout(app.adminClickTimer);
                
                // Si ya es admin, ir directo
                if (app.isAdmin) {
                    app.navigate('admin');
                    return;
                }
                
                // Necesita 5 clicks en 2 segundos
                if (app.adminClickCount >= 5) {
                    app.adminClickCount = 0;
                    app.showAdminLogin();
                } else {
                    app.adminClickTimer = setTimeout(() => {
                        app.adminClickCount = 0;
                    }, 2000);
                }
            },
            
            showAdminLogin: () => {
                document.getElementById('admin-login-modal').style.display = 'flex';
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password').focus();
                document.getElementById('admin-login-error').style.display = 'none';
            },
            
            hideAdminLogin: () => {
                document.getElementById('admin-login-modal').style.display = 'none';
            },
            
            verifyAdminPassword: () => {
                const password = document.getElementById('admin-password').value;
                if (password === app.adminPassword) {
                    app.isAdmin = true;
                    app.adminPasswordInput = password; // Guardar para Edge Function
                    app.hideAdminLogin();
                    app.showToast('üîì Acceso de administrador activado');
                    app.navigate('admin');
                } else {
                    document.getElementById('admin-login-error').style.display = 'block';
                    document.getElementById('admin-password').value = '';
                    document.getElementById('admin-password').focus();
                }
            },
            
            // Renderizar panel de administraci√≥n
            renderAdmin: async (container) => {
                if (!app.isAdmin) {
                    container.innerHTML = '<div class="card text-center"><h3>üîí Acceso denegado</h3><p>No tienes permisos de administrador.</p><button class="btn" onclick="app.navigate(\'home\')">Volver al inicio</button></div>';
                    return;
                }
                
                // Generar opciones de especialidades
                let espOptions = '<option value="">Todas las especialidades</option>';
                espOptions += '<option value="obligatorias"' + (app.adminFilters.especialidad === 'obligatorias' ? ' selected' : '') + '>üìò Obligatorias (sin especialidad)</option>';
                Object.entries(CONFIG.especialidades).forEach(([id, nombre]) => {
                    const selected = app.adminFilters.especialidad === id ? 'selected' : '';
                    espOptions += `<option value="${id}" ${selected}>${nombre}</option>`;
                });
                
                // Generar opciones de asignaturas
                let asigOptions = '<option value="">Todas las asignaturas</option>';
                CONFIG.asignaturas.obligatorias.forEach(a => {
                    const selected = app.adminFilters.asignatura === a.nombre ? 'selected' : '';
                    asigOptions += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                });
                CONFIG.asignaturas.optativas.forEach(a => {
                    const selected = app.adminFilters.asignatura === a.nombre ? 'selected' : '';
                    asigOptions += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                });
                CONFIG.asignaturas.especialidad.forEach(a => {
                    const selected = app.adminFilters.asignatura === a.nombre ? 'selected' : '';
                    asigOptions += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                });
                CONFIG.asignaturas.especialidadOrientacion.forEach(a => {
                    const selected = app.adminFilters.asignatura === a.nombre ? 'selected' : '';
                    asigOptions += `<option value="${a.nombre}" ${selected}>${a.nombre}</option>`;
                });
                
                container.innerHTML = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="margin: 0;">üõ†Ô∏è Panel de Administraci√≥n</h2>
                            <button class="btn btn-outline" onclick="app.isAdmin = false; app.navigate('home');" style="padding: 0.5rem 1rem;">
                                üö™ Cerrar Sesi√≥n Admin
                            </button>
                        </div>
                        
                        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <p style="margin: 0; color: #92400e; font-weight: 600;">‚ö†Ô∏è Panel de administraci√≥n. Los cambios afectan a todos los usuarios.</p>
                        </div>
                        
                        <!-- Filtros -->
                        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; margin: 0 0 1rem 0;">üîç Filtros de B√∫squeda</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Especialidad</label>
                                    <select id="admin-filter-esp" class="form-input" style="padding: 0.5rem;" onchange="app.updateAdminFilters()">
                                        ${espOptions}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Asignatura</label>
                                    <select id="admin-filter-asig" class="form-input" style="padding: 0.5rem;" onchange="app.updateAdminFilters()">
                                        ${asigOptions}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Tema</label>
                                    <input type="number" id="admin-filter-tema" class="form-input" style="padding: 0.5rem;" placeholder="N¬∫ tema" min="1" max="50" value="${app.adminFilters.tema || ''}" onchange="app.updateAdminFilters()">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Buscar texto</label>
                                    <input type="text" id="admin-filter-search" class="form-input" style="padding: 0.5rem;" placeholder="Buscar en pregunta..." value="${app.adminFilters.search || ''}" oninput="app.updateAdminFilters()">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">üëç Votos positivos m√≠n.</label>
                                    <input type="number" id="admin-filter-vpos" class="form-input" style="padding: 0.5rem;" placeholder="M√≠nimo" min="0" value="${app.adminFilters.votosPositivos || ''}" onchange="app.updateAdminFilters()">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">üëé Votos negativos m√≠n.</label>
                                    <input type="number" id="admin-filter-vneg" class="form-input" style="padding: 0.5rem;" placeholder="M√≠nimo" min="0" value="${app.adminFilters.votosNegativos || ''}" onchange="app.updateAdminFilters()">
                                </div>
                            </div>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" onclick="app.loadAdminQuestions()" style="padding: 0.5rem 1rem;">
                                    üîÑ Cargar Preguntas
                                </button>
                                <button class="btn btn-outline" onclick="app.clearAdminFilters()" style="padding: 0.5rem 1rem;">
                                    üóëÔ∏è Limpiar Filtros
                                </button>
                                <button class="btn" onclick="app.scanForDuplicates()" style="padding: 0.5rem 1rem; background: #fef3c7; color: #92400e; border: 1px solid #fcd34d;">
                                    üîç Buscar Duplicados
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lista de preguntas -->
                        <div id="admin-questions-list">
                            <p style="color: var(--text-secondary); text-align: center;">Usa los filtros y pulsa "Cargar Preguntas" para ver las preguntas.</p>
                        </div>
                    </div>
                `;
            },
            
            updateAdminFilters: () => {
                app.adminFilters.especialidad = document.getElementById('admin-filter-esp').value;
                app.adminFilters.asignatura = document.getElementById('admin-filter-asig').value;
                app.adminFilters.tema = document.getElementById('admin-filter-tema').value;
                app.adminFilters.search = document.getElementById('admin-filter-search').value;
                app.adminFilters.votosPositivos = document.getElementById('admin-filter-vpos').value;
                app.adminFilters.votosNegativos = document.getElementById('admin-filter-vneg').value;
            },
            
            clearAdminFilters: () => {
                app.adminFilters = { especialidad: '', asignatura: '', tema: '', search: '', votosPositivos: '', votosNegativos: '' };
                document.getElementById('admin-filter-esp').value = '';
                document.getElementById('admin-filter-asig').value = '';
                document.getElementById('admin-filter-tema').value = '';
                document.getElementById('admin-filter-search').value = '';
                document.getElementById('admin-filter-vpos').value = '';
                document.getElementById('admin-filter-vneg').value = '';
            },
            
            loadAdminQuestions: async () => {
                // Actualizar filtros desde el DOM antes de cargar
                const espSelect = document.getElementById('admin-filter-esp');
                const asigSelect = document.getElementById('admin-filter-asig');
                const temaInput = document.getElementById('admin-filter-tema');
                const searchInput = document.getElementById('admin-filter-search');
                const vposInput = document.getElementById('admin-filter-vpos');
                const vnegInput = document.getElementById('admin-filter-vneg');
                
                if (espSelect) app.adminFilters.especialidad = espSelect.value;
                if (asigSelect) app.adminFilters.asignatura = asigSelect.value;
                if (temaInput) app.adminFilters.tema = temaInput.value;
                if (searchInput) app.adminFilters.search = searchInput.value;
                if (vposInput) app.adminFilters.votosPositivos = vposInput.value;
                if (vnegInput) app.adminFilters.votosNegativos = vnegInput.value;
                
                const listContainer = document.getElementById('admin-questions-list');
                listContainer.innerHTML = '<p style="text-align: center;">‚è≥ Cargando preguntas...</p>';
                
                try {
                    // Construir query
                    let url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=*&order=id.desc&limit=100`;
                    
                    if (app.adminFilters.especialidad) {
                        if (app.adminFilters.especialidad === 'obligatorias') {
                            // Filtrar preguntas sin especialidad (obligatorias)
                            url += `&or=(especialidad.eq.,especialidad.is.null)`;
                        } else {
                            url += `&especialidad=eq.${app.adminFilters.especialidad}`;
                        }
                    }
                    if (app.adminFilters.asignatura) {
                        url += `&asignatura_nombre=eq.${encodeURIComponent(app.adminFilters.asignatura)}`;
                    }
                    if (app.adminFilters.tema) {
                        url += `&tema=eq.${app.adminFilters.tema}`;
                    }
                    if (app.adminFilters.search) {
                        url += `&pregunta=ilike.*${encodeURIComponent(app.adminFilters.search)}*`;
                    }
                    // Filtros de votos
                    if (app.adminFilters.votosPositivos) {
                        url += `&votos_positivos=gte.${app.adminFilters.votosPositivos}`;
                    }
                    if (app.adminFilters.votosNegativos) {
                        url += `&votos_negativos=gte.${app.adminFilters.votosNegativos}`;
                    }
                    
                    console.log('Admin query URL:', url);
                    
                    const response = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    app.adminQuestions = await response.json();
                    app.renderAdminQuestionsList();
                    
                } catch (error) {
                    console.error('Error cargando preguntas admin:', error);
                    listContainer.innerHTML = `<p style="color: var(--error); text-align: center;">‚ùå Error al cargar: ${error.message}</p>`;
                }
            },
            
            renderAdminQuestionsList: () => {
                const listContainer = document.getElementById('admin-questions-list');
                
                if (app.adminQuestions.length === 0) {
                    listContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No se encontraron preguntas con estos filtros.</p>';
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">${app.adminQuestions.length} preguntas encontradas</span>
                    </div>
                `;
                
                app.adminQuestions.forEach(q => {
                    let opciones = q.opciones;
                    if (typeof opciones === 'string') {
                        try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                    }
                    
                    const isDesarrollo = q.tipo === 'desarrollo';
                    const isAI = q.is_ai === true;
                    const isDisabled = q.aprobada === false;
                    const votosPos = q.votos_positivos || 0;
                    const votosNeg = q.votos_negativos || 0;
                    
                    // Badges
                    let badges = '';
                    if (isAI) badges += '<span style="background: #ede9fe; color: #6d28d9; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 0.25rem;">ü§ñ IA</span>';
                    if (isDesarrollo) badges += '<span style="background: #fef3c7; color: #92400e; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 0.25rem;">üìÑ Desarrollo</span>';
                    if (isDisabled) badges += '<span style="background: #fee2e2; color: #991b1b; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üö´ Desactivada</span>';
                    
                    // Badge de votos
                    const votosBadge = `<span style="background: ${votosNeg > votosPos ? '#fee2e2' : '#f3f4f6'}; color: ${votosNeg > votosPos ? '#991b1b' : '#374151'}; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 0.25rem;">üëç ${votosPos} | üëé ${votosNeg}</span>`;
                    
                    const espNombre = q.especialidad ? (CONFIG.especialidades[q.especialidad] || q.especialidad) : 'Obligatoria';
                    
                    html += `
                        <div id="admin-q-${q.id}" style="background: var(--card); border: 1px solid ${isDisabled ? '#fca5a5' : 'var(--border)'}; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; ${isDisabled ? 'opacity: 0.7;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                                        ID: ${q.id} | ${espNombre} | ${q.asignatura_nombre} | Tema ${q.tema} | Autor: ${q.autor || 'N/A'}
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">${votosBadge}${badges}</div>
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${q.pregunta}</div>
                                    ${!isDesarrollo ? `
                                    <div style="font-size: 0.85rem; color: var(--success);">‚úÖ ${q.respuesta_correcta}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                        Opciones: ${(opciones || []).join(' | ')}
                                    </div>
                                    ` : `
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">üìñ Respuesta: ${q.respuesta_correcta.substring(0, 100)}${q.respuesta_correcta.length > 100 ? '...' : ''}</div>
                                    `}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem; flex-shrink: 0;">
                                    <button onclick="app.editAdminQuestion(${q.id})" style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 4px; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem;">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="app.findSimilarQuestions(${q.id})" style="background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; border-radius: 4px; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem;">
                                        üîç Similares
                                    </button>
                                    <button onclick="app.toggleAdminQuestion(${q.id}, ${!isDisabled})" style="background: ${isDisabled ? '#dcfce7' : '#fee2e2'}; color: ${isDisabled ? '#166534' : '#991b1b'}; border: 1px solid ${isDisabled ? '#86efac' : '#fca5a5'}; border-radius: 4px; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem;">
                                        ${isDisabled ? '‚úÖ Activar' : 'üö´ Desactivar'}
                                    </button>
                                    <button onclick="app.deleteAdminQuestion(${q.id})" style="background: #fef2f2; color: #dc2626; border: 1px solid #fca5a5; border-radius: 4px; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem;">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
            },
            
            // Activar/Desactivar pregunta
            toggleAdminQuestion: async (id, disable) => {
                if (!confirm(disable ? '¬øDesactivar esta pregunta? No aparecer√° en los tests.' : '¬øActivar esta pregunta?')) return;
                
                try {
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({ aprobada: !disable })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    app.showToast(disable ? 'üö´ Pregunta desactivada' : '‚úÖ Pregunta activada');
                    
                    // Actualizar en la lista local
                    const q = app.adminQuestions.find(q => q.id === id);
                    if (q) q.aprobada = !disable;
                    app.renderAdminQuestionsList();
                    
                } catch (error) {
                    console.error('Error:', error);
                    app.showToast('‚ùå Error al actualizar');
                }
            },
            
            // Eliminar pregunta (usa Edge Function segura)
            deleteAdminQuestion: async (id) => {
                if (!confirm('‚ö†Ô∏è ¬øELIMINAR esta pregunta permanentemente? Esta acci√≥n no se puede deshacer.')) return;
                
                try {
                    const response = await fetch(`${SUPABASE_CONFIG.url}/functions/v1/admin-delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            password: app.adminPasswordInput,
                            questionId: id,
                            action: 'delete'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || result.error) {
                        throw new Error(result.error || 'Error al eliminar');
                    }
                    
                    app.showToast('üóëÔ∏è Pregunta eliminada');
                    
                    // Quitar de la lista local
                    app.adminQuestions = app.adminQuestions.filter(q => q.id !== id);
                    app.renderAdminQuestionsList();
                    
                } catch (error) {
                    console.error('Error:', error);
                    app.showToast('‚ùå ' + error.message);
                }
            },
            
            // Editar pregunta
            editAdminQuestion: (id) => {
                const q = app.adminQuestions.find(q => q.id === id);
                if (!q) return;
                
                let opciones = q.opciones;
                if (typeof opciones === 'string') {
                    try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                }
                
                const isDesarrollo = q.tipo === 'desarrollo';
                
                // Crear formulario de edici√≥n inline
                const container = document.getElementById(`admin-q-${id}`);
                
                container.innerHTML = `
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 1rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #0369a1;">‚úèÔ∏è Editando Pregunta #${id}</h4>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 600; display: block; margin-bottom: 0.25rem;">Pregunta:</label>
                                <textarea id="edit-pregunta-${id}" class="form-input" rows="2" style="width: 100%;">${q.pregunta}</textarea>
                            </div>
                            
                            ${!isDesarrollo ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">Opci√≥n 1:</label>
                                    <input type="text" id="edit-opt1-${id}" class="form-input" value="${opciones[0] || ''}">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">Opci√≥n 2:</label>
                                    <input type="text" id="edit-opt2-${id}" class="form-input" value="${opciones[1] || ''}">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">Opci√≥n 3:</label>
                                    <input type="text" id="edit-opt3-${id}" class="form-input" value="${opciones[2] || ''}">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">Opci√≥n 4:</label>
                                    <input type="text" id="edit-opt4-${id}" class="form-input" value="${opciones[3] || ''}">
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 600;">Respuesta correcta:</label>
                                <select id="edit-correcta-${id}" class="form-input">
                                    ${opciones.map((opt, i) => `<option value="${i}" ${opt === q.respuesta_correcta ? 'selected' : ''}>Opci√≥n ${i+1}: ${opt.substring(0, 50)}</option>`).join('')}
                                </select>
                            </div>
                            ` : `
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 600;">Respuesta modelo:</label>
                                <textarea id="edit-respuesta-${id}" class="form-input" rows="4" style="width: 100%;">${q.respuesta_correcta}</textarea>
                            </div>
                            `}
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">Tema:</label>
                                    <input type="number" id="edit-tema-${id}" class="form-input" value="${q.tema}" min="1" max="50">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">Tipo:</label>
                                    <select id="edit-tipo-${id}" class="form-input">
                                        <option value="test" ${q.tipo === 'test' || !q.tipo ? 'selected' : ''}>Test</option>
                                        <option value="desarrollo" ${q.tipo === 'desarrollo' ? 'selected' : ''}>Desarrollo</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; font-weight: 600;">¬øEs IA?</label>
                                    <select id="edit-ia-${id}" class="form-input">
                                        <option value="false" ${!q.is_ai ? 'selected' : ''}>No</option>
                                        <option value="true" ${q.is_ai ? 'selected' : ''}>S√≠ ü§ñ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn" onclick="app.saveAdminQuestion(${id}, ${isDesarrollo})" style="padding: 0.5rem 1rem;">
                                üíæ Guardar Cambios
                            </button>
                            <button class="btn btn-outline" onclick="app.renderAdminQuestionsList()" style="padding: 0.5rem 1rem;">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // Guardar cambios de pregunta
            saveAdminQuestion: async (id, isDesarrollo) => {
                const pregunta = document.getElementById(`edit-pregunta-${id}`).value.trim();
                const tema = parseInt(document.getElementById(`edit-tema-${id}`).value);
                const tipo = document.getElementById(`edit-tipo-${id}`).value;
                const isAI = document.getElementById(`edit-ia-${id}`).value === 'true';
                
                let opciones = [];
                let respuestaCorrecta = '';
                
                if (!isDesarrollo && tipo !== 'desarrollo') {
                    opciones = [
                        document.getElementById(`edit-opt1-${id}`).value.trim(),
                        document.getElementById(`edit-opt2-${id}`).value.trim(),
                        document.getElementById(`edit-opt3-${id}`).value.trim(),
                        document.getElementById(`edit-opt4-${id}`).value.trim()
                    ];
                    const correctaIdx = parseInt(document.getElementById(`edit-correcta-${id}`).value);
                    respuestaCorrecta = opciones[correctaIdx];
                } else {
                    respuestaCorrecta = document.getElementById(`edit-respuesta-${id}`).value.trim();
                }
                
                if (!pregunta || (!respuestaCorrecta && tipo !== 'desarrollo')) {
                    app.showToast('‚ö†Ô∏è Completa los campos obligatorios');
                    return;
                }
                
                try {
                    const updateData = {
                        pregunta: pregunta,
                        tema: tema,
                        tipo: tipo,
                        is_ai: isAI,
                        respuesta_correcta: respuestaCorrecta
                    };
                    
                    if (tipo !== 'desarrollo') {
                        updateData.opciones = opciones;
                    }
                    
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const updated = await response.json();
                    
                    // Actualizar en la lista local
                    const idx = app.adminQuestions.findIndex(q => q.id === id);
                    if (idx !== -1 && updated[0]) {
                        app.adminQuestions[idx] = updated[0];
                    }
                    
                    app.showToast('‚úÖ Pregunta actualizada');
                    app.renderAdminQuestionsList();
                    
                } catch (error) {
                    console.error('Error:', error);
                    app.showToast('‚ùå Error al guardar');
                }
            },
            
            // Funci√≥n para normalizar texto para comparaci√≥n
            normalizeText: (text) => {
                if (!text) return '';
                return text.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Quitar acentos
                    .replace(/[^a-z0-9\s]/g, '') // Solo letras, n√∫meros y espacios
                    .replace(/\s+/g, ' ') // Normalizar espacios
                    .trim();
            },
            
            // Calcular similitud entre dos textos (Jaccard similarity)
            calculateSimilarity: (text1, text2) => {
                const words1 = new Set(app.normalizeText(text1).split(' ').filter(w => w.length > 2));
                const words2 = new Set(app.normalizeText(text2).split(' ').filter(w => w.length > 2));
                
                if (words1.size === 0 || words2.size === 0) return 0;
                
                const intersection = new Set([...words1].filter(x => words2.has(x)));
                const union = new Set([...words1, ...words2]);
                
                return intersection.size / union.size;
            },
            
            // Buscar preguntas similares
            findSimilarQuestions: async (questionId) => {
                const targetQuestion = app.adminQuestions.find(q => q.id === questionId);
                if (!targetQuestion) return;
                
                // Mostrar indicador de carga
                app.showToast('üîç Buscando preguntas similares...');
                
                try {
                    // Cargar TODAS las preguntas para comparar
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=id,pregunta,respuesta_correcta,asignatura_nombre,especialidad,tema,tipo,aprobada,is_ai,votos_positivos,votos_negativos`, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error al cargar preguntas');
                    
                    const allQuestions = await response.json();
                    
                    // Calcular similitud con cada pregunta
                    const similarities = allQuestions
                        .filter(q => q.id !== questionId) // Excluir la pregunta actual
                        .map(q => {
                            const pregSimilarity = app.calculateSimilarity(targetQuestion.pregunta, q.pregunta);
                            const respSimilarity = app.calculateSimilarity(targetQuestion.respuesta_correcta, q.respuesta_correcta);
                            // Ponderamos m√°s la similitud de pregunta
                            const totalSimilarity = (pregSimilarity * 0.7) + (respSimilarity * 0.3);
                            return { ...q, similarity: totalSimilarity, pregSimilarity, respSimilarity };
                        })
                        .filter(q => q.similarity >= 0.3) // M√≠nimo 30% de similitud
                        .sort((a, b) => b.similarity - a.similarity)
                        .slice(0, 20); // Top 20 m√°s similares
                    
                    app.showSimilarQuestionsModal(targetQuestion, similarities);
                    
                } catch (error) {
                    console.error('Error:', error);
                    app.showToast('‚ùå Error al buscar similares');
                }
            },
            
            // Mostrar modal con preguntas similares
            showSimilarQuestionsModal: (targetQuestion, similarQuestions) => {
                // Crear modal
                const modal = document.createElement('div');
                modal.id = 'similar-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
                
                let similarHtml = '';
                if (similarQuestions.length === 0) {
                    similarHtml = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">‚ú® No se encontraron preguntas similares (>30% similitud)</p>';
                } else {
                    similarQuestions.forEach(q => {
                        const simPercent = Math.round(q.similarity * 100);
                        const pregPercent = Math.round(q.pregSimilarity * 100);
                        const respPercent = Math.round(q.respSimilarity * 100);
                        const bgColor = simPercent >= 80 ? '#fee2e2' : simPercent >= 60 ? '#fef3c7' : '#f0fdf4';
                        const borderColor = simPercent >= 80 ? '#fca5a5' : simPercent >= 60 ? '#fcd34d' : '#86efac';
                        
                        similarHtml += `
                            <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                                            ID: ${q.id} | ${q.asignatura_nombre || 'N/A'} | Tema ${q.tema}
                                            ${q.aprobada === false ? ' | üö´ Desactivada' : ''}
                                        </div>
                                        <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">${q.pregunta}</div>
                                        <div style="font-size: 0.8rem; color: #059669;">‚úÖ ${q.respuesta_correcta?.substring(0, 80)}${(q.respuesta_correcta?.length || 0) > 80 ? '...' : ''}</div>
                                    </div>
                                    <div style="text-align: right; flex-shrink: 0;">
                                        <div style="font-weight: 700; font-size: 1.1rem; color: ${simPercent >= 80 ? '#dc2626' : simPercent >= 60 ? '#d97706' : '#059669'};">${simPercent}%</div>
                                        <div style="font-size: 0.65rem; color: var(--text-secondary);">Preg: ${pregPercent}%</div>
                                        <div style="font-size: 0.65rem; color: var(--text-secondary);">Resp: ${respPercent}%</div>
                                        <button onclick="app.editAdminQuestion(${q.id}); document.getElementById('similar-modal').remove();" style="margin-top: 0.25rem; background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.7rem;">
                                            ‚úèÔ∏è Editar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                modal.innerHTML = `
                    <div style="background: var(--card); border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border); background: #fef3c7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: #92400e;">üîç Preguntas Similares</h3>
                                <button onclick="document.getElementById('similar-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
                            </div>
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #fcd34d;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Pregunta original (ID: ${targetQuestion.id}):</div>
                                <div style="font-weight: 600;">${targetQuestion.pregunta}</div>
                            </div>
                        </div>
                        <div style="padding: 1rem; overflow-y: auto; flex: 1;">
                            <div style="margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                ${similarQuestions.length} pregunta${similarQuestions.length !== 1 ? 's' : ''} similar${similarQuestions.length !== 1 ? 'es' : ''} encontrada${similarQuestions.length !== 1 ? 's' : ''}
                                <span style="margin-left: 1rem;">üî¥ >80% | üü° 60-80% | üü¢ 30-60%</span>
                            </div>
                            ${similarHtml}
                        </div>
                        <div style="padding: 1rem; border-top: 1px solid var(--border); text-align: center;">
                            <button onclick="document.getElementById('similar-modal').remove()" class="btn" style="padding: 0.5rem 2rem;">Cerrar</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Cerrar con click fuera
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            },
            
            // Escaneo masivo de duplicados
            scanForDuplicates: async () => {
                // Leer filtros actuales
                const espSelect = document.getElementById('admin-filter-esp');
                const asigSelect = document.getElementById('admin-filter-asig');
                const temaInput = document.getElementById('admin-filter-tema');
                
                const filters = {
                    especialidad: espSelect?.value || '',
                    asignatura: asigSelect?.value || '',
                    tema: temaInput?.value || ''
                };
                
                // Construir URL con filtros - incluir opciones para ver todas las respuestas
                let url = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?select=id,pregunta,respuesta_correcta,opciones,asignatura_nombre,especialidad,tema,tipo,aprobada,is_ai,votos_positivos,votos_negativos`;
                
                if (filters.especialidad) {
                    if (filters.especialidad === 'obligatorias') {
                        url += `&or=(especialidad.eq.,especialidad.is.null)`;
                    } else {
                        url += `&especialidad=eq.${filters.especialidad}`;
                    }
                }
                if (filters.asignatura) {
                    url += `&asignatura_nombre=eq.${encodeURIComponent(filters.asignatura)}`;
                }
                if (filters.tema) {
                    url += `&tema=eq.${filters.tema}`;
                }
                
                app.showToast('üîç Analizando preguntas... Esto puede tardar un momento.');
                
                try {
                    const response = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error al cargar preguntas');
                    
                    const questions = await response.json();
                    
                    if (questions.length === 0) {
                        app.showToast('‚ö†Ô∏è No hay preguntas con estos filtros');
                        return;
                    }
                    
                    if (questions.length > 500) {
                        if (!confirm(`Hay ${questions.length} preguntas. El an√°lisis puede tardar. ¬øContinuar?`)) return;
                    }
                    
                    // Agrupar por asignatura para comparar solo dentro de la misma asignatura
                    const byAsignatura = {};
                    questions.forEach(q => {
                        const key = q.asignatura_nombre || 'Sin asignatura';
                        if (!byAsignatura[key]) byAsignatura[key] = [];
                        byAsignatura[key].push(q);
                    });
                    
                    // Buscar duplicados dentro de cada asignatura
                    const duplicatePairs = [];
                    
                    for (const [asignatura, asigQuestions] of Object.entries(byAsignatura)) {
                        for (let i = 0; i < asigQuestions.length; i++) {
                            for (let j = i + 1; j < asigQuestions.length; j++) {
                                const q1 = asigQuestions[i];
                                const q2 = asigQuestions[j];
                                
                                const pregSimilarity = app.calculateSimilarity(q1.pregunta, q2.pregunta);
                                const respSimilarity = app.calculateSimilarity(q1.respuesta_correcta, q2.respuesta_correcta);
                                const totalSimilarity = (pregSimilarity * 0.7) + (respSimilarity * 0.3);
                                
                                if (totalSimilarity >= 0.4) { // M√≠nimo 40% para el escaneo masivo
                                    duplicatePairs.push({
                                        q1, q2,
                                        similarity: totalSimilarity,
                                        pregSimilarity,
                                        respSimilarity,
                                        asignatura
                                    });
                                }
                            }
                        }
                    }
                    
                    // Ordenar por similitud
                    duplicatePairs.sort((a, b) => b.similarity - a.similarity);
                    
                    app.showDuplicatesModal(duplicatePairs, questions.length, filters);
                    
                } catch (error) {
                    console.error('Error:', error);
                    app.showToast('‚ùå Error al analizar duplicados');
                }
            },
            
            // Funci√≥n para obtener opciones como array
            getOptionsArray: (q) => {
                let opciones = q.opciones;
                if (typeof opciones === 'string') {
                    try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                }
                return opciones || [];
            },
            
            // Mostrar modal con todos los duplicados encontrados
            showDuplicatesModal: (pairs, totalQuestions, filters) => {
                const modal = document.createElement('div');
                modal.id = 'duplicates-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
                
                // Funci√≥n helper para generar HTML de una pregunta
                const renderQuestionCard = (q, borderColor, pairIdx, qNum) => {
                    const opciones = app.getOptionsArray(q);
                    const espNombre = q.especialidad ? (CONFIG.especialidades[q.especialidad] || q.especialidad) : 'Obligatoria';
                    const isDesarrollo = q.tipo === 'desarrollo';
                    
                    let opcionesHtml = '';
                    if (!isDesarrollo && opciones.length > 0) {
                        opcionesHtml = '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e5e7eb;">';
                        opciones.forEach((opt, i) => {
                            const isCorrect = opt === q.respuesta_correcta;
                            opcionesHtml += `<div style="font-size: 0.75rem; padding: 0.15rem 0; ${isCorrect ? 'color: #059669; font-weight: 600;' : 'color: var(--text-secondary);'}">${isCorrect ? '‚úÖ' : '‚óã'} ${opt}</div>`;
                        });
                        opcionesHtml += '</div>';
                    } else if (isDesarrollo) {
                        opcionesHtml = `<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e5e7eb;"><div style="font-size: 0.75rem; color: var(--text-secondary);">üìù <strong>Respuesta modelo:</strong></div><div style="font-size: 0.75rem; color: #374151; margin-top: 0.25rem; max-height: 100px; overflow-y: auto;">${q.respuesta_correcta}</div></div>`;
                    }
                    
                    return `
                        <div id="dup-card-${pairIdx}-${qNum}" style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid ${borderColor};">
                            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.25rem;">
                                <span>ID: ${q.id} ${q.aprobada === false ? 'üö´' : ''} ${q.is_ai ? 'ü§ñ' : ''}</span>
                                <span style="background: #e0e7ff; color: #3730a3; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.65rem;">${espNombre}</span>
                            </div>
                            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.5rem;">Tema ${q.tema} | üëç${q.votos_positivos || 0} üëé${q.votos_negativos || 0}</div>
                            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">${q.pregunta}</div>
                            ${opcionesHtml}
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                <button onclick="app.editAdminQuestion(${q.id}); document.getElementById('duplicates-modal').remove();" style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.7rem;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="app.quickDisableFromModal(${q.id}, ${pairIdx}, ${qNum})" style="background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.7rem;">
                                    üö´ Desactivar
                                </button>
                                <button onclick="app.quickDeleteFromModal(${q.id}, ${pairIdx}, ${qNum})" style="background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.7rem;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                };
                
                let pairsHtml = '';
                if (pairs.length === 0) {
                    pairsHtml = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">‚ú® ¬°No se encontraron duplicados! (>40% similitud)</p>';
                } else {
                    pairs.forEach((pair, idx) => {
                        const simPercent = Math.round(pair.similarity * 100);
                        const pregPercent = Math.round(pair.pregSimilarity * 100);
                        const respPercent = Math.round(pair.respSimilarity * 100);
                        const bgColor = simPercent >= 80 ? '#fee2e2' : simPercent >= 60 ? '#fef3c7' : '#f0fdf4';
                        const borderColor = simPercent >= 80 ? '#fca5a5' : simPercent >= 60 ? '#fcd34d' : '#86efac';
                        const labelColor = simPercent >= 80 ? '#dc2626' : simPercent >= 60 ? '#d97706' : '#059669';
                        
                        pairsHtml += `
                            <div id="dup-pair-${idx}" style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">
                                        üìö ${pair.asignatura}
                                    </span>
                                    <span style="font-weight: 700; font-size: 1rem; color: ${labelColor}; background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">
                                        ${simPercent}% similar
                                        <span style="font-size: 0.65rem; font-weight: normal;">(Preg:${pregPercent}% Resp:${respPercent}%)</span>
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    ${renderQuestionCard(pair.q1, borderColor, idx, 1)}
                                    ${renderQuestionCard(pair.q2, borderColor, idx, 2)}
                                </div>
                            </div>
                        `;
                    });
                }
                
                const filterDesc = [];
                if (filters.especialidad) filterDesc.push(`Esp: ${filters.especialidad}`);
                if (filters.asignatura) filterDesc.push(`Asig: ${filters.asignatura}`);
                if (filters.tema) filterDesc.push(`Tema: ${filters.tema}`);
                const filterText = filterDesc.length > 0 ? filterDesc.join(' | ') : 'Sin filtros (todas las preguntas)';
                
                // Contar por severidad
                const critical = pairs.filter(p => p.similarity >= 0.8).length;
                const warning = pairs.filter(p => p.similarity >= 0.6 && p.similarity < 0.8).length;
                const minor = pairs.filter(p => p.similarity < 0.6).length;
                
                modal.innerHTML = `
                    <div style="background: var(--card); border-radius: 12px; max-width: 1000px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, #fef3c7, #fde68a);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: #92400e;">üîç An√°lisis de Duplicados</h3>
                                <button onclick="document.getElementById('duplicates-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #78350f;">
                                ${filterText} | ${totalQuestions} preguntas analizadas
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; gap: 1rem; font-size: 0.8rem;">
                                <span style="color: #dc2626;">üî¥ Cr√≠ticos (>80%): ${critical}</span>
                                <span style="color: #d97706;">üü° Altos (60-80%): ${warning}</span>
                                <span style="color: #059669;">üü¢ Moderados (40-60%): ${minor}</span>
                            </div>
                        </div>
                        <div style="padding: 1rem; overflow-y: auto; flex: 1;">
                            ${pairs.length > 0 ? `<p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Se encontraron <strong>${pairs.length}</strong> parejas de preguntas similares. 
                                Las m√°s cr√≠ticas aparecen primero. Puedes desactivar una de cada pareja para evitar duplicados.
                            </p>` : ''}
                            ${pairsHtml}
                        </div>
                        <div style="padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">
                                üí° Tip: Las preguntas con üö´ ya est√°n desactivadas
                            </span>
                            <button onclick="document.getElementById('duplicates-modal').remove()" class="btn" style="padding: 0.5rem 2rem;">Cerrar</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            },
            
            // Desactivar r√°pido desde el modal de duplicados
            quickDisableFromModal: async (id, pairIdx, qNum) => {
                if (!confirm('¬øDesactivar esta pregunta? No aparecer√° en los tests.')) return;
                
                try {
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.table}?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({ aprobada: false })
                    });
                    
                    if (!response.ok) throw new Error('Error');
                    
                    app.showToast('üö´ Pregunta desactivada');
                    
                    // Marcar visualmente la tarjeta como desactivada
                    const card = document.getElementById(`dup-card-${pairIdx}-${qNum}`);
                    if (card) {
                        card.style.opacity = '0.5';
                        card.style.background = '#f3f4f6';
                        const infoLine = card.querySelector('div > span:first-child');
                        if (infoLine && !infoLine.textContent.includes('üö´')) {
                            infoLine.textContent += ' üö´';
                        }
                    }
                    
                } catch (error) {
                    app.showToast('‚ùå Error al desactivar');
                }
            },
            
            // Eliminar r√°pido desde el modal de duplicados (usa Edge Function segura)
            quickDeleteFromModal: async (id, pairIdx, qNum) => {
                if (!confirm('‚ö†Ô∏è ¬øELIMINAR esta pregunta permanentemente? Esta acci√≥n NO se puede deshacer.')) return;
                
                try {
                    const response = await fetch(`${SUPABASE_CONFIG.url}/functions/v1/admin-delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify({
                            password: app.adminPasswordInput,
                            questionId: id,
                            action: 'delete'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || result.error) {
                        throw new Error(result.error || 'Error al eliminar');
                    }
                    
                    app.showToast('üóëÔ∏è Pregunta eliminada');
                    
                    // Quitar visualmente la tarjeta
                    const card = document.getElementById(`dup-card-${pairIdx}-${qNum}`);
                    if (card) {
                        card.innerHTML = `<div style="padding: 1rem; text-align: center; color: #dc2626; font-size: 0.85rem;">üóëÔ∏è Pregunta #${id} eliminada</div>`;
                        card.style.background = '#fef2f2';
                    }
                    
                } catch (error) {
                    app.showToast('‚ùå ' + error.message);
                }
            },
            
            // Exportar preguntas a PDF seg√∫n filtros actuales
            exportToPDF: async () => {
                try {
                    // Verificar que jsPDF est√© disponible
                    if (!window.jspdf || !window.jspdf.jsPDF) {
                        app.showToast('‚ùå Error: Librer√≠a PDF no cargada');
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Obtener preguntas filtradas actuales
                    const questions = app.filteredQuestions;
                    
                    if (questions.length === 0) {
                        app.showToast('‚ö†Ô∏è No hay preguntas para exportar');
                        return;
                    }
                    
                    // Informaci√≥n del documento
                    const asignaturaNombre = app.currentAsignatura?.nombre || 'Asignatura';
                    const especialidadNombre = app.userEspecialidad ? CONFIG.especialidades[app.userEspecialidad] : '';
                    const temaInfo = app.currentTema === 'all' ? 'Todos los temas' : 'Tema ' + app.currentTema;
                    
                    // Agrupar preguntas por tema (usar 'unit' que es el campo correcto)
                    const preguntasPorTema = {};
                    questions.forEach(q => {
                        const tema = q.unit || 1;
                        if (!preguntasPorTema[tema]) {
                            preguntasPorTema[tema] = [];
                        }
                        preguntasPorTema[tema].push(q);
                    });
                    
                    const temas = Object.keys(preguntasPorTema).sort((a, b) => parseInt(a) - parseInt(b));
                    
                    let y = 20;
                    const pageHeight = 280;
                    const marginLeft = 15;
                    const maxWidth = 180;
                    const lineHeight = 6;
                    
                    // T√≠tulo del documento
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(asignaturaNombre || 'Preguntas', marginLeft, y);
                    y += 8;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    if (especialidadNombre) {
                        doc.text(especialidadNombre, marginLeft, y);
                        y += 6;
                    }
                    doc.text(temaInfo, marginLeft, y);
                    y += 6;
                    doc.text('Total: ' + questions.length + ' preguntas', marginLeft, y);
                    y += 8;
                    
                    // L√≠nea divisora
                    doc.setDrawColor(180);
                    doc.line(marginLeft, y, marginLeft + maxWidth, y);
                    y += 10;
                    
                    // Iterar por cada tema
                    for (const tema of temas) {
                        const preguntasTema = preguntasPorTema[tema];
                        
                        // T√≠tulo del tema - SIEMPRE mostrar
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        // L√≠nea separadora antes del tema
                        doc.setDrawColor(100);
                        doc.setLineWidth(0.5);
                        doc.line(marginLeft, y, marginLeft + maxWidth, y);
                        y += 8;
                        
                        doc.setFontSize(13);
                        doc.setFont('helvetica', 'bold');
                        doc.text('TEMA ' + tema + ' (' + preguntasTema.length + ' preguntas)', marginLeft, y);
                        y += 10;
                        
                        doc.setLineWidth(0.2);
                        
                        // Iterar por cada pregunta del tema
                        let numPregTema = 1;
                        for (const q of preguntasTema) {
                            // Verificar espacio en p√°gina
                            if (y > pageHeight - 50) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            // Texto de pregunta (usar 'question' que es el campo correcto)
                            const preguntaTexto = q.question || 'Sin texto';
                            
                            // N√∫mero y pregunta
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'bold');
                            const preguntaCompleta = numPregTema + '. ' + preguntaTexto;
                            const preguntaLines = doc.splitTextToSize(preguntaCompleta, maxWidth);
                            doc.text(preguntaLines, marginLeft, y);
                            y += preguntaLines.length * lineHeight + 2;
                            
                            doc.setFontSize(9);
                            
                            if (q.tipo === 'desarrollo') {
                                // Pregunta de desarrollo (usar 'answer' que es el campo correcto)
                                doc.setFont('helvetica', 'italic');
                                doc.text('Respuesta:', marginLeft + 5, y);
                                y += 5;
                                doc.setFont('helvetica', 'normal');
                                const respuesta = q.answer || 'Sin respuesta';
                                const respuestaLines = doc.splitTextToSize(respuesta, maxWidth - 10);
                                doc.text(respuestaLines, marginLeft + 5, y);
                                y += respuestaLines.length * 5 + 3;
                            } else {
                                // Pregunta tipo test - mostrar TODAS las opciones (usar 'options' y 'answer')
                                let opciones = q.options;
                                if (typeof opciones === 'string') {
                                    try { opciones = JSON.parse(opciones); } catch(e) { opciones = []; }
                                }
                                if (!opciones || !Array.isArray(opciones)) opciones = [];
                                
                                const respCorrecta = q.answer || '';
                                
                                for (let idx = 0; idx < opciones.length; idx++) {
                                    const letra = String.fromCharCode(65 + idx);
                                    const opcionTexto = opciones[idx] || '';
                                    const esCorrecta = opcionTexto === respCorrecta;
                                    
                                    // Verificar si necesitamos nueva p√°gina
                                    if (y > pageHeight - 10) {
                                        doc.addPage();
                                        y = 20;
                                    }
                                    
                                    if (esCorrecta) {
                                        doc.setFont('helvetica', 'bold');
                                        const textoOpcion = letra + ') ' + opcionTexto + ' [CORRECTA]';
                                        const opcionLines = doc.splitTextToSize(textoOpcion, maxWidth - 10);
                                        doc.text(opcionLines, marginLeft + 5, y);
                                        y += opcionLines.length * 5;
                                    } else {
                                        doc.setFont('helvetica', 'normal');
                                        const textoOpcion = letra + ') ' + opcionTexto;
                                        const opcionLines = doc.splitTextToSize(textoOpcion, maxWidth - 10);
                                        doc.text(opcionLines, marginLeft + 5, y);
                                        y += opcionLines.length * 5;
                                    }
                                }
                            }
                            
                            y += 8;
                            numPregTema++;
                        }
                        
                        y += 5;
                    }
                    
                    // Generar nombre de archivo
                    const safeAsig = (asignaturaNombre || 'preguntas').replace(/[^a-z0-9]/gi, '_');
                    const safeTema = temaInfo.replace(/[^a-z0-9]/gi, '_');
                    const fileName = safeAsig + '_' + safeTema + '.pdf';
                    
                    // Descargar PDF
                    doc.save(fileName);
                    app.showToast('PDF exportado correctamente');
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    app.showToast('Error al exportar PDF: ' + (error.message || 'desconocido'));
                }
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>
