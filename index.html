<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIU estudio examenes</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #1e293b;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --info: #3b82f6;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #0f172a;
            --accent: #fbbf24;
            --success: #34d399;
            --error: #f87171;
            --bg: #0f172a;
            --card: #1e293b;
            --info: #60a5fa;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --input-bg: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        /* --- NAVEGACI√ìN --- */
        nav {
            background-color: var(--secondary);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .nav-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .logo { font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px;}
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap;}
        .menu-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .menu-btn:hover, .menu-btn.active {
            background-color: var(--primary);
            transform: translateY(-1px);
        }
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        /* --- MEN√ö DESPLEGABLE --- */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown > .menu-btn {
            cursor: pointer;
            user-select: none;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--card);
            min-width: 200px;
            box-shadow: 0 8px 16px var(--shadow);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
        }
        .dropdown.active .dropdown-content {
            display: block;
        }
        .dropdown-content button {
            background: none;
            border: none;
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .dropdown-content button:hover {
            background-color: var(--primary);
            color: white;
        }
        
        /* --- CONTENEDOR CENTRAL --- */
        main {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 2rem auto;
            padding: 0 1rem;
            box-sizing: border-box;
        } 
        /* --- TARJETAS --- */
        .card {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px var(--shadow);
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-out;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2, h3 { margin-top: 0; color: var(--text-primary); }
        /* --- FORMULARIOS --- */
        .form-group { margin-bottom: 1.2rem; text-align: left;}
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;}
        .form-input, .form-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
            transition: border-color 0.2s;
            box-sizing: border-box;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .form-select option {
            background: var(--card);
            color: var(--text-primary);
        }
        textarea.form-input { min-height: 100px; resize: vertical; }
        
        /* --- BOT√ìN DE TEMA --- */
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        /* --- BOTONES --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: #64748b; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #059669; }
        .btn-warning { background-color: var(--accent); color: #fff; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-outline { background: transparent; border: 2px solid #cbd5e1; color: #64748b; }
        .btn-outline:hover { border-color: var(--secondary); color: var(--secondary); background: transparent; }
        .btn-info { background-color: var(--info); }
        .btn-info:hover { background-color: #2563eb; }
        /* --- ESTILOS DEL TEST --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: #64748b; font-size: 0.9rem; }
        
        .quiz-progress {
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
        .question-text { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; line-height: 1.5; color: var(--text-primary); }
        .option-btn {
            width: 100%; text-align: left; padding: 1.2rem; margin-bottom: 0.8rem;
            background: var(--card); border: 2px solid var(--border); border-radius: 10px;
            cursor: pointer; transition: all 0.2s; font-size: 1rem; color: var(--text-primary);
            position: relative;
        }
        .option-btn:hover { border-color: var(--primary); background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .option-btn.correct { background: #dcfce7; border-color: var(--success); color: #065f46; font-weight: 600; }
        [data-theme="dark"] .option-btn.correct { background: #064e3b; color: #6ee7b7; }
        .option-btn.incorrect { background: #fee2e2; border-color: var(--error); color: #991b1b; }
        [data-theme="dark"] .option-btn.incorrect { background: #7f1d1d; color: #fca5a5; }
        .option-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
        [data-theme="dark"] .option-btn.selected { background: var(--primary); color: white; }
        
        /* --- ESTILOS DE LA B√öSQUEDA (ACTUALIZADO) --- */
        .result-item { 
            padding: 1rem; 
            border-bottom: 1px solid var(--border); 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .result-item:hover { background: var(--input-bg); }
        .tag { 
            font-size: 0.75rem; 
            background: var(--border); 
            padding: 4px 8px; 
            border-radius: 6px; 
            color: var(--text-secondary); 
            margin-right: 8px; 
            font-weight: 600; 
            display: inline-block;
            margin-bottom: 4px;
        }
        .tag-subject { background: #e0e7ff; color: #4338ca; }
        [data-theme="dark"] .tag-subject { background: #312e81; color: #a5b4fc; }
        .tag-obligatoria { background: #fef3c7; color: #92400e; }
        [data-theme="dark"] .tag-obligatoria { background: #78350f; color: #fde68a; }
        .tag-optativa { background: #dbeafe; color: #1e40af; }
        [data-theme="dark"] .tag-optativa { background: #1e3a8a; color: #93c5fd; }
        .tag-especialidad { background: #fce7f3; color: #9f1239; }
        [data-theme="dark"] .tag-especialidad { background: #831843; color: #fbcfe8; }
        .detail-option {
            padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg);
        }
        .detail-correct {
            background-color: #dcfce7; border-color: var(--success); color: #065f46; font-weight: bold;
        }
        [data-theme="dark"] .detail-correct {
            background-color: #064e3b; border-color: var(--success); color: #6ee7b7;
        }

        /* ESTILO PARA RESALTAR TEXTO DE B√öSQUEDA */
        .highlight {
            background-color: var(--accent);
            color: var(--secondary);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        /* Clases para modo oscuro en elementos din√°micos */
        .bg-light-box {
            background: #f8fafc;
        }
        [data-theme="dark"] .bg-light-box {
            background: #1e293b;
        }
        
        .bg-white-box {
            background: white;
        }
        [data-theme="dark"] .bg-white-box {
            background: #334155;
        }
        
        .bg-blue-light {
            background: #eff6ff;
        }
        [data-theme="dark"] .bg-blue-light {
            background: #1e293b;
        }
        
        .text-muted {
            color: #64748b;
        }
        [data-theme="dark"] .text-muted {
            color: #94a3b8;
        }
        
        .text-dark {
            color: #334155;
        }
        [data-theme="dark"] .text-dark {
            color: #e2e8f0;
        }
        
        .border-light {
            border-color: #e2e8f0;
        }
        [data-theme="dark"] .border-light {
            border-color: #334155;
        }
        
        /* SNIPPET STYLES - NUEVOS ESTILOS PARA LA L√çNEA DE COLOR */
        .snippet-container { margin-top: 10px; }
        .search-snippet {
            margin-top: 5px; 
            font-size: 0.9rem; 
            padding: 8px 10px; 
            border-radius: 4px;
            line-height: 1.4;
            margin-bottom: 8px; 
            font-weight: 500;
        }
        .snippet-correct {
            border-left: 3px solid var(--success); /* L√≠nea verde */
            background: #dcfce7; /* Fondo verde claro */
            color: #065f46;
        }
        .snippet-incorrect {
            border-left: 3px solid var(--error); /* L√≠nea roja */
            background: #fee2e2; /* Fondo rojo claro */
            color: #991b1b;
        }

        /* --- UTILIDADES --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .loading-box { text-align: center; padding: 3rem; color: #94a3b8; }
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        @media (max-width: 600px) {
            .nav-content { justify-content: center; }
            .card { padding: 1.5rem; }
            .btn { padding: 0.8rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <!-- T√≠tulo de navegaci√≥n actualizado -->
            <div class="logo">VIU - Master Profesor</div>
            <div class="nav-buttons">
                <button class="menu-btn active" onclick="app.navigate('home')">Inicio</button>
                <div class="dropdown" id="test-dropdown">
                    <button class="menu-btn" onclick="app.toggleDropdown(event)">üìù Modos ‚ñæ</button>
                    <div class="dropdown-content">
                        <button onclick="app.closeDropdown(); app.navigate('home'); app.startQuiz();">üìù Test Normal</button>
                        <button onclick="app.closeDropdown(); app.navigate('exam-mode');">‚è±Ô∏è Modo Examen</button>
                        <button onclick="app.closeDropdown(); app.navigate('review-mode');">üîÑ Modo Repaso</button>
                    </div>
                </div>
                <button class="menu-btn" onclick="app.navigate('search')">üîç Buscar</button>
                <button class="menu-btn" onclick="app.navigate('contribute')" title="Contribuir con preguntas">+
                <button class="theme-toggle" onclick="app.showHelp()" title="Ayuda y atajos">
                    ‚ÑπÔ∏è
                </button>
                <button class="theme-toggle" onclick="app.toggleTheme()" id="theme-toggle" title="Cambiar tema">
                    üåô
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Modal de Ayuda -->
    <div id="help-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card bg-white-box" style="max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; position: relative;">
            <button onclick="app.hideHelp()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary);">&times;</button>
            <h2 style="margin-bottom: 1.5rem;">üìö Gu√≠a de Uso</h2>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">‚å®Ô∏è Atajos de Teclado</h3>
            <div style="margin-left: 1rem; margin-bottom: 1rem;">
                <p><strong>Durante el test:</strong></p>
                <ul style="margin-left: 1rem;">
                    <li><kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">1</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">2</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">3</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">4</kbd> 
                        - Seleccionar respuesta</li>
                    <li><kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">Enter</kbd> - Siguiente pregunta</li>
                    <li><kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">‚Üê</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">‚Üí</kbd> - Navegar entre preguntas</li>
                </ul>
            </div>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üìù Modos de Estudio</h3>
            <div style="margin-left: 1rem; margin-bottom: 1rem;">
                <p><strong>Test Normal:</strong> Pr√°ctica con feedback inmediato. Al responder, se muestra si es correcta o incorrecta. Incluye notas personales y navegaci√≥n libre.</p>
                <p><strong>‚è±Ô∏è Modo Examen:</strong> Simulaci√≥n de examen real con tiempo l√≠mite (configurable). Sin feedback durante el examen, solo al finalizar. Incluye navegaci√≥n libre, temporizador y revisi√≥n completa al terminar.</p>
                <p><strong>üîÑ Modo Repaso:</strong> Practica solo las preguntas que has fallado anteriormente. Funciona igual que el test normal pero filtrado por tus errores hist√≥ricos.</p>
                <p><strong>üìñ Resumen de Temas:</strong> Visualiza todas las preguntas y respuestas correctas de un tema para estudiarlo antes de hacer tests.</p>
            </div>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üìù Notas Personales</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Cada pregunta tiene un campo de notas donde puedes escribir apuntes personales, recordatorios o explicaciones. 
                Las notas se guardan autom√°ticamente en tu navegador y solo aparecen en Test Normal y Modo Repaso.
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">‚≠ê Marcar Preguntas</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Marca preguntas dif√≠ciles con el bot√≥n ‚≠ê/üîñ para repasarlas despu√©s. Las preguntas marcadas se guardan y puedes crear tests solo con ellas usando el checkbox "Solo preguntas marcadas".
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üìä Estad√≠sticas Avanzadas</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                El sistema guarda tu historial completo de tests y ofrece:
            </p>
            <ul style="margin-left: 2rem; margin-bottom: 1rem;">
                <li><strong>Predictor de aciertos:</strong> Estima tu probabilidad de √©xito basado en tus √∫ltimos 10 tests</li>
                <li><strong>An√°lisis de tendencia:</strong> Compara tu rendimiento reciente con el anterior</li>
                <li><strong>Gr√°ficos de evoluci√≥n:</strong> Visualiza tu progreso en los √∫ltimos 20 tests</li>
                <li><strong>Rendimiento por asignatura:</strong> Estad√≠sticas detalladas de cada materia</li>
            </ul>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üîç B√∫squeda</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Busca preguntas por texto, filtra por asignatura o tema espec√≠fico. 
                Ideal para revisar conceptos concretos.
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üåô Modo Oscuro</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Alterna entre modo claro y oscuro con el bot√≥n ‚òÄÔ∏è/üåô en la barra superior. La preferencia se guarda autom√°ticamente.
            </p>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" onclick="app.hideHelp()">¬°Entendido!</button>
            </div>
        </div>
    </div>
    
    <main id="app-container">
        <div class="loading-box">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Cargando sistema...</p>
        </div>
    </main>
    <!-- Notificaci√≥n Flotante -->
    <div id="toast">Mensaje</div>
    <script>
        // --- CONFIGURACI√ìN Y ESTRUCTURA ---
        const CONFIG = {
            especialidades: {
                'tecnologias-informatica': 'Tecnolog√≠as e Inform√°tica',
                'orientacion-educativa': 'Orientaci√≥n Educativa',
                'musica': 'M√∫sica',
                'lengua-literatura': 'Lengua y Literatura',
                'ingles': 'Ingl√©s',
                'geografia-historia': 'Geograf√≠a e Historia',
                'fol': 'FOL',
                'fisica-quimica': 'F√≠sica y Qu√≠mica',
                'educacion-fisica': 'Educaci√≥n F√≠sica',
                'economia-administracion': 'Econom√≠a y Administraci√≥n',
                'dibujo': 'Dibujo',
                'biologia-geologia': 'Biolog√≠a y Geolog√≠a'
            },
            asignaturas: {
                obligatorias: [
                    { id: 'sociedad-familia-educacion', nombre: 'Sociedad, familia y educaci√≥n', archivo: 'obligatorias/sociedad-familia-educacion.json' },
                    { id: 'procesos-contextos-educativos', nombre: 'Procesos y contextos educativos', archivo: 'obligatorias/procesos-contextos-educativos.json' },
                    { id: 'aprendizaje-desarrollo-personalidad', nombre: 'Aprendizaje y desarrollo de la personalidad', archivo: 'obligatorias/aprendizaje-desarrollo-personalidad.json' }
                ],
                optativas: [
                    { id: 'mediacion', nombre: 'Mediaci√≥n', archivo: 'optativas-comunes/mediacion.json' },
                    { id: 'materiales-estrategias-didacticas', nombre: 'Materiales y estrategias did√°cticas', archivo: 'optativas-comunes/materiales-estrategias-didacticas.json' },
                    { id: 'educacion-emocional-habilidades-sociales', nombre: 'Educaci√≥n emocional y habilidades sociales', archivo: 'optativas-comunes/educacion-emocional-habilidades-sociales.json' }
                ],
                especialidad: [
                    { id: 'innovacion-docente-investigacion', nombre: 'Innovaci√≥n docente e iniciaci√≥n a la investigaci√≥n', archivo: 'innovacion-docente-investigacion.json' },
                    { id: 'complementos-formacion-disciplinar', nombre: 'Complementos para la formaci√≥n disciplinar', archivo: 'complementos-formacion-disciplinar.json' },
                    { id: 'aprendizaje-ensenanza', nombre: 'Aprendizaje y ense√±anza', archivo: 'aprendizaje-ensenanza.json' }
                ],
                especialidadOrientacion: [
                    { id: 'procesos-orientacion-educativa', nombre: 'Procesos de orientaci√≥n educativa', archivo: 'procesos-orientacion-educativa.json' },
                    { id: 'investigacion-innovacion-gestion-cambio', nombre: 'Investigaci√≥n e innovaci√≥n educativa', archivo: 'investigacion-innovacion-gestion-cambio.json' },
                    { id: 'educacion-inclusiva-atencion-diversidad', nombre: 'Educaci√≥n inclusiva', archivo: 'educacion-inclusiva-atencion-diversidad.json' }
                ]
            }
        };

        const app = {
            filteredQuestions: [],
            activeQuizQuestions: [],
            currentEspecialidad: '',
            currentAsignatura: null,
            asignaturasDisponibles: [],
            loadedData: {},
            
            // Estado del Quiz
            quiz: { 
                index: 0, 
                score: 0, 
                answered: false, 
                failedQuestions: [],
                answers: [] // Guarda {questionIndex, selectedOption, isCorrect}
            },
            
            // Configuraci√≥n de quiz
            quizSettings: {
                randomOrder: false, // false = orden original, true = orden aleatorio
                onlyMarked: false   // mostrar solo preguntas marcadas
            },
            
            // Preguntas marcadas como dif√≠ciles (guardadas en localStorage)
            markedQuestions: new Set(),
            
            // Historial de tests completados
            testHistory: [],
            
            // Estad√≠sticas por asignatura
            stats: {},
            
            // Preferencias guardadas
            savedPreferences: null,
            
            // Tema actual (light o dark)
            currentTheme: 'light',
            
            // Notas personales por pregunta
            questionNotes: {},
            
            // Tama√±o de fuente (porcentaje)
            fontSize: 100,
            
            // Contribuciones del usuario
            userContributions: [],
            
            // Estado de contribuci√≥n (para mantener especialidad, asignatura, tema)
            contribState: { especialidad: '', asignatura: '', tema: '' },
            
            // ID de contribuci√≥n siendo editada (null si es nueva)
            editingContribId: null,
            
            // Estado para persistir la b√∫squeda
            searchState: { term: '', resultsHTML: '' },
            
            // Modo examen
            // Modo examen
            examMode: {
                active: false,
                timeLimit: 30, // minutos
                questionCount: 30,
                startTime: null,
                endTime: null,
                timer: null
            },
            
            // Historial de respuestas incorrectas (para modo repaso)
            failedQuestionsHistory: [],
            
            // Controlar dropdown con clic
            toggleDropdown: (event) => {
                event.stopPropagation();
                const dropdown = document.getElementById('test-dropdown');
                dropdown.classList.toggle('active');
            },
            
            closeDropdown: () => {
                const dropdown = document.getElementById('test-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
            },
            
            init: async () => {
                app.showLoading('Cargando datos...');
                app.loadMarkedQuestions();
                app.loadTestHistory();
                app.loadStats();
                app.loadPreferences();
                app.loadQuestionNotes();
                app.loadContributions();
                app.loadContribState();
                app.loadFailedHistory();
                await app.loadInitialData();
                
                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('test-dropdown');
                    if (dropdown && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
                
                // Aplicar preferencias guardadas
                if (app.savedPreferences) {
                    if (app.savedPreferences.lastEspecialidad) {
                        app.currentEspecialidad = app.savedPreferences.lastEspecialidad;
                        await app.loadEspecialidadData(app.savedPreferences.lastEspecialidad);
                    }
                    if (app.savedPreferences.lastAsignatura) {
                        app.selectAsignatura(app.savedPreferences.lastAsignatura);
                        // Aplicar filtro de tema si hay uno guardado
                        if (app.savedPreferences.lastTema && app.savedPreferences.lastTema !== 'all') {
                            app.applyTemaFilter(app.savedPreferences.lastTema);
                        }
                    }
                    if (app.savedPreferences.randomOrder !== undefined) {
                        app.quizSettings.randomOrder = app.savedPreferences.randomOrder;
                    }
                    if (app.savedPreferences.onlyMarked !== undefined) {
                        app.quizSettings.onlyMarked = app.savedPreferences.onlyMarked;
                    }
                }
                
                // Cargar y aplicar tema
                app.loadTheme();
                
                // Cargar y aplicar tama√±o de fuente
                app.loadFontSize();
                
                // Configurar atajos de teclado
                app.setupKeyboardShortcuts();
                
                // Inicializar modal de ayuda
                app.initHelpModal();
                
                // Restaurar vista anterior o ir a home
                const savedView = localStorage.getItem('viu_current_view') || 'home';
                app.navigate(savedView);
            },
            
            // Gesti√≥n de tema oscuro/claro
            loadTheme: () => {
                const savedTheme = localStorage.getItem('viu_theme') || 'light';
                app.currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);
                app.updateThemeIcon();
            },
            
            toggleTheme: () => {
                const newTheme = app.currentTheme === 'light' ? 'dark' : 'light';
                app.currentTheme = newTheme;
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('viu_theme', newTheme);
                app.updateThemeIcon();
                app.showToast(newTheme === 'dark' ? 'üåô Modo oscuro activado' : '‚òÄÔ∏è Modo claro activado');
            },
            
            updateThemeIcon: () => {
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = app.currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                }
            },
            
            showHelp: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            },
            
            hideHelp: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            },
            
            initHelpModal: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    // Cerrar al hacer click fuera del contenido
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            app.hideHelp();
                        }
                    });
                    // Cerrar con tecla Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.style.display === 'flex') {
                            app.hideHelp();
                        }
                    });
                }
            },
            
            // Gesti√≥n de tama√±o de fuente
            loadFontSize: () => {
                const savedSize = localStorage.getItem('viu_font_size');
                if (savedSize) {
                    app.fontSize = parseInt(savedSize);
                } else {
                    app.fontSize = 100;
                }
                app.applyFontSize();
            },
            
            saveFontSize: (size) => {
                app.fontSize = size;
                localStorage.setItem('viu_font_size', size.toString());
                app.applyFontSize();
            },
            
            applyFontSize: () => {
                document.documentElement.style.fontSize = `${app.fontSize}%`;
            },
            
            // Cargar preguntas marcadas desde localStorage
            loadMarkedQuestions: () => {
                try {
                    const marked = localStorage.getItem('viu_marked_questions');
                    if (marked) {
                        app.markedQuestions = new Set(JSON.parse(marked));
                    }
                } catch (e) {
                    app.markedQuestions = new Set();
                }
            },
            
            // Guardar preguntas marcadas en localStorage
            saveMarkedQuestions: () => {
                try {
                    localStorage.setItem('viu_marked_questions', JSON.stringify([...app.markedQuestions]));
                } catch (e) {
                    console.error('Error guardando preguntas marcadas:', e);
                }
            },
            
            // Alternar marcado de pregunta
            toggleMarkQuestion: (questionId) => {
                if (app.markedQuestions.has(questionId)) {
                    app.markedQuestions.delete(questionId);
                    app.showToast('Pregunta desmarcada ‚≠ê');
                } else {
                    app.markedQuestions.add(questionId);
                    app.showToast('Pregunta marcada como dif√≠cil üîñ');
                }
                app.saveMarkedQuestions();
                app.renderQuiz(document.getElementById('app-container'));
            },
            
            // Limpiar todas las preguntas marcadas
            clearAllMarkedQuestions: () => {
                const count = app.markedQuestions.size;
                if (count === 0) {
                    app.showToast('No hay preguntas marcadas');
                    return;
                }
                if (confirm(`¬øEliminar todas las ${count} preguntas marcadas?`)) {
                    app.markedQuestions.clear();
                    app.saveMarkedQuestions();
                    // Desmarcar el checkbox si estaba marcado
                    app.quizSettings.onlyMarked = false;
                    app.showToast('‚úÖ Todas las preguntas desmarcadas');
                    // Recargar la vista actual para actualizar la UI
                    app.navigate('home');
                }
            },
            
            // Cargar notas de preguntas desde localStorage
            loadQuestionNotes: () => {
                try {
                    const notes = localStorage.getItem('viu_question_notes');
                    if (notes) {
                        app.questionNotes = JSON.parse(notes);
                    }
                } catch (e) {
                    app.questionNotes = {};
                }
            },
            
            // Guardar notas de preguntas en localStorage
            saveQuestionNotes: () => {
                try {
                    localStorage.setItem('viu_question_notes', JSON.stringify(app.questionNotes));
                } catch (e) {
                    console.error('Error guardando notas:', e);
                }
            },
            
            // Guardar/actualizar nota de una pregunta
            saveQuestionNote: (questionId, note) => {
                if (note && note.trim()) {
                    app.questionNotes[questionId] = note.trim();
                } else {
                    delete app.questionNotes[questionId];
                }
                app.saveQuestionNotes();
            },
            
            // Cargar contribuciones del usuario
            loadContributions: () => {
                try {
                    const contributions = localStorage.getItem('viu_user_contributions');
                    if (contributions) {
                        app.userContributions = JSON.parse(contributions);
                    }
                } catch (e) {
                    app.userContributions = [];
                }
            },
            
            // Guardar contribuciones del usuario
            saveContributions: () => {
                try {
                    localStorage.setItem('viu_user_contributions', JSON.stringify(app.userContributions));
                } catch (e) {
                    console.error('Error guardando contribuciones:', e);
                }
            },
            
            // Cargar estado de contribuci√≥n
            loadContribState: () => {
                try {
                    const state = localStorage.getItem('viu_contrib_state');
                    if (state) {
                        app.contribState = JSON.parse(state);
                    }
                } catch (e) {
                    app.contribState = { especialidad: '', asignatura: '', tema: '' };
                }
            },
            
            // Guardar estado de contribuci√≥n
            saveContribState: () => {
                try {
                    localStorage.setItem('viu_contrib_state', JSON.stringify(app.contribState));
                } catch (e) {
                    console.error('Error guardando estado de contribuci√≥n:', e);
                }
            },
            
            // Cargar historial de preguntas falladas
            loadFailedHistory: () => {
                try {
                    const failed = localStorage.getItem('viu_failed_questions');
                    if (failed) {
                        app.failedQuestionsHistory = JSON.parse(failed);
                    }
                } catch (e) {
                    console.error('Error cargando historial de fallos:', e);
                    app.failedQuestionsHistory = [];
                }
            },
            
            // Guardar historial de preguntas falladas
            saveFailedHistory: () => {
                try {
                    localStorage.setItem('viu_failed_questions', JSON.stringify(app.failedQuestionsHistory));
                } catch (e) {
                    console.error('Error guardando historial de fallos:', e);
                }
            },
            
            // A√±adir nueva contribuci√≥n
            addContribution: (contribution) => {
                contribution.id = 'contrib_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                contribution.timestamp = new Date().toISOString();
                app.userContributions.push(contribution);
                app.saveContributions();
                app.showToast('‚úÖ Pregunta a√±adida a tus contribuciones');
            },
            
            // Editar contribuci√≥n
            editContribution: (id) => {
                const contrib = app.userContributions.find(c => c.id === id);
                if (!contrib) return;
                
                // Guardar ID de contribuci√≥n que se est√° editando
                app.editingContribId = id;
                
                // Restaurar estado de la contribuci√≥n
                app.contribState.especialidad = '';
                app.contribState.asignatura = contrib.asignaturaId;
                app.contribState.tema = contrib.tema;
                
                // Detectar si es de especialidad
                const parts = contrib.asignaturaId.split('-');
                if (parts.length > 2) {
                    app.contribState.especialidad = parts[0] + '-' + parts[1];
                }
                
                // Navegar a la vista de contribuir
                app.navigate('contribute');
                
                // Esperar a que se renderice y luego cargar los datos
                setTimeout(async () => {
                    // Seleccionar especialidad si existe
                    const espSelect = document.getElementById('contrib-especialidad');
                    if (espSelect && app.contribState.especialidad) {
                        espSelect.value = app.contribState.especialidad;
                        await app.updateContribAsignaturas();
                    }
                    
                    // Seleccionar asignatura
                    const asigSelect = document.getElementById('contrib-asignatura');
                    if (asigSelect) {
                        asigSelect.value = contrib.asignaturaId;
                    }
                    
                    // Iniciar el formulario de contribuci√≥n
                    app.startContributing();
                    
                    // Cargar los datos de la contribuci√≥n en el formulario
                    setTimeout(() => {
                        document.getElementById('contrib-tema').value = contrib.tema;
                        document.getElementById('contrib-question').value = contrib.question;
                        document.getElementById('contrib-option-1').value = contrib.options[0];
                        document.getElementById('contrib-option-2').value = contrib.options[1];
                        document.getElementById('contrib-option-3').value = contrib.options[2];
                        document.getElementById('contrib-option-4').value = contrib.options[3];
                        
                        // Seleccionar la respuesta correcta
                        const correctIdx = contrib.options.indexOf(contrib.answer) + 1;
                        document.getElementById('contrib-correct').value = correctIdx;
                        
                        // Cambiar el bot√≥n de enviar
                        const submitBtn = document.querySelector('#contrib-form-area button[onclick="app.submitContribution()"]');
                        if (submitBtn) {
                            submitBtn.innerHTML = 'üíæ Guardar Cambios';
                            submitBtn.style.background = '#3b82f6';
                        }
                        
                        app.showToast('‚úèÔ∏è Editando contribuci√≥n');
                    }, 100);
                }, 200);
            },
            
            // Eliminar contribuci√≥n
            deleteContribution: (id) => {
                if (confirm('¬øEliminar esta contribuci√≥n?')) {
                    app.userContributions = app.userContributions.filter(c => c.id !== id);
                    app.saveContributions();
                    app.showToast('üóëÔ∏è Contribuci√≥n eliminada');
                    // Solo actualizar la lista, no recargar toda la vista
                    app.renderContributionsList();
                }
            },
            
            // Limpiar todas las contribuciones
            clearAllContributions: () => {
                if (confirm(`¬øEliminar todas las ${app.userContributions.length} contribuciones?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                    app.userContributions = [];
                    app.saveContributions();
                    app.showToast('‚úÖ Todas las contribuciones eliminadas');
                    // Solo actualizar la lista, no recargar toda la vista
                    app.renderContributionsList();
                }
            },
            
            // Exportar contribuciones como JSON
            exportContributions: () => {
                if (app.userContributions.length === 0) {
                    app.showToast('‚ö†Ô∏è No hay contribuciones para exportar');
                    return;
                }
                
                // Reparar contribuciones antiguas que no tienen baseFileName
                const repairedContributions = app.userContributions.map(contrib => {
                    if (!contrib.baseFileName) {
                        // Intentar encontrar la asignatura para obtener el baseFileName
                        const asignatura = app.asignaturasDisponibles.find(a => a.id === contrib.asignaturaId);
                        if (asignatura && asignatura.archivo) {
                            contrib.baseFileName = asignatura.archivo.split('/').pop().replace('.json', '');
                        } else {
                            // Fallback: intentar derivarlo del asignaturaId
                            // Si tiene prefijo de especialidad (3+ partes), quitar las primeras 2
                            const parts = contrib.asignaturaId.split('-');
                            contrib.baseFileName = parts.length > 3 ? parts.slice(2).join('-') : contrib.asignaturaId;
                        }
                    }
                    return contrib;
                });
                
                const dataStr = JSON.stringify(repairedContributions, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `contribuciones_viu_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                // Guardar las contribuciones reparadas
                app.userContributions = repairedContributions;
                app.saveContributions();
                
                app.showToast('üì• Archivo descargado. Las contribuciones se mantienen guardadas.');
            },
            
            // Configurar atajos de teclado
            setupKeyboardShortcuts: () => {
                document.addEventListener('keydown', (e) => {
                    // Solo en vista de quiz
                    if (!window.location.hash.includes('quiz') && app.quiz.index >= 0) {
                        const container = document.getElementById('app-container');
                        if (!container || !container.querySelector('.option-btn')) return;
                    }
                    
                    // Si est√° escribiendo en un input/textarea, ignorar
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    // N√∫meros 1-4 para seleccionar opciones
                    if (['1', '2', '3', '4'].includes(e.key)) {
                        const index = parseInt(e.key) - 1;
                        const buttons = document.querySelectorAll('.option-btn');
                        if (buttons[index] && !buttons[index].disabled && !app.quiz.answered) {
                            e.preventDefault();
                            buttons[index].click();
                        }
                    }
                    
                    // Enter para siguiente
                    if (e.key === 'Enter') {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn && !nextBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            nextBtn.click();
                        }
                    }
                    
                    // Flechas para navegar
                    if (e.key === 'ArrowLeft') {
                        const prevBtn = document.querySelector('button[onclick="app.previousQuestion()"]');
                        if (prevBtn) {
                            e.preventDefault();
                            prevBtn.click();
                        }
                    }
                    
                    if (e.key === 'ArrowRight') {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn && !nextBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            nextBtn.click();
                        }
                    }
                });
            },
            
            // Cargar historial de tests
            loadTestHistory: () => {
                try {
                    const history = localStorage.getItem('viu_test_history');
                    if (history) {
                        app.testHistory = JSON.parse(history);
                    }
                } catch (e) {
                    app.testHistory = [];
                }
            },
            
            // Guardar historial de tests
            saveTestHistory: () => {
                try {
                    localStorage.setItem('viu_test_history', JSON.stringify(app.testHistory));
                } catch (e) {
                    console.error('Error guardando historial:', e);
                }
            },
            
            // Cargar estad√≠sticas
            loadStats: () => {
                try {
                    const stats = localStorage.getItem('viu_stats');
                    if (stats) {
                        app.stats = JSON.parse(stats);
                    }
                } catch (e) {
                    app.stats = {};
                }
            },
            
            // Guardar estad√≠sticas
            saveStats: () => {
                try {
                    localStorage.setItem('viu_stats', JSON.stringify(app.stats));
                } catch (e) {
                    console.error('Error guardando estad√≠sticas:', e);
                }
            },
            
            // Cargar preferencias del usuario
            loadPreferences: () => {
                try {
                    const prefs = localStorage.getItem('viu_preferences');
                    if (prefs) {
                        const saved = JSON.parse(prefs);
                        app.savedPreferences = saved;
                    }
                } catch (e) {
                    app.savedPreferences = null;
                }
            },
            
            // Guardar preferencias del usuario
            savePreferences: () => {
                try {
                    const unitSelector = document.getElementById('unit-selector');
                    const prefs = {
                        lastAsignatura: app.currentAsignatura ? app.currentAsignatura.id : null,
                        lastEspecialidad: app.currentEspecialidad,
                        lastTema: unitSelector ? unitSelector.value : 'all',
                        randomOrder: app.quizSettings.randomOrder,
                        onlyMarked: app.quizSettings.onlyMarked
                    };
                    localStorage.setItem('viu_preferences', JSON.stringify(prefs));
                } catch (e) {
                    console.error('Error guardando preferencias:', e);
                }
            },
            
            // Registrar test completado
            recordTestCompletion: (score, total, asignatura, tema) => {
                const percentage = Math.round((score / total) * 100);
                const testRecord = {
                    date: new Date().toISOString(),
                    asignatura: asignatura,
                    tema: tema || 'Todos',
                    score: score,
                    total: total,
                    percentage: percentage
                };
                
                // A√±adir al historial
                app.testHistory.unshift(testRecord);
                // Mantener solo los √∫ltimos 50 tests
                if (app.testHistory.length > 50) {
                    app.testHistory = app.testHistory.slice(0, 50);
                }
                app.saveTestHistory();
                
                // Guardar preguntas falladas en el historial
                if (app.quiz.failedQuestions && app.quiz.failedQuestions.length > 0) {
                    app.quiz.failedQuestions.forEach(q => {
                        // Buscar si ya existe en el historial
                        const existing = app.failedQuestionsHistory.find(fq => fq.id === q.id && fq.subject === q.subject);
                        if (existing) {
                            existing.failCount = (existing.failCount || 1) + 1;
                            existing.lastFailed = new Date().toISOString();
                        } else {
                            app.failedQuestionsHistory.push({
                                ...q,
                                failCount: 1,
                                lastFailed: new Date().toISOString()
                            });
                        }
                    });
                    // Mantener solo las √∫ltimas 200 preguntas falladas
                    if (app.failedQuestionsHistory.length > 200) {
                        app.failedQuestionsHistory = app.failedQuestionsHistory.slice(0, 200);
                    }
                    app.saveFailedHistory();
                }
                
                // Actualizar estad√≠sticas por asignatura
                if (!app.stats[asignatura]) {
                    app.stats[asignatura] = {
                        totalTests: 0,
                        totalQuestions: 0,
                        correctAnswers: 0,
                        lastTest: null
                    };
                }
                
                app.stats[asignatura].totalTests++;
                app.stats[asignatura].totalQuestions += total;
                app.stats[asignatura].correctAnswers += score;
                app.stats[asignatura].lastTest = testRecord.date;
                app.saveStats();
            },

            // Cargar datos iniciales
            loadInitialData: async () => {
                try {
                    // Intentar cargar todas las asignaturas obligatorias
                for (const asig of CONFIG.asignaturas.obligatorias) {
                    try {
                        const response = await fetch(`data/asignaturas/${asig.archivo}?t=${Date.now()}`);
                        if (response.ok) {
                            const data = await response.json();
                            app.loadedData[asig.id] = data;
                        }
                    } catch (error) {
                        console.warn(`No se pudo cargar ${asig.nombre}`);
                    }
                }                    // Intentar cargar optativas comunes
                for (const asig of CONFIG.asignaturas.optativas) {
                    try {
                        const response = await fetch(`data/asignaturas/${asig.archivo}?t=${Date.now()}`);
                        if (response.ok) {
                            const data = await response.json();
                            app.loadedData[asig.id] = data;
                        }
                    } catch (error) {
                        console.warn(`No se pudo cargar ${asig.nombre}`);
                    }
                }                    app.updateAvailableSubjects();
                } catch (error) {
                    console.error('Error cargando datos:', error);
                }
            },
            
            // Cargar asignaturas de especialidad
            loadEspecialidadData: async (especialidadId) => {
                const especialidadPath = `data/asignaturas/especialidades/${especialidadId}`;
                const asignaturasEsp = especialidadId === 'orientacion-educativa' 
                    ? CONFIG.asignaturas.especialidadOrientacion 
                    : CONFIG.asignaturas.especialidad;
                
                for (const asig of asignaturasEsp) {
                    const key = `${especialidadId}-${asig.id}`;
                    if (!app.loadedData[key]) {
                        try {
                            const url = `${especialidadPath}/${asig.archivo}?t=${Date.now()}`;
                            const response = await fetch(url);
                            if (response.ok) {
                                const data = await response.json();
                                app.loadedData[key] = data;
                            }
                        } catch (error) {
                            console.warn(`No se pudo cargar ${asig.nombre} de ${especialidadId}`);
                        }
                    }
                }
                app.updateAvailableSubjects();
            },
            
            // Actualizar lista de asignaturas disponibles
            updateAvailableSubjects: () => {
                app.asignaturasDisponibles = [];
                
                // Obligatorias
                CONFIG.asignaturas.obligatorias.forEach(asig => {
                    if (app.loadedData[asig.id]) {
                        app.asignaturasDisponibles.push({
                            id: asig.id,
                            nombre: asig.nombre,
                            tipo: 'obligatoria',
                            archivo: asig.archivo,
                            data: app.loadedData[asig.id]
                        });
                    }
                });
                
                // Optativas
                CONFIG.asignaturas.optativas.forEach(asig => {
                    if (app.loadedData[asig.id]) {
                        app.asignaturasDisponibles.push({
                            id: asig.id,
                            nombre: asig.nombre,
                            tipo: 'optativa',
                            archivo: asig.archivo,
                            data: app.loadedData[asig.id]
                        });
                    }
                });
                
                // Especialidad seleccionada
                if (app.currentEspecialidad) {
                    const asignaturasEsp = app.currentEspecialidad === 'orientacion-educativa' 
                        ? CONFIG.asignaturas.especialidadOrientacion 
                        : CONFIG.asignaturas.especialidad;
                    
                    asignaturasEsp.forEach(asig => {
                        const key = `${app.currentEspecialidad}-${asig.id}`;
                        if (app.loadedData[key]) {
                            app.asignaturasDisponibles.push({
                                id: key,
                                nombre: asig.nombre,
                                tipo: 'especialidad',
                                especialidad: CONFIG.especialidades[app.currentEspecialidad],
                                archivo: asig.archivo,
                                baseId: asig.id,
                                data: app.loadedData[key]
                            });
                        }
                    });
                }
                
                // Seleccionar primera asignatura con preguntas si no hay ninguna seleccionada
                if (!app.currentAsignatura && app.asignaturasDisponibles.length > 0) {
                    const firstWithQuestions = app.asignaturasDisponibles.find(a => 
                        a.data.temas && a.data.temas.some(t => t.preguntas && t.preguntas.length > 0)
                    );
                    if (firstWithQuestions) {
                        app.selectAsignatura(firstWithQuestions.id);
                    }
                }
            },
            
            // Seleccionar asignatura
            selectAsignatura: (asigId) => {
                const asig = app.asignaturasDisponibles.find(a => a.id === asigId);
                if (asig) {
                    app.currentAsignatura = asig;
                    app.updateQuestionsFromAsignatura();
                }
            },
            
            // Actualizar preguntas desde la asignatura actual
            updateQuestionsFromAsignatura: () => {
                if (!app.currentAsignatura) {
                    app.filteredQuestions = [];
                    return;
                }
                
                const data = app.currentAsignatura.data;
                app.filteredQuestions = [];
                
                if (!data.temas || !Array.isArray(data.temas)) {
                    console.error('Datos inv√°lidos: no hay temas', data);
                    return;
                }
                
                data.temas.forEach(tema => {
                    if (tema.preguntas && Array.isArray(tema.preguntas)) {
                        tema.preguntas.forEach(p => {
                            app.filteredQuestions.push({
                                id: p.id,
                                subject: data.asignatura,
                                unit: tema.numero,
                                question: p.pregunta,
                                options: p.opciones,
                                answer: p.respuesta_correcta
                            });
                        });
                    }
                });
            },
            
            // Aplicar filtro de tema espec√≠fico
            applyTemaFilter: (temaNum) => {
                if (!app.currentAsignatura || temaNum === 'all') {
                    app.updateQuestionsFromAsignatura();
                    return;
                }
                
                const data = app.currentAsignatura.data;
                app.filteredQuestions = [];
                
                if (!data.temas || !Array.isArray(data.temas)) return;
                
                const tema = data.temas.find(t => t.numero == temaNum);
                if (tema && tema.preguntas && Array.isArray(tema.preguntas)) {
                    tema.preguntas.forEach(p => {
                        app.filteredQuestions.push({
                            id: p.id,
                            subject: data.asignatura,
                            unit: tema.numero,
                            question: p.pregunta,
                            options: p.opciones,
                            answer: p.respuesta_correcta
                        });
                    });
                }
            },
            
            showLoading: (message = 'Cargando...') => {
                const container = document.getElementById('app-container');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-box">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                            <p>${message}</p>
                        </div>
                    `;
                }
            },
            
            // Navegaci√≥n
            navigate: (viewId, param = null) => {
                // Cerrar dropdown si est√° abierto
                app.closeDropdown();
                
                // Guardar vista actual
                localStorage.setItem('viu_current_view', viewId);
                
                // Actualizar men√∫
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                
                // Limpiar estado de b√∫squeda si no vamos a la vista de b√∫squeda o detalle
                if (viewId !== 'search' && viewId !== 'detail') {
                    app.searchState = { term: '', resultsHTML: '' };
                }

                // L√≥gica segura para encontrar el bot√≥n activo
                let activeBtn = null;
                try {
                    // Si navegamos a 'detail', el bot√≥n activo sigue siendo 'search'
                    const targetView = viewId === 'detail' ? 'search' : viewId;
                    
                    // Para vistas de test (quiz, exam-mode, review-mode), no marcar ning√∫n bot√≥n principal como activo
                    if (['quiz', 'exam-mode', 'review-mode'].includes(viewId)) {
                        // No marcar ninguno
                    } else {
                        activeBtn = document.querySelector(`button[onclick="app.navigate('${targetView}')"]`);
                    }
                } catch(e) { /* Bot√≥n no encontrado */ }

                if (activeBtn) activeBtn.classList.add('active');

                const container = document.getElementById('app-container');
                container.innerHTML = '';

                switch(viewId) {
                    case 'home': app.renderHome(container); break;
                    case 'quiz': app.renderQuiz(container); break;
                    case 'exam-mode': app.renderExamMode(container); break;
                    case 'review-mode': app.renderReviewMode(container); break;
                    case 'summary': app.renderSummary(container); break;
                    case 'stats-advanced': app.renderAdvancedStats(container); break;
                    case 'search': app.renderSearch(container); break;
                    case 'detail': app.renderDetail(container, param); break;
                    case 'history': app.renderHistory(container); break;
                    case 'contribute': app.renderContribute(container); break;
                    case 'admin': app.renderAdmin(container); break;
                    default: app.renderHome(container);
                }
            },

            // --- VISTAS ---
            renderHome: (container) => {
                // Opciones de especialidad
                const especialidadOptions = Object.entries(CONFIG.especialidades).map(([id, nombre]) => 
                    `<option value="${id}" ${id === app.currentEspecialidad ? 'selected' : ''}>${nombre}</option>`
                ).join('');
                
                // Agrupar asignaturas por tipo
                const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                const especialidad = app.asignaturasDisponibles.filter(a => a.tipo === 'especialidad');
                
                let asignaturaOptions = '';
                
                if (obligatorias.length > 0) {
                    asignaturaOptions += '<optgroup label="üìï Obligatorias">';
                    obligatorias.forEach(a => {
                        const numPreguntas = a.data.temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (optativas.length > 0) {
                    asignaturaOptions += '<optgroup label="üìó Optativas Comunes">';
                    optativas.forEach(a => {
                        const numPreguntas = a.data.temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (especialidad.length > 0) {
                    asignaturaOptions += `<optgroup label="üìò ${app.currentAsignatura?.especialidad || 'Especialidad'}">`;
                    especialidad.forEach(a => {
                        const numPreguntas = a.data.temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                const totalPreguntas = app.filteredQuestions.length;
                const canStartQuiz = totalPreguntas > 0;
                
                // Obtener temas disponibles de la asignatura actual
                let temasDisponibles = [];
                if (app.currentAsignatura && app.currentAsignatura.data.temas) {
                    temasDisponibles = app.currentAsignatura.data.temas.filter(t => t.preguntas && t.preguntas.length > 0);
                }
                
                const savedTema = app.savedPreferences?.lastTema || 'all';
                const unitOptions = temasDisponibles.map(tema => 
                    `<option value="${tema.numero}" ${savedTema == tema.numero ? 'selected' : ''}>${tema.nombre} (${tema.preguntas.length} preguntas)</option>`
                ).join('');
                
                // Determinar el tema seleccionado para mostrar en el mensaje
                const currentTema = savedTema === 'all' ? 'all' : savedTema;
                const temaInfo = currentTema !== 'all' 
                    ? `‚úÖ ${totalPreguntas} preguntas disponibles - Tema ${currentTema}`
                    : `‚úÖ ${totalPreguntas} preguntas disponibles (${temasDisponibles.length} temas)`;
                
                container.innerHTML = `
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                        <h1>ZONA DE ESTUDIO VIU</h1>
                        <p class="text-muted" style="margin-bottom: 2rem;">Master en Formaci√≥n del Profesorado</p>
                        
                        <div style="max-width:500px; margin: 2rem auto; text-align:left;">
                            <div class="form-group">
                                <label class="form-label">üéì Especialidad (opcional):</label>
                                <select id="especialidad-selector" class="form-select" onchange="app.changeEspecialidad(this.value)">
                                    <option value="">Sin especialidad</option>
                                    ${especialidadOptions}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìñ Asignatura:</label>
                                <select id="asignatura-selector" class="form-select" onchange="app.changeAsignatura(this.value)" ${!asignaturaOptions ? 'disabled' : ''}>
                                    ${asignaturaOptions || '<option value="">No hay asignaturas disponibles</option>'}
                                </select>
                            </div>
                            
                            ${canStartQuiz ? `
                            <div class="form-group">
                                <label class="form-label">üìù Modo de Test:</label>
                                <select id="unit-selector" class="form-select">
                                    <option value="all">üìö Todas las preguntas (${totalPreguntas})</option>
                                    ${unitOptions}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">‚öôÔ∏è Configuraci√≥n:</label>
                                <div class="bg-light-box border-light" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; border: 1px solid;">
                                    <label class="text-dark" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                                        <input type="checkbox" id="random-order-check" ${app.quizSettings.randomOrder ? 'checked' : ''} 
                                               onchange="app.quizSettings.randomOrder = this.checked" 
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>üé≤ Orden aleatorio de preguntas</span>
                                    </label>
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                                        <label class="text-dark" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; flex: 1;">
                                            <input type="checkbox" id="only-marked-check" ${app.quizSettings.onlyMarked ? 'checked' : ''} 
                                                   onchange="app.quizSettings.onlyMarked = this.checked; app.updateMarkedCount()" 
                                                   style="width: 18px; height: 18px; cursor: pointer;"
                                                   ${app.markedQuestions.size === 0 ? 'disabled' : ''}>
                                            <span id="marked-label" style="${app.markedQuestions.size === 0 ? 'opacity: 0.5;' : ''}">üîñ Solo preguntas marcadas (<span id="marked-count">0</span>)</span>
                                        </label>
                                        <button id="clear-marked-btn"
                                                style="padding: 0.25rem 0.4rem; background: #fca5a5; color: #7f1d1d; border: 1px solid #f87171; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; display: ${app.markedQuestions.size > 0 ? 'flex' : 'none'}; align-items: center; justify-content: center; min-width: 28px; height: 28px;"
                                                title="Limpiar todas las preguntas marcadas">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                    <div class="text-dark" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <label style="font-weight: 500; display: flex; align-items: center; justify-content: space-between;">
                                            <span>üî§ Tama√±o de letra</span>
                                            <span id="font-size-value" style="font-size: 0.9rem; color: var(--text-secondary);">${app.fontSize || 100}%</span>
                                        </label>
                                        <input type="range" id="font-size-slider" min="80" max="120" step="5" value="${app.fontSize || 100}"
                                               style="width: 100%; cursor: pointer; accent-color: var(--primary);">
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div id="quiz-info-box" style="background:${canStartQuiz ? '#dcfce7' : '#fee2e2'}; padding:1rem; border-radius:8px; margin-bottom:2rem; border: 2px solid ${canStartQuiz ? 'var(--success)' : 'var(--error)'};">
                            <p style="margin:0; font-weight:600; color: ${canStartQuiz ? '#065f46' : '#991b1b'};">
                                ${canStartQuiz 
                                    ? temaInfo
                                    : '‚ö†Ô∏è Esta asignatura a√∫n no tiene preguntas disponibles'}
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 1rem; max-width: 400px; margin: 0 auto;">
                            <button class="btn ${!canStartQuiz ? 'btn-secondary' : ''}" onclick="app.startQuiz()" ${!canStartQuiz ? 'disabled' : ''}>
                                üìù Comenzar Test Normal
                            </button>
                            <button class="btn" style="background: #dc2626; border-color: #dc2626;" onclick="app.navigate('exam-mode')" ${!canStartQuiz ? 'disabled' : ''}>
                                üìù Modo Examen (con tiempo)
                            </button>
                            <button class="btn" style="background: #0891b2; border-color: #0891b2;" onclick="app.navigate('review-mode')" ${app.failedQuestionsHistory.length === 0 ? 'disabled' : ''}>
                                üîÑ Repasar Preguntas Falladas (${app.failedQuestionsHistory.length})
                            </button>
                            ${canStartQuiz ? `
                            <button class="btn btn-outline" onclick="app.navigate('summary')">
                                üìñ Ver Resumen del Tema
                            </button>
                            ` : ''}
                        </div>
                        
                        ${app.currentAsignatura ? `
                        <div class="bg-light-box" style="margin-top: 2rem; padding: 1rem; border-radius: 8px; text-align: left;">
                            <h3 style="font-size: 1rem; margin-top:0;">‚ÑπÔ∏è Informaci√≥n de la asignatura:</h3>
                            <ul style="margin:0; padding-left: 1.5rem;">
                                <li><strong>Nombre:</strong> ${app.currentAsignatura.nombre}</li>
                                <li><strong>Tipo:</strong> ${app.currentAsignatura.tipo}</li>
                                ${app.currentAsignatura.especialidad ? `<li><strong>Especialidad:</strong> ${app.currentAsignatura.especialidad}</li>` : ''}
                                <li><strong>Temas:</strong> ${app.currentAsignatura.data.temas.length}</li>
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${app.renderStatsSection()}
                    </div>
                `;
                
                // Actualizar contador de preguntas marcadas despu√©s de renderizar
                setTimeout(() => {
                    app.updateMarkedCount();
                    
                    // Registrar evento del bot√≥n de limpiar marcadas
                    const clearBtn = document.getElementById('clear-marked-btn');
                    if (clearBtn) {
                        clearBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            app.clearAllMarkedQuestions();
                        });
                    }
                    
                    // Guardar preferencias cuando cambian los checkboxes
                    const randomCheck = document.getElementById('random-order-check');
                    const onlyMarkedCheck = document.getElementById('only-marked-check');
                    const unitSelector = document.getElementById('unit-selector');
                    const fontSizeSlider = document.getElementById('font-size-slider');
                    const fontSizeValue = document.getElementById('font-size-value');
                    
                    if (randomCheck) {
                        randomCheck.addEventListener('change', () => app.savePreferences());
                    }
                    if (onlyMarkedCheck) {
                        onlyMarkedCheck.addEventListener('change', () => app.savePreferences());
                    }
                    if (fontSizeSlider && fontSizeValue) {
                        fontSizeSlider.addEventListener('input', (e) => {
                            const value = parseInt(e.target.value);
                            fontSizeValue.textContent = value + '%';
                            app.saveFontSize(value);
                        });
                    }
                    if (unitSelector) {
                        unitSelector.addEventListener('change', () => {
                            const selectedValue = unitSelector.value;
                            
                            // Aplicar filtro de tema
                            app.applyTemaFilter(selectedValue);
                            
                            app.savePreferences();
                            
                            // Actualizar el mensaje din√°micamente
                            const infoBox = document.getElementById('quiz-info-box');
                            if (infoBox) {
                                const temas = app.currentAsignatura?.data?.temas?.filter(t => t.preguntas && t.preguntas.length > 0) || [];
                                let totalQ = app.filteredQuestions.length;
                                
                                if (selectedValue === 'all') {
                                    infoBox.innerHTML = `<p style="margin:0; font-weight:600; color: #065f46;">‚úÖ ${totalQ} preguntas disponibles (${temas.length} temas)</p>`;
                                } else {
                                    infoBox.innerHTML = `<p style="margin:0; font-weight:600; color: #065f46;">‚úÖ ${totalQ} preguntas disponibles - Tema ${selectedValue}</p>`;
                                }
                            }
                        });
                    }
                }, 0);
            },
            
            renderQuiz: (container) => {
                // Usamos activeQuizQuestions en lugar de filteredQuestions
                const questions = app.activeQuizQuestions;
                if (!questions || questions.length === 0) {
                    container.innerHTML = `<div class="card text-center"><h3>‚ö†Ô∏è No hay preguntas activas.</h3><p>Ve al inicio para configurar el test.</p><button class="btn" onclick="app.navigate('home')">Ir al Inicio</button></div>`;
                    return;
                }
                if (app.quiz.index >= questions.length) {
                    app.renderQuizResult(container);
                    return;
                }
                
                const q = questions[app.quiz.index];
                const progress = ((app.quiz.index) / questions.length) * 100;
                
                // Verificar si esta pregunta ya fue respondida
                const previousAnswer = app.quiz.answers[app.quiz.index];
                app.quiz.answered = !!previousAnswer;
                
                // Mezclar opciones solo si no hay respuesta previa (para mantener consistencia)
                const shuffledOptions = previousAnswer ? q.options : app.shuffle([...q.options]);
                
                container.innerHTML = `
                    <div class="card">
                        ${app.examMode.active ? `
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #dc2626;">
                            <div style="text-align: center; margin-bottom: 0.75rem;">
                                <div id="exam-timer" style="font-size: 1.5rem; font-weight: 600; color: #dc2626;">‚è±Ô∏è --:--</div>
                                <div style="font-size: 0.85rem; color: #991b1b; margin-top: 0.25rem;">Modo Examen - Tiempo restante</div>
                            </div>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap; justify-content: center;">
                                ${app.activeQuizQuestions.map((_, idx) => {
                                    const answered = app.quiz.answers[idx];
                                    const isCurrent = idx === app.quiz.index;
                                    return `<div style="width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: 2px solid ${isCurrent ? '#dc2626' : answered ? '#22c55e' : '#cbd5e1'}; background: ${answered ? '#dcfce7' : 'white'}; color: ${isCurrent ? '#dc2626' : answered ? '#166534' : '#64748b'};" onclick="app.jumpToQuestion(${idx})" title="${answered ? 'Respondida' : 'Sin responder'}">${idx + 1}</div>`;
                                }).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.75rem; color: #991b1b;">
                                Respondidas: ${app.quiz.answers.filter(a => a).length} / ${app.activeQuizQuestions.length}
                            </div>
                        </div>
                        ` : ''}
                        <div class="quiz-header">
                            <span>Pregunta ${app.quiz.index + 1} de ${questions.length}</span>
                            <span class="tag tag-subject">${q.subject} - U${q.unit}</span>
                        </div>
                        <div class="quiz-progress"><div class="progress-bar" style="width: ${progress}%"></div></div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div class="question-text" style="flex: 1;">${q.question}</div>
                            <button onclick="app.toggleMarkQuestion('${q.id}')" 
                                    style="background: ${app.markedQuestions.has(q.id) ? '#f59e0b' : 'transparent'}; 
                                           border: 2px solid ${app.markedQuestions.has(q.id) ? '#f59e0b' : '#cbd5e1'}; 
                                           color: ${app.markedQuestions.has(q.id) ? 'white' : '#64748b'}; 
                                           padding: 0.5rem 0.75rem; 
                                           border-radius: 8px; 
                                           cursor: pointer; 
                                           font-size: 1.2rem; 
                                           transition: all 0.2s;
                                           flex-shrink: 0;
                                           margin-left: 1rem;"
                                    title="${app.markedQuestions.has(q.id) ? 'Desmarcar pregunta' : 'Marcar como dif√≠cil'}">
                                ${app.markedQuestions.has(q.id) ? 'üîñ' : '‚≠ê'}
                            </button>
                        </div>
                        
                        <div id="options-container">
                            ${shuffledOptions.map((opt, idx) => `
                                <button class="option-btn" data-option="${idx}" onclick="app.checkAnswer(this)" ${previousAnswer ? 'disabled' : ''}>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-area" class="${previousAnswer ? '' : 'hidden'} bg-light-box" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px;"></div>
                        
                        ${!app.examMode.active ? `
                        <div class="bg-light-box" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">
                                üìù Notas personales:
                            </label>
                            <textarea id="question-note" 
                                      placeholder="Escribe aqu√≠ tus apuntes o recordatorios sobre esta pregunta..."
                                      style="width: 100%; 
                                             min-height: 80px; 
                                             padding: 0.75rem; 
                                             border: 1px solid var(--border); 
                                             border-radius: 6px; 
                                             font-family: inherit; 
                                             font-size: 0.95rem; 
                                             resize: vertical;
                                             background: var(--card);
                                             color: var(--text-primary);">${app.questionNotes[q.id] || ''}</textarea>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                            <div>
                                ${app.quiz.index > 0 ? `
                                <button class="btn btn-outline" style="width: auto;" onclick="app.previousQuestion()">‚¨Ö Anterior</button>
                                ` : ''}
                            </div>
                            ${app.examMode.active ? `
                            <div style="flex: 1; display: flex; justify-content: center;">
                                <button class="btn" style="background: #dc2626; border-color: #dc2626;" onclick="app.finishExam()">‚úÖ Finalizar Examen</button>
                            </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px;">
                                ${app.examMode.active && app.quiz.index < questions.length - 1 ? `
                                <button class="btn" style="width: auto;" onclick="app.nextQuestion()">Siguiente ‚ûú</button>
                                ` : !app.examMode.active && !previousAnswer ? `
                                <button class="btn btn-warning" style="width: auto;" onclick="app.skipQuestion()">Saltar ‚Ü∑</button>
                                ` : ''}
                                ${!app.examMode.active && app.quiz.index < questions.length - 1 ? `
                                <button id="next-btn" class="btn ${previousAnswer ? '' : 'hidden'}" style="width: auto;" onclick="app.nextQuestion()">Siguiente ‚ûú</button>
                                ` : !app.examMode.active ? `
                                <button id="next-btn" class="btn ${previousAnswer ? '' : 'hidden'}" style="width: auto;" onclick="app.nextQuestion()">Ver Resultados üèÅ</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-center"><button class="btn-outline" style="border:none; font-size:0.8rem;" onclick="app.navigate('home')">Salir del test</button></div>
                `;
                
                // Si ya fue respondida, mostrar el feedback guardado
                if (previousAnswer) {
                    const feedback = document.getElementById('feedback-area');
                    const optionButtons = document.querySelectorAll('.option-btn');
                    
                    // En modo examen, solo mostrar selecci√≥n sin revelar si es correcta (y permitir cambio)
                    if (app.examMode.active) {
                        optionButtons.forEach(btn => {
                            const optText = btn.innerText.trim();
                            if (optText === previousAnswer.selectedOption) {
                                btn.classList.add('selected');
                            }
                            // NO deshabilitar botones para permitir cambiar
                            btn.disabled = false;
                        });
                    } else {
                        // Modo normal: mostrar correctas e incorrectas
                        optionButtons.forEach(btn => {
                            const optText = btn.innerText.trim();
                            if (optText === previousAnswer.selectedOption) {
                                btn.classList.add(previousAnswer.isCorrect ? 'correct' : 'incorrect');
                            }
                            if (optText === q.answer) {
                                btn.classList.add('correct');
                            }
                        });
                        
                        if (previousAnswer.isCorrect) {
                            feedback.innerHTML = `<b style="color:var(--success)">¬°Correcto! üéâ</b>`;
                        } else {
                            feedback.innerHTML = `<b style="color:var(--error)">Incorrecto.</b><br>La respuesta correcta es: <b>${q.answer}</b>`;
                        }
                    }
                }
                
                // Event listener para guardar notas
                const noteTextarea = document.getElementById('question-note');
                if (noteTextarea) {
                    noteTextarea.addEventListener('blur', () => {
                        app.saveQuestionNote(q.id, noteTextarea.value);
                    });
                    // Tambi√©n guardar al escribir (con debounce simple)
                    let saveTimeout;
                    noteTextarea.addEventListener('input', () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(() => {
                            app.saveQuestionNote(q.id, noteTextarea.value);
                        }, 1000);
                    });
                }
            },
            
            // Renderizar secci√≥n de estad√≠sticas
            renderStatsSection: () => {
                const currentAsigName = app.currentAsignatura ? app.currentAsignatura.nombre : null;
                const asigStats = currentAsigName && app.stats[currentAsigName] ? app.stats[currentAsigName] : null;
                
                // √öltimos 5 tests
                const recentTests = app.testHistory.slice(0, 5);
                
                if (!asigStats && recentTests.length === 0) {
                    return ''; // No mostrar nada si no hay datos
                }
                
                let statsHTML = '<div class="bg-blue-light" style="margin-top: 2rem; padding: 1rem; border-radius: 8px; border: 2px solid var(--primary); text-align: left;">';
                statsHTML += '<h3 class="text-dark" style="font-size: 1rem; margin-top:0;">üìä Estad√≠sticas y Progreso</h3>';
                
                if (asigStats) {
                    const avgPercentage = Math.round((asigStats.correctAnswers / asigStats.totalQuestions) * 100);
                    const failedAnswers = asigStats.totalQuestions - asigStats.correctAnswers;
                    const successRate = avgPercentage;
                    const failRate = 100 - avgPercentage;
                    
                    statsHTML += `
                        <div class="bg-white-box" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 3px var(--shadow);">
                            <p class="text-dark" style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 0.95rem;">${currentAsigName}</p>
                            
                            <!-- Gr√°fico circular de aciertos/fallos -->
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="position: relative; width: 100px; height: 100px;">
                                    <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                                        <!-- C√≠rculo de fondo -->
                                        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#fee2e2" stroke-width="3"></circle>
                                        <!-- C√≠rculo de progreso -->
                                        <circle cx="18" cy="18" r="15.915" fill="none" 
                                                stroke="${avgPercentage >= 70 ? '#22c55e' : avgPercentage >= 50 ? '#f59e0b' : '#ef4444'}" 
                                                stroke-width="3" 
                                                stroke-dasharray="${avgPercentage}, 100"
                                                stroke-linecap="round"></circle>
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${avgPercentage >= 70 ? 'var(--success)' : avgPercentage >= 50 ? '#f59e0b' : 'var(--error)'};">
                                            ${avgPercentage}%
                                        </div>
                                        <div class="text-muted" style="font-size: 0.7rem;">Acierto</div>
                                    </div>
                                </div>
                                
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                            <span style="color: #22c55e; font-weight: 600;">‚úì Correctas</span>
                                            <span style="font-weight: 700;">${asigStats.correctAnswers}</span>
                                        </div>
                                        <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 8px;">
                                            <div style="background: #22c55e; height: 100%; width: ${successRate}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                            <span style="color: #ef4444; font-weight: 600;">‚úó Falladas</span>
                                            <span style="font-weight: 700;">${failedAnswers}</span>
                                        </div>
                                        <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 8px;">
                                            <div style="background: #ef4444; height: 100%; width: ${failRate}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estad√≠sticas adicionales -->
                            <div class="border-light" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #0ea5e9;">${asigStats.totalTests}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Tests</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6;">${asigStats.totalQuestions}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Preguntas</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: ${avgPercentage >= 70 ? '#22c55e' : avgPercentage >= 50 ? '#f59e0b' : '#ef4444'};">${avgPercentage}%</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Promedio</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (recentTests.length > 0) {
                    // Mini gr√°fico de tendencia
                    statsHTML += '<div class="bg-white-box" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 3px var(--shadow);">';
                    statsHTML += '<p class="text-dark" style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 0.9rem;">üìà Tendencia reciente</p>';
                    statsHTML += '<div class="bg-light-box" style="display: flex; align-items: flex-end; justify-content: space-between; height: 80px; gap: 3px; padding: 0.5rem; border-radius: 4px;">';
                    
                    const last8 = recentTests.slice(0, 8).reverse();
                    last8.forEach((test, idx) => {
                        const height = test.percentage;
                        const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                        statsHTML += `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;" title="${test.percentage}% - ${test.asignatura}">
                                <div style="font-size: 0.65rem; font-weight: 600; margin-bottom: 2px; color: ${color};">${test.percentage}%</div>
                                <div style="width: 100%; height: ${height}%; background: ${color}; border-radius: 3px 3px 0 0; min-height: 4px; transition: all 0.3s; box-shadow: 0 -1px 3px rgba(0,0,0,0.1);"></div>
                            </div>
                        `;
                    });
                    
                    statsHTML += '</div>';
                    statsHTML += `<p class="text-muted" style="margin: 0.5rem 0 0 0; font-size: 0.75rem; text-align: center;">√öltimos ${last8.length} tests realizados</p>`;
                    statsHTML += '</div>';
                    
                    // Lista de √∫ltimos tests
                    statsHTML += '<div style="margin-top: 1rem;">';
                    statsHTML += '<p class="text-dark" style="margin: 0 0 0.5rem 0; font-weight: 600; font-size: 0.9rem;">üïí Actividad reciente</p>';
                    statsHTML += '<div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">';
                    
                    recentTests.forEach(test => {
                        const date = new Date(test.date);
                        const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        const percentColor = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                        const icon = test.percentage >= 70 ? 'üéâ' : test.percentage >= 50 ? 'üëç' : 'üí™';
                        
                        statsHTML += `
                            <div class="bg-white-box" style="padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; border-left: 3px solid ${percentColor}; box-shadow: 0 1px 2px var(--shadow);">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div class="text-dark" style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${test.asignatura}</div>
                                        <div class="text-muted" style="font-size: 0.75rem;">${test.tema} ¬∑ ${dateStr}</div>
                                        <div class="text-muted" style="margin-top: 0.25rem; font-size: 0.75rem;">
                                            ${test.score}/${test.total} correctas
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                        <div style="font-size: 1.2rem;">${icon}</div>
                                        <div style="font-weight: 700; font-size: 1rem; color: ${percentColor};">
                                            ${test.percentage}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    statsHTML += '</div>';
                    statsHTML += '</div>';
                    
                    if (app.testHistory.length > 5) {
                        statsHTML += `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem;">
                                <button class="btn btn-outline" onclick="app.navigate('history')" style="font-size: 0.85rem;">
                                    üìà Historial
                                </button>
                                <button class="btn btn-outline" onclick="app.navigate('stats-advanced')" style="font-size: 0.85rem;">
                                    üìä Estad√≠sticas avanzadas
                                </button>
                            </div>
                        `;
                    } else if (app.testHistory.length > 0) {
                        statsHTML += `
                            <button class="btn btn-outline" onclick="app.navigate('stats-advanced')" style="margin-top: 0.75rem; width: 100%; font-size: 0.9rem;">
                                üìä Ver estad√≠sticas avanzadas
                            </button>
                        `;
                    }
                }
                
                // Bot√≥n de reiniciar datos
                if (app.testHistory.length > 0 || Object.keys(app.stats).length > 0) {
                    statsHTML += `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <button onclick="app.confirmResetAllData()" 
                                    style="width: 100%; padding: 0.6rem; background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;"
                                    onmouseover="this.style.background='#fee2e2'; this.style.borderColor='#f87171'"
                                    onmouseout="this.style.background='#fef2f2'; this.style.borderColor='#fca5a5'">
                                üîÑ Reiniciar todos los datos
                            </button>
                        </div>
                    `;
                }
                
                statsHTML += '</div>';
                return statsHTML;
            },
            
            // Renderizar vista de historial completo
            renderHistory: (container) => {
                if (app.testHistory.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h2>üìà Historial de Tests</h2>
                            <p style="color: #94a3b8; margin: 2rem 0;">No has completado ning√∫n test todav√≠a.</p>
                            <button class="btn" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                        </div>
                    `;
                    return;
                }
                
                // Agrupar por asignatura
                const byAsignatura = {};
                app.testHistory.forEach(test => {
                    if (!byAsignatura[test.asignatura]) {
                        byAsignatura[test.asignatura] = [];
                    }
                    byAsignatura[test.asignatura].push(test);
                });
                
                let historyHTML = `
                    <div class="card">
                        <h2>üìà Historial Completo</h2>
                        <p style="color: #64748b; margin-bottom: 2rem;">Total de tests realizados: <strong>${app.testHistory.length}</strong></p>
                `;
                
                // Gr√°fica simple de progreso (√∫ltimos 10 tests)
                const last10 = app.testHistory.slice(0, 10).reverse();
                historyHTML += '<div style="margin-bottom: 2rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">';
                historyHTML += '<h3 style="font-size: 1rem; margin-top: 0;">üìä Progreso reciente (√∫ltimos 10 tests)</h3>';
                historyHTML += '<div style="display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 4px;">';
                
                last10.forEach((test, idx) => {
                    const height = test.percentage;
                    const color = test.percentage >= 70 ? 'var(--success)' : test.percentage >= 50 ? '#f59e0b' : 'var(--error)';
                    historyHTML += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="font-size: 0.7rem; font-weight: 600; margin-bottom: 2px;">${test.percentage}%</div>
                            <div style="width: 100%; height: ${height}%; background: ${color}; border-radius: 4px 4px 0 0; min-height: 5px; transition: all 0.3s;"></div>
                        </div>
                    `;
                });
                
                historyHTML += '</div></div>';
                
                // Lista por asignatura
                Object.keys(byAsignatura).forEach(asigName => {
                    const tests = byAsignatura[asigName];
                    const totalTests = tests.length;
                    const avgPercentage = Math.round(tests.reduce((sum, t) => sum + t.percentage, 0) / totalTests);
                    
                    historyHTML += `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 2px solid #0ea5e9;">
                            <h3 style="font-size: 1rem; margin: 0 0 0.5rem 0; color: #0369a1;">${asigName}</h3>
                            <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b;">
                                ${totalTests} test${totalTests > 1 ? 's' : ''} ¬∑ Promedio: <strong style="color: ${avgPercentage >= 70 ? 'var(--success)' : avgPercentage >= 50 ? '#f59e0b' : 'var(--error)'};">${avgPercentage}%</strong>
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                    `;
                    
                    tests.forEach(test => {
                        const date = new Date(test.date);
                        const dateStr = date.toLocaleDateString('es-ES', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: '2-digit',
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        const percentColor = test.percentage >= 70 ? 'var(--success)' : test.percentage >= 50 ? '#f59e0b' : 'var(--error)';
                        
                        historyHTML += `
                            <div style="padding: 0.75rem; background: white; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid ${percentColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${test.tema}</div>
                                        <div style="color: #64748b; font-size: 0.85rem;">${dateStr} ¬∑ ${test.score}/${test.total} correctas</div>
                                    </div>
                                    <div style="font-weight: 700; font-size: 1.2rem; color: ${percentColor}; min-width: 60px; text-align: right;">
                                        ${test.percentage}%
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    historyHTML += '</div></div>';
                });
                
                historyHTML += `
                        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                            <button class="btn btn-outline" onclick="app.navigate('home')" style="flex: 1;">üè† Volver al Inicio</button>
                            <button class="btn" onclick="if(confirm('¬øEliminar todo el historial?')) { app.clearHistory(); }" style="flex: 1; background: var(--error); border-color: var(--error);">
                                üóëÔ∏è Limpiar Historial
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = historyHTML;
            },
            
            // Limpiar historial
            clearHistory: () => {
                app.testHistory = [];
                app.stats = {};
                app.saveTestHistory();
                app.saveStats();
                app.showToast('‚úÖ Historial limpiado');
                app.navigate('history');
            },
            
            // === NUEVAS FUNCIONALIDADES ===
            
            // 1. MODO EXAMEN SIMULADO
            renderExamMode: (container) => {
                const totalPreguntas = app.filteredQuestions.length;
                const canStart = totalPreguntas > 0 && app.currentAsignatura;
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üìù Modo Examen Simulado</h1>
                        <p class="text-muted">Prep√°rate para el examen real con l√≠mite de tiempo</p>
                        
                        ${canStart ? `
                        <div style="max-width: 500px; margin: 2rem auto; text-align: left;">
                            <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h3 style="margin-top: 0; font-size: 1.1rem;">‚öôÔ∏è Configuraci√≥n del Examen</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">üìö Asignatura seleccionada:</label>
                                    <div style="padding: 0.75rem; background: var(--card); border: 2px solid var(--primary); border-radius: 6px; font-weight: 600;">
                                        ${app.currentAsignatura.nombre}
                                    </div>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                        Total disponible: ${totalPreguntas} preguntas
                                    </p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìä N√∫mero de preguntas:</label>
                                    <input type="number" id="exam-question-count" class="form-select" 
                                           value="30" min="5" max="${totalPreguntas}" style="font-size: 1.1rem; font-weight: 600;">
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                        M√≠nimo 5, m√°ximo ${totalPreguntas}
                                    </p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">‚è±Ô∏è Tiempo l√≠mite (minutos):</label>
                                    <input type="number" id="exam-time-limit" class="form-select" 
                                           value="30" min="5" max="180" style="font-size: 1.1rem; font-weight: 600;">
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                                        Recomendado: 1 minuto por pregunta
                                    </p>
                                </div>
                            </div>
                            
                            <div class="bg-light-box" style="padding: 1rem; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 1.5rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #dc2626; font-size: 0.95rem;">‚ö†Ô∏è Condiciones del examen:</h4>
                                <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                    <li>El tiempo comenzar√° al iniciar el examen</li>
                                    <li>Las preguntas se presentar√°n en orden aleatorio</li>
                                    <li>Cuando el tiempo termine, el examen se enviar√° autom√°ticamente</li>
                                    <li>No podr√°s volver atr√°s en las preguntas</li>
                                </ul>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-outline" onclick="app.navigate('home')" style="flex: 1;">
                                    ‚Üê Volver
                                </button>
                                <button class="btn" onclick="app.startExamMode()" style="flex: 2; background: #dc2626; border-color: #dc2626;">
                                    üöÄ Comenzar Examen
                                </button>
                            </div>
                        </div>
                        ` : `
                        <div style="padding: 2rem; text-align: center;">
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Primero debes seleccionar una asignatura desde la p√°gina de inicio.
                            </p>
                            <button class="btn" onclick="app.navigate('home')">
                                üè† Ir al Inicio
                            </button>
                        </div>
                        `}
                    </div>
                `;
            },
            
            startExamMode: () => {
                const questionCount = parseInt(document.getElementById('exam-question-count').value);
                const timeLimit = parseInt(document.getElementById('exam-time-limit').value);
                
                if (questionCount < 5 || questionCount > app.filteredQuestions.length) {
                    app.showToast('‚ö†Ô∏è N√∫mero de preguntas inv√°lido');
                    return;
                }
                
                if (timeLimit < 5 || timeLimit > 180) {
                    app.showToast('‚ö†Ô∏è Tiempo l√≠mite inv√°lido');
                    return;
                }
                
                // Configurar modo examen
                app.examMode.active = true;
                app.examMode.questionCount = questionCount;
                app.examMode.timeLimit = timeLimit;
                app.examMode.startTime = Date.now();
                app.examMode.endTime = Date.now() + (timeLimit * 60 * 1000);
                
                // Seleccionar preguntas aleatorias
                const shuffled = app.shuffle([...app.filteredQuestions]);
                app.activeQuizQuestions = shuffled.slice(0, questionCount);
                
                // Reiniciar quiz
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                // Iniciar temporizador
                app.startExamTimer();
                
                app.navigate('quiz');
            },
            
            startExamTimer: () => {
                const updateTimer = () => {
                    const now = Date.now();
                    const remaining = app.examMode.endTime - now;
                    
                    if (remaining <= 0) {
                        // Tiempo terminado
                        clearInterval(app.examMode.timer);
                        app.examMode.active = false;
                        app.showToast('‚è∞ ¬°Tiempo terminado!');
                        // Forzar finalizaci√≥n
                        app.quiz.index = app.activeQuizQuestions.length;
                        app.navigate('quiz');
                        return;
                    }
                    
                    // Actualizar display del timer
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    const timerDisplay = document.getElementById('exam-timer');
                    if (timerDisplay) {
                        const isUrgent = remaining < 60000; // Menos de 1 minuto
                        timerDisplay.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;
                        timerDisplay.style.color = isUrgent ? '#dc2626' : 'var(--text-primary)';
                        timerDisplay.style.fontWeight = isUrgent ? '800' : '600';
                    }
                };
                
                updateTimer();
                app.examMode.timer = setInterval(updateTimer, 1000);
            },
            
            // 2. MODO REPASO DE FALLOS
            renderReviewMode: (container) => {
                const failedCount = app.failedQuestionsHistory.length;
                
                if (failedCount === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üîÑ Modo Repaso</h1>
                            <p class="text-muted">Repasa las preguntas que has fallado anteriormente</p>
                            <div style="font-size: 3rem; margin: 2rem 0;">‚úÖ</div>
                            <h3 style="color: var(--success);">¬°No tienes preguntas falladas!</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                                Completa algunos tests para que aparezcan aqu√≠ las preguntas que necesitas repasar.
                            </p>
                            <button class="btn" onclick="app.navigate('home')">
                                üè† Volver al Inicio
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Agrupar por asignatura
                const bySubject = {};
                app.failedQuestionsHistory.forEach(q => {
                    if (!bySubject[q.subject]) {
                        bySubject[q.subject] = [];
                    }
                    bySubject[q.subject].push(q);
                });
                
                let optionsHTML = Object.keys(bySubject).map(subject => {
                    const count = bySubject[subject].length;
                    return `<option value="${subject}">${subject} (${count} pregunta${count > 1 ? 's' : ''})</option>`;
                }).join('');
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üîÑ Modo Repaso</h1>
                        <p class="text-muted">Preguntas que has fallado anteriormente</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin: 2rem 0; border: 2px solid #0891b2;">
                            <h3 style="margin-top: 0; font-size: 1.1rem; color: #0e7490;">üìä Estad√≠sticas de Repaso</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: var(--card); border-radius: 6px;">
                                    <div style="font-size: 2rem; font-weight: 700; color: #dc2626;">${failedCount}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Preguntas falladas</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--card); border-radius: 6px;">
                                    <div style="font-size: 2rem; font-weight: 700; color: #0891b2;">${Object.keys(bySubject).length}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Asignaturas</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div class="form-group">
                                <label class="form-label">üìö Filtrar por asignatura:</label>
                                <select id="review-subject-filter" class="form-select">
                                    <option value="all">Todas las asignaturas (${failedCount})</option>
                                    ${optionsHTML}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üî¢ Ordenar por:</label>
                                <select id="review-sort" class="form-select">
                                    <option value="recent">M√°s recientes primero</option>
                                    <option value="most-failed">M√°s falladas primero</option>
                                    <option value="random">Orden aleatorio</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button class="btn btn-outline" onclick="app.navigate('home')" style="flex: 1;">
                                    ‚Üê Volver
                                </button>
                                <button class="btn" onclick="app.startReviewMode()" style="flex: 2; background: #0891b2; border-color: #0891b2;">
                                    üöÄ Comenzar Repaso
                                </button>
                            </div>
                            
                            <button class="btn" onclick="app.clearFailedHistory()" 
                                    style="width: 100%; margin-top: 1rem; background: #fef2f2; color: #991b1b; border-color: #fca5a5;">
                                üóëÔ∏è Limpiar historial de fallos
                            </button>
                        </div>
                    </div>
                `;
            },
            
            startReviewMode: () => {
                // RESETEAR MODO EXAMEN - esto es un test normal de repaso
                if (app.examMode.timer) {
                    clearInterval(app.examMode.timer);
                }
                app.examMode = {
                    active: false,
                    timeLimit: 30,
                    questionCount: 30,
                    startTime: null,
                    endTime: null,
                    timer: null
                };
                
                const subjectFilter = document.getElementById('review-subject-filter').value;
                const sortBy = document.getElementById('review-sort').value;
                
                let questions = [...app.failedQuestionsHistory];
                
                // Filtrar por asignatura
                if (subjectFilter !== 'all') {
                    questions = questions.filter(q => q.subject === subjectFilter);
                }
                
                // Ordenar
                if (sortBy === 'recent') {
                    questions.sort((a, b) => new Date(b.lastFailed) - new Date(a.lastFailed));
                } else if (sortBy === 'most-failed') {
                    questions.sort((a, b) => (b.failCount || 1) - (a.failCount || 1));
                } else {
                    questions = app.shuffle(questions);
                }
                
                if (questions.length === 0) {
                    app.showToast('‚ö†Ô∏è No hay preguntas con ese filtro');
                    return;
                }
                
                // Configurar quiz
                app.activeQuizQuestions = questions;
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            
            clearFailedHistory: () => {
                if (confirm('¬øSeguro que quieres limpiar el historial de preguntas falladas?')) {
                    app.failedQuestionsHistory = [];
                    app.saveFailedHistory();
                    app.showToast('‚úÖ Historial de fallos limpiado');
                    app.navigate('home');
                }
            },
            
            // 3. MODO RESUMEN DE TEMA
            renderSummary: (container) => {
                if (!app.currentAsignatura) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üìñ Resumen de Temas</h1>
                            <p class="text-muted">Selecciona una asignatura primero</p>
                            <button class="btn" onclick="app.navigate('home')">üè† Ir al Inicio</button>
                        </div>
                    `;
                    return;
                }
                
                const temas = app.currentAsignatura.data.temas.filter(t => t.preguntas && t.preguntas.length > 0);
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üìñ Resumen de Temas</h1>
                        <p class="text-muted">${app.currentAsignatura.nombre}</p>
                        
                        <div style="max-width: 600px; margin: 2rem auto;">
                            <div class="form-group">
                                <label class="form-label">üìö Selecciona un tema:</label>
                                <select id="summary-tema-select" class="form-select" onchange="app.showTemaSummary(this.value)">
                                    <option value="">-- Selecciona un tema --</option>
                                    ${temas.map(t => `<option value="${t.numero}">${t.nombre} (${t.preguntas.length} preguntas)</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div id="summary-content" style="margin-top: 2rem;"></div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn btn-outline" onclick="app.navigate('home')">‚Üê Volver al Inicio</button>
                        </div>
                    </div>
                `;
            },
            
            showTemaSummary: (temaNumero) => {
                const summaryContent = document.getElementById('summary-content');
                
                if (!temaNumero) {
                    summaryContent.innerHTML = '';
                    return;
                }
                
                const tema = app.currentAsignatura.data.temas.find(t => t.numero == temaNumero);
                if (!tema) return;
                
                let html = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; border: 2px solid var(--primary); text-align: left;">
                        <h2 style="margin-top: 0; color: var(--primary);">${tema.nombre}</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                            üìä ${tema.preguntas.length} pregunta${tema.preguntas.length > 1 ? 's' : ''} en este tema
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                `;
                
                tema.preguntas.forEach((p, idx) => {
                    const isMarked = app.markedQuestions.has(p.id);
                    const hasNote = app.questionNotes[p.id];
                    
                    html += `
                        <div class="bg-white-box" style="padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 4px var(--shadow); border-left: 4px solid ${isMarked ? '#f59e0b' : 'var(--primary)'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">Pregunta ${idx + 1}</h4>
                                ${isMarked ? '<span style="font-size: 1.2rem;">üîñ</span>' : ''}
                            </div>
                            
                            <p style="font-weight: 600; margin-bottom: 1rem; line-height: 1.5;">${p.pregunta}</p>
                            
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; border: 2px solid #22c55e;">
                                <div style="font-weight: 600; color: #166534; margin-bottom: 0.5rem; font-size: 0.9rem;">‚úì Respuesta correcta:</div>
                                <div style="color: #15803d; font-weight: 500;">${p.respuesta_correcta}</div>
                            </div>
                            
                            ${hasNote ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #fffbeb; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem; font-size: 0.85rem;">üìù Tus notas:</div>
                                <div style="color: #78350f; font-size: 0.9rem; white-space: pre-wrap;">${hasNote}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <button class="btn" onclick="app.studyThisTema(${temaNumero})" style="width: 100%;">
                                üìù Practicar este tema ahora
                            </button>
                        </div>
                    </div>
                `;
                
                summaryContent.innerHTML = html;
            },
            
            studyThisTema: (temaNumero) => {
                // Aplicar filtro de tema
                const unitSelector = document.getElementById('unit-selector');
                if (unitSelector) {
                    unitSelector.value = temaNumero;
                }
                app.applyTemaFilter(temaNumero);
                app.savePreferences();
                
                // Iniciar test
                app.navigate('home');
                setTimeout(() => {
                    app.startQuiz();
                }, 500);
            },
            
            // 4. ESTAD√çSTICAS AVANZADAS CON PREDICTOR
            renderAdvancedStats: (container) => {
                if (app.testHistory.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h1>üìä Estad√≠sticas Avanzadas</h1>
                            <p class="text-muted">Completa algunos tests para ver tus estad√≠sticas avanzadas</p>
                            <button class="btn" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                        </div>
                    `;
                    return;
                }
                
                // Calcular predicci√≥n basada en √∫ltimos 10 tests
                const last10 = app.testHistory.slice(0, 10);
                const avgLast10 = Math.round(last10.reduce((sum, t) => sum + t.percentage, 0) / last10.length);
                
                // Calcular tendencia (mejorando/empeorando)
                const last5 = app.testHistory.slice(0, 5);
                const prev5 = app.testHistory.slice(5, 10);
                const avgLast5 = last5.length > 0 ? Math.round(last5.reduce((sum, t) => sum + t.percentage, 0) / last5.length) : 0;
                const avgPrev5 = prev5.length > 0 ? Math.round(prev5.reduce((sum, t) => sum + t.percentage, 0) / prev5.length) : 0;
                const trend = avgLast5 - avgPrev5;
                
                // Predictor de examen
                let prediction = avgLast10;
                let predictionText = '';
                let predictionColor = '';
                
                if (trend > 5) {
                    prediction = Math.min(100, avgLast10 + 5);
                    predictionText = 'Tendencia al alza üìà';
                    predictionColor = '#22c55e';
                } else if (trend < -5) {
                    prediction = Math.max(0, avgLast10 - 5);
                    predictionText = 'Necesitas repasar m√°s üìâ';
                    predictionColor = '#ef4444';
                } else {
                    predictionText = 'Rendimiento estable ‚û°Ô∏è';
                    predictionColor = '#f59e0b';
                }
                
                // Estad√≠sticas por asignatura
                let byAsignatura = {};
                app.testHistory.forEach(t => {
                    if (!byAsignatura[t.asignatura]) {
                        byAsignatura[t.asignatura] = {
                            tests: [],
                            total: 0,
                            correct: 0
                        };
                    }
                    byAsignatura[t.asignatura].tests.push(t);
                    byAsignatura[t.asignatura].total += t.total;
                    byAsignatura[t.asignatura].correct += t.score;
                });
                
                let asignaturasHTML = '';
                Object.keys(byAsignatura).sort((a, b) => {
                    const avgA = (byAsignatura[a].correct / byAsignatura[a].total) * 100;
                    const avgB = (byAsignatura[b].correct / byAsignatura[b].total) * 100;
                    return avgB - avgA;
                }).forEach(asigName => {
                    const data = byAsignatura[asigName];
                    const avg = Math.round((data.correct / data.total) * 100);
                    const color = avg >= 70 ? '#22c55e' : avg >= 50 ? '#f59e0b' : '#ef4444';
                    
                    asignaturasHTML += `
                        <div class="bg-white-box" style="padding: 1rem; border-radius: 8px; border-left: 4px solid ${color};">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 0.95rem;">${asigName}</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                <div style="flex: 1;">
                                    <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 12px;">
                                        <div style="background: ${color}; height: 100%; width: ${avg}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <div style="font-weight: 700; font-size: 1.1rem; color: ${color}; min-width: 50px; text-align: right;">
                                    ${avg}%
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                ${data.tests.length} test${data.tests.length > 1 ? 's' : ''} ¬∑ ${data.correct}/${data.total} correctas
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = `
                    <div class="card">
                        <h1>üìä Estad√≠sticas Avanzadas</h1>
                        <p class="text-muted">An√°lisis detallado de tu rendimiento</p>
                        
                        <!-- Predictor de examen -->
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; border: 3px solid ${predictionColor}; margin: 2rem 0;">
                            <h2 style="margin-top: 0; font-size: 1.2rem; color: ${predictionColor};">üîÆ Predictor de Examen</h2>
                            <div style="text-align: center; margin: 1.5rem 0;">
                                <div style="font-size: 3rem; font-weight: 800; color: ${predictionColor};">
                                    ${prediction}%
                                </div>
                                <div style="font-size: 1.1rem; margin-top: 0.5rem; color: var(--text-secondary);">
                                    ${predictionText}
                                </div>
                            </div>
                            <div style="background: var(--card); padding: 1rem; border-radius: 6px;">
                                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                                    Basado en tus √∫ltimos ${last10.length} tests, tu rendimiento promedio es del <strong>${avgLast10}%</strong>.
                                    ${trend > 0 ? `Has mejorado un <strong>${trend}%</strong> en las √∫ltimas sesiones. ¬°Sigue as√≠! üéâ` : 
                                      trend < 0 ? `Has bajado un <strong>${Math.abs(trend)}%</strong>. Dedica m√°s tiempo al repaso. üí™` :
                                      'Mantienes un rendimiento constante. üëç'}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico de evoluci√≥n -->
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin-top: 0; font-size: 1.1rem;">üìà Evoluci√≥n Temporal</h3>
                            <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 150px; gap: 4px; padding: 1rem; background: var(--card); border-radius: 6px;">
                                ${app.testHistory.slice(0, 20).reverse().map((test, idx) => {
                                    const height = test.percentage;
                                    const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                                    return `
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;" title="${test.asignatura}: ${test.percentage}%">
                                            <div style="font-size: 0.65rem; font-weight: 600; margin-bottom: 3px;">${test.percentage}%</div>
                                            <div style="width: 100%; height: ${height}%; background: ${color}; border-radius: 4px 4px 0 0; min-height: 5px; transition: all 0.3s; box-shadow: 0 -2px 4px rgba(0,0,0,0.1);"></div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <p style="margin: 1rem 0 0 0; font-size: 0.85rem; text-align: center; color: var(--text-secondary);">
                                √öltimos ${Math.min(20, app.testHistory.length)} tests (m√°s recientes a la derecha)
                            </p>
                        </div>
                        
                        <!-- Rendimiento por asignatura -->
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin-top: 0; font-size: 1.1rem;">üìö Rendimiento por Asignatura</h3>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                ${asignaturasHTML}
                            </div>
                        </div>
                        
                        <!-- Recomendaciones -->
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <h3 style="margin-top: 0; font-size: 1.1rem; color: #1e40af;">üí° Recomendaciones</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary);">
                                ${app.failedQuestionsHistory.length > 0 ? 
                                    `<li>Tienes <strong>${app.failedQuestionsHistory.length} preguntas falladas</strong>. Usa el modo repaso para mejorarlas.</li>` : 
                                    '<li>¬°Excelente! No tienes preguntas pendientes de repasar.</li>'}
                                ${trend < 0 ? 
                                    '<li>Tu rendimiento ha bajado. Considera tomar un descanso y luego repasar conceptos b√°sicos.</li>' : 
                                    trend > 5 ? 
                                    '<li>¬°Vas muy bien! Mant√©n el ritmo de estudio.</li>' :
                                    '<li>Rendimiento estable. Considera aumentar la dificultad o probar el modo examen.</li>'}
                                <li>Usa el <strong>modo resumen</strong> para repasar antes de hacer tests.</li>
                                ${avgLast10 < 70 ? 
                                    '<li>Intenta hacer m√°s tests en modo normal antes del examen simulado.</li>' :
                                    '<li>Est√°s listo para probar el modo examen simulado con l√≠mite de tiempo.</li>'}
                            </ul>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn btn-outline" onclick="app.navigate('home')">‚Üê Volver al Inicio</button>
                        </div>
                    </div>
                `;
            },
            
            // === FIN DE NUEVAS FUNCIONALIDADES ===
            
            // Renderizar vista de contribuciones
            renderContribute: (container) => {
                // Opciones de especialidad
                const especialidadOptions = Object.entries(CONFIG.especialidades).map(([id, nombre]) => 
                    `<option value="${id}">${nombre}</option>`
                ).join('');
                
                // Agrupar asignaturas disponibles
                const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                
                let asignaturaOptions = '';
                
                if (obligatorias.length > 0) {
                    asignaturaOptions += '<optgroup label="üìï Obligatorias">';
                    obligatorias.forEach(a => {
                        asignaturaOptions += `<option value="${a.id}">${a.nombre}</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (optativas.length > 0) {
                    asignaturaOptions += '<optgroup label="üìó Optativas Comunes">';
                    optativas.forEach(a => {
                        asignaturaOptions += `<option value="${a.id}">${a.nombre}</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                container.innerHTML = `
                    <div class="card">
                        <h2>‚ûï Contribuir con Preguntas</h2>
                        <p class="text-muted" style="margin-bottom: 2rem;">Ayuda a ampliar el banco de preguntas. Selecciona la asignatura y a√±ade preguntas una tras otra.</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">1Ô∏è‚É£ Selecciona la Asignatura</h3>
                            
                            <div class="form-group">
                                <label class="form-label">üéì Especialidad (opcional):</label>
                                <select id="contrib-especialidad" class="form-select" onchange="app.updateContribAsignaturas()">
                                    <option value="">Sin especialidad</option>
                                    ${especialidadOptions}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìñ Asignatura:</label>
                                <select id="contrib-asignatura" class="form-select">
                                    <option value="">Selecciona una asignatura</option>
                                    ${asignaturaOptions}
                                </select>
                            </div>
                            
                            <button class="btn" onclick="app.startContributing()" style="width: 100%;">
                                ‚û°Ô∏è Continuar
                            </button>
                        </div>
                        
                        <div id="contrib-form-area" style="display: none;"></div>
                        <div id="contributions-list"></div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn-outline" style="border:none; font-size:0.8rem; color: var(--text-secondary); cursor: pointer;" onclick="app.navigate('admin')">
                                Acceso administrador
                            </button>
                        </div>
                    </div>
                `;
                
                app.renderContributionsList();
                
                // Restaurar valores guardados
                setTimeout(() => {
                    const espSelect = document.getElementById('contrib-especialidad');
                    const asigSelect = document.getElementById('contrib-asignatura');
                    
                    if (espSelect && app.contribState.especialidad) {
                        espSelect.value = app.contribState.especialidad;
                        app.updateContribAsignaturas().then(() => {
                            if (asigSelect && app.contribState.asignatura) {
                                asigSelect.value = app.contribState.asignatura;
                            }
                        });
                    } else if (asigSelect && app.contribState.asignatura) {
                        asigSelect.value = app.contribState.asignatura;
                    }
                }, 100);
            },
            
            // Actualizar asignaturas seg√∫n especialidad
            updateContribAsignaturas: async () => {
                const especialidadId = document.getElementById('contrib-especialidad').value;
                const asignaturaSelect = document.getElementById('contrib-asignatura');
                
                if (!asignaturaSelect) return;
                
                let options = '<option value="">Selecciona una asignatura</option>';
                
                if (especialidadId) {
                    // Cargar asignaturas de especialidad si no est√°n cargadas
                    await app.loadEspecialidadData(especialidadId);
                    
                    // Obtener la lista de asignaturas de especialidad desde CONFIG
                    const asignaturasEsp = especialidadId === 'orientacion-educativa' 
                        ? CONFIG.asignaturas.especialidadOrientacion 
                        : CONFIG.asignaturas.especialidad;
                    
                    // Construir opciones de especialidad directamente desde loadedData
                    const especialidadOpts = [];
                    asignaturasEsp.forEach(asig => {
                        const key = `${especialidadId}-${asig.id}`;
                        if (app.loadedData[key]) {
                            especialidadOpts.push({ id: key, nombre: asig.nombre });
                        }
                    });
                    
                    if (especialidadOpts.length > 0) {
                        options += '<optgroup label="üìò Especialidad">';
                        especialidadOpts.forEach(a => options += `<option value="${a.id}">${a.nombre}</option>`);
                        options += '</optgroup>';
                    }
                    
                    // Tambi√©n incluir obligatorias y optativas
                    const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                    const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                    
                    if (obligatorias.length > 0) {
                        options += '<optgroup label="üìï Obligatorias">';
                        obligatorias.forEach(a => options += `<option value="${a.id}">${a.nombre}</option>`);
                        options += '</optgroup>';
                    }
                    
                    if (optativas.length > 0) {
                        options += '<optgroup label="üìó Optativas Comunes">';
                        optativas.forEach(a => options += `<option value="${a.id}">${a.nombre}</option>`);
                        options += '</optgroup>';
                    }
                } else {
                    // Solo mostrar obligatorias y optativas
                    const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                    const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                    
                    if (obligatorias.length > 0) {
                        options += '<optgroup label="üìï Obligatorias">';
                        obligatorias.forEach(a => options += `<option value="${a.id}">${a.nombre}</option>`);
                        options += '</optgroup>';
                    }
                    
                    if (optativas.length > 0) {
                        options += '<optgroup label="üìó Optativas Comunes">';
                        optativas.forEach(a => options += `<option value="${a.id}">${a.nombre}</option>`);
                        options += '</optgroup>';
                    }
                }
                
                asignaturaSelect.innerHTML = options;
            },
            
            // Iniciar proceso de contribuci√≥n
            startContributing: () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                const especialidadId = document.getElementById('contrib-especialidad').value;
                
                if (!asignaturaId) {
                    app.showToast('‚ö†Ô∏è Selecciona una asignatura');
                    return;
                }
                
                // Guardar estado
                app.contribState.especialidad = especialidadId;
                app.contribState.asignatura = asignaturaId;
                app.saveContribState();
                
                const formArea = document.getElementById('contrib-form-area');
                formArea.style.display = 'block';
                formArea.innerHTML = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="font-size: 1.1rem; margin-top: 0;">2Ô∏è‚É£ A√±ade Preguntas</h3>
                        <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                            Asignatura seleccionada: <strong id="selected-asig-name"></strong>
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">üìö N√∫mero de Tema (1-50):</label>
                            <input type="number" id="contrib-tema" class="form-select" placeholder="Ej: 1, 2, 3..." min="1" max="50" step="1" value="${app.contribState.tema || ''}" style="font-size: 1.1rem; font-weight: 600;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‚ùì Pregunta:</label>
                            <textarea id="contrib-question" class="form-select" rows="3" placeholder="Escribe la pregunta aqu√≠..." style="resize: vertical;"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìù Opciones de respuesta:</label>
                            <input type="text" id="contrib-option-1" class="form-select" placeholder="Opci√≥n 1" style="margin-bottom: 0.5rem;">
                            <input type="text" id="contrib-option-2" class="form-select" placeholder="Opci√≥n 2" style="margin-bottom: 0.5rem;">
                            <input type="text" id="contrib-option-3" class="form-select" placeholder="Opci√≥n 3" style="margin-bottom: 0.5rem;">
                            <input type="text" id="contrib-option-4" class="form-select" placeholder="Opci√≥n 4">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‚úÖ Respuesta correcta:</label>
                            <select id="contrib-correct" class="form-select">
                                <option value="">Selecciona la opci√≥n correcta</option>
                                <option value="1">Opci√≥n 1</option>
                                <option value="2">Opci√≥n 2</option>
                                <option value="3">Opci√≥n 3</option>
                                <option value="4">Opci√≥n 4</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="app.submitContribution()" style="flex: 1;">
                                ‚ûï A√±adir Pregunta
                            </button>
                            <button class="btn btn-outline" onclick="app.finishContributing()" style="flex: 1;">
                                ‚úÖ Finalizar
                            </button>
                        </div>
                    </div>
                `;
                
                // Obtener nombre de asignatura
                const asig = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                const nameElement = document.getElementById('selected-asig-name');
                if (nameElement && asig) {
                    nameElement.textContent = asig.nombre;
                }
                
                // Scroll al formulario
                formArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            },
            
            // Finalizar contribuciones
            finishContributing: () => {
                const formArea = document.getElementById('contrib-form-area');
                formArea.style.display = 'none';
                
                if (app.userContributions.length > 0) {
                    app.showToast(`‚úÖ ${app.userContributions.length} pregunta(s) guardadas. No olvides exportarlas.`);
                }
                
                // Actualizar bot√≥n de exportar
                app.navigate('contribute');
            },
            
            // Actualizar lista de contribuciones
            renderContributionsList: () => {
                const listContainer = document.getElementById('contributions-list');
                if (!listContainer) return;
                
                if (app.userContributions.length === 0) {
                    listContainer.innerHTML = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <p class="text-muted">No tienes contribuciones pendientes</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; margin: 0;">üìã Tus Contribuciones (${app.userContributions.length})</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="app.exportContributions()" style="padding: 0.5rem 1rem;">
                                    üì• Exportar
                                </button>
                                <button class="btn" onclick="app.clearAllContributions()" style="padding: 0.5rem 1rem; background: #fca5a5; border-color: #f87171;" title="Limpiar todas">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0 0 1rem 0;">
                            üíæ Las contribuciones se guardan autom√°ticamente y persisten al recargar la p√°gina
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto;">
                `;
                
                app.userContributions.forEach(contrib => {
                    html += `
                        <div class="bg-white-box" style="padding: 1rem; border-radius: 6px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                        ${contrib.asignaturaName} - Tema ${contrib.tema}
                                    </div>
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${contrib.question}</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                        <div>‚úÖ ${contrib.answer}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="app.editContribution('${contrib.id}')" 
                                            style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 4px; padding: 0.5rem; cursor: pointer; flex-shrink: 0;"
                                            title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="app.deleteContribution('${contrib.id}')" 
                                            style="background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 4px; padding: 0.5rem; cursor: pointer; flex-shrink: 0;"
                                            title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                listContainer.innerHTML = html;
            },
            
            // Actualizar temas disponibles seg√∫n asignatura seleccionada
            updateContribTemas: () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                const temaInput = document.getElementById('contrib-tema');
                
                if (asignaturaId) {
                    const asignatura = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                    if (asignatura && asignatura.data && asignatura.data.temas) {
                        const maxTema = asignatura.data.temas.length;
                        temaInput.max = maxTema;
                        temaInput.placeholder = `N√∫mero de tema (1-${maxTema})`;
                    }
                } else {
                    temaInput.max = '';
                    temaInput.placeholder = 'N√∫mero de tema (ej: 1, 2, 3...)';
                }
            },
            
            // Enviar contribuci√≥n
            submitContribution: () => {
                const asignaturaId = document.getElementById('contrib-asignatura').value;
                const tema = document.getElementById('contrib-tema').value;
                const question = document.getElementById('contrib-question').value.trim();
                const option1 = document.getElementById('contrib-option-1').value.trim();
                const option2 = document.getElementById('contrib-option-2').value.trim();
                const option3 = document.getElementById('contrib-option-3').value.trim();
                const option4 = document.getElementById('contrib-option-4').value.trim();
                const correctIdx = document.getElementById('contrib-correct').value;
                
                // Validaciones
                if (!asignaturaId) {
                    app.showToast('‚ö†Ô∏è Selecciona una asignatura');
                    return;
                }
                
                // Validar tema como n√∫mero entero entre 1 y 50
                const temaNum = parseInt(tema);
                if (!tema || isNaN(temaNum) || temaNum < 1 || temaNum > 50 || tema.includes('.')) {
                    app.showToast('‚ö†Ô∏è El tema debe ser un n√∫mero entero entre 1 y 50');
                    document.getElementById('contrib-tema').focus();
                    return;
                }
                if (!question) {
                    app.showToast('‚ö†Ô∏è Escribe una pregunta');
                    return;
                }
                if (!option1 || !option2 || !option3 || !option4) {
                    app.showToast('‚ö†Ô∏è Completa las 4 opciones');
                    return;
                }
                if (!correctIdx) {
                    app.showToast('‚ö†Ô∏è Selecciona la respuesta correcta');
                    return;
                }
                
                // Buscar asignatura en todas las listas
                const asignatura = app.asignaturasDisponibles.find(a => a.id === asignaturaId);
                
                if (!asignatura) {
                    app.showToast('‚ùå Error: Asignatura no encontrada');
                    return;
                }
                
                const options = [option1, option2, option3, option4];
                const answer = options[parseInt(correctIdx) - 1];
                
                // Extraer el nombre base del archivo (sin ruta ni .json)
                let baseFileName = asignatura.archivo.split('/').pop().replace('.json', '');
                
                const contribution = {
                    asignaturaId,
                    asignaturaName: asignatura.nombre,
                    baseFileName,  // Nombre del archivo real en data/asignaturas/
                    tema: parseInt(tema),
                    question,
                    options,
                    answer
                };
                
                // Si estamos editando, reemplazar la contribuci√≥n existente
                if (app.editingContribId) {
                    const index = app.userContributions.findIndex(c => c.id === app.editingContribId);
                    if (index !== -1) {
                        // Mantener el ID y timestamp originales
                        contribution.id = app.editingContribId;
                        contribution.timestamp = app.userContributions[index].timestamp;
                        app.userContributions[index] = contribution;
                        app.saveContributions();
                        app.showToast('‚úÖ Contribuci√≥n actualizada');
                    }
                    // Resetear el modo de edici√≥n
                    app.editingContribId = null;
                    // Volver a la lista
                    app.navigate('contribute');
                } else {
                    // Nueva contribuci√≥n
                    app.addContribution(contribution);
                    
                    // Guardar el tema para la pr√≥xima pregunta
                    app.contribState.tema = temaNum;
                    app.saveContribState();
                    
                    // Limpiar solo pregunta y opciones, mantener tema
                    document.getElementById('contrib-question').value = '';
                    document.getElementById('contrib-option-1').value = '';
                    document.getElementById('contrib-option-2').value = '';
                    document.getElementById('contrib-option-3').value = '';
                    document.getElementById('contrib-option-4').value = '';
                    document.getElementById('contrib-correct').value = '';
                    
                    // Focus en el campo de pregunta para continuar r√°pidamente
                    document.getElementById('contrib-question').focus();
                    
                    app.renderContributionsList();
                }
            },
            
            // Renderizar vista de administraci√≥n
            renderAdmin: (container) => {
                container.innerHTML = `
                    <div class="card">
                        <h2>üîß Panel de Administraci√≥n</h2>
                        <p class="text-muted" style="margin-bottom: 2rem;">Herramienta para procesar archivos de contribuciones y generar archivos listos para GitHub.</p>
                        
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">üìÅ Procesar y Fusionar Contribuciones</h3>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Sube archivos de contribuciones y opcionalmente el archivo final existente para fusionarlos autom√°ticamente.
                            </p>
                            
                            <div class="form-group">
                                <label class="form-label">üìã Archivos de contribuciones (nuevas preguntas):</label>
                                <input type="file" id="admin-contrib-files" accept=".json" multiple class="form-select" style="cursor: pointer;">
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Archivos exportados desde "Contribuir a Preguntas"
                                </p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìÇ Archivo final existente (opcional):</label>
                                <input type="file" id="admin-existing-file" accept=".json" class="form-select" style="cursor: pointer;">
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Si ya tienes preguntas en producci√≥n, sube el archivo para fusionarlo con las nuevas contribuciones
                                </p>
                            </div>
                            
                            <button class="btn" onclick="app.processContributions()" style="width: 100%;">
                                üîÄ Procesar y Fusionar
                            </button>
                        </div>
                        
                        <div id="process-result" style="display: none;"></div>
                        
                        <button class="btn btn-outline" onclick="app.navigate('contribute')" style="width: 100%; margin-top: 2rem;">
                            ‚¨ÖÔ∏è Volver a Contribuir
                        </button>
                    </div>
                `;
            },
            
            // Fusionar archivos JSON
            processContributions: async () => {
                const contribInput = document.getElementById('admin-contrib-files');
                const existingInput = document.getElementById('admin-existing-file');
                
                if (!contribInput.files.length) {
                    app.showToast('‚ö†Ô∏è Selecciona al menos un archivo de contribuciones');
                    return;
                }
                
                try {
                    // Leer archivo existente si se proporcion√≥
                    let existingData = null;
                    if (existingInput.files.length > 0) {
                        const existingText = await existingInput.files[0].text();
                        existingData = JSON.parse(existingText);
                        console.log('üìÇ Archivo existente cargado:', existingData);
                    }
                    
                    // Leer todos los archivos de contribuciones
                    const allContributions = [];
                    for (let file of contribInput.files) {
                        const text = await file.text();
                        const contributions = JSON.parse(text);
                        if (Array.isArray(contributions)) {
                            allContributions.push(...contributions);
                        }
                    }
                    
                    if (allContributions.length === 0 && !existingData) {
                        app.showToast('‚ö†Ô∏è No se encontraron contribuciones v√°lidas');
                        return;
                    }
                    
                    // Agrupar por asignatura
                    // Importante: Usar el asignaturaId completo (con prefijo de especialidad si existe)
                    // para mantener separadas las asignaturas de diferentes especialidades
                    const byAsignatura = {};
                    allContributions.forEach(contrib => {
                        if (!byAsignatura[contrib.asignaturaId]) {
                            byAsignatura[contrib.asignaturaId] = {
                                name: contrib.asignaturaName,
                                contributions: []
                            };
                        }
                        byAsignatura[contrib.asignaturaId].contributions.push(contrib);
                    });
                    
                    // Generar resumen y archivos por asignatura
                    const resultDiv = document.getElementById('process-result');
                    let resultHTML = `
                        <div class="bg-light-box" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; margin-top: 0;">‚úÖ Procesamiento Completado</h3>
                            <p><strong>${allContributions.length}</strong> contribuciones procesadas de <strong>${contribInput.files.length}</strong> archivo(s)</p>
                            <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                                Agrupadas en <strong>${Object.keys(byAsignatura).length}</strong> asignatura(s):
                            </p>
                        </div>
                    `;
                    
                    // Crear un archivo por cada asignatura
                    for (const [asigId, data] of Object.entries(byAsignatura)) {
                        // Agrupar por tema dentro de cada asignatura
                        const byTema = {};
                        
                        // FUSI√ìN: Si existe archivo previo, cargar sus preguntas primero
                        if (existingData && existingData.temas) {
                            existingData.temas.forEach(tema => {
                                if (!byTema[tema.numero]) {
                                    byTema[tema.numero] = [];
                                }
                                // Las preguntas existentes ya est√°n en formato correcto
                                byTema[tema.numero].push(...tema.preguntas);
                            });
                            console.log('‚úÖ Preguntas existentes cargadas en temas:', Object.keys(byTema));
                        }
                        
                        // Agregar las nuevas contribuciones
                        data.contributions.forEach(contrib => {
                            if (!byTema[contrib.tema]) {
                                byTema[contrib.tema] = [];
                            }
                            // Convertir a formato espa√±ol para que coincida con los archivos existentes
                            byTema[contrib.tema].push({
                                id: contrib.id || `contrib_${Date.now()}`,
                                pregunta: contrib.question,
                                opciones: contrib.options,
                                respuesta_correcta: contrib.answer
                            });
                        });
                        
                        // Crear estructura final
                        const temas = [];
                        for (const [temaNum, preguntas] of Object.entries(byTema)) {
                            temas.push({
                                numero: parseInt(temaNum),
                                nombre: `Tema ${temaNum}`,
                                preguntas: preguntas
                            });
                        }
                        
                        // Ordenar por n√∫mero de tema
                        temas.sort((a, b) => a.numero - b.numero);
                        
                        // Calcular totales
                        const totalPreguntas = temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const nuevasPreguntas = data.contributions.length;
                        const existentes = totalPreguntas - nuevasPreguntas;
                        
                        // Determinar tipo de asignatura basado en el asignaturaId
                        let tipo = 'optativa'; // default
                        if (asigId.includes('-')) {
                            // Si tiene guiones m√∫ltiples, probablemente es de especialidad
                            const parts = asigId.split('-');
                            if (parts.length > 2) {
                                tipo = 'especialidad';
                            } else {
                                // Verificar si es obligatoria
                                const obligatorias = ['aprendizaje-desarrollo-personalidad', 'procesos-contextos-educativos', 'sociedad-familia-educacion'];
                                tipo = obligatorias.includes(asigId) ? 'obligatoria' : 'optativa';
                            }
                        }
                        
                        const outputData = {
                            asignatura: data.name,
                            tipo: tipo,
                            temas: temas
                        };
                        const jsonStr = JSON.stringify(outputData, null, 2);
                        
                        // Obtener baseFileName de la primera contribuci√≥n (todas deber√≠an tener el mismo)
                        const baseFileName = data.contributions[0]?.baseFileName || null;
                        
                        // Crear bot√≥n de descarga para esta asignatura
                        resultHTML += `
                            <div class="bg-white-box" style="padding: 1rem; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${data.name}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${existingData ? `
                                                <span style="color: var(--success);">‚úÖ ${existentes} existentes</span> + 
                                                <span style="color: var(--accent);">‚ûï ${nuevasPreguntas} nuevas</span> = 
                                                <strong>${totalPreguntas} total</strong> ¬∑ ${temas.length} tema(s)
                                            ` : `${data.contributions.length} pregunta(s) ¬∑ ${temas.length} tema(s)`}
                                        </div>
                                        ${baseFileName ? `<div style="font-size: 0.75rem; color: var(--accent); margin-top: 0.25rem;">üìÇ ${baseFileName}.json</div>` : ''}
                                    </div>
                                    <button class="btn" onclick="app.downloadAsignaturaJSON('${asigId}', '${data.name}', ${JSON.stringify(outputData).replace(/"/g, '&quot;')}, '${baseFileName || ''}')" style="padding: 0.5rem 1rem; white-space: nowrap;">
                                        üì• Descargar
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    resultHTML += `
                        <div class="bg-light-box" style="padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                üí° <strong>Siguiente paso:</strong> ${existingData ? 
                                    'El archivo descargado contiene TODAS las preguntas (existentes + nuevas) fusionadas. Reemplaza el archivo en GitHub con este nuevo.' : 
                                    'Descarga cada archivo y reempl√°zalo en la carpeta correspondiente de GitHub.'}
                            </p>
                        </div>
                    `;
                    
                    resultDiv.innerHTML = resultHTML;
                    resultDiv.style.display = 'block';
                    
                    app.showToast('‚úÖ Contribuciones procesadas correctamente');
                } catch (e) {
                    console.error(e);
                    app.showToast('‚ùå Error al procesar los archivos: ' + e.message);
                }
            },
            
            // Descargar JSON de asignatura
            downloadAsignaturaJSON: (asigId, asigName, data, baseFileName) => {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Usar baseFileName si est√° disponible (viene de las contribuciones)
                // Si no, intentar buscar en asignaturasDisponibles o usar el asigId como fallback
                let fileName = baseFileName;
                
                if (!fileName) {
                    const asignatura = app.asignaturasDisponibles.find(a => a.id === asigId);
                    if (asignatura && asignatura.archivo) {
                        fileName = asignatura.archivo.split('/').pop().replace('.json', '');
                    } else {
                        // √öltimo fallback: usar el ID sin prefijo de especialidad
                        // Ej: "tecnologias-informatica-complementos-formacion-disciplinar" ‚Üí "complementos-formacion-disciplinar"
                        const parts = asigId.split('-');
                        if (parts.length > 3) {
                            // Probablemente tiene prefijo de especialidad (2 palabras)
                            fileName = parts.slice(2).join('-');
                        } else {
                            fileName = asigId;
                        }
                    }
                }
                
                link.download = `${fileName}.json`;
                link.click();
                URL.revokeObjectURL(url);
                app.showToast(`üì• ${asigName} descargado`);
            },
            
            // Confirmar y reiniciar todos los datos
            confirmResetAllData: () => {
                if (confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√°:\n\n‚Ä¢ Todo el historial de tests\n‚Ä¢ Todas las estad√≠sticas\n‚Ä¢ Todas las preguntas marcadas\n\n¬øEst√°s seguro de que quieres reiniciar todos los datos?')) {
                    // Limpiar todo
                    app.testHistory = [];
                    app.stats = {};
                    app.markedQuestions.clear();
                    
                    // Guardar cambios
                    app.saveTestHistory();
                    app.saveStats();
                    app.saveMarkedQuestions();
                    
                    app.showToast('‚úÖ Todos los datos han sido reiniciados');
                    app.navigate('home');
                }
            },
            
            renderSearch: (container) => {
                // Usar el estado de b√∫squeda guardado
                const initialTerm = app.searchState.term;
                const initialResults = app.searchState.resultsHTML || '<p style="color:#94a3b8; text-align:center;">Empieza a escribir para buscar en preguntas y respuestas.</p>';

                container.innerHTML = `
                    <div class="card">
                        <h2>üîç Buscador Global</h2>
                        <input type="text" id="search-input" class="form-input" 
                                placeholder="Busca en todas las asignaturas..." 
                                oninput="app.handleSearch(this.value)"
                                value="${initialTerm}">
                        <div id="search-results" style="margin-top:1rem;">
                            ${initialResults}
                        </div>
                    </div>
                `;
            },
            renderDetail: (container, questionId) => {
                // Buscar en todas las asignaturas cargadas
                let foundQuestion = null;
                let foundAsignatura = null;
                
                for (const asig of app.asignaturasDisponibles) {
                    for (const tema of asig.data.temas) {
                        const pregunta = tema.preguntas.find(p => p.id === questionId);
                        if (pregunta) {
                            foundQuestion = {
                                id: pregunta.id,
                                subject: asig.nombre,
                                unit: tema.numero,
                                question: pregunta.pregunta,
                                options: pregunta.opciones,
                                answer: pregunta.respuesta_correcta,
                                tipo: asig.tipo
                            };
                            foundAsignatura = asig;
                            break;
                        }
                    }
                    if (foundQuestion) break;
                }
                
                if (!foundQuestion) return app.navigate('search');
                
                const q = foundQuestion;
                let tipoClass = 'tag';
                if (q.tipo === 'obligatoria') tipoClass += ' tag-obligatoria';
                else if (q.tipo === 'optativa') tipoClass += ' tag-optativa';
                else if (q.tipo === 'especialidad') tipoClass += ' tag-especialidad';
                
                container.innerHTML = `
                    <div class="card">
                        <button class="btn btn-outline" style="width:auto; margin-bottom:1rem;" onclick="app.navigate('search')">‚¨Ö Volver al Buscador</button>
                        <div style="margin-bottom:1rem;">
                            <span class="${tipoClass}">${q.tipo}</span>
                            <span class="tag tag-subject">${q.subject}</span>
                            <span class="tag">Tema ${q.unit}</span>
                            <small style="color:#94a3b8; display:block; margin-top:8px;">ID: ${q.id}</small>
                        </div>
                        <h2 style="font-size:1.3rem; margin-bottom:1.5rem;">${q.question}</h2>
                        
                        <div>
                            ${q.options.map(opt => {
                                const isCorrect = opt === q.answer;
                                return `
                                    <div class="detail-option ${isCorrect ? 'detail-correct' : ''}">
                                        ${opt} ${isCorrect ? '‚úÖ (Correcta)' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },
            // --- MANEJADORES DE EVENTOS ---
            changeEspecialidad: async (especialidadId) => {
                if (especialidadId && especialidadId !== app.currentEspecialidad) {
                    app.showLoading('Cargando asignaturas de especialidad...');
                    app.currentEspecialidad = especialidadId;
                    await app.loadEspecialidadData(especialidadId);
                } else if (!especialidadId) {
                    app.currentEspecialidad = '';
                    app.updateAvailableSubjects();
                }
                app.savePreferences();
                app.navigate('home');
            },
            
            changeAsignatura: (asigId) => {
                app.selectAsignatura(asigId);
                app.savePreferences();
                app.navigate('home');
            },
            
            // Actualizar contador de preguntas marcadas
            updateMarkedCount: () => {
                const countEl = document.getElementById('marked-count');
                const checkbox = document.getElementById('only-marked-check');
                const label = document.getElementById('marked-label');
                const clearBtn = document.getElementById('clear-marked-btn');
                
                if (countEl && app.filteredQuestions) {
                    const markedInCurrent = app.filteredQuestions.filter(q => app.markedQuestions.has(q.id)).length;
                    countEl.textContent = markedInCurrent;
                    
                    // Deshabilitar checkbox si no hay preguntas marcadas
                    if (checkbox) {
                        checkbox.disabled = markedInCurrent === 0;
                        if (markedInCurrent === 0) {
                            checkbox.checked = false;
                            app.quizSettings.onlyMarked = false;
                        }
                    }
                    
                    // Actualizar estilo del label
                    if (label) {
                        label.style.opacity = markedInCurrent === 0 ? '0.5' : '1';
                    }
                    
                    // Mostrar/ocultar bot√≥n de limpiar
                    if (clearBtn) {
                        clearBtn.style.display = app.markedQuestions.size > 0 ? 'flex' : 'none';
                    }
                }
            },
            checkAnswer: (btn) => {
                const q = app.activeQuizQuestions[app.quiz.index];
                const selectedOpt = btn.innerText.trim();
                const isCorrect = selectedOpt === q.answer;
                const feedback = document.getElementById('feedback-area');
                const nextBtn = document.getElementById('next-btn');
                
                // MODO EXAMEN: Permitir cambiar selecci√≥n
                if (app.examMode.active) {
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.option-btn').forEach(b => {
                        b.classList.remove('selected');
                        b.disabled = false;
                    });
                    
                    // Marcar nueva selecci√≥n
                    btn.classList.add('selected');
                    app.quiz.answered = true;
                    
                    // Guardar la respuesta en el array
                    app.quiz.answers[app.quiz.index] = {
                        questionIndex: app.quiz.index,
                        selectedOption: selectedOpt,
                        isCorrect: isCorrect
                    };
                    
                    // Mostrar bot√≥n siguiente
                    nextBtn.classList.remove('hidden');
                    return;
                }
                
                // MODO NORMAL: No permitir cambios
                if (app.quiz.answered) return;
                app.quiz.answered = true;
                
                // Guardar la respuesta en el array
                app.quiz.answers[app.quiz.index] = {
                    questionIndex: app.quiz.index,
                    selectedOption: selectedOpt,
                    isCorrect: isCorrect
                };
                
                // Ocultar bot√≥n saltar al responder
                const skipBtn = document.querySelector('.btn-warning');
                if(skipBtn) skipBtn.style.display = 'none';
                
                // Deshabilitar todos los botones
                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                
                // MODO NORMAL: Mostrar feedback inmediato
                if (isCorrect) {
                    btn.classList.add('correct');
                    app.quiz.score++;
                    feedback.innerHTML = `<b style="color:var(--success)">¬°Correcto! üéâ</b>`;
                } else {
                    btn.classList.add('incorrect');
                    feedback.innerHTML = `<b style="color:var(--error)">Incorrecto.</b><br>La respuesta correcta es: <b>${q.answer}</b>`;
                    document.querySelectorAll('.option-btn').forEach(b => {
                        if (b.innerText.trim() === q.answer) b.classList.add('correct');
                    });
                    // Guardar pregunta fallada para repaso
                    app.quiz.failedQuestions.push(q);
                }
                feedback.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            },
            skipQuestion: () => {
                const currentQ = app.activeQuizQuestions[app.quiz.index];
                app.activeQuizQuestions.splice(app.quiz.index, 1);
                app.activeQuizQuestions.push(currentQ);
                
                app.renderQuiz(document.getElementById('app-container'));
                app.showToast("Pregunta saltada ‚Ü∑");
            },
            nextQuestion: () => {
                // En modo examen, recalcular score y preguntas falladas
                if (app.examMode.active) {
                    app.quiz.score = 0;
                    app.quiz.failedQuestions = [];
                    
                    app.quiz.answers.forEach((answer, idx) => {
                        if (answer) {
                            if (answer.isCorrect) {
                                app.quiz.score++;
                            } else {
                                app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                            }
                        }
                    });
                }
                
                app.quiz.index++;
                app.navigate('quiz');
            },
            
            previousQuestion: () => {
                if (app.quiz.index > 0) {
                    // En modo examen, recalcular score y preguntas falladas antes de retroceder
                    if (app.examMode.active) {
                        app.quiz.score = 0;
                        app.quiz.failedQuestions = [];
                        
                        app.quiz.answers.forEach((answer, idx) => {
                            if (answer) {
                                if (answer.isCorrect) {
                                    app.quiz.score++;
                                } else {
                                    app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                                }
                            }
                        });
                    }
                    
                    app.quiz.index--;
                    app.navigate('quiz');
                }
            },
            
            jumpToQuestion: (index) => {
                if (!app.examMode.active) return;
                
                // Recalcular score antes de saltar
                app.quiz.score = 0;
                app.quiz.failedQuestions = [];
                
                app.quiz.answers.forEach((answer, idx) => {
                    if (answer) {
                        if (answer.isCorrect) {
                            app.quiz.score++;
                        } else {
                            app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                        }
                    }
                });
                
                app.quiz.index = index;
                app.navigate('quiz');
            },
            
            finishExam: () => {
                if (!app.examMode.active) return;
                
                const unanswered = app.activeQuizQuestions.length - app.quiz.answers.filter(a => a).length;
                
                if (unanswered > 0) {
                    const confirmMsg = `‚ö†Ô∏è Tienes ${unanswered} pregunta${unanswered > 1 ? 's' : ''} sin responder.\n\n¬øSeguro que quieres finalizar el examen?`;
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                }
                
                // Recalcular puntuaci√≥n final
                app.quiz.score = 0;
                app.quiz.failedQuestions = [];
                
                app.quiz.answers.forEach((answer, idx) => {
                    if (answer) {
                        if (answer.isCorrect) {
                            app.quiz.score++;
                        } else {
                            app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                        }
                    } else {
                        // Preguntas sin responder tambi√©n cuentan como falladas
                        app.quiz.failedQuestions.push(app.activeQuizQuestions[idx]);
                    }
                });
                
                // Ir directamente a resultados
                app.quiz.index = app.activeQuizQuestions.length;
                app.navigate('quiz');
            },
            
            startQuiz: () => {
                // RESETEAR MODO EXAMEN - esto es un test normal
                if (app.examMode.timer) {
                    clearInterval(app.examMode.timer);
                }
                app.examMode = {
                    active: false,
                    timeLimit: 30,
                    questionCount: 30,
                    startTime: null,
                    endTime: null,
                    timer: null
                };
                
                // Obtener selecci√≥n de unidad
                const unitSelector = document.getElementById('unit-selector');
                const selectedUnit = unitSelector ? unitSelector.value : 'all';
                
                // Filtrar preguntas para el test
                let questionsForQuiz = [...app.filteredQuestions];
                
                if (selectedUnit !== 'all') {
                    questionsForQuiz = questionsForQuiz.filter(q => q.unit == selectedUnit);
                }
                
                // Filtrar solo preguntas marcadas si est√° activado
                if (app.quizSettings.onlyMarked) {
                    questionsForQuiz = questionsForQuiz.filter(q => app.markedQuestions.has(q.id));
                    if (questionsForQuiz.length === 0) {
                        app.showToast("No hay preguntas marcadas para esta selecci√≥n.");
                        return;
                    }
                }
                
                if(questionsForQuiz.length === 0) {
                    app.showToast("No hay preguntas para esta selecci√≥n.");
                    return;
                }
                
                // Configurar test: aleatorio o en orden
                if (app.quizSettings.randomOrder) {
                    app.activeQuizQuestions = app.shuffle(questionsForQuiz);
                } else {
                    app.activeQuizQuestions = questionsForQuiz; // Mantener orden original
                }
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            
            startReviewQuiz: () => {
                if (app.quiz.failedQuestions.length === 0) {
                    app.showToast('No hay preguntas falladas para repasar');
                    return;
                }
                
                // Configurar test solo con preguntas falladas
                app.activeQuizQuestions = app.shuffle([...app.quiz.failedQuestions]);
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            renderQuizResult: (container) => {
                // Detener temporizador del modo examen si est√° activo
                if (app.examMode.active && app.examMode.timer) {
                    clearInterval(app.examMode.timer);
                    app.examMode.timer = null;
                }
                
                const total = app.activeQuizQuestions.length;
                const percent = Math.round((app.quiz.score / total) * 100);
                const numFailed = app.quiz.failedQuestions.length;
                let msg = percent >= 50 ? "¬°Buen trabajo! üëç" : "A seguir repasando üí™";
                if(percent === 100) msg = "¬°Impecable! üèÜ";
                
                const asignaturaName = app.currentAsignatura ? app.currentAsignatura.nombre : 'Sin asignatura';
                const wasExamMode = app.examMode.active;
                
                // Resetear modo examen
                if (app.examMode.active) {
                    app.examMode.active = false;
                }
                
                // Registrar test completado
                if (app.currentAsignatura) {
                    const unitSelector = document.getElementById('unit-selector');
                    const selectedUnit = unitSelector ? unitSelector.value : 'all';
                    const temaName = selectedUnit === 'all' ? 'Todos' : `Tema ${selectedUnit}`;
                    app.recordTestCompletion(app.quiz.score, total, asignaturaName, temaName);
                }
                
                // Si fue modo examen, mostrar revisi√≥n detallada
                if (wasExamMode) {
                    let reviewHTML = `
                        <div class="card">
                            <h1>üìä Resultados del Examen</h1>
                            <p style="color:#dc2626; font-weight: 600;">üéØ Modo Examen Simulado</p>
                            <p style="color:#64748b">Asignatura: ${asignaturaName}</p>
                            <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin: 1rem 0;">
                                ${app.quiz.score} / ${total}
                            </div>
                            <p style="font-size: 1.5rem;">${percent}%</p>
                            <p style="margin-bottom:1rem;">${msg}</p>
                            
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #0ea5e9;">
                                <h3 style="margin-top: 0; font-size: 1.1rem;">üìã Revisi√≥n Completa</h3>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; text-align: left;">
                    `;
                    
                    app.activeQuizQuestions.forEach((q, idx) => {
                        const answer = app.quiz.answers[idx];
                        const isCorrect = answer && answer.isCorrect;
                        const userAnswer = answer ? answer.selectedOption : 'Sin respuesta';
                        
                        reviewHTML += `
                            <div class="bg-light-box" style="padding: 1.25rem; border-radius: 8px; border-left: 4px solid ${isCorrect ? '#22c55e' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                    <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">Pregunta ${idx + 1} de ${total}</h4>
                                    <span style="font-size: 1.5rem;">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                                
                                <p style="font-weight: 600; margin-bottom: 1rem; line-height: 1.5;">${q.question}</p>
                                
                                ${!isCorrect && answer ? `
                                <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; border: 1px solid #fca5a5;">
                                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem; font-size: 0.9rem;">‚ùå Tu respuesta:</div>
                                    <div style="color: #dc2626;">${userAnswer}</div>
                                </div>
                                ` : answer ? `
                                <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; border: 1px solid #86efac;">
                                    <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem; font-size: 0.9rem;">‚úÖ Tu respuesta:</div>
                                    <div style="color: #15803d;">${userAnswer}</div>
                                </div>
                                ` : ''}
                                
                                <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 6px; border: 2px solid #22c55e;">
                                    <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem; font-size: 0.9rem;">‚úì Respuesta correcta:</div>
                                    <div style="color: #15803d; font-weight: 500;">${q.answer}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    reviewHTML += `
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 300px; margin: 0 auto;">
                                <button class="btn" onclick="app.navigate('exam-mode')">üîÅ Repetir Modo Examen</button>
                                <button class="btn btn-outline" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = reviewHTML;
                    return;
                }
                
                // Modo normal
                container.innerHTML = `
                    <div class="card text-center">
                        <h1>üìä Resultados</h1>
                        <p style="color:#64748b">Asignatura: ${asignaturaName}</p>
                        <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin: 1rem 0;">
                            ${app.quiz.score} / ${total}
                        </div>
                        <p style="font-size: 1.5rem;">${percent}%</p>
                        <p style="margin-bottom:1rem;">${msg}</p>
                        
                        ${numFailed > 0 ? `
                        <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #fca5a5;">
                            <p style="margin: 0; color: #dc2626; font-weight: 600;">
                                ‚ö†Ô∏è Fallaste ${numFailed} pregunta${numFailed > 1 ? 's' : ''}
                            </p>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 300px; margin: 0 auto;">
                            ${numFailed > 0 ? `
                            <button class="btn" onclick="app.startReviewQuiz()" style="background: #dc2626; border-color: #dc2626;">
                                üîÑ Repasar Solo Falladas (${numFailed})
                            </button>
                            ` : ''}
                            <button class="btn" onclick="app.startQuiz()">üîÅ Repetir Test Completo</button>
                            <button class="btn btn-outline" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                        </div>
                    </div>
                `;
            },
            
            // Funci√≥n auxiliar para insertar el resaltado
            highlightText: (text, keyword) => {
                if (!keyword) return text;
                const regex = new RegExp(keyword, 'gi');
                // Usa una funci√≥n de reemplazo para mantener las may√∫sculas/min√∫sculas del texto original
                return text.replace(regex, match => `<span class="highlight">${match}</span>`);
            },

            handleSearch: (term) => {
                const resultsDiv = document.getElementById('search-results');
                
                if (term.length < 2) {
                    resultsDiv.innerHTML = '<p style="color:#94a3b8; text-align:center;">Empieza a escribir para buscar en preguntas y respuestas de todas las asignaturas cargadas.</p>';
                    app.searchState.term = term;
                    app.searchState.resultsHTML = resultsDiv.innerHTML;
                    return;
                }
                
                const termLower = term.toLowerCase();
                
                // Buscar en todas las asignaturas cargadas
                let allSearchQuestions = [];
                app.asignaturasDisponibles.forEach(asig => {
                    asig.data.temas.forEach(tema => {
                        tema.preguntas.forEach(p => {
                            allSearchQuestions.push({
                                id: p.id,
                                subject: asig.nombre,
                                unit: tema.numero,
                                question: p.pregunta,
                                options: p.opciones,
                                answer: p.respuesta_correcta,
                                tipo: asig.tipo
                            });
                        });
                    });
                });
                
                const found = allSearchQuestions.filter(q => {
                    if (q.question.toLowerCase().includes(termLower)) return true;
                    return q.options.some(opt => opt.toLowerCase().includes(termLower));
                });
                
                let resultsHTML;
                
                if (found.length === 0) {
                    resultsHTML = '<p style="color:var(--error); text-align:center;">No se encontraron resultados en las asignaturas cargadas.</p>';
                } else {
                    resultsHTML = found.map(q => {
                        const isTermInQuestion = q.question.toLowerCase().includes(termLower);
                        
                        // 1. Pregunta (siempre se muestra, se resalta si la contiene)
                        const highlightedQuestion = app.highlightText(q.question, isTermInQuestion ? term : null);
                        
                        let snippetsHTML = '<div class="snippet-container">';
                        
                        // 2. Respuesta Correcta (siempre se muestra, con estilo verde)
                        const isTermInCorrectAnswer = q.answer.toLowerCase().includes(termLower);
                        const highlightedCorrectAnswer = app.highlightText(q.answer, isTermInCorrectAnswer ? term : null);
                        
                        snippetsHTML += `
                            <div class="search-snippet snippet-correct">
                                <small style="font-weight:700;">‚úÖ Respuesta Correcta:</small> ${highlightedCorrectAnswer}
                            </div>
                        `;
                        
                        // 3. Respuestas Incorrectas (solo se muestran si contienen el t√©rmino)
                        q.options.forEach(opt => {
                            if (opt !== q.answer) { // Si es una opci√≥n incorrecta
                                const isTermInIncorrectAnswer = opt.toLowerCase().includes(termLower);
                                
                                if (isTermInIncorrectAnswer) {
                                    const highlightedIncorrectAnswer = app.highlightText(opt, term); // Resaltado garantizado
                                    
                                    snippetsHTML += `
                                        <div class="search-snippet snippet-incorrect">
                                            <small style="font-weight:700;">‚ùå Respuesta Incorrecta:</small> ${highlightedIncorrectAnswer}
                                        </div>
                                    `;
                                }
                            }
                        });
                        
                        snippetsHTML += '</div>';

                        // Determinar el tag de tipo
                        let tipoClass = 'tag';
                        if (q.tipo === 'obligatoria') tipoClass += ' tag-obligatoria';
                        else if (q.tipo === 'optativa') tipoClass += ' tag-optativa';
                        else if (q.tipo === 'especialidad') tipoClass += ' tag-especialidad';
                        
                        // FINAL RESULT CARD RENDERING
                        return `
                            <div class="result-item" onclick="app.navigate('detail', '${q.id}')">
                                <div style="margin-bottom: 8px;">
                                    <span class="${tipoClass}">${q.tipo}</span>
                                    <span class="tag tag-subject">${q.subject}</span>
                                    <span class="tag">Tema ${q.unit}</span>
                                </div>
                                <div style="font-weight: 500; margin-top: 5px; margin-bottom: 5px;">${highlightedQuestion}</div>
                                ${snippetsHTML}
                            </div>
                        `;
                    }).join('');
                }
                
                resultsDiv.innerHTML = resultsHTML;

                // ACTUALIZAR ESTADO DE B√öSQUEDA
                app.searchState.term = term;
                app.searchState.resultsHTML = resultsHTML;
            },
            shuffle: (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },
            showToast: (text) => {
                const toast = document.getElementById("toast");
                toast.innerText = text;
                toast.className = "show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>
