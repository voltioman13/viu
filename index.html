<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIU estudio examenes</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #1e293b;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --info: #3b82f6;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #0f172a;
            --accent: #fbbf24;
            --success: #34d399;
            --error: #f87171;
            --bg: #0f172a;
            --card: #1e293b;
            --info: #60a5fa;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --input-bg: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        /* --- NAVEGACI√ìN --- */
        nav {
            background-color: var(--secondary);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .nav-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .logo { font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px;}
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap;}
        .menu-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .menu-btn:hover, .menu-btn.active {
            background-color: var(--primary);
            transform: translateY(-1px);
        }
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        /* --- CONTENEDOR CENTRAL --- */
        main {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 2rem auto;
            padding: 0 1rem;
            box-sizing: border-box;
        }
        /* --- TARJETAS --- */
        .card {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px var(--shadow);
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-out;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2, h3 { margin-top: 0; color: var(--text-primary); }
        /* --- FORMULARIOS --- */
        .form-group { margin-bottom: 1.2rem; text-align: left;}
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;}
        .form-input, .form-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
            transition: border-color 0.2s;
            box-sizing: border-box;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .form-select option {
            background: var(--card);
            color: var(--text-primary);
        }
        textarea.form-input { min-height: 100px; resize: vertical; }
        
        /* --- BOT√ìN DE TEMA --- */
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        /* --- BOTONES --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: #64748b; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #059669; }
        .btn-warning { background-color: var(--accent); color: #fff; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-outline { background: transparent; border: 2px solid #cbd5e1; color: #64748b; }
        .btn-outline:hover { border-color: var(--secondary); color: var(--secondary); background: transparent; }
        .btn-info { background-color: var(--info); }
        .btn-info:hover { background-color: #2563eb; }
        /* --- ESTILOS DEL TEST --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: #64748b; font-size: 0.9rem; }
        
        .quiz-progress {
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
        .question-text { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; line-height: 1.5; color: var(--text-primary); }
        .option-btn {
            width: 100%; text-align: left; padding: 1.2rem; margin-bottom: 0.8rem;
            background: var(--card); border: 2px solid var(--border); border-radius: 10px;
            cursor: pointer; transition: all 0.2s; font-size: 1rem; color: var(--text-primary);
            position: relative;
        }
        .option-btn:hover { border-color: var(--primary); background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .option-btn.correct { background: #dcfce7; border-color: var(--success); color: #065f46; font-weight: 600; }
        [data-theme="dark"] .option-btn.correct { background: #064e3b; color: #6ee7b7; }
        .option-btn.incorrect { background: #fee2e2; border-color: var(--error); color: #991b1b; }
        [data-theme="dark"] .option-btn.incorrect { background: #7f1d1d; color: #fca5a5; }
        
        /* --- ESTILOS DE LA B√öSQUEDA (ACTUALIZADO) --- */
        .result-item { 
            padding: 1rem; 
            border-bottom: 1px solid var(--border); 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .result-item:hover { background: var(--input-bg); }
        .tag { 
            font-size: 0.75rem; 
            background: var(--border); 
            padding: 4px 8px; 
            border-radius: 6px; 
            color: var(--text-secondary); 
            margin-right: 8px; 
            font-weight: 600; 
            display: inline-block;
            margin-bottom: 4px;
        }
        .tag-subject { background: #e0e7ff; color: #4338ca; }
        [data-theme="dark"] .tag-subject { background: #312e81; color: #a5b4fc; }
        .tag-obligatoria { background: #fef3c7; color: #92400e; }
        [data-theme="dark"] .tag-obligatoria { background: #78350f; color: #fde68a; }
        .tag-optativa { background: #dbeafe; color: #1e40af; }
        [data-theme="dark"] .tag-optativa { background: #1e3a8a; color: #93c5fd; }
        .tag-especialidad { background: #fce7f3; color: #9f1239; }
        [data-theme="dark"] .tag-especialidad { background: #831843; color: #fbcfe8; }
        .detail-option {
            padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg);
        }
        .detail-correct {
            background-color: #dcfce7; border-color: var(--success); color: #065f46; font-weight: bold;
        }
        [data-theme="dark"] .detail-correct {
            background-color: #064e3b; border-color: var(--success); color: #6ee7b7;
        }

        /* ESTILO PARA RESALTAR TEXTO DE B√öSQUEDA */
        .highlight {
            background-color: var(--accent);
            color: var(--secondary);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        /* Clases para modo oscuro en elementos din√°micos */
        .bg-light-box {
            background: #f8fafc;
        }
        [data-theme="dark"] .bg-light-box {
            background: #1e293b;
        }
        
        .bg-white-box {
            background: white;
        }
        [data-theme="dark"] .bg-white-box {
            background: #334155;
        }
        
        .bg-blue-light {
            background: #eff6ff;
        }
        [data-theme="dark"] .bg-blue-light {
            background: #1e293b;
        }
        
        .text-muted {
            color: #64748b;
        }
        [data-theme="dark"] .text-muted {
            color: #94a3b8;
        }
        
        .text-dark {
            color: #334155;
        }
        [data-theme="dark"] .text-dark {
            color: #e2e8f0;
        }
        
        .border-light {
            border-color: #e2e8f0;
        }
        [data-theme="dark"] .border-light {
            border-color: #334155;
        }
        
        /* SNIPPET STYLES - NUEVOS ESTILOS PARA LA L√çNEA DE COLOR */
        .snippet-container { margin-top: 10px; }
        .search-snippet {
            margin-top: 5px; 
            font-size: 0.9rem; 
            padding: 8px 10px; 
            border-radius: 4px;
            line-height: 1.4;
            margin-bottom: 8px; 
            font-weight: 500;
        }
        .snippet-correct {
            border-left: 3px solid var(--success); /* L√≠nea verde */
            background: #dcfce7; /* Fondo verde claro */
            color: #065f46;
        }
        .snippet-incorrect {
            border-left: 3px solid var(--error); /* L√≠nea roja */
            background: #fee2e2; /* Fondo rojo claro */
            color: #991b1b;
        }

        /* --- UTILIDADES --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .loading-box { text-align: center; padding: 3rem; color: #94a3b8; }
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        @media (max-width: 600px) {
            .nav-content { justify-content: center; }
            .card { padding: 1.5rem; }
            .btn { padding: 0.8rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <!-- T√≠tulo de navegaci√≥n actualizado -->
            <div class="logo">VIU - Master Profesor</div>
            <div class="nav-buttons">
                <button class="menu-btn active" onclick="app.navigate('home')">Inicio</button>
                <button class="menu-btn" onclick="app.navigate('quiz')">Test</button>
                <button class="menu-btn" onclick="app.navigate('search')">üîç Buscar</button>
                <button class="theme-toggle" onclick="app.showHelp()" title="Ayuda y atajos">
                    ‚ÑπÔ∏è
                </button>
                <button class="theme-toggle" onclick="app.toggleTheme()" id="theme-toggle" title="Cambiar tema">
                    üåô
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Modal de Ayuda -->
    <div id="help-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card bg-white-box" style="max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; position: relative;">
            <button onclick="app.hideHelp()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary);">&times;</button>
            <h2 style="margin-bottom: 1.5rem;">üìö Gu√≠a de Uso</h2>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">‚å®Ô∏è Atajos de Teclado</h3>
            <div style="margin-left: 1rem; margin-bottom: 1rem;">
                <p><strong>Durante el test:</strong></p>
                <ul style="margin-left: 1rem;">
                    <li><kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">1</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">2</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">3</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">4</kbd> 
                        - Seleccionar respuesta</li>
                    <li><kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">Enter</kbd> - Siguiente pregunta</li>
                    <li><kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">‚Üê</kbd> 
                        <kbd style="background: var(--card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border);">‚Üí</kbd> - Navegar entre preguntas</li>
                </ul>
            </div>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üìù Notas Personales</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Cada pregunta tiene un campo de notas donde puedes escribir apuntes personales, recordatorios o explicaciones. 
                Las notas se guardan autom√°ticamente en tu navegador.
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">‚≠ê Marcar Preguntas</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Marca preguntas dif√≠ciles para repasarlas despu√©s. Las preguntas marcadas se guardan y puedes crear tests solo con ellas.
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üìä Estad√≠sticas</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                El sistema guarda tu historial de tests, porcentajes de acierto y progreso por asignatura. 
                Consulta las estad√≠sticas en la p√°gina de inicio.
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üîç B√∫squeda</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Busca preguntas por texto, filtra por asignatura o tema espec√≠fico. 
                Ideal para revisar conceptos concretos.
            </p>
            
            <h3 style="color: var(--primary); margin-top: 1rem;">üåô Modo Oscuro</h3>
            <p style="margin-left: 1rem; margin-bottom: 1rem;">
                Alterna entre modo claro y oscuro con el bot√≥n ‚òÄÔ∏è/üåô en la barra superior.
            </p>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" onclick="app.hideHelp()">¬°Entendido!</button>
            </div>
        </div>
    </div>
    
    <main id="app-container">
        <div class="loading-box">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Cargando sistema...</p>
        </div>
    </main>
    <!-- Notificaci√≥n Flotante -->
    <div id="toast">Mensaje</div>
    <script>
        // --- CONFIGURACI√ìN Y ESTRUCTURA ---
        const CONFIG = {
            especialidades: {
                'tecnologias-informatica': 'Tecnolog√≠as e Inform√°tica',
                'orientacion-educativa': 'Orientaci√≥n Educativa',
                'musica': 'M√∫sica',
                'lengua-literatura': 'Lengua y Literatura',
                'ingles': 'Ingl√©s',
                'geografia-historia': 'Geograf√≠a e Historia',
                'fol': 'FOL',
                'fisica-quimica': 'F√≠sica y Qu√≠mica',
                'educacion-fisica': 'Educaci√≥n F√≠sica',
                'economia-administracion': 'Econom√≠a y Administraci√≥n',
                'dibujo': 'Dibujo',
                'biologia-geologia': 'Biolog√≠a y Geolog√≠a'
            },
            asignaturas: {
                obligatorias: [
                    { id: 'sociedad-familia-educacion', nombre: 'Sociedad, familia y educaci√≥n', archivo: 'obligatorias/sociedad-familia-educacion.json' },
                    { id: 'procesos-contextos-educativos', nombre: 'Procesos y contextos educativos', archivo: 'obligatorias/procesos-contextos-educativos.json' },
                    { id: 'aprendizaje-desarrollo-personalidad', nombre: 'Aprendizaje y desarrollo de la personalidad', archivo: 'obligatorias/aprendizaje-desarrollo-personalidad.json' }
                ],
                optativas: [
                    { id: 'mediacion', nombre: 'Mediaci√≥n', archivo: 'optativas-comunes/mediacion.json' },
                    { id: 'materiales-estrategias-didacticas', nombre: 'Materiales y estrategias did√°cticas', archivo: 'optativas-comunes/materiales-estrategias-didacticas.json' },
                    { id: 'educacion-emocional-habilidades-sociales', nombre: 'Educaci√≥n emocional y habilidades sociales', archivo: 'optativas-comunes/educacion-emocional-habilidades-sociales.json' }
                ],
                especialidad: [
                    { id: 'innovacion-docente-investigacion', nombre: 'Innovaci√≥n docente e iniciaci√≥n a la investigaci√≥n', archivo: 'innovacion-docente-investigacion.json' },
                    { id: 'complementos-formacion-disciplinar', nombre: 'Complementos para la formaci√≥n disciplinar', archivo: 'complementos-formacion-disciplinar.json' },
                    { id: 'aprendizaje-ensenanza', nombre: 'Aprendizaje y ense√±anza', archivo: 'aprendizaje-ensenanza.json' }
                ],
                especialidadOrientacion: [
                    { id: 'procesos-orientacion-educativa', nombre: 'Procesos de orientaci√≥n educativa', archivo: 'procesos-orientacion-educativa.json' },
                    { id: 'investigacion-innovacion-gestion-cambio', nombre: 'Investigaci√≥n e innovaci√≥n educativa', archivo: 'investigacion-innovacion-gestion-cambio.json' },
                    { id: 'educacion-inclusiva-atencion-diversidad', nombre: 'Educaci√≥n inclusiva', archivo: 'educacion-inclusiva-atencion-diversidad.json' }
                ]
            }
        };

        const app = {
            filteredQuestions: [],
            activeQuizQuestions: [],
            currentEspecialidad: '',
            currentAsignatura: null,
            asignaturasDisponibles: [],
            loadedData: {},
            
            // Estado del Quiz
            quiz: { 
                index: 0, 
                score: 0, 
                answered: false, 
                failedQuestions: [],
                answers: [] // Guarda {questionIndex, selectedOption, isCorrect}
            },
            
            // Configuraci√≥n de quiz
            quizSettings: {
                randomOrder: false, // false = orden original, true = orden aleatorio
                onlyMarked: false   // mostrar solo preguntas marcadas
            },
            
            // Preguntas marcadas como dif√≠ciles (guardadas en localStorage)
            markedQuestions: new Set(),
            
            // Historial de tests completados
            testHistory: [],
            
            // Estad√≠sticas por asignatura
            stats: {},
            
            // Preferencias guardadas
            savedPreferences: null,
            
            // Tema actual (light o dark)
            currentTheme: 'light',
            
            // Notas personales por pregunta
            questionNotes: {},
            
            // Estado para persistir la b√∫squeda
            searchState: { term: '', resultsHTML: '' },
            
            init: async () => {
                app.showLoading('Cargando datos...');
                app.loadMarkedQuestions();
                app.loadTestHistory();
                app.loadStats();
                app.loadPreferences();
                app.loadQuestionNotes();
                await app.loadInitialData();
                
                // Aplicar preferencias guardadas
                if (app.savedPreferences) {
                    if (app.savedPreferences.lastEspecialidad) {
                        app.currentEspecialidad = app.savedPreferences.lastEspecialidad;
                        await app.loadEspecialidadData(app.savedPreferences.lastEspecialidad);
                    }
                    if (app.savedPreferences.lastAsignatura) {
                        app.selectAsignatura(app.savedPreferences.lastAsignatura);
                    }
                    if (app.savedPreferences.randomOrder !== undefined) {
                        app.quizSettings.randomOrder = app.savedPreferences.randomOrder;
                    }
                    if (app.savedPreferences.onlyMarked !== undefined) {
                        app.quizSettings.onlyMarked = app.savedPreferences.onlyMarked;
                    }
                }
                
                // Cargar y aplicar tema
                app.loadTheme();
                
                // Configurar atajos de teclado
                app.setupKeyboardShortcuts();
                
                // Inicializar modal de ayuda
                app.initHelpModal();
                
                app.navigate('home');
            },
            
            // Gesti√≥n de tema oscuro/claro
            loadTheme: () => {
                const savedTheme = localStorage.getItem('viu_theme') || 'light';
                app.currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);
                app.updateThemeIcon();
            },
            
            toggleTheme: () => {
                const newTheme = app.currentTheme === 'light' ? 'dark' : 'light';
                app.currentTheme = newTheme;
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('viu_theme', newTheme);
                app.updateThemeIcon();
                app.showToast(newTheme === 'dark' ? 'üåô Modo oscuro activado' : '‚òÄÔ∏è Modo claro activado');
            },
            
            updateThemeIcon: () => {
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = app.currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                }
            },
            
            showHelp: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            },
            
            hideHelp: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            },
            
            initHelpModal: () => {
                const modal = document.getElementById('help-modal');
                if (modal) {
                    // Cerrar al hacer click fuera del contenido
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            app.hideHelp();
                        }
                    });
                    // Cerrar con tecla Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.style.display === 'flex') {
                            app.hideHelp();
                        }
                    });
                }
            },
            
            // Cargar preguntas marcadas desde localStorage
            loadMarkedQuestions: () => {
                try {
                    const marked = localStorage.getItem('viu_marked_questions');
                    if (marked) {
                        app.markedQuestions = new Set(JSON.parse(marked));
                    }
                } catch (e) {
                    app.markedQuestions = new Set();
                }
            },
            
            // Guardar preguntas marcadas en localStorage
            saveMarkedQuestions: () => {
                try {
                    localStorage.setItem('viu_marked_questions', JSON.stringify([...app.markedQuestions]));
                } catch (e) {
                    console.error('Error guardando preguntas marcadas:', e);
                }
            },
            
            // Alternar marcado de pregunta
            toggleMarkQuestion: (questionId) => {
                if (app.markedQuestions.has(questionId)) {
                    app.markedQuestions.delete(questionId);
                    app.showToast('Pregunta desmarcada ‚≠ê');
                } else {
                    app.markedQuestions.add(questionId);
                    app.showToast('Pregunta marcada como dif√≠cil üîñ');
                }
                app.saveMarkedQuestions();
                app.renderQuiz(document.getElementById('app-container'));
            },
            
            // Limpiar todas las preguntas marcadas
            clearAllMarkedQuestions: () => {
                const count = app.markedQuestions.size;
                if (count === 0) {
                    app.showToast('No hay preguntas marcadas');
                    return;
                }
                if (confirm(`¬øEliminar todas las ${count} preguntas marcadas?`)) {
                    app.markedQuestions.clear();
                    app.saveMarkedQuestions();
                    // Desmarcar el checkbox si estaba marcado
                    app.quizSettings.onlyMarked = false;
                    app.showToast('‚úÖ Todas las preguntas desmarcadas');
                    // Recargar la vista actual para actualizar la UI
                    app.navigate('home');
                }
            },
            
            // Cargar notas de preguntas desde localStorage
            loadQuestionNotes: () => {
                try {
                    const notes = localStorage.getItem('viu_question_notes');
                    if (notes) {
                        app.questionNotes = JSON.parse(notes);
                    }
                } catch (e) {
                    app.questionNotes = {};
                }
            },
            
            // Guardar notas de preguntas en localStorage
            saveQuestionNotes: () => {
                try {
                    localStorage.setItem('viu_question_notes', JSON.stringify(app.questionNotes));
                } catch (e) {
                    console.error('Error guardando notas:', e);
                }
            },
            
            // Guardar/actualizar nota de una pregunta
            saveQuestionNote: (questionId, note) => {
                if (note && note.trim()) {
                    app.questionNotes[questionId] = note.trim();
                } else {
                    delete app.questionNotes[questionId];
                }
                app.saveQuestionNotes();
            },
            
            // Configurar atajos de teclado
            setupKeyboardShortcuts: () => {
                document.addEventListener('keydown', (e) => {
                    // Solo en vista de quiz
                    if (!window.location.hash.includes('quiz') && app.quiz.index >= 0) {
                        const container = document.getElementById('app-container');
                        if (!container || !container.querySelector('.option-btn')) return;
                    }
                    
                    // Si est√° escribiendo en un input/textarea, ignorar
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    // N√∫meros 1-4 para seleccionar opciones
                    if (['1', '2', '3', '4'].includes(e.key)) {
                        const index = parseInt(e.key) - 1;
                        const buttons = document.querySelectorAll('.option-btn');
                        if (buttons[index] && !buttons[index].disabled && !app.quiz.answered) {
                            e.preventDefault();
                            buttons[index].click();
                        }
                    }
                    
                    // Enter para siguiente
                    if (e.key === 'Enter') {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn && !nextBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            nextBtn.click();
                        }
                    }
                    
                    // Flechas para navegar
                    if (e.key === 'ArrowLeft') {
                        const prevBtn = document.querySelector('button[onclick="app.previousQuestion()"]');
                        if (prevBtn) {
                            e.preventDefault();
                            prevBtn.click();
                        }
                    }
                    
                    if (e.key === 'ArrowRight') {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn && !nextBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            nextBtn.click();
                        }
                    }
                });
            },
            
            // Cargar historial de tests
            loadTestHistory: () => {
                try {
                    const history = localStorage.getItem('viu_test_history');
                    if (history) {
                        app.testHistory = JSON.parse(history);
                    }
                } catch (e) {
                    app.testHistory = [];
                }
            },
            
            // Guardar historial de tests
            saveTestHistory: () => {
                try {
                    localStorage.setItem('viu_test_history', JSON.stringify(app.testHistory));
                } catch (e) {
                    console.error('Error guardando historial:', e);
                }
            },
            
            // Cargar estad√≠sticas
            loadStats: () => {
                try {
                    const stats = localStorage.getItem('viu_stats');
                    if (stats) {
                        app.stats = JSON.parse(stats);
                    }
                } catch (e) {
                    app.stats = {};
                }
            },
            
            // Guardar estad√≠sticas
            saveStats: () => {
                try {
                    localStorage.setItem('viu_stats', JSON.stringify(app.stats));
                } catch (e) {
                    console.error('Error guardando estad√≠sticas:', e);
                }
            },
            
            // Cargar preferencias del usuario
            loadPreferences: () => {
                try {
                    const prefs = localStorage.getItem('viu_preferences');
                    if (prefs) {
                        const saved = JSON.parse(prefs);
                        app.savedPreferences = saved;
                    }
                } catch (e) {
                    app.savedPreferences = null;
                }
            },
            
            // Guardar preferencias del usuario
            savePreferences: () => {
                try {
                    const unitSelector = document.getElementById('unit-selector');
                    const prefs = {
                        lastAsignatura: app.currentAsignatura ? app.currentAsignatura.id : null,
                        lastEspecialidad: app.currentEspecialidad,
                        lastTema: unitSelector ? unitSelector.value : 'all',
                        randomOrder: app.quizSettings.randomOrder,
                        onlyMarked: app.quizSettings.onlyMarked
                    };
                    localStorage.setItem('viu_preferences', JSON.stringify(prefs));
                } catch (e) {
                    console.error('Error guardando preferencias:', e);
                }
            },
            
            // Registrar test completado
            recordTestCompletion: (score, total, asignatura, tema) => {
                const percentage = Math.round((score / total) * 100);
                const testRecord = {
                    date: new Date().toISOString(),
                    asignatura: asignatura,
                    tema: tema || 'Todos',
                    score: score,
                    total: total,
                    percentage: percentage
                };
                
                // A√±adir al historial
                app.testHistory.unshift(testRecord);
                // Mantener solo los √∫ltimos 50 tests
                if (app.testHistory.length > 50) {
                    app.testHistory = app.testHistory.slice(0, 50);
                }
                app.saveTestHistory();
                
                // Actualizar estad√≠sticas por asignatura
                if (!app.stats[asignatura]) {
                    app.stats[asignatura] = {
                        totalTests: 0,
                        totalQuestions: 0,
                        correctAnswers: 0,
                        lastTest: null
                    };
                }
                
                app.stats[asignatura].totalTests++;
                app.stats[asignatura].totalQuestions += total;
                app.stats[asignatura].correctAnswers += score;
                app.stats[asignatura].lastTest = testRecord.date;
                app.saveStats();
            },

            // Cargar datos iniciales
            loadInitialData: async () => {
                try {
                    // Intentar cargar todas las asignaturas obligatorias
                    for (const asig of CONFIG.asignaturas.obligatorias) {
                        try {
                            const response = await fetch(`data/asignaturas/${asig.archivo}`);
                            if (response.ok) {
                                const data = await response.json();
                                app.loadedData[asig.id] = data;
                            }
                        } catch (error) {
                            console.warn(`No se pudo cargar ${asig.nombre}`);
                        }
                    }
                    
                    // Intentar cargar optativas comunes
                    for (const asig of CONFIG.asignaturas.optativas) {
                        try {
                            const response = await fetch(`data/asignaturas/${asig.archivo}`);
                            if (response.ok) {
                                const data = await response.json();
                                app.loadedData[asig.id] = data;
                            }
                        } catch (error) {
                            console.warn(`No se pudo cargar ${asig.nombre}`);
                        }
                    }
                    
                    app.updateAvailableSubjects();
                } catch (error) {
                    console.error('Error cargando datos:', error);
                }
            },
            
            // Cargar asignaturas de especialidad
            loadEspecialidadData: async (especialidadId) => {
                const especialidadPath = `data/asignaturas/especialidades/${especialidadId}`;
                const asignaturasEsp = especialidadId === 'orientacion-educativa' 
                    ? CONFIG.asignaturas.especialidadOrientacion 
                    : CONFIG.asignaturas.especialidad;
                
                for (const asig of asignaturasEsp) {
                    const key = `${especialidadId}-${asig.id}`;
                    if (!app.loadedData[key]) {
                        try {
                            const response = await fetch(`${especialidadPath}/${asig.archivo}`);
                            if (response.ok) {
                                const data = await response.json();
                                app.loadedData[key] = data;
                            }
                        } catch (error) {
                            console.warn(`No se pudo cargar ${asig.nombre} de ${especialidadId}`);
                        }
                    }
                }
                app.updateAvailableSubjects();
            },
            
            // Actualizar lista de asignaturas disponibles
            updateAvailableSubjects: () => {
                app.asignaturasDisponibles = [];
                
                // Obligatorias
                CONFIG.asignaturas.obligatorias.forEach(asig => {
                    if (app.loadedData[asig.id]) {
                        app.asignaturasDisponibles.push({
                            id: asig.id,
                            nombre: asig.nombre,
                            tipo: 'obligatoria',
                            data: app.loadedData[asig.id]
                        });
                    }
                });
                
                // Optativas
                CONFIG.asignaturas.optativas.forEach(asig => {
                    if (app.loadedData[asig.id]) {
                        app.asignaturasDisponibles.push({
                            id: asig.id,
                            nombre: asig.nombre,
                            tipo: 'optativa',
                            data: app.loadedData[asig.id]
                        });
                    }
                });
                
                // Especialidad seleccionada
                if (app.currentEspecialidad) {
                    const asignaturasEsp = app.currentEspecialidad === 'orientacion-educativa' 
                        ? CONFIG.asignaturas.especialidadOrientacion 
                        : CONFIG.asignaturas.especialidad;
                    
                    asignaturasEsp.forEach(asig => {
                        const key = `${app.currentEspecialidad}-${asig.id}`;
                        if (app.loadedData[key]) {
                            app.asignaturasDisponibles.push({
                                id: key,
                                nombre: asig.nombre,
                                tipo: 'especialidad',
                                especialidad: CONFIG.especialidades[app.currentEspecialidad],
                                data: app.loadedData[key]
                            });
                        }
                    });
                }
                
                // Seleccionar primera asignatura con preguntas si no hay ninguna seleccionada
                if (!app.currentAsignatura && app.asignaturasDisponibles.length > 0) {
                    const firstWithQuestions = app.asignaturasDisponibles.find(a => 
                        a.data.temas && a.data.temas.some(t => t.preguntas && t.preguntas.length > 0)
                    );
                    if (firstWithQuestions) {
                        app.selectAsignatura(firstWithQuestions.id);
                    }
                }
            },
            
            // Seleccionar asignatura
            selectAsignatura: (asigId) => {
                const asig = app.asignaturasDisponibles.find(a => a.id === asigId);
                if (asig) {
                    app.currentAsignatura = asig;
                    app.updateQuestionsFromAsignatura();
                }
            },
            
            // Actualizar preguntas desde la asignatura actual
            updateQuestionsFromAsignatura: () => {
                if (!app.currentAsignatura) {
                    app.filteredQuestions = [];
                    return;
                }
                
                const data = app.currentAsignatura.data;
                app.filteredQuestions = [];
                
                if (!data.temas || !Array.isArray(data.temas)) {
                    console.error('Datos inv√°lidos: no hay temas', data);
                    return;
                }
                
                data.temas.forEach(tema => {
                    if (tema.preguntas && Array.isArray(tema.preguntas)) {
                        tema.preguntas.forEach(p => {
                            app.filteredQuestions.push({
                                id: p.id,
                                subject: data.asignatura,
                                unit: tema.numero,
                                question: p.pregunta,
                                options: p.opciones,
                                answer: p.respuesta_correcta
                            });
                        });
                    }
                });
            },
            
            showLoading: (message = 'Cargando...') => {
                const container = document.getElementById('app-container');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-box">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                            <p>${message}</p>
                        </div>
                    `;
                }
            },
            
            // Navegaci√≥n
            navigate: (viewId, param = null) => {
                // Actualizar men√∫
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                
                // Limpiar estado de b√∫squeda si no vamos a la vista de b√∫squeda o detalle
                if (viewId !== 'search' && viewId !== 'detail') {
                    app.searchState = { term: '', resultsHTML: '' };
                }

                // L√≥gica segura para encontrar el bot√≥n activo
                let activeBtn = null;
                try {
                    // Si navegamos a 'detail', el bot√≥n activo sigue siendo 'search'
                    const targetView = viewId === 'detail' ? 'search' : viewId;
                    activeBtn = document.querySelector(`button[onclick="app.navigate('${targetView}')"]`);
                } catch(e) { /* Bot√≥n no encontrado */ }

                if (activeBtn) activeBtn.classList.add('active');

                const container = document.getElementById('app-container');
                container.innerHTML = '';

                switch(viewId) {
                    case 'home': app.renderHome(container); break;
                    case 'quiz': app.renderQuiz(container); break;
                    case 'search': app.renderSearch(container); break;
                    case 'detail': app.renderDetail(container, param); break;
                    case 'history': app.renderHistory(container); break;
                    default: app.renderHome(container);
                }
            },

            // --- VISTAS ---
            renderHome: (container) => {
                // Opciones de especialidad
                const especialidadOptions = Object.entries(CONFIG.especialidades).map(([id, nombre]) => 
                    `<option value="${id}" ${id === app.currentEspecialidad ? 'selected' : ''}>${nombre}</option>`
                ).join('');
                
                // Agrupar asignaturas por tipo
                const obligatorias = app.asignaturasDisponibles.filter(a => a.tipo === 'obligatoria');
                const optativas = app.asignaturasDisponibles.filter(a => a.tipo === 'optativa');
                const especialidad = app.asignaturasDisponibles.filter(a => a.tipo === 'especialidad');
                
                let asignaturaOptions = '';
                
                if (obligatorias.length > 0) {
                    asignaturaOptions += '<optgroup label="üìï Obligatorias">';
                    obligatorias.forEach(a => {
                        const numPreguntas = a.data.temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (optativas.length > 0) {
                    asignaturaOptions += '<optgroup label="üìó Optativas Comunes">';
                    optativas.forEach(a => {
                        const numPreguntas = a.data.temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                if (especialidad.length > 0) {
                    asignaturaOptions += `<optgroup label="üìò ${app.currentAsignatura?.especialidad || 'Especialidad'}">`;
                    especialidad.forEach(a => {
                        const numPreguntas = a.data.temas.reduce((sum, t) => sum + t.preguntas.length, 0);
                        const selected = app.currentAsignatura && app.currentAsignatura.id === a.id ? 'selected' : '';
                        asignaturaOptions += `<option value="${a.id}" ${selected}>${a.nombre} (${numPreguntas} preguntas)</option>`;
                    });
                    asignaturaOptions += '</optgroup>';
                }
                
                const totalPreguntas = app.filteredQuestions.length;
                const canStartQuiz = totalPreguntas > 0;
                
                // Obtener temas disponibles de la asignatura actual
                let temasDisponibles = [];
                if (app.currentAsignatura && app.currentAsignatura.data.temas) {
                    temasDisponibles = app.currentAsignatura.data.temas.filter(t => t.preguntas && t.preguntas.length > 0);
                }
                
                const savedTema = app.savedPreferences?.lastTema || 'all';
                const unitOptions = temasDisponibles.map(tema => 
                    `<option value="${tema.numero}" ${savedTema == tema.numero ? 'selected' : ''}>${tema.nombre} (${tema.preguntas.length} preguntas)</option>`
                ).join('');
                
                container.innerHTML = `
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                        <h1>ZONA DE ESTUDIO VIU</h1>
                        <p class="text-muted" style="margin-bottom: 2rem;">Master en Formaci√≥n del Profesorado</p>
                        
                        <div style="max-width:500px; margin: 2rem auto; text-align:left;">
                            <div class="form-group">
                                <label class="form-label">üéì Especialidad (opcional):</label>
                                <select id="especialidad-selector" class="form-select" onchange="app.changeEspecialidad(this.value)">
                                    <option value="">Sin especialidad</option>
                                    ${especialidadOptions}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìñ Asignatura:</label>
                                <select id="asignatura-selector" class="form-select" onchange="app.changeAsignatura(this.value)" ${!asignaturaOptions ? 'disabled' : ''}>
                                    ${asignaturaOptions || '<option value="">No hay asignaturas disponibles</option>'}
                                </select>
                            </div>
                            
                            ${canStartQuiz ? `
                            <div class="form-group">
                                <label class="form-label">üìù Modo de Test:</label>
                                <select id="unit-selector" class="form-select">
                                    <option value="all">üìö Todas las preguntas (${totalPreguntas})</option>
                                    ${unitOptions}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">‚öôÔ∏è Configuraci√≥n:</label>
                                <div class="bg-light-box border-light" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; border: 1px solid;">
                                    <label class="text-dark" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                                        <input type="checkbox" id="random-order-check" ${app.quizSettings.randomOrder ? 'checked' : ''} 
                                               onchange="app.quizSettings.randomOrder = this.checked" 
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span>üé≤ Orden aleatorio de preguntas</span>
                                    </label>
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                                        <label class="text-dark" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; flex: 1;">
                                            <input type="checkbox" id="only-marked-check" ${app.quizSettings.onlyMarked ? 'checked' : ''} 
                                                   onchange="app.quizSettings.onlyMarked = this.checked; app.updateMarkedCount()" 
                                                   style="width: 18px; height: 18px; cursor: pointer;"
                                                   ${app.markedQuestions.size === 0 ? 'disabled' : ''}>
                                            <span id="marked-label" style="${app.markedQuestions.size === 0 ? 'opacity: 0.5;' : ''}">üîñ Solo preguntas marcadas (<span id="marked-count">0</span>)</span>
                                        </label>
                                        <button id="clear-marked-btn"
                                                style="padding: 0.25rem 0.4rem; background: #fca5a5; color: #7f1d1d; border: 1px solid #f87171; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; display: ${app.markedQuestions.size > 0 ? 'flex' : 'none'}; align-items: center; justify-content: center; min-width: 28px; height: 28px;"
                                                title="Limpiar todas las preguntas marcadas">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="background:${canStartQuiz ? '#dcfce7' : '#fee2e2'}; padding:1rem; border-radius:8px; margin-bottom:2rem; border: 2px solid ${canStartQuiz ? 'var(--success)' : 'var(--error)'};">
                            <p style="margin:0; font-weight:600; color: ${canStartQuiz ? '#065f46' : '#991b1b'};">
                                ${canStartQuiz 
                                    ? `‚úÖ ${totalPreguntas} preguntas disponibles (${temasDisponibles.length} temas)` 
                                    : '‚ö†Ô∏è Esta asignatura a√∫n no tiene preguntas disponibles'}
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 1rem; max-width: 300px; margin: 0 auto;">
                            <button class="btn ${!canStartQuiz ? 'btn-secondary' : ''}" onclick="app.startQuiz()" ${!canStartQuiz ? 'disabled' : ''}>
                                üìù Comenzar Test
                            </button>
                        </div>
                        
                        ${app.currentAsignatura ? `
                        <div class="bg-light-box" style="margin-top: 2rem; padding: 1rem; border-radius: 8px; text-align: left;">
                            <h3 style="font-size: 1rem; margin-top:0;">‚ÑπÔ∏è Informaci√≥n de la asignatura:</h3>
                            <ul style="margin:0; padding-left: 1.5rem;">
                                <li><strong>Nombre:</strong> ${app.currentAsignatura.nombre}</li>
                                <li><strong>Tipo:</strong> ${app.currentAsignatura.tipo}</li>
                                ${app.currentAsignatura.especialidad ? `<li><strong>Especialidad:</strong> ${app.currentAsignatura.especialidad}</li>` : ''}
                                <li><strong>Temas:</strong> ${app.currentAsignatura.data.temas.length}</li>
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${app.renderStatsSection()}
                    </div>
                `;
                
                // Actualizar contador de preguntas marcadas despu√©s de renderizar
                setTimeout(() => {
                    app.updateMarkedCount();
                    
                    // Registrar evento del bot√≥n de limpiar marcadas
                    const clearBtn = document.getElementById('clear-marked-btn');
                    if (clearBtn) {
                        clearBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            app.clearAllMarkedQuestions();
                        });
                    }
                    
                    // Guardar preferencias cuando cambian los checkboxes
                    const randomCheck = document.getElementById('random-order-check');
                    const onlyMarkedCheck = document.getElementById('only-marked-check');
                    const unitSelector = document.getElementById('unit-selector');
                    
                    if (randomCheck) {
                        randomCheck.addEventListener('change', () => app.savePreferences());
                    }
                    if (onlyMarkedCheck) {
                        onlyMarkedCheck.addEventListener('change', () => app.savePreferences());
                    }
                    if (unitSelector) {
                        unitSelector.addEventListener('change', () => app.savePreferences());
                    }
                }, 0);
            },
            
            renderQuiz: (container) => {
                // Usamos activeQuizQuestions en lugar de filteredQuestions
                const questions = app.activeQuizQuestions;
                if (!questions || questions.length === 0) {
                    container.innerHTML = `<div class="card text-center"><h3>‚ö†Ô∏è No hay preguntas activas.</h3><p>Ve al inicio para configurar el test.</p><button class="btn" onclick="app.navigate('home')">Ir al Inicio</button></div>`;
                    return;
                }
                if (app.quiz.index >= questions.length) {
                    app.renderQuizResult(container);
                    return;
                }
                
                const q = questions[app.quiz.index];
                const progress = ((app.quiz.index) / questions.length) * 100;
                
                // Verificar si esta pregunta ya fue respondida
                const previousAnswer = app.quiz.answers[app.quiz.index];
                app.quiz.answered = !!previousAnswer;
                
                // Mezclar opciones solo si no hay respuesta previa (para mantener consistencia)
                const shuffledOptions = previousAnswer ? q.options : app.shuffle([...q.options]);
                
                container.innerHTML = `
                    <div class="card">
                        <div class="quiz-header">
                            <span>Pregunta ${app.quiz.index + 1} de ${questions.length}</span>
                            <span class="tag tag-subject">${q.subject} - U${q.unit}</span>
                        </div>
                        <div class="quiz-progress"><div class="progress-bar" style="width: ${progress}%"></div></div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div class="question-text" style="flex: 1;">${q.question}</div>
                            <button onclick="app.toggleMarkQuestion('${q.id}')" 
                                    style="background: ${app.markedQuestions.has(q.id) ? '#f59e0b' : 'transparent'}; 
                                           border: 2px solid ${app.markedQuestions.has(q.id) ? '#f59e0b' : '#cbd5e1'}; 
                                           color: ${app.markedQuestions.has(q.id) ? 'white' : '#64748b'}; 
                                           padding: 0.5rem 0.75rem; 
                                           border-radius: 8px; 
                                           cursor: pointer; 
                                           font-size: 1.2rem; 
                                           transition: all 0.2s;
                                           flex-shrink: 0;
                                           margin-left: 1rem;"
                                    title="${app.markedQuestions.has(q.id) ? 'Desmarcar pregunta' : 'Marcar como dif√≠cil'}">
                                ${app.markedQuestions.has(q.id) ? 'üîñ' : '‚≠ê'}
                            </button>
                        </div>
                        
                        <div id="options-container">
                            ${shuffledOptions.map((opt, idx) => `
                                <button class="option-btn" data-option="${idx}" onclick="app.checkAnswer(this)" ${previousAnswer ? 'disabled' : ''}>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-area" class="${previousAnswer ? '' : 'hidden'} bg-light-box" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px;"></div>
                        
                        <div class="bg-light-box" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">
                                üìù Notas personales:
                            </label>
                            <textarea id="question-note" 
                                      placeholder="Escribe aqu√≠ tus apuntes o recordatorios sobre esta pregunta..."
                                      style="width: 100%; 
                                             min-height: 80px; 
                                             padding: 0.75rem; 
                                             border: 1px solid var(--border); 
                                             border-radius: 6px; 
                                             font-family: inherit; 
                                             font-size: 0.95rem; 
                                             resize: vertical;
                                             background: var(--card);
                                             color: var(--text-primary);">${app.questionNotes[q.id] || ''}</textarea>
                        </div>
                        
                        <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; gap: 10px;">
                            <div>
                                ${app.quiz.index > 0 ? `
                                <button class="btn btn-outline" style="width: auto;" onclick="app.previousQuestion()">‚¨Ö Anterior</button>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                ${!app.quiz.answered ? `<button class="btn btn-warning" style="width: auto;" onclick="app.skipQuestion()">Saltar ‚Ü∑</button>` : ''}
                                ${app.quiz.index < questions.length - 1 ? `
                                <button id="next-btn" class="btn ${previousAnswer ? '' : 'hidden'}" style="width: auto;" onclick="app.nextQuestion()">Siguiente ‚ûú</button>
                                ` : `
                                <button id="next-btn" class="btn ${previousAnswer ? '' : 'hidden'}" style="width: auto;" onclick="app.nextQuestion()">Ver Resultados üèÅ</button>
                                `}
                            </div>
                        </div>
                    </div>
                    <div class="text-center"><button class="btn-outline" style="border:none; font-size:0.8rem;" onclick="app.navigate('home')">Salir del test</button></div>
                `;
                
                // Si ya fue respondida, mostrar el feedback guardado
                if (previousAnswer) {
                    const feedback = document.getElementById('feedback-area');
                    const optionButtons = document.querySelectorAll('.option-btn');
                    
                    optionButtons.forEach(btn => {
                        const optText = btn.innerText.trim();
                        if (optText === previousAnswer.selectedOption) {
                            btn.classList.add(previousAnswer.isCorrect ? 'correct' : 'incorrect');
                        }
                        if (optText === q.answer) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    if (previousAnswer.isCorrect) {
                        feedback.innerHTML = `<b style="color:var(--success)">¬°Correcto! üéâ</b>`;
                    } else {
                        feedback.innerHTML = `<b style="color:var(--error)">Incorrecto.</b><br>La respuesta correcta es: <b>${q.answer}</b>`;
                    }
                }
                
                // Event listener para guardar notas
                const noteTextarea = document.getElementById('question-note');
                if (noteTextarea) {
                    noteTextarea.addEventListener('blur', () => {
                        app.saveQuestionNote(q.id, noteTextarea.value);
                    });
                    // Tambi√©n guardar al escribir (con debounce simple)
                    let saveTimeout;
                    noteTextarea.addEventListener('input', () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(() => {
                            app.saveQuestionNote(q.id, noteTextarea.value);
                        }, 1000);
                    });
                }
            },
            
            // Renderizar secci√≥n de estad√≠sticas
            renderStatsSection: () => {
                const currentAsigName = app.currentAsignatura ? app.currentAsignatura.nombre : null;
                const asigStats = currentAsigName && app.stats[currentAsigName] ? app.stats[currentAsigName] : null;
                
                // √öltimos 5 tests
                const recentTests = app.testHistory.slice(0, 5);
                
                if (!asigStats && recentTests.length === 0) {
                    return ''; // No mostrar nada si no hay datos
                }
                
                let statsHTML = '<div class="bg-blue-light" style="margin-top: 2rem; padding: 1rem; border-radius: 8px; border: 2px solid var(--primary); text-align: left;">';
                statsHTML += '<h3 class="text-dark" style="font-size: 1rem; margin-top:0;">üìä Estad√≠sticas y Progreso</h3>';
                
                if (asigStats) {
                    const avgPercentage = Math.round((asigStats.correctAnswers / asigStats.totalQuestions) * 100);
                    const failedAnswers = asigStats.totalQuestions - asigStats.correctAnswers;
                    const successRate = avgPercentage;
                    const failRate = 100 - avgPercentage;
                    
                    statsHTML += `
                        <div class="bg-white-box" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 3px var(--shadow);">
                            <p class="text-dark" style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 0.95rem;">${currentAsigName}</p>
                            
                            <!-- Gr√°fico circular de aciertos/fallos -->
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="position: relative; width: 100px; height: 100px;">
                                    <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                                        <!-- C√≠rculo de fondo -->
                                        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#fee2e2" stroke-width="3"></circle>
                                        <!-- C√≠rculo de progreso -->
                                        <circle cx="18" cy="18" r="15.915" fill="none" 
                                                stroke="${avgPercentage >= 70 ? '#22c55e' : avgPercentage >= 50 ? '#f59e0b' : '#ef4444'}" 
                                                stroke-width="3" 
                                                stroke-dasharray="${avgPercentage}, 100"
                                                stroke-linecap="round"></circle>
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${avgPercentage >= 70 ? 'var(--success)' : avgPercentage >= 50 ? '#f59e0b' : 'var(--error)'};">
                                            ${avgPercentage}%
                                        </div>
                                        <div class="text-muted" style="font-size: 0.7rem;">Acierto</div>
                                    </div>
                                </div>
                                
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                            <span style="color: #22c55e; font-weight: 600;">‚úì Correctas</span>
                                            <span style="font-weight: 700;">${asigStats.correctAnswers}</span>
                                        </div>
                                        <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 8px;">
                                            <div style="background: #22c55e; height: 100%; width: ${successRate}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                            <span style="color: #ef4444; font-weight: 600;">‚úó Falladas</span>
                                            <span style="font-weight: 700;">${failedAnswers}</span>
                                        </div>
                                        <div style="background: #f1f5f9; border-radius: 4px; overflow: hidden; height: 8px;">
                                            <div style="background: #ef4444; height: 100%; width: ${failRate}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estad√≠sticas adicionales -->
                            <div class="border-light" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #0ea5e9;">${asigStats.totalTests}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Tests</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6;">${asigStats.totalQuestions}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Preguntas</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 700; color: ${avgPercentage >= 70 ? '#22c55e' : avgPercentage >= 50 ? '#f59e0b' : '#ef4444'};">${avgPercentage}%</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">Promedio</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (recentTests.length > 0) {
                    // Mini gr√°fico de tendencia
                    statsHTML += '<div class="bg-white-box" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 3px var(--shadow);">';
                    statsHTML += '<p class="text-dark" style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 0.9rem;">üìà Tendencia reciente</p>';
                    statsHTML += '<div class="bg-light-box" style="display: flex; align-items: flex-end; justify-content: space-between; height: 80px; gap: 3px; padding: 0.5rem; border-radius: 4px;">';
                    
                    const last8 = recentTests.slice(0, 8).reverse();
                    last8.forEach((test, idx) => {
                        const height = test.percentage;
                        const color = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                        statsHTML += `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;" title="${test.percentage}% - ${test.asignatura}">
                                <div style="font-size: 0.65rem; font-weight: 600; margin-bottom: 2px; color: ${color};">${test.percentage}%</div>
                                <div style="width: 100%; height: ${height}%; background: ${color}; border-radius: 3px 3px 0 0; min-height: 4px; transition: all 0.3s; box-shadow: 0 -1px 3px rgba(0,0,0,0.1);"></div>
                            </div>
                        `;
                    });
                    
                    statsHTML += '</div>';
                    statsHTML += `<p class="text-muted" style="margin: 0.5rem 0 0 0; font-size: 0.75rem; text-align: center;">√öltimos ${last8.length} tests realizados</p>`;
                    statsHTML += '</div>';
                    
                    // Lista de √∫ltimos tests
                    statsHTML += '<div style="margin-top: 1rem;">';
                    statsHTML += '<p class="text-dark" style="margin: 0 0 0.5rem 0; font-weight: 600; font-size: 0.9rem;">üïí Actividad reciente</p>';
                    statsHTML += '<div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">';
                    
                    recentTests.forEach(test => {
                        const date = new Date(test.date);
                        const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        const percentColor = test.percentage >= 70 ? '#22c55e' : test.percentage >= 50 ? '#f59e0b' : '#ef4444';
                        const icon = test.percentage >= 70 ? 'üéâ' : test.percentage >= 50 ? 'üëç' : 'üí™';
                        
                        statsHTML += `
                            <div class="bg-white-box" style="padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; border-left: 3px solid ${percentColor}; box-shadow: 0 1px 2px var(--shadow);">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div class="text-dark" style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${test.asignatura}</div>
                                        <div class="text-muted" style="font-size: 0.75rem;">${test.tema} ¬∑ ${dateStr}</div>
                                        <div class="text-muted" style="margin-top: 0.25rem; font-size: 0.75rem;">
                                            ${test.score}/${test.total} correctas
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                        <div style="font-size: 1.2rem;">${icon}</div>
                                        <div style="font-weight: 700; font-size: 1rem; color: ${percentColor};">
                                            ${test.percentage}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    statsHTML += '</div>';
                    statsHTML += '</div>';
                    
                    if (app.testHistory.length > 5) {
                        statsHTML += `
                            <button class="btn btn-outline" onclick="app.navigate('history')" style="margin-top: 0.75rem; width: 100%; font-size: 0.9rem;">
                                üìà Ver historial completo (${app.testHistory.length} tests)
                            </button>
                        `;
                    }
                }
                
                // Bot√≥n de reiniciar datos
                if (app.testHistory.length > 0 || Object.keys(app.stats).length > 0) {
                    statsHTML += `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <button onclick="app.confirmResetAllData()" 
                                    style="width: 100%; padding: 0.6rem; background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;"
                                    onmouseover="this.style.background='#fee2e2'; this.style.borderColor='#f87171'"
                                    onmouseout="this.style.background='#fef2f2'; this.style.borderColor='#fca5a5'">
                                üîÑ Reiniciar todos los datos
                            </button>
                        </div>
                    `;
                }
                
                statsHTML += '</div>';
                return statsHTML;
            },
            
            // Renderizar vista de historial completo
            renderHistory: (container) => {
                if (app.testHistory.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <h2>üìà Historial de Tests</h2>
                            <p style="color: #94a3b8; margin: 2rem 0;">No has completado ning√∫n test todav√≠a.</p>
                            <button class="btn" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                        </div>
                    `;
                    return;
                }
                
                // Agrupar por asignatura
                const byAsignatura = {};
                app.testHistory.forEach(test => {
                    if (!byAsignatura[test.asignatura]) {
                        byAsignatura[test.asignatura] = [];
                    }
                    byAsignatura[test.asignatura].push(test);
                });
                
                let historyHTML = `
                    <div class="card">
                        <h2>üìà Historial Completo</h2>
                        <p style="color: #64748b; margin-bottom: 2rem;">Total de tests realizados: <strong>${app.testHistory.length}</strong></p>
                `;
                
                // Gr√°fica simple de progreso (√∫ltimos 10 tests)
                const last10 = app.testHistory.slice(0, 10).reverse();
                historyHTML += '<div style="margin-bottom: 2rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">';
                historyHTML += '<h3 style="font-size: 1rem; margin-top: 0;">üìä Progreso reciente (√∫ltimos 10 tests)</h3>';
                historyHTML += '<div style="display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 4px;">';
                
                last10.forEach((test, idx) => {
                    const height = test.percentage;
                    const color = test.percentage >= 70 ? 'var(--success)' : test.percentage >= 50 ? '#f59e0b' : 'var(--error)';
                    historyHTML += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="font-size: 0.7rem; font-weight: 600; margin-bottom: 2px;">${test.percentage}%</div>
                            <div style="width: 100%; height: ${height}%; background: ${color}; border-radius: 4px 4px 0 0; min-height: 5px; transition: all 0.3s;"></div>
                        </div>
                    `;
                });
                
                historyHTML += '</div></div>';
                
                // Lista por asignatura
                Object.keys(byAsignatura).forEach(asigName => {
                    const tests = byAsignatura[asigName];
                    const totalTests = tests.length;
                    const avgPercentage = Math.round(tests.reduce((sum, t) => sum + t.percentage, 0) / totalTests);
                    
                    historyHTML += `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 2px solid #0ea5e9;">
                            <h3 style="font-size: 1rem; margin: 0 0 0.5rem 0; color: #0369a1;">${asigName}</h3>
                            <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b;">
                                ${totalTests} test${totalTests > 1 ? 's' : ''} ¬∑ Promedio: <strong style="color: ${avgPercentage >= 70 ? 'var(--success)' : avgPercentage >= 50 ? '#f59e0b' : 'var(--error)'};">${avgPercentage}%</strong>
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                    `;
                    
                    tests.forEach(test => {
                        const date = new Date(test.date);
                        const dateStr = date.toLocaleDateString('es-ES', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: '2-digit',
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        const percentColor = test.percentage >= 70 ? 'var(--success)' : test.percentage >= 50 ? '#f59e0b' : 'var(--error)';
                        
                        historyHTML += `
                            <div style="padding: 0.75rem; background: white; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid ${percentColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${test.tema}</div>
                                        <div style="color: #64748b; font-size: 0.85rem;">${dateStr} ¬∑ ${test.score}/${test.total} correctas</div>
                                    </div>
                                    <div style="font-weight: 700; font-size: 1.2rem; color: ${percentColor}; min-width: 60px; text-align: right;">
                                        ${test.percentage}%
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    historyHTML += '</div></div>';
                });
                
                historyHTML += `
                        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                            <button class="btn btn-outline" onclick="app.navigate('home')" style="flex: 1;">üè† Volver al Inicio</button>
                            <button class="btn" onclick="if(confirm('¬øEliminar todo el historial?')) { app.clearHistory(); }" style="flex: 1; background: var(--error); border-color: var(--error);">
                                üóëÔ∏è Limpiar Historial
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = historyHTML;
            },
            
            // Limpiar historial
            clearHistory: () => {
                app.testHistory = [];
                app.stats = {};
                app.saveTestHistory();
                app.saveStats();
                app.showToast('‚úÖ Historial limpiado');
                app.navigate('history');
            },
            
            // Confirmar y reiniciar todos los datos
            confirmResetAllData: () => {
                if (confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√°:\n\n‚Ä¢ Todo el historial de tests\n‚Ä¢ Todas las estad√≠sticas\n‚Ä¢ Todas las preguntas marcadas\n\n¬øEst√°s seguro de que quieres reiniciar todos los datos?')) {
                    // Limpiar todo
                    app.testHistory = [];
                    app.stats = {};
                    app.markedQuestions.clear();
                    
                    // Guardar cambios
                    app.saveTestHistory();
                    app.saveStats();
                    app.saveMarkedQuestions();
                    
                    app.showToast('‚úÖ Todos los datos han sido reiniciados');
                    app.navigate('home');
                }
            },
            
            renderSearch: (container) => {
                // Usar el estado de b√∫squeda guardado
                const initialTerm = app.searchState.term;
                const initialResults = app.searchState.resultsHTML || '<p style="color:#94a3b8; text-align:center;">Empieza a escribir para buscar en preguntas y respuestas.</p>';

                container.innerHTML = `
                    <div class="card">
                        <h2>üîç Buscador Global</h2>
                        <input type="text" id="search-input" class="form-input" 
                                placeholder="Busca en todas las asignaturas..." 
                                oninput="app.handleSearch(this.value)"
                                value="${initialTerm}">
                        <div id="search-results" style="margin-top:1rem;">
                            ${initialResults}
                        </div>
                    </div>
                `;
            },
            renderDetail: (container, questionId) => {
                // Buscar en todas las asignaturas cargadas
                let foundQuestion = null;
                let foundAsignatura = null;
                
                for (const asig of app.asignaturasDisponibles) {
                    for (const tema of asig.data.temas) {
                        const pregunta = tema.preguntas.find(p => p.id === questionId);
                        if (pregunta) {
                            foundQuestion = {
                                id: pregunta.id,
                                subject: asig.nombre,
                                unit: tema.numero,
                                question: pregunta.pregunta,
                                options: pregunta.opciones,
                                answer: pregunta.respuesta_correcta,
                                tipo: asig.tipo
                            };
                            foundAsignatura = asig;
                            break;
                        }
                    }
                    if (foundQuestion) break;
                }
                
                if (!foundQuestion) return app.navigate('search');
                
                const q = foundQuestion;
                let tipoClass = 'tag';
                if (q.tipo === 'obligatoria') tipoClass += ' tag-obligatoria';
                else if (q.tipo === 'optativa') tipoClass += ' tag-optativa';
                else if (q.tipo === 'especialidad') tipoClass += ' tag-especialidad';
                
                container.innerHTML = `
                    <div class="card">
                        <button class="btn btn-outline" style="width:auto; margin-bottom:1rem;" onclick="app.navigate('search')">‚¨Ö Volver al Buscador</button>
                        <div style="margin-bottom:1rem;">
                            <span class="${tipoClass}">${q.tipo}</span>
                            <span class="tag tag-subject">${q.subject}</span>
                            <span class="tag">Tema ${q.unit}</span>
                            <small style="color:#94a3b8; display:block; margin-top:8px;">ID: ${q.id}</small>
                        </div>
                        <h2 style="font-size:1.3rem; margin-bottom:1.5rem;">${q.question}</h2>
                        
                        <div>
                            ${q.options.map(opt => {
                                const isCorrect = opt === q.answer;
                                return `
                                    <div class="detail-option ${isCorrect ? 'detail-correct' : ''}">
                                        ${opt} ${isCorrect ? '‚úÖ (Correcta)' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },
            // --- MANEJADORES DE EVENTOS ---
            changeEspecialidad: async (especialidadId) => {
                if (especialidadId && especialidadId !== app.currentEspecialidad) {
                    app.showLoading('Cargando asignaturas de especialidad...');
                    app.currentEspecialidad = especialidadId;
                    await app.loadEspecialidadData(especialidadId);
                } else if (!especialidadId) {
                    app.currentEspecialidad = '';
                    app.updateAvailableSubjects();
                }
                app.savePreferences();
                app.navigate('home');
            },
            
            changeAsignatura: (asigId) => {
                app.selectAsignatura(asigId);
                app.savePreferences();
                app.navigate('home');
            },
            
            // Actualizar contador de preguntas marcadas
            updateMarkedCount: () => {
                const countEl = document.getElementById('marked-count');
                const checkbox = document.getElementById('only-marked-check');
                const label = document.getElementById('marked-label');
                const clearBtn = document.getElementById('clear-marked-btn');
                
                if (countEl && app.filteredQuestions) {
                    const markedInCurrent = app.filteredQuestions.filter(q => app.markedQuestions.has(q.id)).length;
                    countEl.textContent = markedInCurrent;
                    
                    // Deshabilitar checkbox si no hay preguntas marcadas
                    if (checkbox) {
                        checkbox.disabled = markedInCurrent === 0;
                        if (markedInCurrent === 0) {
                            checkbox.checked = false;
                            app.quizSettings.onlyMarked = false;
                        }
                    }
                    
                    // Actualizar estilo del label
                    if (label) {
                        label.style.opacity = markedInCurrent === 0 ? '0.5' : '1';
                    }
                    
                    // Mostrar/ocultar bot√≥n de limpiar
                    if (clearBtn) {
                        clearBtn.style.display = app.markedQuestions.size > 0 ? 'flex' : 'none';
                    }
                }
            },
            checkAnswer: (btn) => {
                if (app.quiz.answered) return;
                app.quiz.answered = true;
                
                const q = app.activeQuizQuestions[app.quiz.index];
                // Obtener la opci√≥n seleccionada del texto del bot√≥n
                const selectedOpt = btn.innerText.trim();
                const isCorrect = selectedOpt === q.answer;
                const feedback = document.getElementById('feedback-area');
                const nextBtn = document.getElementById('next-btn');
                
                // Guardar la respuesta en el array
                app.quiz.answers[app.quiz.index] = {
                    questionIndex: app.quiz.index,
                    selectedOption: selectedOpt,
                    isCorrect: isCorrect
                };
                
                // Ocultar bot√≥n saltar al responder
                const skipBtn = document.querySelector('.btn-warning');
                if(skipBtn) skipBtn.style.display = 'none';
                
                // Deshabilitar todos los botones
                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                
                if (isCorrect) {
                    btn.classList.add('correct');
                    app.quiz.score++;
                    feedback.innerHTML = `<b style="color:var(--success)">¬°Correcto! üéâ</b>`;
                } else {
                    btn.classList.add('incorrect');
                    feedback.innerHTML = `<b style="color:var(--error)">Incorrecto.</b><br>La respuesta correcta es: <b>${q.answer}</b>`;
                    document.querySelectorAll('.option-btn').forEach(b => {
                        if (b.innerText.trim() === q.answer) b.classList.add('correct');
                    });
                    // Guardar pregunta fallada para repaso
                    app.quiz.failedQuestions.push(q);
                }
                feedback.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            },
            skipQuestion: () => {
                const currentQ = app.activeQuizQuestions[app.quiz.index];
                app.activeQuizQuestions.splice(app.quiz.index, 1);
                app.activeQuizQuestions.push(currentQ);
                
                app.renderQuiz(document.getElementById('app-container'));
                app.showToast("Pregunta saltada ‚Ü∑");
            },
            nextQuestion: () => {
                app.quiz.index++;
                app.navigate('quiz');
            },
            
            previousQuestion: () => {
                if (app.quiz.index > 0) {
                    app.quiz.index--;
                    app.navigate('quiz');
                }
            },
            startQuiz: () => {
                // Obtener selecci√≥n de unidad
                const unitSelector = document.getElementById('unit-selector');
                const selectedUnit = unitSelector ? unitSelector.value : 'all';
                
                // Filtrar preguntas para el test
                let questionsForQuiz = [...app.filteredQuestions];
                
                if (selectedUnit !== 'all') {
                    questionsForQuiz = questionsForQuiz.filter(q => q.unit == selectedUnit);
                }
                
                // Filtrar solo preguntas marcadas si est√° activado
                if (app.quizSettings.onlyMarked) {
                    questionsForQuiz = questionsForQuiz.filter(q => app.markedQuestions.has(q.id));
                    if (questionsForQuiz.length === 0) {
                        app.showToast("No hay preguntas marcadas para esta selecci√≥n.");
                        return;
                    }
                }
                
                if(questionsForQuiz.length === 0) {
                    app.showToast("No hay preguntas para esta selecci√≥n.");
                    return;
                }
                
                // Configurar test: aleatorio o en orden
                if (app.quizSettings.randomOrder) {
                    app.activeQuizQuestions = app.shuffle(questionsForQuiz);
                } else {
                    app.activeQuizQuestions = questionsForQuiz; // Mantener orden original
                }
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            
            startReviewQuiz: () => {
                if (app.quiz.failedQuestions.length === 0) {
                    app.showToast('No hay preguntas falladas para repasar');
                    return;
                }
                
                // Configurar test solo con preguntas falladas
                app.activeQuizQuestions = app.shuffle([...app.quiz.failedQuestions]);
                app.quiz.index = 0;
                app.quiz.score = 0;
                app.quiz.answered = false;
                app.quiz.failedQuestions = [];
                app.quiz.answers = [];
                
                app.navigate('quiz');
            },
            renderQuizResult: (container) => {
                const total = app.activeQuizQuestions.length;
                const percent = Math.round((app.quiz.score / total) * 100);
                const numFailed = app.quiz.failedQuestions.length;
                let msg = percent >= 50 ? "¬°Buen trabajo! üëç" : "A seguir repasando üí™";
                if(percent === 100) msg = "¬°Impecable! üèÜ";
                
                const asignaturaName = app.currentAsignatura ? app.currentAsignatura.nombre : 'Sin asignatura';
                
                // Registrar test completado
                if (app.currentAsignatura) {
                    const unitSelector = document.getElementById('unit-selector');
                    const selectedUnit = unitSelector ? unitSelector.value : 'all';
                    const temaName = selectedUnit === 'all' ? 'Todos' : `Tema ${selectedUnit}`;
                    app.recordTestCompletion(app.quiz.score, total, asignaturaName, temaName);
                }
                
                container.innerHTML = `
                    <div class="card text-center">
                        <h1>üìä Resultados</h1>
                        <p style="color:#64748b">Asignatura: ${asignaturaName}</p>
                        <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin: 1rem 0;">
                            ${app.quiz.score} / ${total}
                        </div>
                        <p style="font-size: 1.5rem;">${percent}%</p>
                        <p style="margin-bottom:1rem;">${msg}</p>
                        
                        ${numFailed > 0 ? `
                        <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #fca5a5;">
                            <p style="margin: 0; color: #dc2626; font-weight: 600;">
                                ‚ö†Ô∏è Fallaste ${numFailed} pregunta${numFailed > 1 ? 's' : ''}
                            </p>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 300px; margin: 0 auto;">
                            ${numFailed > 0 ? `
                            <button class="btn" onclick="app.startReviewQuiz()" style="background: #dc2626; border-color: #dc2626;">
                                üîÑ Repasar Solo Falladas (${numFailed})
                            </button>
                            ` : ''}
                            <button class="btn" onclick="app.startQuiz()">üîÅ Repetir Test Completo</button>
                            <button class="btn btn-outline" onclick="app.navigate('home')">üè† Volver al Inicio</button>
                        </div>
                    </div>
                `;
            },
            
            // Funci√≥n auxiliar para insertar el resaltado
            highlightText: (text, keyword) => {
                if (!keyword) return text;
                const regex = new RegExp(keyword, 'gi');
                // Usa una funci√≥n de reemplazo para mantener las may√∫sculas/min√∫sculas del texto original
                return text.replace(regex, match => `<span class="highlight">${match}</span>`);
            },

            handleSearch: (term) => {
                const resultsDiv = document.getElementById('search-results');
                
                if (term.length < 2) {
                    resultsDiv.innerHTML = '<p style="color:#94a3b8; text-align:center;">Empieza a escribir para buscar en preguntas y respuestas de todas las asignaturas cargadas.</p>';
                    app.searchState.term = term;
                    app.searchState.resultsHTML = resultsDiv.innerHTML;
                    return;
                }
                
                const termLower = term.toLowerCase();
                
                // Buscar en todas las asignaturas cargadas
                let allSearchQuestions = [];
                app.asignaturasDisponibles.forEach(asig => {
                    asig.data.temas.forEach(tema => {
                        tema.preguntas.forEach(p => {
                            allSearchQuestions.push({
                                id: p.id,
                                subject: asig.nombre,
                                unit: tema.numero,
                                question: p.pregunta,
                                options: p.opciones,
                                answer: p.respuesta_correcta,
                                tipo: asig.tipo
                            });
                        });
                    });
                });
                
                const found = allSearchQuestions.filter(q => {
                    if (q.question.toLowerCase().includes(termLower)) return true;
                    return q.options.some(opt => opt.toLowerCase().includes(termLower));
                });
                
                let resultsHTML;
                
                if (found.length === 0) {
                    resultsHTML = '<p style="color:var(--error); text-align:center;">No se encontraron resultados en las asignaturas cargadas.</p>';
                } else {
                    resultsHTML = found.map(q => {
                        const isTermInQuestion = q.question.toLowerCase().includes(termLower);
                        
                        // 1. Pregunta (siempre se muestra, se resalta si la contiene)
                        const highlightedQuestion = app.highlightText(q.question, isTermInQuestion ? term : null);
                        
                        let snippetsHTML = '<div class="snippet-container">';
                        
                        // 2. Respuesta Correcta (siempre se muestra, con estilo verde)
                        const isTermInCorrectAnswer = q.answer.toLowerCase().includes(termLower);
                        const highlightedCorrectAnswer = app.highlightText(q.answer, isTermInCorrectAnswer ? term : null);
                        
                        snippetsHTML += `
                            <div class="search-snippet snippet-correct">
                                <small style="font-weight:700;">‚úÖ Respuesta Correcta:</small> ${highlightedCorrectAnswer}
                            </div>
                        `;
                        
                        // 3. Respuestas Incorrectas (solo se muestran si contienen el t√©rmino)
                        q.options.forEach(opt => {
                            if (opt !== q.answer) { // Si es una opci√≥n incorrecta
                                const isTermInIncorrectAnswer = opt.toLowerCase().includes(termLower);
                                
                                if (isTermInIncorrectAnswer) {
                                    const highlightedIncorrectAnswer = app.highlightText(opt, term); // Resaltado garantizado
                                    
                                    snippetsHTML += `
                                        <div class="search-snippet snippet-incorrect">
                                            <small style="font-weight:700;">‚ùå Respuesta Incorrecta:</small> ${highlightedIncorrectAnswer}
                                        </div>
                                    `;
                                }
                            }
                        });
                        
                        snippetsHTML += '</div>';

                        // Determinar el tag de tipo
                        let tipoClass = 'tag';
                        if (q.tipo === 'obligatoria') tipoClass += ' tag-obligatoria';
                        else if (q.tipo === 'optativa') tipoClass += ' tag-optativa';
                        else if (q.tipo === 'especialidad') tipoClass += ' tag-especialidad';
                        
                        // FINAL RESULT CARD RENDERING
                        return `
                            <div class="result-item" onclick="app.navigate('detail', '${q.id}')">
                                <div style="margin-bottom: 8px;">
                                    <span class="${tipoClass}">${q.tipo}</span>
                                    <span class="tag tag-subject">${q.subject}</span>
                                    <span class="tag">Tema ${q.unit}</span>
                                </div>
                                <div style="font-weight: 500; margin-top: 5px; margin-bottom: 5px;">${highlightedQuestion}</div>
                                ${snippetsHTML}
                            </div>
                        `;
                    }).join('');
                }
                
                resultsDiv.innerHTML = resultsHTML;

                // ACTUALIZAR ESTADO DE B√öSQUEDA
                app.searchState.term = term;
                app.searchState.resultsHTML = resultsHTML;
            },
            shuffle: (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },
            showToast: (text) => {
                const toast = document.getElementById("toast");
                toast.innerText = text;
                toast.className = "show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>
